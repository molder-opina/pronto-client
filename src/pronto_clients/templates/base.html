<!doctype html>
<html lang="es" style="color-scheme: dark">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>{{ restaurant_name|title }} ¬∑ Clientes</title>
  <link rel="stylesheet" href="{{ assets_css }}/shared/base.css" />
  <link rel="stylesheet" href="{{ assets_css }}/shared/components.css" />
  <link rel="stylesheet" href="{{ assets_css }}/shared/utilities.css" />
  <link rel="stylesheet" href="{{ assets_css_clients }}/main-ux.css" />
  <link rel="stylesheet" href="{{ assets_css_clients }}/qa-fixes.css" />
  <link rel="stylesheet" href="{{ assets_css_clients }}/color-improvements.css" />
  <link rel="stylesheet" href="{{ assets_css_clients }}/qa-error-fixes-updated.css" />
  <!-- Local Fixes -->
  <link rel="stylesheet" href="{{ url_for('static', filename='css/client_fixes.css') }}" />

  <link rel="icon" href="{{ restaurant_assets }}/branding/icon.png" type="image/png" />
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet" />
  <meta name="csrf-token" content="{{ csrf_token() }}" />

  <script>
    window.APP_SETTINGS = {{ app_settings | tojson | safe }};
    window.APP_CONFIG = {
      'app_name': '{{ app_name }}',
      'restaurant_name': '{{ restaurant_name }}',
      'restaurant_assets': '{{ restaurant_assets }}',
      'static_host_url': '{{ static_host_url }}',
      'current_year': '{{ current_year }}',
      'debug_mode': '{{ debug_mode }}' === 'True',
      'server_time': '{{ server_time }}'
    };
  </script>
  {% if customer_data is defined %}
  <script>
    window.APP_SESSION = { customer: {{ customer_data | tojson | safe }} };
  </script>
  {% endif %}
</head>

<body>
  <!-- FIX APPLIED: PROFILE MODAL CSS MOVED -->
  <div class="global-loading-overlay" id="global-loading" role="status" aria-live="polite">
    <div class="global-loading-spinner"></div>
    <span>Cargando</span>
  </div>
  <div class="notification-container" id="notification-container"></div>

  <!-- Profile Modal -->
  <div class="profile-modal" id="profile-modal">
    <div class="profile-modal-overlay"></div>
    <div class="profile-modal-content">
      <button class="profile-modal-close">√ó</button>

      <!-- Not Logged In View -->
      <div id="profile-not-logged-in" class="profile-view">
        <div class="profile-header">
          <h2>Bienvenido a Pronto</h2>
          <p style="color: var(--muted); margin-top: 0.5rem">
            Inicia sesi√≥n o reg√≠strate para guardar tus pedidos
          </p>
        </div>

        <div class="profile-tabs">
          <button class="profile-tab active" data-tab="login">Iniciar Sesi√≥n</button>
          <button class="profile-tab" data-tab="register">Registrarse</button>
        </div>

        <!-- Login Form -->
        <form id="login-form" class="profile-form">
          <div class="form-group">
            <label for="login-email">Correo electr√≥nico</label>
            <input type="email" id="login-email" required autocomplete="email" />
          </div>
          <div class="form-group">
            <label for="login-password">Contrase√±a</label>
            <div class="password-input-wrapper">
              <input type="password" id="login-password" required autocomplete="current-password" />
              <button type="button" class="password-toggle" aria-label="Mostrar contrase√±a">
                <svg class="eye-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"></path>
                  <circle cx="12" cy="12" r="3"></circle>
                </svg>
                <svg class="eye-slash-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
                  style="display: none">
                  <path
                    d="M17.94 17.94A10.07 10.07 0 0 1 12 20c-7 0-11-8-11-8a18.45 18.45 0 0 1 5.06-5.94M9.9 4.24A9.12 9.12 0 0 1 12 4c7 0 11 8 11 8a18.5 18.5 0 0 1-2.16 3.19m-6.72-1.07a3 3 0 1 1-4.24-4.24">
                  </path>
                  <line x1="1" y1="1" x2="23" y2="23"></line>
                </svg>
              </button>
            </div>
          </div>
          <button type="submit" class="btn btn-primary btn--full">Iniciar Sesi√≥n</button>
          <button type="button" class="btn btn-link forgot-password-btn" id="forgot-password-btn"
            style="margin-top: 1rem; align-self: flex-start">
            ¬øOlvidaste tu contrase√±a?
          </button>
          <div class="form-feedback" id="login-feedback"></div>
        </form>

        <!-- Register Form -->
        <form id="register-form" class="profile-form" style="display: none">
          <div class="form-group">
            <label for="register-name">Nombre completo para teclear</label>
            <input type="text" id="register-name" placeholder="Ej: Juan P√©rez Garc√≠a" required autocomplete="name" />
          </div>
          <div class="form-group">
            <label for="register-email">Correo electr√≥nico</label>
            <input type="email" id="register-email" placeholder="tu@email.com" required autocomplete="email" />
          </div>
          <div class="form-group">
            <label for="register-phone">Tel√©fono celular</label>
            <div class="phone-input-container">
              <div class="country-code-selector">
                <span class="flag-icon">üá≤üáΩ</span>
                <span class="country-code">+52</span>
              </div>
              <input type="tel" id="register-phone" placeholder="5512345678" maxlength="10" pattern="[0-9]{10}" required
                autocomplete="tel" />
            </div>
            <small style="color: var(--muted); font-size: 0.85rem; margin-top: 0.25rem; display: block">10 d√≠gitos sin
              espacios</small>
          </div>
          <div class="form-group">
            <label for="register-password">Contrase√±a</label>
            <div class="password-input-wrapper">
              <input type="password" id="register-password" placeholder="M√≠nimo 6 caracteres" required minlength="6"
                autocomplete="new-password" />
              <button type="button" class="password-toggle" aria-label="Mostrar contrase√±a">
                <svg class="eye-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"></path>
                  <circle cx="12" cy="12" r="3"></circle>
                </svg>
                <svg class="eye-slash-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
                  style="display: none">
                  <path
                    d="M17.94 17.94A10.07 10.07 0 0 1 12 20c-7 0-11-8-11-8a18.45 18.45 0 0 1 5.06-5.94M9.9 4.24A9.12 9.12 0 0 1 12 4c7 0 11 8 11 8a18.5 18.5 0 0 1-2.16 3.19m-6.72-1.07a3 3 0 1 1-4.24-4.24">
                  </path>
                  <line x1="1" y1="1" x2="23" y2="23"></line>
                </svg>
              </button>
            </div>
            <div class="password-strength">
              <div class="password-strength-bar" id="password-strength-bar"></div>
            </div>
            <div class="password-requirements" id="password-requirements">
              <span class="req" data-req="length">M√≠nimo 6 caracteres</span>
              <span class="req" data-req="number">Un n√∫mero</span>
              <span class="req" data-req="uppercase">Una may√∫scula</span>
            </div>
          </div>
          <div class="form-group checkbox-group">
            <input type="checkbox" id="accept-terms" required />
            <label for="accept-terms">
              Acepto los <a href="#" target="_blank">T√©rminos de Servicio</a> y
              <a href="#" target="_blank">Pol√≠tica de Privacidad</a>
            </label>
          </div>
          <button type="submit" class="btn btn-primary btn--full" id="register-submit-btn" disabled>
            Crear Cuenta
          </button>
          <div class="form-feedback" id="register-feedback"></div>
        </form>
      </div>

      <!-- Logged In View -->
      <div id="profile-logged-in" class="profile-view" style="display: none">
        <div class="profile-header">
          <img id="profile-modal-avatar" class="profile-modal-avatar" src="" alt="" />
          <h2 id="profile-name">Usuario</h2>
          <p id="profile-email" style="color: var(--muted)"></p>
        </div>

        <div class="profile-menu">
          <button class="profile-menu-item" data-profile-action="orders">
            <span>üìã</span>
            <span>Mis Pedidos</span>
          </button>
          <button class="profile-menu-item" data-profile-action="settings">
            <span>‚öôÔ∏è</span>
            <span>Configuraci√≥n</span>
          </button>
          <button class="profile-menu-item" data-profile-action="logout">
            <span>üö™</span>
            <span>Cerrar Sesi√≥n</span>
          </button>
        </div>
      </div>
    </div>
  </div>
  <header class="header">
    <div class="header-container">
      <div class="logo-section">
        <a href="/" class="logo-link">
          <img src="{{ restaurant_assets }}/branding/logo.jpg" alt="{{ restaurant_name }} logo"
            data-onload-class="loaded"
            data-fallback-src="data:image/svg+xml,%3Csvg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22%3E%3Ccircle cx=%2250%22 cy=%2250%22 r=%2240%22 fill=%22%23ff6b35%22/%3E%3Ctext x=%2250%22 y=%2260%22 text-anchor=%22middle%22 font-size=%2240%22 fill=%22white%22 font-family=%22sans-serif%22%3EQ%3C/text%3E%3C/svg%3E" />
          <span class="brand-name">{{ restaurant_name|title }}</span>
        </a>
      </div>
      <div class="header-actions">
        <button class="header-btn waiter-btn" aria-label="Llamar al mesero" title="Llamar al mesero">
          <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
              d="M15 17h5l-1.405-1.405A2.032 2.032 0 0118 14.158V11a6.002 6.002 0 00-4-5.659V5a2 2 0 10-4 0v.341C7.67 6.165 6 8.388 6 11v3.159c0 .538-.214 1.055-.595 1.436L4 17h5m6 0v1a3 3 0 11-6 0v-1m6 0H9" />
          </svg>
        </button>
        <button class="header-btn cart-btn" data-toggle-cart aria-label="Ver carrito" title="Ver carrito">
          <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
              d="M3 3h2l.4 2M7 13h10l4-8H5.4M7 13L5.4 5M7 13l-2.293 2.293c-.63.63-.184 1.707.707 1.707H17m0 0a2 2 0 100 4 2 2 0 000-4zm-8 2a2 2 0 11-4 0 2 2 0 014 0z" />
          </svg>
          <span class="cart-badge" id="cart-count">0</span>
        </button>
        <button class="header-btn profile-btn" aria-label="Mi perfil" title="Mi perfil">
          <img class="profile-avatar" id="profile-avatar"
            src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Ccircle cx='50' cy='50' r='50' fill='%23e2e8f0'/%3E%3Cpath d='M50 45a15 15 0 100-30 15 15 0 000 30zM25 85c0-13.8 11.2-25 25-25s25 11.2 25 25' fill='%236b7280'/%3E%3C/svg%3E"
            alt="Foto de perfil" />
        </button>
      </div>
    </div>
  </header>

  <!-- View Tabs - Switch between Menu and My Orders -->
  <div class="view-tabs sticky-nav" id="view-tabs">
    <div class="view-tabs-container">
      <button class="view-tab active" id="tab-menu">
        <i data-lucide="utensils" class="view-tab__icon"></i>
        <span class="view-tab__text">Men√∫</span>
      </button>
      <button class="view-tab" id="tab-details">
        <i data-lucide="clipboard-list" class="view-tab__icon"></i>
        <span class="view-tab__text">Detalles</span>
      </button>
      <button class="view-tab" id="tab-orders">
        <i data-lucide="clipboard-check" class="view-tab__icon"></i>
        <span class="view-tab__text">√ìrdenes</span>
        <span class="badge badge--hidden" id="orders-badge">0</span>
      </button>
    </div>
  </div>

  <!-- Active Orders Section - Shows when viewing orders -->
  <div class="active-orders-section" id="active-orders-section">
    <!-- Single Order Tracker (se usa como modal de detalle) -->
    <div class="single-order-tracker" id="single-order-tracker"></div>

    <!-- Multiple Orders Grid - Shows when there are 2+ orders -->
    <div class="multiple-orders-view" id="multiple-orders-view">
      <div class="multiple-orders-view__header">
        <div class="active-orders-headline">
          <h2>√ìrdenes Activas</h2>
          <span>‚è±Ô∏è Se actualiza autom√°ticamente cada 10 segundos</span>
        </div>
      </div>
      <div class="active-orders-list" id="active-orders-list">
        <!-- Orders will be dynamically inserted here -->
      </div>
    </div>

    <!-- Modal de detalle -->
    <div class="order-detail-modal" id="order-detail-modal">
      <div class="order-detail-content" id="order-detail-content">
        <button class="order-detail-close" id="close-order-detail">‚úï</button>
        <div id="order-detail-body"></div>
      </div>
    </div>
  </div>

  <!-- Checkout Section (Detalles Tab) - Hidden by default -->
  <div class="checkout-section" id="checkout-section" style="display: none">
    <div class="checkout-shell">
      <div class="checkout-accordion-list" id="checkout-accordions">
        <!-- 1. Customer Info Accordion -->
        <div class="checkout-accordion" id="accordion-customer">
          <div class="checkout-accordion-header" data-action="toggle-parent-class" data-class="collapsed">
            <div class="accordion-title">
              <div class="header-btn-icon">
                <!-- Avatar -->
                <img src="{{ static_host_url }}/assets/images/default-avatar.png" alt="Profile" />
              </div>
              <span>Datos del Cliente</span>
            </div>
            <div style="display: flex; align-items: center">
              <span class="header-status" id="customer-status-badge">Requerido</span>
              <span class="accordion-chevron">‚ñº</span>
            </div>
          </div>
          <div class="accordion-content">
            <p style="margin-bottom: 1rem; color: var(--text-secondary, #6b7280); font-size: 0.9em">
              Ingresa tus datos para contactarte cuando el pedido est√© listo.
            </p>
            <form id="checkout-form" novalidate>
              <div class="form-group">
                <label for="customer-name">Nombre <span class="label-hint">(opcional)</span></label>
                <input type="text" id="customer-name" name="name" placeholder="Tu nombre" maxlength="100"
                  autocomplete="name" />
                <span class="form-group__status" id="customer-name-status"></span>
                <span class="form-group__error" id="customer-name-error"></span>
              </div>

              <div class="form-group">
                <label for="customer-email">Email
                  <span class="required-indicator" style="color: var(--danger, #e74c3c)">*</span>
                  <small class="text-muted" style="color: var(--muted); display: block; margin-top: 4px">Requerido para
                    env√≠o de ticket</small>
                </label>
                <input type="email" id="customer-email" name="email" placeholder="tu@email.com" maxlength="254"
                  autocomplete="email" required />
                <span class="form-group__status" id="customer-email-status"></span>
                <span class="form-group__error" id="customer-email-error"></span>
              </div>

              <div class="form-group">
                <label for="customer-phone">Tel√©fono <span class="label-hint">(opcional)</span></label>
                <div class="phone-input-group">
                  <select id="phone-country-code" class="phone-country-select" style="max-width: 80px"></select>
                  <input type="tel" id="customer-phone" name="phone" placeholder="N√∫mero celular" maxlength="15"
                    autocomplete="tel" />
                </div>
                <span class="form-group__status" id="customer-phone-status"></span>
                <span class="form-group__error" id="customer-phone-error"></span>
              </div>

              <div class="mesa-info-card" style="
                    margin-top: 1rem;
                    border: 1px solid #e5e7eb;
                    padding: 1rem;
                    border-radius: 8px;
                  ">
                <div class="mesa-info-card__content">
                  <h4 class="mesa-info-card__title" id="table-label" style="margin: 0">Mesa ‚Äî</h4>
                  <input type="hidden" id="table-number" name="table_number" />
                </div>
              </div>

              <div class="form-group" style="margin-top: 1rem">
                <label for="notes">Notas especiales</label>
                <textarea id="notes" name="notes" rows="3" placeholder="Alergias, preferencias..."
                  maxlength="500"></textarea>
                <span class="form-group__counter" id="notes-counter" style="font-size: 0.8em; float: right">0/500</span>
              </div>

              <div class="feedback-message" id="checkout-feedback"></div>
            </form>
          </div>
        </div>

        <!-- 2. History of Session Orders (Dynamic) -->
        <div id="checkout-history-container">
          <!-- Rendered via JS -->
        </div>

        <!-- 3. Current Cart Accordion -->
        <div class="checkout-accordion expanded" id="accordion-current-order">
          <div class="checkout-accordion-header" data-action="toggle-parent-class" data-class="collapsed">
            <div class="accordion-title">
              <span class="accordion-icon">üõí</span>
              <span>Orden Actual</span>
            </div>
            <div style="display: flex; align-items: center">
              <span class="header-status new">Por Confirmar</span>
              <span class="accordion-chevron">‚ñº</span>
            </div>
          </div>
          <div class="accordion-content">
            <!-- Cart Items Summary -->
            <div class="checkout-summary-header" style="margin-bottom: 1rem">
              <h3 class="checkout-summary__title" style="font-size: 1rem">Resumen del Pedido</h3>
              <span class="checkout-summary__badge" id="cart-items-count">0 items</span>
            </div>

            <div class="checkout-summary__items" id="checkout-summary"></div>

            <div class="checkout-summary__divider"></div>

            <div class="checkout-summary__total">
              <span class="checkout-summary__total-label">Total a Pagar</span>
              <span class="checkout-summary__total-amount" id="checkout-total">$0.00</span>
            </div>

            <button type="submit" form="checkout-form" class="checkout-submit-btn" id="checkout-submit-btn">
              Confirmar Pedido
            </button>

            <p class="checkout-summary__secure"
              style="text-align: center; margin-top: 1rem; font-size: 0.8rem; color: gray">
              üîí Confirmaci√≥n instant√°nea
            </p>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Account Details Section - Shows when viewing account summary -->
  <div class="account-details-section" id="account-details-section">
    <div class="account-details-container">
      <div class="account-details-header">
        <div>
          <h2 class="account-details-title">üí≥ Resumen de Cuenta</h2>
          <p class="account-details-subtitle">Detalles completos de tu sesi√≥n</p>
        </div>
      </div>
      <div id="account-details-content">
        <!-- Account details will be dynamically inserted here -->
      </div>
    </div>
  </div>

  <main>{% block content %}{% endblock %}</main>

  <!-- Cart Panel Block (outside main so it's accessible in all views) -->
  {% block cart_panel %}{% endblock %}

  <!-- Mini Order Tracker (shown when there's an active order) - Global across all pages -->
  <div class="mini-tracker" id="mini-tracker">
    <button class="mini-tracker-close" id="mini-tracker-close" aria-label="Cerrar tracker" title="Ocultar tracker">
      √ó
    </button>
    <div class="mini-tracker-content">
      <div class="mini-tracker-left">
        <div class="mini-tracker-icon">üçΩÔ∏è</div>
        <div class="mini-tracker-info">
          <div class="mini-tracker-title">Tu pedido</div>
          <div class="mini-tracker-status" id="mini-tracker-status">Preparando...</div>
        </div>
      </div>
      <div class="mini-tracker-right">
        <div class="mini-tracker-order-select" id="mini-tracker-order-select-wrapper">
          <label for="mini-tracker-order-select">Orden</label>
          <select id="mini-tracker-order-select"></select>
        </div>
        <div class="mini-tracker-progress-container" id="mini-tracker-progress-container">
          <div class="mini-tracker-progress-bar">
            <div class="mini-tracker-progress-fill" id="mini-tracker-progress"></div>
          </div>
          <div class="mini-tracker-percentage" id="mini-tracker-percentage">0%</div>
        </div>
        <button class="mini-tracker-btn" id="view-detail-btn" data-action="call" data-fn="viewFullTracker">
          Ver detalle
        </button>
        <button class="mini-tracker-btn mini-tracker-btn--primary" id="request-checkout-btn" style="display: none"
          data-action="call" data-fn="requestCheckoutFromTracker">
          üí≥ Pedir Cuenta
        </button>
      </div>
    </div>
  </div>

  <footer class="footer">
    <div class="footer-container">
      <!-- Business Hours Display -->
      <div class="business-hours-display" id="business-hours-display">
        <h3 class="business-hours-title">‚è∞ Horarios de Atenci√≥n</h3>
        <div class="business-hours-schedule" id="business-hours-schedule">
          <!-- Schedule will be populated by JavaScript -->
        </div>
        <div class="business-hours-status" id="current-status">
          <!-- Current status will be populated by JavaScript -->
        </div>
      </div>

      <div class="footer-hours-actions">
        <button type="button" class="footer-hours-btn" id="footer-hours-btn">
          üïí Ver horarios de atenci√≥n
        </button>
      </div>

      <p class="footer-copyright">
        &copy; {{ restaurant_name|title }} {{ current_year }} ¬∑ Hecho con pasi√≥n
        <button type="button" class="support-link" data-open-support>Soporte t√©cnico</button>
      </p>
    </div>
  </footer>

  <!-- Outside Business Hours Modal -->
  <div class="outside-hours-modal" id="outside-hours-modal">
    <div class="outside-hours-modal-content">
      <h2 style="margin: 0 0 1rem 0; color: var(--text); font-size: 1.5rem">
        üïê Fuera de Horario
      </h2>
      <p style="margin: 0 0 1.5rem 0; color: var(--muted); line-height: 1.6">
        Actualmente nos encontramos fuera de nuestro horario de atenci√≥n. Puedes ver nuestro men√∫,
        pero los pedidos no ser√°n procesados hasta que abramos.
      </p>
      <div id="outside-hours-schedule"
        style="background: #f8fafc; border-radius: 8px; padding: 1rem; margin-bottom: 1.5rem">
        <!-- Schedule will be populated by JavaScript -->
      </div>
      <button type="button" class="btn btn-primary outside-hours-continue-btn" id="outside-hours-continue-btn">
        Continuar de todos modos
      </button>
    </div>
  </div>

  <!-- All outside-hours styles moved to menu.css for better maintainability -->

  <!-- Support Modal -->
  <div class="support-modal" id="support-modal">
    <div class="support-modal-content">
      <button class="support-modal-close" id="support-modal-close">√ó</button>
      <h2>Soporte t√©cnico</h2>
      <p>Cu√©ntanos qu√© problema encontraste y te contactaremos.</p>
      <form id="support-form">
        <div class="form-group">
          <label for="support-category">Categor√≠a del problema</label>
          <select id="support-category" required>
            <option value="">Selecciona una categor√≠a</option>
            <option value="order">Problema con un pedido</option>
            <option value="payment">Problema de pago</option>
            <option value="product">Producto incorrecto o faltante</option>
            <option value="delivery">Problema de entrega</option>
            <option value="account">Problema con mi cuenta</option>
            <option value="technical">Error t√©cnico en la app</option>
            <option value="suggestion">Sugerencia o comentario</option>
            <option value="other">Otro</option>
          </select>
        </div>
        <div class="form-group">
          <label for="support-name">Nombre</label>
          <input type="text" id="support-name" required placeholder="Tu nombre" />
        </div>
        <div class="form-group">
          <label for="support-email">Correo</label>
          <input type="email" id="support-email" required placeholder="tu@email.com" />
        </div>
        <div class="form-group">
          <label for="support-description">¬øQu√© sucedi√≥?</label>
          <textarea id="support-description" rows="4" required
            placeholder="Describe el problema con detalle..."></textarea>
        </div>
        <div class="form-group">
          <label for="support-image">Adjuntar imagen (opcional)</label>
          <div class="file-upload-wrapper">
            <input type="file" id="support-image" accept="image/*" capture="environment" />
            <div class="file-upload-preview" id="support-image-preview" style="display: none">
              <img id="support-image-img" src="" alt="Vista previa" />
              <button type="button" class="remove-image" id="remove-support-image">√ó</button>
            </div>
            <div class="file-upload-placeholder" id="support-image-placeholder">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                <polyline points="17 8 12 3 7 8"></polyline>
                <line x1="12" y1="3" x2="12" y2="15"></line>
              </svg>
              <span>Toma una foto o selecciona</span>
            </div>
          </div>
        </div>
        <input type="hidden" id="support-page-url" />
        <button type="submit" class="btn btn-primary btn--full">Enviar reporte</button>
        <div class="support-feedback" id="support-feedback"></div>
      </form>
      <div class="support-success" id="support-success" style="display: none">
        <div class="support-success-icon">‚úì</div>
        <h3>¬°Reporte enviado!</h3>
        <p>Tu n√∫mero de ticket es: <strong id="support-ticket-number"></strong></p>
        <p>Te contactaremos a <span id="support-confirm-email"></span> en breve.</p>
        <button type="button" class="btn btn-secondary" id="support-close-btn">Cerrar</button>
      </div>
    </div>
  </div>

  <!-- Password Recovery Modal -->
  <div class="password-recovery-modal" id="password-recovery-modal">
    <div class="password-recovery-modal-overlay"></div>
    <div class="password-recovery-modal-content">
      <button class="password-recovery-modal-close" id="password-recovery-close">√ó</button>

      <!-- Step 1: Request Recovery -->
      <div id="password-recovery-step-1" class="password-recovery-step">
        <div class="password-recovery-header">
          <h2>¬øOlvidaste tu contrase√±a?</h2>
          <p style="color: var(--muted); margin-top: 0.5rem">
            Ingresa tu email y te enviaremos un enlace para restablecerla
          </p>
        </div>

        <form id="password-recovery-form">
          <div class="form-group">
            <label for="recovery-email">Correo electr√≥nico</label>
            <input type="email" id="recovery-email" placeholder="tu@email.com" required autocomplete="email" />
          </div>
          <button type="submit" class="btn btn-primary btn--full" id="recovery-submit-btn">
            Enviar enlace de recuperaci√≥n
          </button>
          <div class="form-feedback" id="recovery-feedback"></div>
        </form>

        <div class="password-recovery-footer">
          <button class="btn btn-ghost btn--full" id="back-to-login-btn">
            ‚Üê Volver a iniciar sesi√≥n
          </button>
        </div>
      </div>

      <!-- Step 2: Success Message -->
      <div id="password-recovery-step-2" class="password-recovery-step" style="display: none">
        <div class="password-recovery-success">
          <div class="password-recovery-success-icon">‚úì</div>
          <h3>¬°Enlace enviado!</h3>
          <p style="color: var(--muted)">
            Si el correo electr√≥nico est√° registrado, recibir√°s un enlace para restablecer tu
            contrase√±a.
          </p>
          <button class="btn btn-secondary btn--full" id="recovery-done-btn">Entendido</button>
        </div>
      </div>

      <!-- Step 3: Reset Password (for when user clicks link) -->
      <div id="password-recovery-step-3" class="password-recovery-step" style="display: none">
        <div class="password-recovery-header">
          <h2>Nueva contrase√±a</h2>
          <p style="color: var(--muted); margin-top: 0.5rem">Ingresa tu nueva contrase√±a</p>
        </div>

        <form id="password-reset-form">
          <div class="form-group">
            <label for="reset-password">Nueva contrase√±a</label>
            <div class="password-input-wrapper">
              <input type="password" id="reset-password" placeholder="M√≠nimo 6 caracteres" required minlength="6"
                autocomplete="new-password" />
              <button type="button" class="password-toggle" aria-label="Mostrar contrase√±a">
                <svg class="eye-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"></path>
                  <circle cx="12" cy="12" r="3"></circle>
                </svg>
                <svg class="eye-slash-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
                  style="display: none">
                  <path d="M17.94 17.94A10.07 10.07 0 0 1 12 20c-7 0-11-8-11-8a18.45 18.45 0 0 1 5.06-5.94"></path>
                  <line x1="1" y1="1" x2="23" y2="23"></line>
                </svg>
              </button>
            </div>
            <div class="password-strength">
              <div class="password-strength-bar" id="reset-password-strength-bar"></div>
            </div>
          </div>
          <div class="form-group">
            <label for="reset-password-confirm">Confirmar contrase√±a</label>
            <input type="password" id="reset-password-confirm" placeholder="Repite tu contrase√±a" required
              autocomplete="new-password" />
          </div>
          <button type="submit" class="btn btn-primary btn--full" id="reset-submit-btn">
            Cambiar contrase√±a
          </button>
          <div class="form-feedback" id="reset-feedback"></div>
        </form>
      </div>

      <!-- Step 4: Reset Success -->
      <div id="password-recovery-step-4" class="password-recovery-step" style="display: none">
        <div class="password-recovery-success">
          <div class="password-recovery-success-icon">‚úì</div>
          <h3>¬°Contrase√±a actualizada!</h3>
          <p style="color: var(--muted)">Tu contrase√±a ha sido cambiada exitosamente.</p>
          <button class="btn btn-primary btn--full" id="reset-success-btn">Iniciar sesi√≥n</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Order History Modal -->
  <div class="order-history-modal" id="order-history-modal">
    <div class="order-history-modal-overlay"></div>
    <div class="order-history-modal-content">
      <button class="order-history-modal-close" id="order-history-close">√ó</button>

      <div class="order-history-header">
        <h2>Mis Pedidos</h2>
        <div class="order-history-tabs">
          <button class="order-history-tab active" data-status="all">Todos</button>
          <button class="order-history-tab" data-status="active">Activos</button>
          <button class="order-history-tab" data-status="completed">Completados</button>
        </div>
      </div>

      <div class="order-history-content" id="order-history-content">
        <div class="order-history-loading" id="order-history-loading" style="display: none">
          <div class="spinner"></div>
          <p>Cargando pedidos...</p>
        </div>
        <div class="order-history-empty" id="order-history-empty" style="display: none">
          <svg class="empty-state-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
            <path
              d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2" />
          </svg>
          <h3 class="empty-state-title">Sin pedidos a√∫n</h3>
          <p class="empty-state-description">
            Tus pedidos aparecer√°n aqu√≠ despu√©s de realizar uno.
          </p>
          <button class="btn btn-primary" data-action="call" data-fn="backToMenu">Ver men√∫</button>
        </div>
        <div class="order-history-list" id="order-history-list"></div>
      </div>
    </div>
  </div>

  <!-- Keyboard Shortcuts Modal -->
  <div class="shortcuts-modal" id="shortcuts-modal" role="dialog" aria-labelledby="shortcuts-title" aria-modal="true">
    <div class="shortcuts-modal-content">
      <div class="shortcuts-header">
        <h2 id="shortcuts-title">
          <svg width="20" height="20" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
              d="M15 15l-2 5L9 9l11 4-5 2zm0 0l5 5M7.188 2.239l.777 2.897M5.136 7.965l-2.898-.777M13.95 4.05l-2.122 2.122m-5.657 5.656l-2.12 2.122" />
          </svg>
          Atajos de Teclado
        </h2>
        <button class="shortcuts-close" aria-label="Cerrar atajos">&times;</button>
      </div>

      <div class="shortcuts-section">
        <h3>Navegaci√≥n</h3>
        <div class="shortcuts-list">
          <div class="shortcut-item">
            <span class="shortcut-description">Ir al inicio</span>
            <div class="shortcut-keys">
              <kbd>G</kbd>
              <kbd>H</kbd>
            </div>
          </div>
          <div class="shortcut-item">
            <span class="shortcut-description">Enfocar b√∫squeda</span>
            <div class="shortcut-keys">
              <kbd>/</kbd>
            </div>
          </div>
          <div class="shortcut-item">
            <span class="shortcut-description">Ver filtros</span>
            <div class="shortcut-keys">
              <kbd>F</kbd>
            </div>
          </div>
        </div>
      </div>

      <div class="shortcuts-section">
        <h3>Carrito y Pedidos</h3>
        <div class="shortcuts-list">
          <div class="shortcut-item">
            <span class="shortcut-description">Ver carrito</span>
            <div class="shortcut-keys">
              <kbd>C</kbd>
            </div>
          </div>
          <div class="shortcut-item">
            <span class="shortcut-description">Confirmar pedido</span>
            <div class="shortcut-keys">
              <kbd>Enter</kbd>
            </div>
          </div>
          <div class="shortcut-item">
            <span class="shortcut-description">Ver estado del pedido</span>
            <div class="shortcut-keys">
              <kbd>O</kbd>
            </div>
          </div>
        </div>
      </div>

      <div class="shortcuts-section">
        <h3>Men√∫</h3>
        <div class="shortcuts-list">
          <div class="shortcut-item">
            <span class="shortcut-description">Refrescar men√∫</span>
            <div class="shortcut-keys">
              <kbd>R</kbd>
            </div>
          </div>
          <div class="shortcut-item">
            <span class="shortcut-description">Navegar productos</span>
            <div class="shortcut-keys">
              <kbd>J</kbd>
              <kbd>K</kbd>
            </div>
          </div>
          <div class="shortcut-item">
            <span class="shortcut-description">Seleccionar categor√≠a</span>
            <div class="shortcut-keys">
              <kbd>1</kbd>
              <kbd>4</kbd>
            </div>
          </div>
        </div>
      </div>

      <div class="shortcuts-section">
        <h3>General</h3>
        <div class="shortcuts-list">
          <div class="shortcut-item">
            <span class="shortcut-description">Cerrar modal / Volver</span>
            <div class="shortcut-keys">
              <kbd>Esc</kbd>
            </div>
          </div>
        </div>
      </div>

      <p class="shortcuts-hint">Presiona <kbd>?</kbd> para mostrar esta ayuda</p>
    </div>
  </div>

  <!-- Shortcuts Hint Text -->
  <div class="shortcuts-hint-text" style="
        position: fixed;
        bottom: 0.5rem;
        right: 0.5rem;
        font-size: 0.7rem;
        color: #9ca3af;
        z-index: 800;
        pointer-events: none;
        opacity: 0.7;
      ">
    Presiona <kbd style="font-family: inherit; font-weight: bold">?</kbd> para atajos
  </div>

  <script>
    (function () {
      const modal = document.getElementById('shortcuts-modal');
      const closeBtn = modal?.querySelector('.shortcuts-close');

      function openModal() {
        modal?.classList.add('active');
        closeBtn?.focus();
      }

      function closeModal() {
        modal?.classList.remove('active');
      }

      closeBtn?.addEventListener('click', closeModal);

      // Close on backdrop click
      modal?.addEventListener('click', (e) => {
        if (e.target === modal) closeModal();
      });

      document.addEventListener('keydown', function (e) {
        // Robust key check for ? (Shift+/)
        const isQuestionMark = e.key === '?' || (e.key === '/' && e.shiftKey);

        if (isQuestionMark && !e.target.matches('input, textarea, select')) {
          e.preventDefault();
          if (modal?.classList.contains('active')) {
            closeModal();
          } else {
            openModal();
          }
        }

        if (e.key === 'Escape' && modal?.classList.contains('active')) {
          closeModal();
        }
      });
    })();
  </script>

  <script>
    window.__PRONTO_TS_CLIENT_BASE__ = true;
  </script>
  <script type="module" src="{{ static_host_url }}/assets/js/clients/base.js?v=cachebust1"></script>

  <!-- Sticky Cart Summary Bar (Mobile) -->
  <div class="sticky-cart-bar" id="sticky-cart-bar" role="dialog" aria-label="Resumen del carrito">
    <div class="sticky-cart-bar__content">
      <div class="sticky-cart-bar__info">
        <div class="sticky-cart-bar__icon">
          <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
              d="M16 11V7a4 4 0 00-8 0v4M5 9h14l1 12H4L5 9z" />
          </svg>
          <span class="sticky-cart-bar__badge" id="sticky-cart-count">0</span>
        </div>
        <div class="sticky-cart-bar__details">
          <span class="sticky-cart-bar__label">Tu pedido:</span>
          <span class="sticky-cart-bar__total" id="sticky-cart-total">$0.00</span>
          <span class="sticky-cart-bar__items" id="sticky-cart-items">0 art√≠culos</span>
        </div>
      </div>
      <button class="sticky-cart-bar__btn" id="sticky-cart-btn" data-action="call" data-fn="showCart">
        Ver Carrito
        <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" />
        </svg>
      </button>
    </div>
  </div>

  <!-- Undo Snackbar -->
  <div class="undo-snackbar" id="undo-snackbar" role="alert" aria-live="polite">
    <span class="undo-snackbar__message">Art√≠culo eliminado</span>
    <button class="undo-snackbar__action" id="undo-btn">Deshacer</button>
  </div>

  <!-- Debug Panel -->
  {# {% if debug_auto_table %} {% include 'debug_panel.html'} {% endif %} #}

  <script defer src="{{ static_host_url }}/assets/js/shared/bindings.js"></script>

  <script>
  // FORCE CONFIG RESTORATION - FIX FOR LEGACY OVERWRITE
  (function () {
  if (!window.APP_CONFIG) window.APP_CONFIG = {};

  // Restore values that might have been lost
  if (!window.APP_CONFIG.static_host_url) {
  window.APP_CONFIG.static_host_url = '{{ static_host_url }}';
  }

  // Ensure restaurant assets are correct
  if (!window.APP_CONFIG.restaurant_assets || window.APP_CONFIG.restaurant_assets.includes('undefined')) {
  window.APP_CONFIG.restaurant_assets = '{{ restaurant_assets }}';
  }

  console.log('[Config Fixer] Restored APP_CONFIG:', window.APP_CONFIG);
  })();
  </script>

  <script>
  document.addEventListener('DOMContentLoaded', () => {
  if (window.Lucide && window.Lucide.createIcons) {
  window.Lucide.createIcons({ icons: window.Lucide.icons });
  }
  });
  </script>

  <!-- Local Fixes Script -->
  <script src="{{ url_for('static', filename='js/client_fixes.js') }}"></script>

  <!-- Vue Notification Center for SSE notifications -->
  <div id="notification-center-root"></div>
</body>

</html>
