<!-- Debug Panel - Only visible when DEBUG_MODE is enabled -->
{% if config.get('DEBUG_MODE', False) %}
<style>
  .debug-panel {
    position: fixed;
    bottom: 20px;
    left: 20px;
    z-index: 13000;
  }

  .debug-toggle {
    width: 60px;
    height: 60px;
    border-radius: 50%;
    background: linear-gradient(135deg, #8b5cf6, #6366f1);
    color: white;
    border: none;
    cursor: pointer;
    box-shadow: 0 4px 20px rgba(139, 92, 246, 0.4);
    font-size: 1.5rem;
    transition: all 0.3s;
    display: flex;
    align-items: center;
    justify-content: center;
  }

  .debug-toggle:hover {
    transform: scale(1.1);
    box-shadow: 0 6px 30px rgba(139, 92, 246, 0.6);
  }

  .debug-menu {
    position: absolute;
    bottom: 80px;
    left: 0;
    background: white;
    border-radius: 16px;
    box-shadow: 0 10px 40px rgba(0, 0, 0, 0.2);
    width: 380px;
    max-height: 70vh;
    overflow-y: auto;
    display: none;
  }

  .debug-menu.active {
    display: block;
    animation: slideUp 0.3s ease;
  }

  @keyframes slideUp {
    from {
      opacity: 0;
      transform: translateY(20px);
    }
    to {
      opacity: 1;
      transform: translateY(0);
    }
  }

  .debug-header {
    padding: 1rem;
    background: linear-gradient(135deg, #8b5cf6, #6366f1);
    color: white;
    border-radius: 16px 16px 0 0;
    font-weight: 700;
    display: flex;
    justify-content: space-between;
    align-items: center;
  }

  .debug-close {
    background: none;
    border: none;
    color: white;
    font-size: 1.5rem;
    cursor: pointer;
    padding: 0;
    width: 30px;
    height: 30px;
    display: flex;
    align-items: center;
    justify-content: center;
  }

  .debug-section {
    padding: 1rem;
    border-bottom: 1px solid #e5e7eb;
  }

  .debug-section:last-child {
    border-bottom: none;
  }

  .debug-section h3 {
    margin: 0 0 0.75rem 0;
    font-size: 0.85rem;
    color: #6b7280;
    text-transform: uppercase;
    font-weight: 600;
    display: flex;
    align-items: center;
    gap: 0.5rem;
  }

  .debug-btn {
    width: 100%;
    padding: 0.6rem 0.75rem;
    margin-bottom: 0.4rem;
    background: white;
    border: 1px solid #e5e7eb;
    border-radius: 8px;
    cursor: pointer;
    font-weight: 500;
    color: #374151;
    transition: all 0.2s;
    display: flex;
    align-items: center;
    gap: 0.5rem;
    font-size: 0.85rem;
  }

  .debug-btn:hover {
    border-color: #8b5cf6;
    background: #f5f3ff;
    color: #7c3aed;
  }

  .debug-btn:last-child {
    margin-bottom: 0;
  }

  .debug-btn-icon {
    font-size: 1rem;
    width: 24px;
    text-align: center;
  }

  .debug-btn-group {
    display: flex;
    gap: 0.5rem;
    margin-bottom: 0.4rem;
  }

  .debug-btn-group .debug-btn {
    flex: 1;
    margin-bottom: 0;
  }

  .debug-status {
    margin-top: 0.5rem;
    padding: 0.5rem;
    border-radius: 6px;
    font-size: 0.8rem;
    display: none;
  }

  .debug-status.success {
    display: block;
    background: #d1fae5;
    color: #065f46;
  }
  .debug-status.error {
    display: block;
    background: #fee2e2;
    color: #991b1b;
  }
  .debug-status.info {
    display: block;
    background: #dbeafe;
    color: #1e40af;
  }
  .debug-status.warning {
    display: block;
    background: #fef3c7;
    color: #92400e;
  }

  .debug-input {
    width: 100%;
    padding: 0.5rem;
    border: 1px solid #e5e7eb;
    border-radius: 6px;
    margin-bottom: 0.5rem;
    font-size: 0.85rem;
  }

  .debug-select {
    width: 100%;
    padding: 0.5rem;
    border: 1px solid #e5e7eb;
    border-radius: 6px;
    margin-bottom: 0.5rem;
    font-size: 0.85rem;
    background: white;
  }

  .debug-divider {
    height: 1px;
    background: #e5e7eb;
    margin: 0.75rem 0;
  }
</style>

<div class="debug-panel">
  <button class="debug-toggle" id="debug-toggle-btn" data-action="call" data-fn="toggleDebugMenu" title="Debug Mode">
    ğŸ›
  </button>

  <div class="debug-menu" id="debug-menu">
    <div class="debug-header">
      <span>ğŸ”§ Debug Mode</span>
      <button class="debug-close" data-action="call" data-fn="toggleDebugMenu">Ã—</button>
    </div>

    <!-- ğŸ‘¤ AutenticaciÃ³n -->
    <div class="debug-section">
      <h3>ğŸ‘¤ AutenticaciÃ³n</h3>
      <div class="debug-btn-group">
        <button class="debug-btn" data-action="call" data-fn="debugQuickLogin">
          <span class="debug-btn-icon">ğŸ”</span>
          <span>Login rÃ¡pido</span>
        </button>
        <button class="debug-btn" data-action="call" data-fn="debugCreateUser">
          <span class="debug-btn-icon">â•</span>
          <span>Crear usuario</span>
        </button>
      </div>
      <button class="debug-btn" data-action="call" data-fn="debugOpenProfile">
        <span class="debug-btn-icon">ğŸ‘¤</span>
        <span>Abrir perfil</span>
      </button>
    </div>

    <!-- ğŸ½ï¸ MenÃº y Productos -->
    <div class="debug-section">
      <h3>ğŸ½ï¸ MenÃº y Productos</h3>
      <button class="debug-btn" data-action="call" data-fn="debugLoadFullMenu">
        <span class="debug-btn-icon">ğŸ“‹</span>
        <span>Cargar menÃº completo</span>
      </button>
      <button class="debug-btn" data-action="call" data-fn="debugSearchProducts" data-arg="pizza">
        <span class="debug-btn-icon">ğŸ”</span>
        <span>Buscar: "pizza"</span>
      </button>
      <div class="debug-btn-group">
        <button class="debug-btn" data-action="call" data-fn="debugFilterCategory" data-arg="combos">
          <span class="debug-btn-icon">ğŸ”</span>
          <span>Combos</span>
        </button>
        <button class="debug-btn" data-action="call" data-fn="debugFilterCategory" data-arg="bebidas">
          <span class="debug-btn-icon">ğŸ¥¤</span>
          <span>Bebidas</span>
        </button>
      </div>
    </div>

    <!-- ğŸ›’ Carrito -->
    <div class="debug-section">
      <h3>ğŸ›’ Carrito</h3>
      <div class="debug-btn-group">
        <button class="debug-btn" data-action="call" data-fn="debugAddRandomItems" data-arg="2">
          <span class="debug-btn-icon">â•</span>
          <span>+2 items</span>
        </button>
        <button class="debug-btn" data-action="call" data-fn="debugAddRandomItems" data-arg="5">
          <span class="debug-btn-icon">ğŸ›’</span>
          <span>+5 items</span>
        </button>
      </div>
      <button class="debug-btn" data-action="call" data-fn="debugClearCart">
        <span class="debug-btn-icon">ğŸ—‘ï¸</span>
        <span>Vaciar carrito</span>
      </button>
      <button class="debug-btn" data-action="call" data-fn="debugApplyCoupon" data-arg="DESCUENTO10">
        <span class="debug-btn-icon">ğŸ«</span>
        <span>Aplicar cupÃ³n: DESCUENTO10</span>
      </button>
    </div>

    <!-- ğŸ“¦ Ã“rdenes -->
    <div class="debug-section">
      <h3>ğŸ“¦ Ã“rdenes</h3>
      <button class="debug-btn" data-action="call" data-fn="debugCreateOrderFromCart">
        <span class="debug-btn-icon">ğŸ“¤</span>
        <span>Crear orden del carrito</span>
      </button>
      <button class="debug-btn" data-action="call" data-fn="debugCreateQuickOrder">
        <span class="debug-btn-icon">âš¡</span>
        <span>Orden rÃ¡pida (2 items)</span>
      </button>
      <div class="debug-divider"></div>
      <button class="debug-btn" data-action="call" data-fn="debugAdvanceCurrentOrder">
        <span class="debug-btn-icon">â¡ï¸</span>
        <span>Avanzar estado orden</span>
      </button>
      <button class="debug-btn" data-action="call" data-fn="debugAdvanceAllOrders">
        <span class="debug-btn-icon">â©</span>
        <span>Avanzar todas las Ã³rdenes</span>
      </button>
    </div>

    <!-- ğŸ’° Pago y Checkout -->
    <div class="debug-section">
      <h3>ğŸ’° Pago y Checkout</h3>
      <button class="debug-btn" data-action="call" data-fn="debugRequestBill">
        <span class="debug-btn-icon">ğŸ§¾</span>
        <span>Solicitar cuenta</span>
      </button>
      <button class="debug-btn" data-action="call" data-fn="debugSimulateCashPayment">
        <span class="debug-btn-icon">ğŸ’µ</span>
        <span>Pago en efectivo</span>
      </button>
      <button class="debug-btn" data-action="call" data-fn="debugSimulateCardPayment">
        <span class="debug-btn-icon">ğŸ’³</span>
        <span>Pago con tarjeta</span>
      </button>
    </div>

    <!-- ğŸ§‘â€ğŸ³ Mesero y Soporte -->
    <div class="debug-section">
      <h3>ğŸ§‘â€ğŸ³ Mesero y Soporte</h3>
      <button class="debug-btn" data-action="call" data-fn="debugCallWaiter">
        <span class="debug-btn-icon">ğŸ””</span>
        <span>Llamar mesero</span>
      </button>
      <button class="debug-btn" data-action="call" data-fn="debugOpenSupport">
        <span class="debug-btn-icon">ğŸ“</span>
        <span>Abrir soporte</span>
      </button>
      <button class="debug-btn" data-action="call" data-fn="debugSubmitSupportTicket">
        <span class="debug-btn-icon">ğŸ«</span>
        <span>Enviar ticket de prueba</span>
      </button>
    </div>

    <!-- ğŸ• Horarios -->
    <div class="debug-section">
      <h3>ğŸ• Horarios</h3>
      <button class="debug-btn" data-action="call" data-fn="debugOpenHoursModal">
        <span class="debug-btn-icon">ğŸ•</span>
        <span>Ver horarios</span>
      </button>
      <button class="debug-btn" data-action="call" data-fn="debugCheckOpenStatus">
        <span class="debug-btn-icon">âœ…</span>
        <span>Verificar estado actual</span>
      </button>
    </div>

    <!-- ğŸ Promociones -->
    <div class="debug-section">
      <h3>ğŸ Promociones</h3>
      <button class="debug-btn" data-action="call" data-fn="debugViewPromotions">
        <span class="debug-btn-icon">ğŸ‰</span>
        <span>Ver promociones</span>
      </button>
      <button class="debug-btn" data-action="call" data-fn="debugCreateTestPromotion">
        <span class="debug-btn-icon">âœ¨</span>
        <span>Crear promociÃ³n test</span>
      </button>
    </div>

    <!-- ğŸ”„ SesiÃ³n -->
    <div class="debug-section">
      <h3>ğŸ”„ SesiÃ³n</h3>
      <div class="debug-btn-group">
        <button class="debug-btn" data-action="call" data-fn="debugResetSession">
          <span class="debug-btn-icon">ğŸ”„</span>
          <span>Reiniciar</span>
        </button>
        <button class="debug-btn" data-action="call" data-fn="debugClearAllData">
          <span class="debug-btn-icon">ğŸ§¹</span>
          <span>Limpiar todo</span>
        </button>
      </div>
      <button class="debug-btn" data-action="call" data-fn="debugFullDemoFlow">
        <span class="debug-btn-icon">ğŸš€</span>
        <span>ğŸš€ Demo completo</span>
      </button>
    </div>

    <!-- Status Display -->
    <div class="debug-section" style="background: #f9fafb">
      <div id="debug-main-status" class="debug-status"></div>
    </div>
  </div>
</div>

<script>
  const employeesBaseUrl = '{{ employees_base_url }}';

  // ============ CSRF FETCH WRAPPER ============
  async function csrfFetch(url, options = {}) {
    const csrfToken = document.querySelector('meta[name="csrf-token"]')?.getAttribute('content');
    const headers = { ...options.headers };
    if (csrfToken) {
      headers['X-CSRFToken'] = csrfToken;
    }
    return fetch(url, { ...options, headers, credentials: 'include' });
  }

  // ============ UTILIDADES ============
  function toggleDebugMenu() {
    const menu = document.getElementById('debug-menu');
    menu.classList.toggle('active');
    if (menu.classList.contains('active')) {
      debugRefreshAll();
    }
  }

  function showStatus(message, type = 'info', elementId = 'debug-main-status') {
    const status = document.getElementById(elementId);
    if (status) {
      status.textContent = message;
      status.className = `debug-status ${type}`;
    }
  }

  async function getMenu() {
    try {
      const res = await fetch(`/api/menu`);
      return await res.json();
    } catch (e) {
      showStatus('Error cargando menÃº', 'error');
      return null;
    }
  }

  async function getSession() {
    const id = localStorage.getItem('pronto-session-id');
    return id ? parseInt(id) : null;
  }

  // ============ AUTENTICACIÃ“N ============
  async function debugQuickLogin() {
    showStatus('Iniciando sesiÃ³n...', 'info');
    try {
      const res = await fetch(`/api/auth/login`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          email: 'debug@test.com',
          password: 'Debug123456',
        }),
      });
      const data = await res.json();
      if (res.ok) {
        localStorage.setItem('pronto-user', JSON.stringify(data.user));
        showStatus('âœ… Login exitoso', 'success');
        setTimeout(() => location.reload(), 1000);
      } else {
        showStatus('âŒ ' + data.error, 'error');
      }
    } catch (e) {
      showStatus('Error: ' + e.message, 'error');
    }
  }

  async function debugCreateUser() {
    showStatus('Creando usuario...', 'info');
    try {
      const res = await fetch(`/api/auth/register`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          name: 'Usuario Debug ' + Date.now(),
          email: `debug${Date.now()}@test.com`,
          phone: '5512345678',
          password: 'Debug123456',
        }),
      });
      const data = await res.json();
      if (res.ok) {
        showStatus('âœ… Usuario creado', 'success');
      } else {
        showStatus('âŒ ' + data.error, 'error');
      }
    } catch (e) {
      showStatus('Error: ' + e.message, 'error');
    }
  }

  function debugOpenProfile() {
    if (typeof toggleProfile === 'function') {
      toggleProfile();
      showStatus('Perfil abierto', 'success');
    } else {
      showStatus('No se encontrÃ³ funciÃ³n toggleProfile', 'error');
    }
  }

  // ============ MENÃš Y PRODUCTOS ============
  async function debugLoadFullMenu() {
    showStatus('Cargando menÃº...', 'info');
    const menu = await getMenu();
    if (menu && menu.categories) {
      showStatus(`âœ… ${menu.categories.length} categorÃ­as cargadas`, 'success');
    }
  }

  async function debugSearchProducts(query) {
    showStatus(`Buscando "${query}"...`, 'info');
    const input = document.getElementById('menu-search');
    if (input) {
      input.value = query;
      input.dispatchEvent(new Event('input', { bubbles: true }));
      showStatus(`âœ… BÃºsqueda: "${query}"`, 'success');
    } else {
      showStatus('No se encontrÃ³ campo de bÃºsqueda', 'error');
    }
  }

  async function debugFilterCategory(category) {
    showStatus(`Filtrando: ${category}`, 'info');
    const buttons = document.querySelectorAll('[data-category]');
    for (const btn of buttons) {
      if (btn.dataset.category === category) {
        btn.click();
        showStatus(`âœ… CategorÃ­a: ${category}`, 'success');
        return;
      }
    }
    showStatus('No se encontrÃ³ categorÃ­a: ' + category, 'error');
  }

  // ============ CARRITO ============
  async function debugAddRandomItems(count) {
    showStatus(`Agregando ${count} items...`, 'info');
    const menu = await getMenu();
    if (!menu || !menu.categories || menu.categories.length === 0) {
      showStatus('No hay menÃº disponible', 'error');
      return;
    }

    const items = menu.categories[0].items?.slice(0, count) || [];
    if (items.length === 0) {
      showStatus('No hay productos disponibles', 'error');
      return;
    }

    for (let i = 0; i < items.length; i++) {
      const item = items[i];
      if (typeof openItemModal === 'function') {
        openItemModal(item);
        await new Promise((r) => setTimeout(r, 200));
        if (typeof addToCartFromModal === 'function') {
          addToCartFromModal();
        }
      }
      await new Promise((r) => setTimeout(r, 300));
    }

    showStatus(`âœ… ${items.length} items agregados al carrito`, 'success');
  }

  async function debugClearCart() {
    localStorage.removeItem('pronto-cart');
    if (typeof window.updateCartBadge === 'function') {
      window.updateCartBadge();
    }
    if (typeof window.renderCartItems === 'function') {
      window.renderCartItems();
    }
    showStatus('âœ… Carrito vaciado', 'success');
  }

  async function debugApplyCoupon(code) {
    showStatus(`Aplicando cupÃ³n: ${code}`, 'info');
    showStatus('ğŸ« CupÃ³n aplicado (simulado)', 'success');
  }

  // ============ Ã“RDENES ============
  async function debugCreateOrderFromCart() {
    showStatus('Creando orden...', 'info');
    const cart = JSON.parse(localStorage.getItem('pronto-cart') || '[]');
    if (cart.length === 0) {
      showStatus('El carrito estÃ¡ vacÃ­o', 'error');
      return;
    }

    try {
      const res = await fetch(`/api/orders`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          customer: { name: 'Cliente Debug', email: 'debug@test.com', phone: '+525599999999' },
          table_number: document.getElementById('table-number')?.value || '1',
          notes: 'Orden de debug',
          items: cart.map((item) => ({ menu_item_id: item.id, quantity: item.quantity })),
        }),
      });
      const data = await res.json();
      if (res.ok) {
        localStorage.setItem('pronto-session-id', data.session_id);
        localStorage.removeItem('pronto-cart');
        showStatus(`âœ… Orden #${data.order_id} creada`, 'success');
        setTimeout(() => location.reload(), 1500);
      } else {
        showStatus('âŒ ' + data.error, 'error');
      }
    } catch (e) {
      showStatus('Error: ' + e.message, 'error');
    }
  }

  async function debugCreateQuickOrder() {
    showStatus('Creando orden rÃ¡pida...', 'info');
    try {
      const res = await fetch(`/api/orders`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          customer: { name: 'Cliente Quick', email: 'quick@test.com' },
          table_number: '1',
          items: [{ menu_item_id: 1, quantity: 2 }],
        }),
      });
      const data = await res.json();
      if (res.ok) {
        localStorage.setItem('pronto-session-id', data.session_id);
        showStatus(`âœ… Orden rÃ¡pida #${data.order_id}`, 'success');
        setTimeout(() => location.reload(), 1500);
      } else {
        showStatus('âŒ ' + data.error, 'error');
      }
    } catch (e) {
      showStatus('Error: ' + e.message, 'error');
    }
  }

  async function debugAdvanceCurrentOrder() {
    const sessionId = await getSession();
    if (!sessionId) {
      showStatus('No hay sesiÃ³n activa', 'error');
      return;
    }

    try {
      const res = await fetch(`/api/session/${sessionId}/orders`, { method: 'GET' });
      const data = await res.json();
      const activeOrder = data.orders?.find((o) => o.status !== 'delivered');
      if (activeOrder) {
        await csrfFetch(`/api/debug/orders/${activeOrder.order_id}/advance`, { method: 'POST' });
        showStatus(`âœ… Orden #${activeOrder.order_id} avanzada`, 'success');
        setTimeout(() => location.reload(), 1000);
      } else {
        showStatus('No hay Ã³rdenes activas', 'warning');
      }
    } catch (e) {
      showStatus('Error: ' + e.message, 'error');
    }
  }

  async function debugAdvanceAllOrders() {
    const sessionId = await getSession();
    if (!sessionId) {
      showStatus('No hay sesiÃ³n activa', 'error');
      return;
    }

    try {
      const res = await fetch(`/api/session/${sessionId}/orders`, { method: 'GET' });
      const data = await res.json();
      const activeOrders = data.orders?.filter((o) => o.status !== 'delivered') || [];

      if (activeOrders.length === 0) {
        showStatus('No hay Ã³rdenes activas', 'warning');
        return;
      }

      for (const order of activeOrders) {
        await csrfFetch(`/api/debug/orders/${order.order_id}/advance`, { method: 'POST' });
        await new Promise((r) => setTimeout(r, 200));
      }

      showStatus(`âœ… ${activeOrders.length} Ã³rdenes avanzadas`, 'success');
      setTimeout(() => location.reload(), 1500);
    } catch (e) {
      showStatus('Error: ' + e.message, 'error');
    }
  }

  // ============ PAGO ============
  async function debugRequestBill() {
    const sessionId = await getSession();
    if (!sessionId) {
      showStatus('No hay sesiÃ³n activa', 'error');
      return;
    }

    try {
      const res = await fetch(`/api/debug/sessions/${sessionId}/request-checkout`, {
        method: 'POST',
      });
      const data = await res.json();
      if (res.ok) {
        showStatus(`ğŸ§¾ Cuenta solicitada: $${data.total_amount?.toFixed(2) || '0.00'}`, 'success');
      } else {
        showStatus('âŒ ' + data.error, 'error');
      }
    } catch (e) {
      showStatus('Error: ' + e.message, 'error');
    }
  }

  async function debugSimulateCashPayment() {
    const sessionId = await getSession();
    if (!sessionId) {
      showStatus('No hay sesiÃ³n activa', 'error');
      return;
    }

    try {
      const res = await fetch(`/api/debug/sessions/${sessionId}/simulate-payment`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ payment_method: 'cash' }),
      });
      const data = await res.json();
      if (res.ok) {
        showStatus(`âœ… Pago en efectivo: $${data.total_amount?.toFixed(2)}`, 'success');
        localStorage.removeItem('pronto-session-id');
        setTimeout(() => (location.href = '/thank-you'), 2000);
      } else {
        showStatus('âŒ ' + data.error, 'error');
      }
    } catch (e) {
      showStatus('Error: ' + e.message, 'error');
    }
  }

  async function debugSimulateCardPayment() {
    const sessionId = await getSession();
    if (!sessionId) {
      showStatus('No hay sesiÃ³n activa', 'error');
      return;
    }

    showStatus('ğŸ’³ Redirigiendo a Stripe...', 'info');
    showStatus('ğŸ’³ Pago con tarjeta (simulado)', 'success');
  }

  // ============ MESERO Y SOPORTE ============
  async function debugCallWaiter() {
    try {
      const res = await fetch(`/api/call-waiter`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ type: 'general', table_number: '1' }),
      });
      if (res.ok) {
        showStatus('ğŸ”” Mesero llamado', 'success');
      } else {
        showStatus('Error al llamar mesero', 'error');
      }
    } catch (e) {
      showStatus('ğŸ”” Llamado (simulado)', 'success');
    }
  }

  function debugOpenSupport() {
    const btn = document.querySelector('[data-open-support]');
    if (btn) {
      btn.click();
      showStatus('Modal de soporte abierto', 'success');
    } else {
      showStatus('No se encontrÃ³ botÃ³n de soporte', 'error');
    }
  }

  async function debugSubmitSupportTicket() {
    try {
      const res = await fetch(`/api/support-tickets`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          name: 'Debug User',
          email: 'debug@test.com',
          description: 'Ticket de prueba desde debug panel',
          category: 'suggestion',
        }),
      });
      if (res.ok) {
        showStatus('ğŸ« Ticket enviado', 'success');
      } else {
        showStatus('Error enviando ticket', 'error');
      }
    } catch (e) {
      showStatus('ğŸ« Ticket enviado (simulado)', 'success');
    }
  }

  // ============ HORARIOS ============
  function debugOpenHoursModal() {
    if (typeof openBusinessHoursModal === 'function') {
      openBusinessHoursModal();
      showStatus('Modal de horarios abierto', 'success');
    } else {
      showStatus('No se encontrÃ³ funciÃ³n de horarios', 'error');
    }
  }

  async function debugCheckOpenStatus() {
    try {
      const res = await fetch(`/api/business-info`);
      const data = await res.json();
      const status = data.current_day_schedule?.is_open ? 'ABIERTO' : 'CERRADO';
      const time = data.current_day_schedule?.is_open
        ? ` â€¢ Cierra a las ${data.current_day_schedule.close_time}`
        : '';
      showStatus(
        `ğŸª Estado: ${status}${time}`,
        data.current_day_schedule?.is_open ? 'success' : 'warning'
      );
    } catch (e) {
      showStatus('Error verificando estado', 'error');
    }
  }

  // ============ PROMOCIONES ============
  async function debugViewPromotions() {
    showStatus('Cargando promociones...', 'info');
    try {
      const res = await fetch(`/api/promotions`);
      const data = await res.json();
      const count = data.promotions?.length || 0;
      showStatus(`ğŸ‰ ${count} promociones encontradas`, 'success');
    } catch (e) {
      showStatus('Error cargando promociones', 'error');
    }
  }

  async function debugCreateTestPromotion() {
    showStatus('Las promociones se crean desde panel de empleados', 'info');
    if (employeesBaseUrl) {
      showStatus(`ğŸ’¡ DirÃ­gete a ${employeesBaseUrl}/promotions`, 'info');
    } else {
      showStatus('Panel de empleados no configurado', 'warning');
    }
  }

  // ============ SESIÃ“N ============
  async function debugResetSession() {
    localStorage.removeItem('pronto-session-id');
    localStorage.removeItem('pronto-user');
    localStorage.removeItem('pronto-cart');
    showStatus('âœ… SesiÃ³n reiniciada', 'success');
    setTimeout(() => (location.href = '/'), 1000);
  }

  async function debugClearAllData() {
    localStorage.clear();
    showStatus('âœ… Todos los datosæ¸…é™¤ados', 'success');
    setTimeout(() => (location.href = '/'), 1000);
  }

  // ============ DEMO COMPLETO ============
  async function debugFullDemoFlow() {
    showStatus('ğŸš€ Iniciando demo completo...', 'info');

    try {
      // Step 1: Login
      showStatus('1/6: Autenticando...', 'info');
      await debugQuickLogin();

      // Step 2: Add items
      await new Promise((r) => setTimeout(r, 2000));
      await debugAddRandomItems(3);

      // Step 3: Create order
      await new Promise((r) => setTimeout(r, 1000));
      await debugCreateOrderFromCart();
    } catch (e) {
      showStatus('Demo completado con advertencias', 'warning');
    }
  }

  // ============ REFRESH ============
  async function debugRefreshAll() {
    const sessionId = await getSession();
    const userStr = localStorage.getItem('pronto-user');
    const user = userStr ? JSON.parse(userStr) : null;

    // Update toggle button text
    const toggleBtn = document.getElementById('debug-toggle-btn');
    if (toggleBtn) {
      if (user?.id) {
        toggleBtn.textContent = `ğŸ› ${user.id}`;
        toggleBtn.title = `Debug Mode - User: ${user.id}`;
      } else if (sessionId) {
        toggleBtn.textContent = `ğŸ› A${sessionId}`;
        toggleBtn.title = `Debug Mode - Anonymous Session: ${sessionId}`;
      } else {
        toggleBtn.textContent = 'ğŸ›';
        toggleBtn.title = 'Debug Mode';
      }
    }

    // Update status display
    if (user?.id) {
      showStatus(`Usuario: #${user.id} (${user.name || 'Sin nombre'})`, 'success');
    } else if (sessionId) {
      showStatus(`SesiÃ³n anÃ³nima: #${sessionId}`, 'info');
    } else {
      showStatus('Sin sesiÃ³n activa', 'warning');
    }
  }

  // InicializaciÃ³n
  document.addEventListener('click', (e) => {
    const panel = document.querySelector('.debug-panel');
    const menu = document.getElementById('debug-menu');
    if (menu?.classList.contains('active') && !panel?.contains(e.target)) {
      menu.classList.remove('active');
    }
  });
</script>
{% endif %}
