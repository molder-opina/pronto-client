{% extends "base.html" %} {% block content %}
<link rel="stylesheet" href="{{ assets_css_employees }}/waiter.css" />
<link rel="stylesheet" href="{{ assets_css_employees }}/waiter-pos-modern.css" />
<link rel="stylesheet" href="{{ assets_css_employees }}/tokens.css" />
<link rel="stylesheet" href="{{ assets_css_employees }}/components/cards.css" />
<link rel="stylesheet" href="{{ assets_css_employees }}/components/toast.css" />
<link rel="stylesheet" href="{{ assets_css_employees }}/components/loading.css" />
<link rel="stylesheet" href="{{ assets_css_employees }}/components/empty-state.css" />

<section
  class="section"
  id="caja"
  data-menu-title="Caja"
  data-menu-group="üè† OPERACI√ìN"
  data-cashier-root
  style="max-width: none !important; width: 100%; padding: 0"
>
  <div class="waiter-unified-header waiter-unified-header--cashier">
    <div class="waiter-unified-header__left">
      <h1 class="waiter-page-title">Operaci√≥n de caja</h1>
    </div>
    <div class="waiter-unified-header__right">
      <button
        type="button"
        class="waiter-toolbar__btn"
        onclick="
          if (window.refreshCashierOrders) window.refreshCashierOrders();
          else window.location.reload();
        "
        title="Actualizar"
      >
        üîÑ Actualizar
      </button>
    </div>
  </div>

  <div class="waiter-tabs-container">
    <div class="waiter-tabs">
      <button type="button" class="waiter-tab active" data-tab="active">
        Activas
        <span class="waiter-tab__badge is-hidden" id="cashier-active-count">0</span>
      </button>
      <button type="button" class="waiter-tab" data-tab="tracking">
        Seguimiento
        <span class="waiter-tab__badge is-hidden" id="cashier-tracking-count">0</span>
      </button>
      <button type="button" class="waiter-tab" data-tab="paid">
        Cerradas
        <span class="waiter-tab__badge is-hidden" id="cashier-paid-count">0</span>
      </button>
      <button type="button" class="waiter-tab" data-tab="cancelled">
        Canceladas
        <span class="waiter-tab__badge is-hidden" id="cashier-cancelled-count">0</span>
      </button>
    </div>
  </div>

  <div
    class="waiter-pos-container waiter-pos-container--cashier"
    style="max-width: none !important; width: 100%"
  >
    <div class="w-full bg-white border-b border-gray-200 sticky top-16 z-40">
      <div class="w-full px-4 sm:px-6 lg:px-8">
        <div class="waiter-toolbar">
          <div class="waiter-toolbar__search">
            <div class="waiter-search-box">
              <svg
                class="waiter-search-box__icon"
                viewBox="0 0 24 24"
                fill="none"
                stroke="currentColor"
                stroke-width="2"
              >
                <circle cx="11" cy="11" r="8"></circle>
                <path d="m21 21-4.35-4.35"></path>
              </svg>
              <input
                type="search"
                id="cashier-search-input"
                class="waiter-search-box__input"
                placeholder="Buscar por orden #, mesa o cliente..."
                autocomplete="off"
              />
              <span
                class="waiter-search-box__count"
                id="cashier-search-count"
                style="display: none"
              ></span>
            </div>
          </div>

          <div class="waiter-toolbar__actions">
            <button
              type="button"
              class="waiter-toolbar__btn"
              id="cashier-open-filters-btn"
              title="Filtros avanzados"
            >
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  d="M3 4a1 1 0 011-1h16a1 1 0 011 1v2.586a1 1 0 01-.293.707l-6.414 6.414a1 1 0 00-.293.707V17l-4 4v-6.586a1 1 0 00-.293-.707L3.293 7.293A1 1 0 013 6.586V4z"
                />
              </svg>
              Filtros
            </button>
            <span class="waiter-orders-count" id="cashier-orders-count">0 √≥rdenes</span>
            <div class="waiter-view-toggle" aria-label="Modo de vista de tabla">
              <button type="button" class="waiter-view-toggle__btn active" id="cashier-view-normal">
                Vista normal
              </button>
              <button type="button" class="waiter-view-toggle__btn" id="cashier-view-compact">
                Vista compacta
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Filters Modal -->
    <div class="waiter-filters-modal" id="cashier-filters-modal" style="display: none">
      <div class="waiter-filters-modal__overlay"></div>
      <div class="waiter-filters-modal__content">
        <div class="waiter-filters-modal__header">
          <h3>Filtrar √ìrdenes</h3>
          <button type="button" class="waiter-filters-modal__close" id="cashier-close-filters-btn">
            ‚úï
          </button>
        </div>

        <div class="waiter-filters-modal__body">
          <p class="modal-hint" style="grid-column: 1 / -1; margin-bottom: 1rem">
            Selecciona los filtros para ver √∫nicamente √≥rdenes en proceso de pago.
          </p>
          <div class="waiter-filters__section">
            <h4>Estados de Sesi√≥n</h4>
            <label
              ><input type="checkbox" name="cashier-session-status" value="awaiting_tip" checked />
              Esperando propina</label
            >
            <label
              ><input
                type="checkbox"
                name="cashier-session-status"
                value="awaiting_payment"
                checked
              />
              Esperando pago</label
            >
            <label
              ><input
                type="checkbox"
                name="cashier-session-status"
                value="awaiting_payment_confirmation"
                checked
              />
              Esperando confirmaci√≥n</label
            >
            <label
              ><input type="checkbox" name="cashier-session-status" value="closed" />
              Cerradas</label
            >
            <label
              ><input type="checkbox" name="cashier-session-status" value="paid" /> Pagadas</label
            >
          </div>

          <div class="waiter-filters__section">
            <h4>Estados de Orden</h4>
            <label
              ><input type="checkbox" name="cashier-workflow-status" value="delivered" checked />
              Entregado</label
            >
            <label
              ><input type="checkbox" name="cashier-workflow-status" value="ready_for_delivery" />
              Listo entrega</label
            >
            <label
              ><input type="checkbox" name="cashier-workflow-status" value="kitchen_in_progress" />
              En cocina</label
            >
            <label
              ><input type="checkbox" name="cashier-workflow-status" value="waiter_accepted" />
              Enviando a cocina</label
            >
            <label
              ><input type="checkbox" name="cashier-workflow-status" value="requested" /> Esperando
              mesero</label
            >
          </div>

          <div class="waiter-filters__section">
            <h4>Rango de fechas</h4>
            <label
              ><input type="radio" name="cashier-date-filter" value="today" checked /> Hoy</label
            >
            <label
              ><input type="radio" name="cashier-date-filter" value="last7" /> √öltimos 7 d√≠as</label
            >
            <label
              ><input type="radio" name="cashier-date-filter" value="custom" /> √öltimos
              <input
                type="number"
                id="cashier-date-filter-days"
                value="7"
                min="1"
                style="width: 70px; margin: 0 6px"
              />
              d√≠as
            </label>
            <label><input type="radio" name="cashier-date-filter" value="all" /> Todos</label>
          </div>
        </div>

        <div class="waiter-filters-modal__footer">
          <button type="button" class="btn btn--small btn--secondary" id="cashier-reset-filters">
            Resetear filtros
          </button>
          <button type="button" class="btn btn--small btn--primary" id="cashier-apply-filters-btn">
            Aplicar
          </button>
        </div>
      </div>
    </div>

    <!-- Active Orders Section -->
    <div id="cashier-active-orders-section" class="orders-section">
      <div class="w-full px-4 sm:px-6 lg:px-8 py-4">
        <div class="table-wrapper">
          <table class="orders-table">
            <thead>
              <tr>
                <th style="width: 40px">‚≠ê</th>
                <th>Orden</th>
                <th>Mesa</th>
                <th>Cliente</th>
                <th>Mesero</th>
                <th>Total</th>
                <th>Estado</th>
                <th>Acciones</th>
              </tr>
            </thead>
            <tbody id="cashier-orders">
              {% for order in cashier_orders %} {% set customer_display_name = order.customer.name
              if order.customer else 'Cliente' %}
              <tr
                data-order-id="{{ order.id }}"
                data-status="{{ order.workflow_status }}"
                data-session-id="{{ order.session_id }}"
                data-session-status="{{ order.session.status }}"
                data-table-number="{{ order.session.table_number or '' }}"
                data-customer-name="{{ customer_display_name }}"
                data-waiter-name="{{ order.waiter_name or '' }}"
              >
                <td>
                  <button
                    type="button"
                    class="star-btn"
                    data-order-id="{{ order.id }}"
                    title="Agregar a seguimiento"
                  >
                    <span class="star-icon">‚òÜ</span>
                  </button>
                </td>
                <td>#{{ order.id }}</td>
                <td>{{ order.session.table_number or 'N/A' }}</td>
                <td>{{ customer_display_name }}</td>
                <td>
                  {% if order.waiter_name %}
                  <span class="waiter-badge">üë§ {{ order.waiter_name }}</span>
                  {% else %}
                  <span class="waiter-badge waiter-badge--unassigned">‚ö†Ô∏è Sin asignar</span>
                  {% endif %}
                </td>
                <td>
                  {{ currency_symbol }}{{ "{:,.2f}".format(order.total_amount) }} {{ currency }}
                </td>
                <td>
                  <span class="status status--{{ order.workflow_status }}"
                    >{{ order.status_display or order.workflow_status }}</span
                  >
                </td>
                <td class="actions"></td>
              </tr>
              {% else %}
              <tr>
                <td colspan="8">Sin √≥rdenes activas.</td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
        <p id="cashier-feedback" class="feedback"></p>
      </div>
    </div>

    <!-- Tracking Orders Section -->
    <div id="cashier-tracking-orders-section" class="orders-section" style="display: none">
      <div class="w-full px-4 sm:px-6 lg:px-8 py-4">
        <div class="table-wrapper tracking-section">
          <table class="orders-table">
            <thead>
              <tr>
                <th style="width: 40px">‚≠ê</th>
                <th>Orden</th>
                <th>Mesa</th>
                <th>Cliente</th>
                <th>Total</th>
                <th>Estado</th>
                <th>Acciones</th>
              </tr>
            </thead>
            <tbody id="cashier-tracking-orders">
              <tr class="tracking-empty-state">
                <td colspan="7" style="text-align: center; padding: 1.5rem">
                  <div style="font-size: 1.5rem; margin-bottom: 0.5rem">‚≠ê</div>
                  <p style="margin: 0">No tienes √≥rdenes en seguimiento</p>
                  <small style="color: #64748b"
                    >Usa la estrella para fijar √≥rdenes importantes.</small
                  >
                </td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>

    <!-- Paid Orders Section -->
    <div id="cashier-paid-orders-section" class="orders-section" style="display: none">
      <div class="w-full px-4 sm:px-6 lg:px-8 py-4">
        <div class="table-wrapper">
          <table class="orders-table">
            <thead>
              <tr>
                <th>Sesi√≥n</th>
                <th>Mesa</th>
                <th>Cliente</th>
                <th>Total</th>
                <th>√ìrdenes</th>
                <th>M√©todo</th>
                <th>Cerrada</th>
                <th>Acciones</th>
              </tr>
            </thead>
            <tbody id="cashier-paid-sessions">
              <tr>
                <td colspan="8" style="text-align: center; padding: 3rem">
                  <div class="loading-state">
                    <div class="spinner spinner--medium" style="margin: 0 auto 1rem"></div>
                    <p style="color: var(--color-gray-500); margin: 0">
                      Cargando sesiones cerradas...
                    </p>
                  </div>
                </td>
              </tr>
            </tbody>
          </table>
        </div>
        <p id="cashier-paid-feedback" class="feedback"></p>
      </div>
    </div>

    <!-- Cancelled Orders Section -->
    <div id="cashier-cancelled-orders-section" class="orders-section" style="display: none">
      <div class="w-full px-4 sm:px-6 lg:px-8 py-4">
        <div class="table-wrapper">
          <table class="orders-table">
            <thead>
              <tr>
                <th>Orden</th>
                <th>Mesa</th>
                <th>Cliente</th>
                <th>Total</th>
                <th>Cancelada</th>
                <th>Motivo</th>
              </tr>
            </thead>
            <tbody id="cashier-cancelled-orders">
              <tr class="cancelled-empty-state">
                <td colspan="6" style="text-align: center; padding: 1.5rem; color: #64748b">
                  No hay √≥rdenes canceladas.
                </td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </div>
</section>

{% endblock %}
