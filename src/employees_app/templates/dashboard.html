{% extends "base.html" %}
{% block content %}
{# JWT auth is validated by ScopeGuard before this template is rendered #}
{# The employee_id and employee_role are passed from the route handler #}
{% if not employee_id %}
{% set should_redirect = True %}
<script>
  console.warn('[SERVER-SIDE AUTH] No employee_id in context - ScopeGuard should have redirected');
  window.location.href = "/";
</script>
{% else %}
{% set should_redirect = False %}
{% endif %}

<link rel="stylesheet" href="{{ assets_css_employees }}/waiter.css" />
<link rel="stylesheet" href="{{ assets_css_employees }}/waiter-pos-modern.css" />
<link rel="stylesheet" href="{{ assets_css_employees }}/reports.css" />
<!-- New Design System Components -->
<link rel="stylesheet" href="{{ assets_css_employees }}/tokens.css" />
<link rel="stylesheet" href="{{ assets_css_employees }}/components/cards.css" />
<link rel="stylesheet" href="{{ assets_css_employees }}/components/toast.css" />
<link rel="stylesheet" href="{{ assets_css_employees }}/components/loading.css" />
<link rel="stylesheet" href="{{ assets_css_employees }}/components/empty-state.css" />
<link rel="stylesheet" href="{{ assets_css_employees }}/components/panel-upgrades.css" />
<link rel="stylesheet" href="{{ assets_css_employees }}/components/aditamentos.css" />
{% if has_permission(Permission.ORDERS_VIEW) %}
<!-- Global notifications panel for waiter calls -->
<div class="notifications-panel" id="notifications-panel" style="display: none">
  <div class="notifications-panel__header">
    <h3>üîî Llamadas de clientes</h3>
    <div class="notifications-panel__actions">
      {% if has_permission(Permission.EMPLOYEES_VIEW) %}
      <button type="button" class="notifications-panel__clear" id="clear-notifications-btn">
        üßπ Limpiar
      </button>
      {% endif %}
      <button class="notifications-panel__close" onclick="window.EmployeeBell.toggleNotificationsPanel()">
        ‚úï
      </button>
    </div>
  </div>
  <div class="notifications-panel__content" id="notifications-content">
    <p class="notifications-empty">No hay llamadas pendientes</p>
  </div>
</div>

<script>
  document.addEventListener('DOMContentLoaded', () => {
    const clearBtn = document.getElementById('clear-notifications-btn');
    if (!clearBtn) return;

    clearBtn.addEventListener('click', async () => {
      if (clearBtn.disabled) return;
      const originalLabel = clearBtn.textContent || 'üßπ Limpiar';
      clearBtn.disabled = true;
      clearBtn.textContent = 'Limpiando...';

      try {
        const response = await fetch('/api/notifications/clear', {
          method: 'POST',
          credentials: 'include',
        });
        const data = await response.json().catch(() => ({}));
        if (!response.ok) {
          throw new Error(
            data.error || data.message || 'No se pudieron limpiar las notificaciones'
          );
        }

        const content = document.getElementById('notifications-content');
        if (content) {
          content.innerHTML = '<p class="notifications-empty">No hay llamadas pendientes</p>';
        }

        if (window.WaiterPanel?.clearPendingCalls) {
          window.WaiterPanel.clearPendingCalls();
        }
        if (window.EmployeeBell) {
          window.EmployeeBell.setCount(0);
          window.EmployeeBell.setState('idle');
        }
      } catch (error) {
        console.error('[Notificaciones] Error al limpiar notificaciones', error);
        clearBtn.textContent = 'Reintentar';
      } finally {
        setTimeout(() => {
          clearBtn.disabled = false;
          if (
            !clearBtn.textContent ||
            clearBtn.textContent === 'Limpiando...' ||
            clearBtn.textContent === 'Reintentar'
          ) {
            clearBtn.textContent = originalLabel;
          }
        }, 400);
      }
    });
  });
</script>

{% endif %}
{% if has_permission(Permission.ORDERS_VIEW) and app_context|lower != 'cashier' %}
<section class="section" id="panel-meseros" data-menu-title="Meseros" data-menu-group="OPERACI√ìN"
  data-icon="clipboard-list" {{ 'data-cashier-root' if app_context=='cashier' else 'data-waiter-root' }}
  style="max-width: none !important; width: 100%; padding: 0">
  <!-- Unified Header: 50/50 Split Layout -->
  <div class="waiter-unified-header">
    <!-- Left Half: Title -->
    <div class="waiter-unified-header__left">
      <h1 class="waiter-page-title">√ìrdenes en Curso</h1>
    </div>

    <!-- Right Half: Designated Tables Area -->
    {% if has_permission(Permission.ORDERS_VIEW) %}
    <div class="waiter-unified-header__right">
      <div class="designated-tables-area">
        <div id="header-tables-badges" class="tables-badges-container">
          <!-- Table badges will be populated by JavaScript -->
        </div>
        <button type="button" id="open-table-assignment" class="btn-add-table" title="Asignar mesas">
          +
        </button>
      </div>
    </div>

    <!-- Hidden supervisor call button -->
    <button type="button" class="btn btn--primary" id="call-supervisor-btn" style="display: none">
      Llamar Supervisor
    </button>
    <div class="supervisor-call-status" id="supervisor-call-status" style="display: none">
      <span class="supervisor-call-status__label">√öltima solicitud</span>
      <p class="supervisor-call-status__details" id="supervisor-call-status-details"></p>
    </div>
    {% endif %}
  </div>

  <!-- Border Bottom Tabs -->
  <div class="waiter-tabs-container">
    <div class="waiter-tabs">
      <button type="button" class="waiter-tab active" data-tab="active">
        Activas
        <span class="waiter-tab__badge is-hidden" id="active-count">0</span>
      </button>
      <button type="button" class="waiter-tab" data-tab="tracking">
        Seguimiento
        <span class="waiter-tab__badge is-hidden" id="tracking-count">0</span>
      </button>
      <button type="button" class="waiter-tab" data-tab="paid">
        Pagadas
        <span class="waiter-tab__badge is-hidden" id="paid-count">0</span>
      </button>
      <button type="button" class="waiter-tab" data-tab="cancelled">
        Canceladas
        <span class="waiter-tab__badge is-hidden" id="cancelled-count">0</span>
      </button>
    </div>
  </div>

  <!-- Main Content Container -->
  <div class="waiter-pos-container" style="max-width: none !important; width: 100%">
    <!-- Filter Bar: Full Width with Master Container -->
    <div class="w-full bg-white border-b border-gray-200 sticky top-16 z-40">
      <div class="w-full px-4 sm:px-6 lg:px-8">
        <div class="waiter-toolbar">
          <div class="waiter-toolbar__tabs" style="display: none">
            <button type="button" class="waiter-tab active" data-tab="active">
              üìã √ìrdenes activas
            </button>
            <button type="button" class="waiter-tab" data-tab="tracking">
              ‚≠ê Seguimiento <span class="waiter-tab__badge" id="tracking-count-old">0</span>
            </button>
            <button type="button" class="waiter-tab" data-tab="paid">‚úÖ √ìrdenes pagadas</button>
            <button type="button" class="waiter-tab" data-tab="cancelled">‚ùå Canceladas</button>
          </div>

          <div class="waiter-toolbar__search">
            <div class="waiter-search-box">
              <svg class="waiter-search-box__icon" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                stroke-width="2">
                <circle cx="11" cy="11" r="8"></circle>
                <path d="m21 21-4.35-4.35"></path>
              </svg>
              <input type="search" id="order-search-input" class="waiter-search-box__input"
                placeholder="Buscar por orden #, mesa o cliente..." autocomplete="off" />
              <span class="waiter-search-box__count" id="order-search-count" style="display: none"></span>
            </div>
          </div>

          <div class="waiter-toolbar__actions">
            <button type="button" class="waiter-toolbar__btn" id="open-filters-btn" title="Filtros avanzados">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path stroke-linecap="round" stroke-linejoin="round"
                  d="M3 4a1 1 0 011-1h16a1 1 0 011 1v2.586a1 1 0 01-.293.707l-6.414 6.414a1 1 0 00-.293.707V17l-4 4v-6.586a1 1 0 00-.293-.707L3.293 7.293A1 1 0 013 6.586V4z" />
              </svg>
              Filtros
            </button>
            <span class="waiter-orders-count">0 √≥rdenes</span>
            <div class="waiter-view-toggle" aria-label="Modo de vista de tabla">
              <button type="button" class="waiter-view-toggle__btn active" id="waiter-view-normal">
                Vista normal
              </button>
              <button type="button" class="waiter-view-toggle__btn" id="waiter-view-compact">
                Vista compacta
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Filters Modal (Hidden by default) - Available for all tabs -->
    <div class="waiter-filters-modal" id="waiter-filters-modal" style="display: none">
      <div class="waiter-filters-modal__overlay"></div>
      <div class="waiter-filters-modal__content">
        <div class="waiter-filters-modal__header">
          <h3>Filtrar √ìrdenes</h3>
          <button type="button" class="waiter-filters-modal__close" id="close-filters-btn">
            ‚úï
          </button>
        </div>

        <div class="waiter-filters-modal__body">
          <p class="modal-hint" style="grid-column: 1 / -1; margin-bottom: 1rem">
            Por favor selecciona los filtros que deseas aplicar para ver las √≥rdenes:
          </p>
          <div class="waiter-filters__section">
            <h4>Vista de √ìrdenes</h4>
            <label><input type="checkbox" id="filter-my-orders" checked /> Mis √≥rdenes</label>
            <label><input type="checkbox" id="filter-unassigned-orders" checked /> Sin asignar</label>
          </div>

          <div class="waiter-filters__section">
            <h4>Estados de Sesi√≥n</h4>
            <label><input type="checkbox" name="session-status" value="open" checked /> Abiertas</label>
            <label><input type="checkbox" name="session-status" value="awaiting_tip" checked />
              Esperando propina</label>
            <label><input type="checkbox" name="session-status" value="awaiting_payment" checked />
              Esperando pago</label>
            <label><input type="checkbox" name="session-status" value="awaiting_payment_confirmation" checked />
              Esperando confirmaci√≥n</label>
            <label><input type="checkbox" name="session-status" value="closed" /> Cerradas</label>
          </div>

          <div class="waiter-filters__section">
            <h4>Estados de Orden</h4>
            <label><input type="checkbox" name="workflow-status" value="new" checked />
              Esperando mesero</label>
            <label><input type="checkbox" name="workflow-status" value="queued" checked />
              Enviando a cocina</label>
            <label><input type="checkbox" name="workflow-status" value="preparing" checked />
              En cocina</label>
            <label><input type="checkbox" name="workflow-status" value="ready" checked />
              Listo entrega</label>
            <label><input type="checkbox" name="workflow-status" value="delivered" checked />
              Entregado</label>
          </div>

          <div class="waiter-filters__section">
            <h4>Rango de fechas</h4>
            <label><input type="radio" name="date-filter" value="today" checked /> Hoy</label>
            <label><input type="radio" name="date-filter" value="last7" /> √öltimos 7 d√≠as</label>
            <label><input type="radio" name="date-filter" value="custom" /> √öltimos
              <input type="number" id="date-filter-days" value="7" min="1" style="width: 70px; margin: 0 6px" />
              d√≠as
            </label>
            <label><input type="radio" name="date-filter" value="all" /> Todos</label>
          </div>
        </div>

        <div class="waiter-filters-modal__footer">
          <button type="button" class="btn btn--small btn--secondary" id="reset-filters">
            Resetear filtros
          </button>
          <button type="button" class="btn btn--small btn--primary" id="apply-filters-btn">
            Aplicar
          </button>
        </div>
      </div>
    </div>

    <!-- Kitchen Filters Modal (Hidden by default) -->
    <div class="waiter-filters-modal" id="kitchen-filters-modal" style="display: none">
      <div class="waiter-filters-modal__overlay"></div>
      <div class="waiter-filters-modal__content">
        <div class="waiter-filters-modal__header">
          <h3>Filtrar √ìrdenes de Cocina</h3>
          <button type="button" class="waiter-filters-modal__close" id="kitchen-close-filters-btn">
            ‚úï
          </button>
        </div>

        <div class="waiter-filters-modal__body">
          <div class="waiter-filters__section">
            <h4>Vista de √ìrdenes</h4>
            <label><input type="checkbox" id="kitchen-filter-my-orders" checked /> Mis √≥rdenes</label>
            <label><input type="checkbox" id="kitchen-filter-all-orders" checked /> Todas las
              √≥rdenes</label>
          </div>

          <div class="waiter-filters__section">
            <h4>Estados de Orden</h4>
            <label><input type="checkbox" name="kitchen-workflow-status" value="new" checked />
              Esperando mesero</label>
            <label><input type="checkbox" name="kitchen-workflow-status" value="queued" checked />
              Enviando a cocina</label>
            <label><input type="checkbox" name="kitchen-workflow-status" value="preparing" checked />
              En cocina</label>
            <label><input type="checkbox" name="kitchen-workflow-status" value="ready" checked />
              Listo entrega</label>
            <label><input type="checkbox" name="kitchen-workflow-status" value="delivered" checked />
              Entregado</label>
          </div>

          <div class="waiter-filters__section">
            <h4>Rango de fechas</h4>
            <label><input type="radio" name="kitchen-date-filter" value="today" checked /> Hoy</label>
            <label><input type="radio" name="kitchen-date-filter" value="last7" /> √öltimos 7 d√≠as</label>
            <label>
              <input type="radio" name="kitchen-date-filter" value="custom" /> √öltimos
              <input type="number" id="kitchen-date-filter-days" value="7" min="1" style="width: 70px; margin: 0 6px" />
              d√≠as
            </label>
            <label><input type="radio" name="kitchen-date-filter" value="all" /> Todos</label>
          </div>
        </div>

        <div class="waiter-filters-modal__footer">
          <button type="button" class="btn btn--small btn--secondary" id="kitchen-reset-filters">
            Resetear filtros
          </button>
          <button type="button" class="btn btn--small btn--primary" id="kitchen-apply-filters-btn">
            Aplicar
          </button>
        </div>
      </div>
    </div>

    <!-- Active Orders Section -->

    <div id="active-orders-section" class="orders-section">
      <div class="w-full px-4 sm:px-6 lg:px-8 py-4">
        <!-- Table View (Only View) -->
        <div class="table-wrapper">
          <table class="orders-table" data-testid="orders-table">
            <thead>
              <tr>
                <th style="width: 40px">‚≠ê</th>
                <th>Orden</th>
                <th>Mesa</th>
                <th>Cliente</th>
                <th>Mesero</th>
                <th>Total</th>
                <th>Estado</th>
                <th>Notas</th>
                <th>Acciones</th>
                <th style="width: 60px"></th>
              </tr>
            </thead>
            <tbody id="waiter-orders">
              {% for order in waiter_orders %} {% set customer_name = order.customer.name if
              order.customer else '' %} {% set raw_customer_email = (order.customer.email or '')
              if order.customer else '' %} {% if raw_customer_email and
              raw_customer_email.startswith('anonimo+') %} {% set raw_customer_email = '' %} {%
              endif %} {% set order_email = order.customer_email or '' %} {% if order_email and
              order_email.startswith('anonimo+') %} {% set order_email = '' %} {% endif %} {% set
              customer_email = raw_customer_email or order_email %} {% set customer_name_upper =
              (customer_name or '')|upper %}
              {% if customer_email and (not customer_name or customer_name_upper in ['INVITADO',
              'CLIENTE ANONIMO', 'CLIENTE AN√ìNIMO', 'ANONIMO', 'AN√ìNIMO', 'CLIENTE']) %} {% set
              customer_display_name = customer_email %} {% elif customer_name %} {% set
              customer_display_name = customer_name %} {% else %} {% set customer_display_name =
              'Cliente' %} {% endif %}
              <tr data-order-id="{{ order.id }}" data-status="{{ order.workflow_status }}"
                data-session-id="{{ order.session_id }}" data-session-status="{{ order.session.status }}"
                data-paid-at="{{ order.session.closed_at if order.session.closed_at else '' }}"
                data-created-at="{{ order.created_at }}" data-session-opened="{{ order.session.opened_at }}"
                data-table-number="{{ order.session.table_number or '' }}"
                data-customer-id="{{ order.customer.id if order.customer else '' }}"
                data-customer-name="{{ customer_display_name }}" data-customer-email="{{ customer_email }}"
                data-customer-phone="{{ order.customer.phone if order.customer else '' }}"
                data-customer-description="{{ (order.customer.physical_description or '')|e if order.customer else '' }}"
                data-customer-avatar="{{ order.customer.avatar if order.customer else '' }}"
                data-waiter-name="{{ order.waiter_name or '' }}" data-waiter-id="{{ order.waiter_id or '' }}"
                data-chef-id="{{ order.chef_id or '' }}" data-notes="{{ (order.session.notes or '')|e }}"
                data-waiter-notes="{{ (order.waiter_notes or '')|e }}">
                <td>
                  <button type="button" class="star-btn" data-order-id="{{ order.id }}" title="Agregar a seguimiento">
                    <span class="star-icon">‚òÜ</span>
                  </button>
                </td>
                <td>
                  <button type="button" class="order-id-link" style="
                      background: none;
                      border: none;
                      color: #3b82f6;
                      font-weight: 600;
                      cursor: pointer;
                      text-decoration: underline;
                      padding: 0;
                    " data-order-detail="{{ order.id }}" data-table-number="{{ order.session.table_number or '' }}"
                    data-customer-name="{{ customer_display_name }}" data-customer-email="{{ customer_email }}"
                    data-customer-phone="{{ order.customer.phone if order.customer else '' }}"
                    data-notes="{{ (order.session.notes or '')|e }}"
                    data-waiter-notes="{{ (order.waiter_notes or '')|e }}" data-status="{{ order.workflow_status }}"
                    data-total="{{ order.total_amount }}">
                    #{{ order.id }}
                  </button>
                </td>
                <td>
                  <button type="button" class="table-number-link" style="
                      background: none;
                      border: none;
                      color: #ea580c;
                      font-weight: 600;
                      cursor: pointer;
                      text-decoration: underline;
                      padding: 0;
                    " data-table-info="{{ order.session.table_number or '' }}"
                    data-table-number="{{ order.session.table_number or '' }}">
                    <svg viewBox="0 0 24 24" fill="none" aria-hidden="true" style="width: 16px; height: 16px">
                      <path d="M4 10h16" stroke="currentColor" stroke-width="2" stroke-linecap="round"></path>
                      <path d="M6 10v10" stroke="currentColor" stroke-width="2" stroke-linecap="round"></path>
                      <path d="M18 10v10" stroke="currentColor" stroke-width="2" stroke-linecap="round"></path>
                      <path d="M8 6h8" stroke="currentColor" stroke-width="2" stroke-linecap="round"></path>
                      <path d="M7 6V4h10v2" stroke="currentColor" stroke-width="2" stroke-linecap="round"></path>
                    </svg>
                    {{ order.session.table_number or 'N/A' }}
                  </button>
                </td>
                <td>{{ customer_display_name }}</td>
                <td>
                  {% if order.waiter_name %}
                  <span class="waiter-badge">üë§ {{ order.waiter_name }}</span>
                  {% else %}
                  <span class="waiter-badge waiter-badge--unassigned">‚ö†Ô∏è Sin asignar</span>
                  {% endif %}
                </td>
                <td>
                  <span class="order-total-display">
                    {{ currency_symbol }}{{ "{:,.2f}".format(order.total_amount) }} {{ currency }}
                  </span>
                </td>
                <td>
                  <span class="status status--{{ order.workflow_status }}">{{ order.workflow_status }}</span>
                </td>
                <td class="order-notes">
                  <div class="waiter-note-inline flex items-center gap-2 flex-wrap">
                    <p class="waiter-note-title">Notas de mesero</p>
                    {% if order.session.notes %}
                    <div
                      class="waiter-note-pill text-xs text-gray-600 bg-gray-50 px-2 py-1 rounded border border-gray-100 flex items-center gap-1"
                      title="{{ order.session.notes }}">
                      <span class="select-none">üë§</span>
                      <span class="truncate max-w-[150px]">{{ order.session.notes }}</span>
                    </div>
                    {% endif %}
                    <div class="relative flex-1 min-w-[170px]">
                      <textarea id="waiter-note-{{ order.id }}" data-order-note="{{ order.id }}"
                        class="waiter-note-input w-full text-sm px-3 rounded-md border border-gray-200 focus:border-orange-500 focus:ring-1 focus:ring-orange-500 resize-none transition-all placeholder-gray-400 bg-white"
                        rows="1" placeholder="Nota...">
{{ order.waiter_notes or '' }}</textarea>
                    </div>
                  </div>
                </td>
                <td class="actions"></td>
                <td class="cancel-action"></td>
              </tr>
              {% endfor %} {% if waiter_orders|length == 0 %}
              <tr class="orders-empty-row">
                <td colspan="10">
                  <div class="orders-empty orders-empty--center" role="status" aria-live="polite">
                    <div class="orders-empty__illustration" aria-hidden="true">
                      <svg viewBox="0 0 64 64" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <circle cx="32" cy="32" r="26" opacity="0.25"></circle>
                        <path d="M20 36a12 12 0 0 1 24 0"></path>
                        <path d="M18 40h28"></path>
                        <path d="M24 24c0-2.2 1.8-4 4-4"></path>
                        <path d="M36 20c2.2 0 4 1.8 4 4"></path>
                        <path d="M30 18h4"></path>
                        <path d="M12 44h40"></path>
                      </svg>
                    </div>
                    <div class="orders-empty__title">¬°Todo al d√≠a!</div>
                    <div class="orders-empty__text">
                      No hay pedidos pendientes. Mantente atento: las nuevas √≥rdenes aparecer√°n
                      aqu√≠.
                    </div>
                  </div>
                </td>
              </tr>
              {% endif %}
              <tr class="orders-filter-empty" data-filter-empty-for="waiter" style="display: none">
                <td colspan="10">No encontramos √≥rdenes que coincidan con tu b√∫squeda.</td>
              </tr>
            </tbody>
          </table>
        </div>
        <p id="waiter-feedback" class="feedback"></p>
      </div>
    </div>

    <!-- Tracking Orders Section (Starred/Favorites) -->
    <div id="tracking-orders-section" class="orders-section" style="display: none">
      <div class="w-full px-2 sm:px-3 lg:px-4 py-4">
        <div class="waiter-header" style="display: none">
          <div class="waiter-header__left">
            <h3>‚≠ê √ìrdenes en Seguimiento</h3>
            <span class="tracking-orders-count">0 √≥rdenes</span>
          </div>
        </div>

        <!-- Table View (Only View) -->
        <div class="table-wrapper">
          <table class="orders-table">
            <thead>
              <tr>
                <th style="width: 40px">‚≠ê</th>
                <th>Orden</th>
                <th>Mesa</th>
                <th>Cliente</th>
                <th>Mesero</th>
                <th>Total</th>
                <th>Estado</th>
                <th>Acciones</th>
                <th style="width: 60px"></th>
              </tr>
            </thead>
            <tbody id="tracking-orders">
              <tr class="tracking-empty-state">
                <td colspan="9" style="text-align: center; padding: 2rem; color: #64748b">
                  <div style="font-size: 1.5rem; margin-bottom: 0.5rem">‚≠ê</div>
                  <p style="margin: 0">No tienes √≥rdenes en seguimiento</p>
                  <p style="margin: 0.5rem 0 0; font-size: 0.9rem">
                    Haz clic en la estrella ‚òÜ de cualquier orden para agregarla aqu√≠
                  </p>
                </td>
              </tr>
            </tbody>
          </table>
        </div>
        <p id="tracking-feedback" class="feedback"></p>
      </div>
    </div>

    <!-- Paid Orders Section -->
    <div id="paid-orders-section" class="orders-section" style="display: none">
      <div class="w-full px-2 sm:px-3 lg:px-4 py-4">
        <!-- Table View (Only View) -->
        <div class="table-wrapper">
          <table class="orders-table">
            <thead>
              <tr>
                <th>Orden</th>
                <th>Mesa</th>
                <th>Cliente</th>
                <th>Mesero</th>
                <th>Total</th>
                <th>M√©todo de pago</th>
                <th>Pagado hace</th>
                <th>Acciones</th>
              </tr>
            </thead>
            <tbody id="paid-sessions">
              <tr>
                <td colspan="8" style="text-align: center; padding: 3rem;">
                  <div class="loading-state">
                    <div class="spinner spinner--medium" style="margin: 0 auto 1rem;"></div>
                    <p style="color: var(--color-gray-500); margin: 0;">Cargando sesiones pagadas...</p>
                  </div>
                </td>
              </tr>
            </tbody>
          </table>
        </div>
        <p id="paid-feedback" class="feedback"></p>
      </div>
    </div>

    <!-- Cancelled Orders Section (hidden by default; shown only on its tab) -->
    <div id="cancelled-orders-section" class="orders-section" style="display: none">
      <div class="w-full px-2 sm:px-3 lg:px-4 py-4">
        <div class="waiter-header" style="display: none">
          <div class="waiter-header__left">
            <h3>‚ùå √ìrdenes Canceladas</h3>
            <span class="cancelled-orders-count">0 √≥rdenes</span>
          </div>
        </div>

        <!-- Table View (Only View) -->
        <div class="table-wrapper">
          <table class="orders-table">
            <thead>
              <tr>
                <th>Orden</th>
                <th>Mesa</th>
                <th>Cliente</th>
                <th>Mesero</th>
                <th>Total</th>
                <th>Motivo</th>
                <th>Fecha</th>
              </tr>
            </thead>
            <tbody id="cancelled-orders">
              <!-- Rendered dynamically by JavaScript -->
            </tbody>
          </table>
        </div>
        <p id="cancelled-feedback" class="feedback"></p>
      </div>
    </div>

    <div class="floating-panel" id="order-floating-panel" style="display: none">
      <div class="floating-panel__overlay" data-close-floating></div>
      <div class="floating-panel__content">
        <div class="floating-panel__header">
          <div>
            <p class="floating-panel__eyebrow" id="floating-panel-subtitle"></p>
            <h3 class="floating-panel__title" id="floating-panel-title"></h3>
          </div>
          <button type="button" class="floating-panel__close" data-close-floating aria-label="Cerrar panel">
            ‚úï
          </button>
        </div>
        <div class="floating-panel__body" id="floating-panel-body"></div>
      </div>
    </div>

    <!-- Partial Delivery Modal -->
    <div id="partial-delivery-modal" class="partial-delivery-modal" style="display: none">
      <div class="partial-delivery-modal__overlay"></div>
      <div class="partial-delivery-modal__content">
        <div class="partial-delivery-modal__header">
          <h3>Entrega Parcial - Orden #<span id="partial-delivery-order-number"></span></h3>
          <button type="button" class="partial-delivery-close" aria-label="Cerrar">‚úï</button>
        </div>
        <div class="partial-delivery-modal__body">
          <p class="partial-delivery-modal__hint">
            Selecciona los items que vas a entregar ahora. Los items ya entregados aparecen en
            verde.
          </p>
          <div id="partial-delivery-items" class="partial-delivery-items"></div>
          <div id="partial-delivery-progress" class="partial-delivery-progress"></div>
        </div>
        <div class="partial-delivery-modal__footer">
          <button type="button" id="cancel-partial-delivery" class="btn btn--secondary">
            Cancelar
          </button>
          <button type="button" id="confirm-partial-delivery" class="btn btn--primary">
            ‚úì Confirmar Entrega
          </button>
        </div>
      </div>
    </div>

    <!-- Cancel Order Modal -->
    <div id="cancel-order-modal" class="partial-delivery-modal" style="display: none">
      <div class="partial-delivery-modal__overlay"></div>
      <div class="partial-delivery-modal__content">
        <div class="partial-delivery-modal__header">
          <h3>Cancelar Orden #<span id="cancel-order-number"></span></h3>
          <button type="button" class="cancel-order-close" aria-label="Cerrar">‚úï</button>
        </div>
        <div class="partial-delivery-modal__body">
          <p class="partial-delivery-modal__hint">Por favor indica el motivo de la cancelaci√≥n:</p>
          <textarea id="cancel-order-reason" class="cancel-order-reason"
            placeholder="Ej. Cliente cambi√≥ de opini√≥n, error en la orden, etc." rows="4" style="
              width: 100%;
              padding: 0.75rem;
              border: 1px solid #e2e8f0;
              border-radius: 4px;
              font-family: inherit;
              font-size: 0.95rem;
              resize: vertical;
            "></textarea>
        </div>
        <div class="partial-delivery-modal__footer">
          <button type="button" id="cancel-order-modal-close" class="btn btn--secondary">
            Cerrar
          </button>
          <button type="button" id="confirm-cancel-order" class="btn btn--danger">
            ‚ùå Confirmar Cancelaci√≥n
          </button>
        </div>
      </div>
    </div>
  </div>
  <!-- Close waiter-pos-container -->

  <!-- Hidden legacy header for compatibility -->
  <header class="section__header" style="display: none">
    <div style="flex: 1">
      <h2>üç¥ Operaci√≥n de meseros</h2>
      <p>Acepta pedidos, entr√©galos cuando est√©n listos. Para cobrar, redirige al cajero.</p>
    </div>
    <button type="button" class="btn-refresh" onclick="
        if (window.refreshWaiterOrders) window.refreshWaiterOrders();
        else window.location.reload();
      " title="Actualizar">
      üîÑ
    </button>
  </header>
</section>
{% if has_permission(Permission.PAYMENTS_VIEW) and app_context|lower != 'cashier' %}
<section class="section" id="session-management" data-menu-title="Sesiones An√≥nimas" style="display: none">
  <header class="section__header">
    <div style="flex: 1">
      <h2>üìã Gesti√≥n de Sesiones</h2>
      <p>
        Administra todas las sesiones activas del restaurante. Limpia sesiones duplicadas o sin
        actividad.
      </p>
    </div>
    <div style="display: flex; gap: 0.75rem; align-items: center; flex-wrap: wrap">
      <label style="
          display: flex;
          align-items: center;
          gap: 0.5rem;
          cursor: pointer;
          user-select: none;
          font-size: 0.9rem;
          color: #475569;
        ">
        <input type="checkbox" id="filter-signed-in-sessions" style="width: 1.1em; height: 1.1em; cursor: pointer" />
        <span>Solo usuarios firmados</span>
      </label>
      <button type="button" class="btn btn--warning" id="clean-inactive-sessions-btn"
        title="Eliminar sesiones an√≥nimas sin √≥rdenes o mayores a 24 horas"
        style="display: inline-flex; align-items: center; gap: 0.5rem;">
        üßπ Limpiar Inactivas
      </button>
      <button type="button" class="btn btn--danger" id="clean-all-sessions-btn"
        title="Eliminar TODAS las sesiones (usar con precauci√≥n)"
        style="display: inline-flex; align-items: center; gap: 0.5rem;">
        üóëÔ∏è Limpiar Todas
      </button>
      <button type="button" class="btn btn--secondary" id="refresh-sessions-btn" title="Actualizar">
        üîÑ Actualizar
      </button>
    </div>
  </header>

  <div class="session-management">
    <div class="table-wrapper">
      <table class="orders-table">
        <thead>
          <tr>
            <th>ID</th>
            <th>Mesa</th>
            <th>Cliente</th>
            <th>Estado</th>
            <th>√ìrdenes Activas</th>
            <th>Iniciada</th>
            <th>√öltima Orden</th>
            <th>Total</th>
            <th>Acciones</th>
          </tr>
        </thead>
        <tbody id="sessions-table-body">
          <tr>
            <td colspan="9" style="text-align: center; padding: 3rem;">
              <div class="loading-state">
                <div class="spinner spinner--medium" style="margin: 0 auto 1rem;"></div>
                <p style="color: var(--color-gray-500); margin: 0;">Cargando sesiones...</p>
              </div>
            </td>
          </tr>
        </tbody>
      </table>
    </div>
    <p id="sessions-feedback" class="feedback"></p>
  </div>
</section>

<script>
  (function () {
    let sessionsData = [];

    function formatDateTime(isoString) {
      if (!isoString) return 'N/A';
      const date = new Date(isoString);
      const now = new Date();
      const diffMs = now - date;
      const diffMins = Math.floor(diffMs / 60000);
      const diffHours = Math.floor(diffMins / 60);
      const diffDays = Math.floor(diffHours / 24);

      if (diffMins < 1) return 'Ahora';
      if (diffMins < 60) return `Hace ${diffMins} min`;
      if (diffHours < 24) return `Hace ${diffHours} h`;
      if (diffDays === 1) return 'Ayer';
      return `Hace ${diffDays} d√≠as`;
    }

    function formatCurrency(amount) {
      return new Intl.NumberFormat('es-MX', {
        style: 'currency',
        currency: 'MXN',
      }).format(amount || 0);
    }

    function getStatusBadge(status) {
      const statusMap = {
        open: { label: 'Abierta', class: 'success' },
        awaiting_tip: { label: 'Esperando propina', class: 'warning' },
        awaiting_payment: { label: 'Esperando pago', class: 'warning' },
        awaiting_payment_confirmation: { label: 'Confirmando pago', class: 'warning' },
        closed: { label: 'Cerrada', class: 'info' },
        paid: { label: 'Pagada', class: 'success' },
      };
      const config = statusMap[status] || { label: status, class: 'default' };
      return `<span class="badge badge--${config.class}">${config.label}</span>`;
    }

    async function loadSessions() {
      const tableBody = document.getElementById('sessions-table-body');
      if (!tableBody) return;
      const feedback = document.getElementById('sessions-feedback');

      try {
        tableBody.innerHTML =
          `<tr><td colspan="9" style="text-align: center; padding: 3rem;">
            <div class="loading-state">
              <div class="spinner spinner--medium" style="margin: 0 auto 1rem;"></div>
              <p style="color: var(--color-gray-500); margin: 0;">Cargando sesiones...</p>
            </div>
          </td></tr>`;

        const response = await fetch('/api/sessions/all');
        if (!response.ok) throw new Error('Error al cargar sesiones');

        const data = await response.json();
        sessionsData = data.sessions || [];

        if (sessionsData.length === 0) {
          tableBody.innerHTML =
            `<tr><td colspan="9" style="text-align: center; padding: 2rem;">
            <div class="empty-state empty-state--table">
              <p style="color: var(--color-gray-500); margin: 0;">No hay sesiones activas</p>
            </div>
          </td></tr>`;
          return;
        }

        tableBody.innerHTML = sessionsData
          .map(
            (session) => `
                <tr>
                    <td>${session.id}</td>
                    <td><strong>${session.table_number}</strong></td>
                    <td>${session.customer_name}</td>
                    <td>${getStatusBadge(session.status)}</td>
                    <td style="text-align: center;">
                        ${session.active_orders_count}
                        ${session.orders_count !== session.active_orders_count
                ? `<span style="color: #94a3b8; font-size: 0.875rem;"> (${session.orders_count} total)</span>`
                : ''
              }
                    </td>
                    <td>${formatDateTime(session.opened_at)}</td>
                    <td>${session.last_order_at ? formatDateTime(session.last_order_at) : 'Sin √≥rdenes'}</td>
                    <td>${formatCurrency(session.total_amount)}</td>
                    <td>
                        <button
                            class="btn btn--small btn--danger"
                            onclick="closeSession(${session.id}, '${session.table_number}')"
                            ${session.status === 'paid' ? 'disabled' : ''}>
                            üóëÔ∏è Cerrar
                        </button>
                    </td>
                </tr>
            `
          )
          .join('');
      } catch (error) {
        console.error('Error loading sessions:', error);
        tableBody.innerHTML =
          '<tr><td colspan="9" style="text-align: center; padding: 2rem; color: #ef4444;">Error al cargar sesiones. Intenta de nuevo.</td></tr>';
        feedback.textContent = 'Error al cargar sesiones';
        feedback.className = 'feedback feedback--error';
        feedback.style.display = 'block';
      }
    }

    window.closeSession = async function (sessionId, tableNumber) {
      if (
        !confirm(
          `¬øEst√°s seguro de que quieres cerrar la sesi√≥n de ${tableNumber}? Esto cancelar√° todas las √≥rdenes activas.`
        )
      ) {
        return;
      }

      const feedback = document.getElementById('sessions-feedback');

      try {
        const response = await fetch(`/api/sessions/${sessionId}/close`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
        });

        const result = await response.json();

        if (response.ok) {
          feedback.textContent = `Sesi√≥n cerrada exitosamente. ${result.cancelled_orders} √≥rdenes canceladas.`;
          feedback.className = 'feedback feedback--success';
          feedback.style.display = 'block';
          setTimeout(() => (feedback.style.display = 'none'), 5000);
          loadSessions();
        } else {
          throw new Error(result.error || 'Error al cerrar sesi√≥n');
        }
      } catch (error) {
        console.error('Error closing session:', error);
        feedback.textContent = error.message || 'Error al cerrar sesi√≥n';
        feedback.className = 'feedback feedback--error';
        feedback.style.display = 'block';
      }
    };

    // Event listeners
    const refreshBtn = document.getElementById('refresh-sessions-btn');
    if (refreshBtn) {
      refreshBtn.addEventListener('click', loadSessions);
    }

    // Load sessions on page load
    if (document.getElementById('sessions-table-body')) {
      loadSessions();
      // Auto refresh every 30 seconds
      setInterval(loadSessions, 30000);
    }
  })();
</script>
{% endif %}
{% endif %} {% if has_permission(Permission.KITCHEN_VIEW) %}
<section class="section" id="panel-cocina" data-menu-title="Cocina" data-menu-group="OPERACI√ìN" data-icon="chef-hat"
  data-kitchen-root style="max-width: none !important; width: 100%; padding: 0">
  <!-- Unified Header (same style as meseros) -->
  <div class="waiter-unified-header">
    <div class="waiter-unified-header__left">
      <h1 class="waiter-page-title">√ìrdenes en Cocina</h1>
    </div>
    <div class="waiter-unified-header__right">
      <div class="designated-tables-area" style="justify-content: flex-end">
        <button type="button" class="btn btn--secondary" onclick="
            if (window.refreshKitchenOrders) window.refreshKitchenOrders();
            else window.location.reload();
          " title="Actualizar">
          üîÑ Actualizar
        </button>
      </div>
    </div>
  </div>

  <!-- Main Content Container -->
  <div class="waiter-pos-container" style="max-width: none !important; width: 100%">
    <!-- Toolbar (copiada de meseros) -->
    <div class="w-full bg-white border-b border-gray-200 sticky top-16 z-40">
      <div class="w-full px-4 sm:px-6 lg:px-8">
        <div class="waiter-toolbar">
          <div class="waiter-toolbar__search">
            <div class="waiter-search-box">
              <svg class="waiter-search-box__icon" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                stroke-width="2">
                <circle cx="11" cy="11" r="8"></circle>
                <path d="m21 21-4.35-4.35"></path>
              </svg>
              <input type="search" id="kitchen-search-input" class="waiter-search-box__input"
                placeholder="Buscar por orden #, mesa, cliente o item..." autocomplete="off" />
              <span class="waiter-search-box__count" id="kitchen-search-count" style="display: none"></span>
            </div>
          </div>

          <div class="waiter-toolbar__actions" style="justify-content: flex-end; gap: 0.75rem">
            <button type="button" class="waiter-toolbar__btn" id="kitchen-open-filters-btn" title="Filtrar √≥rdenes">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path stroke-linecap="round" stroke-linejoin="round"
                  d="M3 4a1 1 0 0 1 0 2v16a1 1 0 0 1 0 2h18a1 1 0 0 1 0-2V6a1 1 0 0 1 0-2H3zM3 10h18M3 14h18M3 18h18" />
              </svg>
              Filtros
            </button>
            <div class="waiter-view-toggle" aria-label="Modo de vista de tabla">
              <button type="button" class="waiter-view-toggle__btn active" id="kitchen-view-normal">
                Vista normal
              </button>
              <button type="button" class="waiter-view-toggle__btn" id="kitchen-view-compact">
                Vista compacta
              </button>
            </div>

            {% if employee_role == 'chef' %}
            <label class="flex items-center gap-2 cursor-pointer" style="font-size: 0.9rem; color: #475569">
              <input type="checkbox" id="filter-my-chef-orders" style="width: 18px; height: 18px; cursor: pointer" />
              <span>Solo mis √≥rdenes</span>
            </label>
            {% endif %}
          </div>
        </div>
      </div>
    </div>

    <div class="w-full px-4 sm:px-6 lg:px-8 py-4">
      <div class="table-wrapper" id="kitchen-table-wrapper">
        <div id="kitchen-active-orders-section">
          <table class="orders-table">
            <thead>
              <tr>
                <th style="width: 32px;"></th>
                <th>Orden</th>
                <th>Mesa</th>
                <th>Cliente</th>
                <th>Detalle</th>
                <th>Estado</th>
                <th>Acciones</th>
              </tr>
            </thead>
            <tbody id="kitchen-orders">
              {% for order in kitchen_orders %} {% set customer_name = order.customer.name if
              order.customer else '' %} {% set raw_customer_email = (order.customer.email or '') if
              order.customer else '' %} {% if raw_customer_email and
              raw_customer_email.startswith('anonimo+') %} {% set raw_customer_email = '' %} {%
              endif %} {% set order_email = order.customer_email or '' %} {% if order_email and
              order_email.startswith('anonimo+') %} {% set order_email = '' %} {% endif %} {% set
              customer_email = raw_customer_email or order_email %} {% set customer_name_upper =
              (customer_name or '')|upper %} {% if
              customer_email and (not customer_name or customer_name_upper in ['INVITADO', 'CLIENTE
              ANONIMO', 'CLIENTE AN√ìNIMO', 'ANONIMO', 'AN√ìNIMO', 'CLIENTE']) %} {% set
              customer_display_name = customer_email %} {% elif customer_name %} {% set
              customer_display_name = customer_name %} {% else %} {% set customer_display_name =
              'Cliente' %} {% endif %}
              <tr data-order-id="{{ order.id }}" data-status="{{ order.workflow_status }}"
                data-session-id="{{ order.session_id }}" data-table-number="{{ order.session.table_number or '' }}"
                data-customer-name="{{ customer_display_name }}" data-customer-email="{{ customer_email }}"
                data-chef-id="{{ order.chef_id or '' }}" data-waiter-id="{{ order.waiter_id or '' }}"
                data-created-at="{{ order.created_at or '' }}" data-notes="{{ (order.session.notes or '')|e }}"
                data-waiter-notes="{{ (order.waiter_notes or '')|e }}">
                <td>
                  <button type="button" class="star-btn" data-order-id="{{ order.id }}" title="Agregar a seguimiento">
                    <span class="star-icon">‚òÜ</span>
                  </button>
                </td>
                <td>#{{ order.id }}</td>
                <td>{{ order.session.table_number or 'N/A' }}</td>
                <td>{{ customer_display_name }}</td>
                <td>
                  <ul>
                    {% for item in order['items'] %}
                    <li>{{ item.quantity }} x {{ item.name }}</li>
                    {% endfor %}
                  </ul>
                  {% if order.session.notes %}
                  <div class="kitchen-customer-note" style="
                      margin-top: 0.5rem;
                      padding: 0.5rem;
                      background-color: #fef3c7;
                      border-left: 3px solid #f59e0b;
                      border-radius: 4px;
                    ">
                    <p style="margin: 0; font-size: 0.85rem; font-weight: 600; color: #92400e">
                      üìù Nota del cliente:
                    </p>
                    <p style="margin: 0.25rem 0 0; font-size: 0.9rem; color: #78350f">
                      {{ order.session.notes }}
                    </p>
                  </div>
                  {% endif %}
                </td>
                <td>
                  <span class="status status--{{ order.workflow_status }}">{{ order.workflow_status }}</span>
                </td>
                <td class="actions"></td>
              </tr>
              {% endfor %} {% if kitchen_orders|length == 0 %}
              <tr>
                <td colspan="7">No hay √≥rdenes activas en cocina.</td>
              </tr>
              {% endif %}
              <tr class="orders-filter-empty" data-filter-empty-for="kitchen" style="display: none">
                <td colspan="7">No encontramos √≥rdenes que coincidan con tu b√∫squeda.</td>
              </tr>
            </tbody>
          </table>
        </div>

        <div id="kitchen-tracking-orders-section" style="display: none;">
          <table class="orders-table">
            <thead>
              <tr>
                <th style="width: 32px;">‚≠ê</th>
                <th>Orden</th>
                <th>Mesa</th>
                <th>Cliente</th>
                <th>Detalle</th>
                <th>Estado</th>
                <th>Acciones</th>
              </tr>
            </thead>
            <tbody id="kitchen-tracking-orders">
              <tr class="tracking-empty-state">
                <td colspan="7" style="text-align: center; padding: 2rem; color: #64748b;">
                  Haz clic en la ‚≠ê estrella de una orden para agregarla a seguimiento.
                </td>
              </tr>
            </tbody>
          </table>
        </div>

        <div id="kitchen-paid-orders-section" style="display: none;">
          <table class="orders-table">
            <thead>
              <tr>
                <th>ID Sesi√≥n</th>
                <th>Mesa</th>
                <th>Cliente</th>
                <th>Total</th>
                <th>√ìrdenes</th>
                <th>Cerrada</th>
                <th>Acciones</th>
              </tr>
            </thead>
            <tbody id="kitchen-paid-sessions">
              <tr>
                <td colspan="7" style="text-align: center; padding: 2rem; color: #64748b;">
                  Cargando sesiones pagadas...
                </td>
              </tr>
            </tbody>
          </table>
          <p id="kitchen-paid-feedback" class="feedback"></p>
        </div>

        <div id="kitchen-cancelled-orders-section" style="display: none;">
          <table class="orders-table">
            <thead>
              <tr>
                <th>Orden</th>
                <th>Mesa</th>
                <th>Cliente</th>
                <th>Detalle</th>
                <th>Estado</th>
                <th>Acciones</th>
              </tr>
            </thead>
            <tbody id="kitchen-cancelled-orders">
              <tr>
                <td colspan="6" style="text-align: center; padding: 2rem; color: #64748b;">
                  No hay √≥rdenes canceladas.
                </td>
              </tr>
            </tbody>
          </table>
        </div>

      </div>
      <p id="kitchen-feedback" class="feedback"></p>
    </div>
  </div>
</section>
{% endif %} {% if has_permission(Permission.PAYMENTS_PROCESS) and (app_context|lower == 'cashier' or
app_context|lower == 'admin') %}
<section class="section" id="caja" data-menu-title="Caja" data-menu-group="OPERACI√ìN" data-icon="credit-card"
  data-cashier-root style="max-width: none !important; width: 100%; padding: 0">
  <div class="waiter-unified-header waiter-unified-header--cashier">
    <div class="waiter-unified-header__left">
      <h1 class="waiter-page-title">Operaci√≥n de caja</h1>
    </div>
    <div class="waiter-unified-header__right">
      <button type="button" class="waiter-toolbar__btn" onclick="
          if (window.refreshCashierOrders) window.refreshCashierOrders();
          else window.location.reload();
        " title="Actualizar">
        Actualizar
      </button>
    </div>
  </div>

  <div class="waiter-tabs-container">
    <div class="waiter-tabs">
      <button type="button" class="waiter-tab active" data-tab="active">
        Activas
        <span class="waiter-tab__badge is-hidden" id="cashier-active-count">0</span>
      </button>
      <button type="button" class="waiter-tab" data-tab="tracking">
        Seguimiento
        <span class="waiter-tab__badge is-hidden" id="cashier-tracking-count">0</span>
      </button>
      <button type="button" class="waiter-tab" data-tab="paid">
        Cerradas
        <span class="waiter-tab__badge is-hidden" id="cashier-paid-count">0</span>
      </button>
      <button type="button" class="waiter-tab" data-tab="cancelled">
        Canceladas
        <span class="waiter-tab__badge is-hidden" id="cashier-cancelled-count">0</span>
      </button>
    </div>
  </div>

  <div class="waiter-pos-container waiter-pos-container--cashier" style="max-width: none !important; width: 100%">
    <div class="w-full bg-white border-b border-gray-200 sticky top-16 z-40">
      <div class="w-full px-4 sm:px-6 lg:px-8">
        <div class="waiter-toolbar">
          <div class="waiter-toolbar__search">
            <div class="waiter-search-box">
              <svg class="waiter-search-box__icon" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                stroke-width="2">
                <circle cx="11" cy="11" r="8"></circle>
                <path d="m21 21-4.35-4.35"></path>
              </svg>
              <input type="search" id="cashier-search-input" class="waiter-search-box__input"
                placeholder="Buscar por orden #, mesa o cliente..." autocomplete="off" />
              <span class="waiter-search-box__count" id="cashier-search-count" style="display: none"></span>
            </div>
          </div>

          <div class="waiter-toolbar__actions">
            <button type="button" class="waiter-toolbar__btn" id="cashier-open-filters-btn" title="Filtros avanzados">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path stroke-linecap="round" stroke-linejoin="round"
                  d="M3 4a1 1 0 011-1h16a1 1 0 011 1v2.586a1 1 0 01-.293.707l-6.414 6.414a1 1 0 00-.293.707V17l-4 4v-6.586a1 1 0 00-.293-.707L3.293 7.293A1 1 0 013 6.586V4z" />
              </svg>
              Filtros
            </button>
            <span class="waiter-orders-count" id="cashier-orders-count">0 √≥rdenes</span>
            <div class="waiter-view-toggle" aria-label="Modo de vista de tabla">
              <button type="button" class="waiter-view-toggle__btn active" id="cashier-view-normal">
                Vista normal
              </button>
              <button type="button" class="waiter-view-toggle__btn" id="cashier-view-compact">
                Vista compacta
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div class="waiter-filters-modal" id="cashier-filters-modal" style="display: none">
      <div class="waiter-filters-modal__overlay"></div>
      <div class="waiter-filters-modal__content">
        <div class="waiter-filters-modal__header">
          <h3>Filtrar √ìrdenes</h3>
          <button type="button" class="waiter-filters-modal__close" id="cashier-close-filters-btn">
            ‚úï
          </button>
        </div>

        <div class="waiter-filters-modal__body">
          <p class="modal-hint" style="grid-column: 1 / -1; margin-bottom: 1rem">
            Selecciona los filtros para ver √∫nicamente √≥rdenes en proceso de pago.
          </p>
          <div class="waiter-filters__section">
            <h4>Estados de Sesi√≥n</h4>
            <label><input type="checkbox" name="cashier-session-status" value="awaiting_tip" checked />
              Esperando propina</label>
            <label><input type="checkbox" name="cashier-session-status" value="awaiting_payment" checked />
              Esperando pago</label>
            <label><input type="checkbox" name="cashier-session-status" value="awaiting_payment_confirmation" checked />
              Esperando confirmaci√≥n</label>
            <label><input type="checkbox" name="cashier-session-status" value="closed" />
              Cerradas</label>
            <label><input type="checkbox" name="cashier-session-status" value="paid" /> Pagadas</label>
          </div>

          <div class="waiter-filters__section">
            <h4>Estados de Orden</h4>
            <label><input type="checkbox" name="cashier-workflow-status" value="delivered" checked />
              Entregado</label>
            <label><input type="checkbox" name="cashier-workflow-status" value="ready_for_delivery" />
              Listo entrega</label>
            <label><input type="checkbox" name="cashier-workflow-status" value="kitchen_in_progress" />
              En cocina</label>
            <label><input type="checkbox" name="cashier-workflow-status" value="waiter_accepted" />
              Enviando a cocina</label>
            <label><input type="checkbox" name="cashier-workflow-status" value="requested" />
              Esperando mesero</label>
          </div>

          <div class="waiter-filters__section">
            <h4>Rango de fechas</h4>
            <label><input type="radio" name="cashier-date-filter" value="today" checked /> Hoy</label>
            <label><input type="radio" name="cashier-date-filter" value="last7" /> √öltimos 7 d√≠as</label>
            <label><input type="radio" name="cashier-date-filter" value="custom" /> √öltimos
              <input type="number" id="cashier-date-filter-days" value="7" min="1" style="width: 70px; margin: 0 6px" />
              d√≠as
            </label>
            <label><input type="radio" name="cashier-date-filter" value="all" /> Todos</label>
          </div>
        </div>

        <div class="waiter-filters-modal__footer">
          <button type="button" class="btn btn--small btn--secondary" id="cashier-reset-filters">
            Resetear filtros
          </button>
          <button type="button" class="btn btn--small btn--primary" id="cashier-apply-filters-btn">
            Aplicar
          </button>
        </div>
      </div>
    </div>

    <div id="cashier-active-orders-section" class="orders-section">
      <div class="w-full px-4 sm:px-6 lg:px-8 py-4">
        <div class="table-wrapper">
          <table class="orders-table">
            <thead>
              <tr>
                <th style="width: 40px">‚≠ê</th>
                <th>Orden</th>
                <th>Mesa</th>
                <th>Cliente</th>
                <th>Mesero</th>
                <th>Total</th>
                <th>Estado</th>

                <th>Acciones</th>
                <th style="width: 60px"></th>
              </tr>
            </thead>
            <tbody id="cashier-orders">
              {% for order in waiter_orders %} {% set customer_name = order.customer.name if
              order.customer else '' %} {% set raw_customer_email = (order.customer.email or '') if
              order.customer else '' %} {% if raw_customer_email and
              raw_customer_email.startswith('anonimo+') %} {% set raw_customer_email = '' %} {%
              endif %} {% set order_email = order.customer_email or '' %} {% if order_email and
              order_email.startswith('anonimo+') %} {% set order_email = '' %} {% endif %} {% set
              customer_email = raw_customer_email or order_email %} {% set customer_name_upper =
              (customer_name or '')|upper %}
              {% if customer_email and (not customer_name or customer_name_upper in ['INVITADO',
              'CLIENTE ANONIMO', 'CLIENTE AN√ìNIMO', 'ANONIMO', 'AN√ìNIMO', 'CLIENTE']) %} {% set
              customer_display_name = customer_email %} {% elif customer_name %} {% set
              customer_display_name = customer_name %} {% else %} {% set customer_display_name =
              'Cliente' %} {% endif %}
              <tr data-order-id="{{ order.id }}" data-status="{{ order.workflow_status }}"
                data-session-id="{{ order.session_id }}" data-session-status="{{ order.session.status }}"
                data-paid-at="{{ order.session.closed_at if order.session.closed_at else '' }}"
                data-created-at="{{ order.created_at }}" data-session-opened="{{ order.session.opened_at }}"
                data-table-number="{{ order.session.table_number or '' }}"
                data-customer-id="{{ order.customer.id if order.customer else '' }}"
                data-customer-name="{{ customer_display_name }}" data-customer-email="{{ customer_email }}"
                data-customer-phone="{{ order.customer.phone if order.customer else '' }}"
                data-customer-description="{{ (order.customer.physical_description or '')|e if order.customer else '' }}"
                data-customer-avatar="{{ order.customer.avatar if order.customer else '' }}"
                data-waiter-name="{{ order.waiter_name or '' }}" data-waiter-id="{{ order.waiter_id or '' }}"
                data-notes="{{ (order.session.notes or '')|e }}" data-waiter-notes="{{ (order.waiter_notes or '')|e }}">
                <td>
                  <button type="button" class="star-btn" data-order-id="{{ order.id }}" title="Agregar a seguimiento">
                    <span class="star-icon">‚òÜ</span>
                  </button>
                </td>
                <td>
                  <button type="button" class="order-id-link" style="
                      background: none;
                      border: none;
                      color: #3b82f6;
                      font-weight: 600;
                      cursor: pointer;
                      text-decoration: underline;
                      padding: 0;
                    " data-order-detail="{{ order.id }}" data-table-number="{{ order.session.table_number or '' }}"
                    data-customer-name="{{ customer_display_name }}" data-customer-email="{{ customer_email }}"
                    data-customer-phone="{{ order.customer.phone if order.customer else '' }}"
                    data-notes="{{ (order.session.notes or '')|e }}"
                    data-waiter-notes="{{ (order.waiter_notes or '')|e }}" data-status="{{ order.workflow_status }}"
                    data-total="{{ order.total_amount }}">
                    #{{ order.id }}
                  </button>
                </td>
                <td>
                  <button type="button" class="table-number-link" style="
                      background: none;
                      border: none;
                      color: #ea580c;
                      font-weight: 600;
                      cursor: pointer;
                      text-decoration: underline;
                      padding: 0;
                    " data-table-info="{{ order.session.table_number or '' }}"
                    data-table-number="{{ order.session.table_number or '' }}">
                    <svg viewBox="0 0 24 24" fill="none" aria-hidden="true" style="width: 16px; height: 16px">
                      <path d="M4 10h16" stroke="currentColor" stroke-width="2" stroke-linecap="round"></path>
                      <path d="M6 10v10" stroke="currentColor" stroke-width="2" stroke-linecap="round"></path>
                      <path d="M18 10v10" stroke="currentColor" stroke-width="2" stroke-linecap="round"></path>
                      <path d="M8 6h8" stroke="currentColor" stroke-width="2" stroke-linecap="round"></path>
                      <path d="M7 6V4h10v2" stroke="currentColor" stroke-width="2" stroke-linecap="round"></path>
                    </svg>
                    {{ order.session.table_number or 'N/A' }}
                  </button>
                </td>
                <td>{{ customer_display_name }}</td>
                <td>
                  {% if order.waiter_name %}
                  <span class="waiter-badge">üë§ {{ order.waiter_name }}</span>
                  {% else %}
                  <span class="waiter-badge waiter-badge--unassigned">‚ö†Ô∏è Sin asignar</span>
                  {% endif %}
                </td>
                <td>
                  {{ currency_symbol }}{{ "{:,.2f}".format(order.total_amount) }} {{ currency }}
                </td>
                <td>
                  <span class="status status--{{ order.workflow_status }}">{{ order.workflow_status }}</span>
                </td>

                <td class="actions"></td>
                <td></td>
              </tr>
              {% else %}
              <tr>
                <td colspan="9">Sin √≥rdenes activas.</td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
        <p id="cashier-feedback" class="feedback"></p>
      </div>
    </div>

    <div id="cashier-tracking-orders-section" class="orders-section" style="display: none">
      <div class="w-full px-4 sm:px-6 lg:px-8 py-4">
        <div class="table-wrapper tracking-section">
          <table class="orders-table">
            <thead>
              <tr>
                <th style="width: 40px">‚≠ê</th>
                <th>Orden</th>
                <th>Mesa</th>
                <th>Cliente</th>
                <th>Total</th>
                <th>Estado</th>
                <th>Acciones</th>
              </tr>
            </thead>
            <tbody id="cashier-tracking-orders">
              <tr class="tracking-empty-state">
                <td colspan="7" style="text-align: center; padding: 1.5rem">
                  <div style="font-size: 1.5rem; margin-bottom: 0.5rem">‚≠ê</div>
                  <p style="margin: 0">No tienes √≥rdenes en seguimiento</p>
                  <small style="color: #64748b">Usa la estrella para fijar √≥rdenes importantes.</small>
                </td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>

    <div id="cashier-paid-orders-section" class="orders-section" style="display: none">
      <div class="w-full px-4 sm:px-6 lg:px-8 py-4">
        <div class="table-wrapper">
          <table class="orders-table">
            <thead>
              <tr>
                <th>Sesi√≥n</th>
                <th>Mesa</th>
                <th>Cliente</th>
                <th>Total</th>
                <th>√ìrdenes</th>
                <th>M√©todo</th>
                <th>Cerrada</th>
              </tr>
            </thead>
            <tbody id="cashier-paid-sessions">
              <tr>
                <td colspan="7" style="text-align: center; padding: 3rem;">
                  <div class="loading-state">
                    <div class="spinner spinner--medium" style="margin: 0 auto 1rem;"></div>
                    <p style="color: var(--color-gray-500); margin: 0;">Cargando sesiones cerradas...</p>
                  </div>
                </td>
              </tr>
            </tbody>
          </table>
        </div>
        <p id="cashier-paid-feedback" class="feedback"></p>
      </div>
    </div>

    <div id="cashier-cancelled-orders-section" class="orders-section" style="display: none">
      <div class="w-full px-4 sm:px-6 lg:px-8 py-4">
        <div class="table-wrapper">
          <table class="orders-table">
            <thead>
              <tr>
                <th>Orden</th>
                <th>Mesa</th>
                <th>Cliente</th>
                <th>Total</th>
                <th>Cancelada</th>
                <th>Motivo</th>
              </tr>
            </thead>
            <tbody id="cashier-cancelled-orders">
              <tr class="cancelled-empty-state">
                <td colspan="6" style="text-align: center; padding: 1.5rem; color: #64748b">
                  No hay √≥rdenes canceladas.
                </td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </div>
</section>
{% if employee_role in ['super_admin', 'admin_roles'] %}
<section class="section" id="reportes" data-menu-title="Reportes" data-menu-group="REPORTES" data-icon="bar-chart-3">
  <header class="section__header">
    <h2>üìä An√°lisis</h2>
    <p>Visualiza ventas, productos m√°s vendidos, horarios pico y propinas por mesero.</p>
  </header>

  <div class="reports-filters">
    <div class="filter-group">
      <label for="report-start-date">Desde:</label>
      <input type="date" id="report-start-date" class="filter-input" />
    </div>
    <div class="filter-group">
      <label for="report-end-date">Hasta:</label>
      <input type="date" id="report-end-date" class="filter-input" />
    </div>
    <div class="filter-group">
      <label for="report-grouping">Agrupar por:</label>
      <select id="report-grouping" class="filter-input">
        <option value="day">D√≠a</option>
        <option value="week">Semana</option>
        <option value="month">Mes</option>
      </select>
    </div>
    <button id="refresh-reports-btn" class="btn btn--primary">üîç Buscar</button>
    <button id="quick-filters-btn" class="btn btn--secondary">Filtros r√°pidos ‚ñº</button>
  </div>

  <div id="quick-filters" class="quick-filters">
    <button class="quick-filter-btn" data-period="today">Hoy</button>
    <button class="quick-filter-btn" data-period="week">Esta semana</button>
    <button class="quick-filter-btn" data-period="month">Este mes</button>
  </div>

  <!-- Sales Report -->
  <div class="report-card card card--light">
    <div class="card__header">
      <div>
        <h3 class="card__header-title">üìà Ventas por Per√≠odo</h3>
      </div>
    </div>
    <div class="card__body">
      <div class="report-summary">
        <div class="summary-item">
          <span class="summary-label">Total √ìrdenes:</span>
          <strong id="total-orders">-</strong>
        </div>
        <div class="summary-item">
          <span class="summary-label">Ingresos Totales:</span>
          <strong id="total-revenue">-</strong>
        </div>
        <div class="summary-item">
          <span class="summary-label">Propinas Totales:</span>
          <strong id="total-tips-summary">-</strong>
        </div>
        <div class="summary-item">
          <span class="summary-label">Ticket Promedio:</span>
          <strong id="avg-order-value">-</strong>
        </div>
      </div>
      <div class="chart-container">
        <canvas id="sales-chart"></canvas>
      </div>
    </div>
  </div>

  <!-- Top Products -->
  <div class="report-card card card--light">
    <div class="card__header">
      <div>
        <h3 class="card__header-title">üèÜ Productos M√°s Vendidos</h3>
      </div>
    </div>
    <div class="card__body">
      <div class="chart-container">
        <canvas id="top-products-chart"></canvas>
      </div>
      <div class="table-wrapper">
        <table id="top-products-table" data-theme="light">
          <thead>
            <tr>
              <th>#</th>
              <th>Producto</th>
              <th>Cantidad</th>
              <th>√ìrdenes</th>
              <th>Ingresos</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </div>
  </div>

  <!-- Peak Hours -->
  <div class="report-card card card--light">
    <div class="card__header">
      <div>
        <h3 class="card__header-title">üïê Horarios Pico</h3>
      </div>
    </div>
    <div class="card__body">
      <div class="peak-hour-info">
        <strong>Hora m√°s concurrida:</strong>
        <span id="peak-hour-display">-</span>
      </div>
      <div class="chart-container">
        <canvas id="peak-hours-chart"></canvas>
      </div>
    </div>
  </div>

  <!-- Waiter Tips -->
  <div class="report-card card card--light">
    <div class="card__header">
      <div>
        <h3 class="card__header-title">üí∞ Propinas por Mesero</h3>
      </div>
    </div>
    <div class="card__body">
      <div class="report-summary">
        <div class="summary-item">
          <span class="summary-label">Total Propinas:</span>
          <strong id="total-tips-waiter">-</strong>
        </div>
        <div class="summary-item">
          <span class="summary-label">Meseros Activos:</span>
          <strong id="waiter-count">-</strong>
        </div>
      </div>
      <div class="table-wrapper">
        <table id="waiter-tips-table">
          <thead>
            <tr>
              <th>Mesero</th>
              <th>√ìrdenes</th>
              <th>Propinas Totales</th>
              <th>Propina Promedio</th>
              <th>% Propina</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </div>

    <div id="reports-feedback" class="feedback"></div>
</section>
{% endif %}


{% if employee_role in ['super_admin', 'admin_roles'] %}
<section class="section" id="marketing" data-menu-title="Marketing" data-menu-group="REPORTES" data-icon="megaphone">
  <header class="section__header">
    <h2>üìà Marketing</h2>
    <p>Campa√±as, mailing y fidelizaci√≥n.</p>
  </header>
  <div class="empty-state">
    <div class="empty-state__icon">üì¢</div>
    <h3>Secci√≥n en construcci√≥n</h3>
  </div>
</section>
{% endif %}

{% endif %} {% if has_permission(Permission.MENU_VIEW) %}
<section class="section" id="menu" data-menu-title="Men√∫ y Productos" data-menu-group="MEN√ö" data-icon="book-open"
  data-catalog-root>
  <header class="section__header">
    <h2>üçΩÔ∏è Cat√°logo inteligente de productos</h2>
    <p>Explora, filtra y actualiza el men√∫ con un panel visual pensado para operaciones.</p>
  </header>

  <div class="catalog-hero">
    <div>
      <p class="catalog-hero__eyebrow">Panel visual</p>
      <h3 class="catalog-hero__title">Gestiona tu men√∫ en segundos</h3>
      <p class="catalog-hero__subtitle">
        Busca, cambia disponibilidad y edita sin perder contexto.
      </p>
    </div>
    <div class="catalog-hero__badges">
      <span class="hero-pill hero-pill--primary">üîç B√∫squeda instant√°nea</span>
      <span class="hero-pill">‚Üï Vista tarjetas / compacta</span>
      <span class="hero-pill">‚ö° Acciones r√°pidas sobre la foto</span>
    </div>
  </div>

  <link rel="stylesheet" href="{{ assets_css_employees }}/dashboard.css" />

  <style>
    /* Modern Catalog Sidebar Styles */
    .modern-catalog-sidebar {
      background: #ffffff;
      border-right: 1px solid #e2e8f0;
      display: flex;
      flex-direction: column;
      height: 100%;
      overflow-y: auto;
      padding: 1.5rem;
      gap: 1.5rem;
    }

    .modern-catalog-sidebar--dark {
      background: #111827;
      border-right-color: rgba(148, 163, 184, 0.15);
      color: #e2e8f0;
    }

    .modern-catalog-sidebar--dark .catalog-stats p {
      color: rgba(226, 232, 240, 0.75);
    }

    .modern-catalog-sidebar--dark .catalog-stats strong {
      color: #ffffff;
    }

    /* Header & Actions */
    .catalog-header-actions {
      display: flex;
      flex-direction: column;
      gap: 1rem;
    }

    .catalog-stats p {
      color: #64748b;
      font-size: 0.875rem;
      margin: 0;
    }

    .catalog-stats strong {
      color: #0f172a;
      font-size: 1.125rem;
      font-weight: 700;
    }

    .btn-modern-primary {
      background: linear-gradient(135deg, #ff6b35 0%, #ea580c 100%);
      color: white;
      border: none;
      border-radius: 12px;
      padding: 0.75rem 1rem;
      font-weight: 600;
      font-size: 0.95rem;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 0.5rem;
      cursor: pointer;
      transition: all 0.2s ease;
      box-shadow: 0 4px 6px -1px rgba(255, 107, 53, 0.2);
      width: 100%;
    }

    .btn-modern-primary:hover {
      transform: translateY(-1px);
      box-shadow: 0 6px 8px -1px rgba(255, 107, 53, 0.3);
    }

    .btn-modern-primary .icon {
      font-size: 1.2rem;
      line-height: 1;
    }

    .catalog-quick-actions {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 0.5rem;
    }

    .btn-icon-action {
      background: #f8fafc;
      border: 1px solid #e2e8f0;
      border-radius: 8px;
      padding: 0.5rem;
      font-size: 1.1rem;
      cursor: pointer;
      transition: all 0.2s;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .modern-catalog-sidebar--dark .btn-icon-action {
      background: rgba(148, 163, 184, 0.08);
      border-color: rgba(148, 163, 184, 0.18);
      color: #e2e8f0;
    }

    .btn-icon-action:hover:not(:disabled) {
      background: #f1f5f9;
      border-color: #cbd5e1;
      transform: translateY(-1px);
    }

    .modern-catalog-sidebar--dark .btn-icon-action:hover:not(:disabled) {
      background: rgba(148, 163, 184, 0.12);
      border-color: rgba(148, 163, 184, 0.24);
    }

    .btn-icon-action.danger:hover:not(:disabled) {
      background: #fee2e2;
      border-color: #fca5a5;
      color: #ef4444;
    }

    .btn-icon-action:disabled {
      opacity: 0.5;
      cursor: not-allowed;
      background: #f1f5f9;
    }

    /* Search */
    .modern-search-container {
      position: relative;
    }

    .search-input-wrapper {
      position: relative;
      display: flex;
      align-items: center;
    }

    .search-icon {
      position: absolute;
      left: 1rem;
      color: #94a3b8;
      pointer-events: none;
      width: 18px;
      height: 18px;
    }

    .modern-catalog-sidebar--dark .search-icon {
      color: rgba(226, 232, 240, 0.72);
      width: 18px;
      height: 18px;
    }

    .modern-search-input {
      width: 100%;
      padding: 0.75rem 1rem 0.75rem 2.5rem;
      border: 1px solid #e2e8f0;
      border-radius: 12px;
      background: #f8fafc;
      font-size: 0.95rem;
      transition: all 0.2s;
    }

    .modern-catalog-sidebar--dark .modern-search-input {
      background: rgba(15, 23, 42, 0.55);
      border-color: rgba(148, 163, 184, 0.18);
      color: #e2e8f0;
    }

    .modern-catalog-sidebar--dark .modern-search-input::placeholder {
      color: rgba(226, 232, 240, 0.55);
    }

    .modern-search-input:focus-visible {
      background: white;
      border-color: #ff6b35;
      box-shadow: 0 0 0 3px rgba(255, 107, 53, 0.1);
      outline: none;
    }

    .modern-catalog-sidebar--dark .modern-search-input:focus-visible {
      background: rgba(15, 23, 42, 0.65);
      box-shadow: 0 0 0 3px rgba(255, 107, 53, 0.22);
    }

    /* Quick filters */
    .catalog-quick-filters {
      display: flex;
      flex-direction: column;
      gap: 0.75rem;
    }

    .quick-filter-buttons {
      display: grid;
      grid-template-columns: 1fr 1fr 1fr;
      gap: 0.5rem;
    }

    .quick-filter-btn {
      border: 1px solid rgba(148, 163, 184, 0.18);
      background: rgba(148, 163, 184, 0.08);
      color: #e2e8f0;
      border-radius: 14px;
      padding: 0.75rem 0.75rem;
      min-height: 48px;
      font-weight: 700;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 0.5rem;
      cursor: pointer;
      transition:
        transform 0.12s ease,
        background 0.12s ease,
        border-color 0.12s ease;
    }

    .quick-filter-btn svg {
      width: 18px;
      height: 18px;
    }

    .quick-filter-btn:hover {
      transform: translateY(-1px);
      background: rgba(148, 163, 184, 0.12);
      border-color: rgba(148, 163, 184, 0.24);
    }

    .quick-filter-btn.active {
      background: rgba(255, 107, 53, 0.18);
      border-color: rgba(255, 107, 53, 0.35);
      color: #ffffff;
    }

    .quick-filter-btn.active svg {
      filter: drop-shadow(0 6px 14px rgba(255, 107, 53, 0.25));
    }

    /* Filters */
    .modern-filters-container {
      display: flex;
      flex-direction: column;
      gap: 1.5rem;
    }

    .filter-section {
      display: flex;
      flex-direction: column;
      gap: 0.75rem;
    }

    .filter-title {
      font-size: 0.8rem;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      color: #64748b;
      font-weight: 700;
      margin: 0;
    }

    .modern-catalog-sidebar--dark .filter-title {
      color: rgba(226, 232, 240, 0.7);
    }

    .segmented-control-modern {
      display: flex;
      background: #f1f5f9;
      padding: 0.25rem;
      border-radius: 10px;
    }

    .modern-catalog-sidebar--dark .segmented-control-modern {
      background: rgba(148, 163, 184, 0.1);
      border: 1px solid rgba(148, 163, 184, 0.14);
    }

    .segment-btn {
      flex: 1;
      border: none;
      background: transparent;
      padding: 0.4rem;
      font-size: 0.85rem;
      font-weight: 500;
      color: #64748b;
      border-radius: 8px;
      cursor: pointer;
      transition: all 0.2s;
    }

    .modern-catalog-sidebar--dark .segment-btn {
      color: rgba(226, 232, 240, 0.72);
    }

    .segment-btn.active {
      background: white;
      color: #0f172a;
      box-shadow: 0 1px 2px rgba(0, 0, 0, 0.05);
      font-weight: 600;
    }

    .modern-catalog-sidebar--dark .segment-btn.active {
      background: linear-gradient(135deg, #ff6b35 0%, #ea580c 100%);
      border-color: transparent;
      color: #ffffff;
      box-shadow: 0 10px 24px rgba(255, 107, 53, 0.25);
    }

    .checkbox-group-modern {
      display: flex;
      flex-direction: column;
      gap: 0.5rem;
    }

    .checkbox-card {
      display: flex;
      align-items: center;
      gap: 0.75rem;
      padding: 0.5rem;
      border-radius: 8px;
      cursor: pointer;
      transition: background 0.2s;
    }

    .checkbox-card:hover {
      background: #f8fafc;
    }

    .modern-catalog-sidebar--dark .checkbox-card:hover {
      background: rgba(148, 163, 184, 0.08);
    }

    .checkbox-card input[type='checkbox'] {
      width: 1.1rem;
      height: 1.1rem;
      border-radius: 4px;
      border: 2px solid #cbd5e1;
      appearance: none;
      cursor: pointer;
      position: relative;
      transition: all 0.2s;
    }

    .checkbox-card input[type='checkbox']:checked {
      background: #ff6b35;
      border-color: #ff6b35;
    }

    .checkbox-card input[type='checkbox']:checked::after {
      content: '‚úì';
      position: absolute;
      color: white;
      font-size: 0.8rem;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
    }

    .checkbox-content {
      font-size: 0.9rem;
      color: #334155;
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }

    .modern-catalog-sidebar--dark .checkbox-content {
      color: rgba(226, 232, 240, 0.92);
    }

    /* Footer Stats */
    .catalog-footer-stats {
      margin-top: auto;
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 1rem;
      padding-top: 1.5rem;
      border-top: 1px solid #e2e8f0;
    }

    .modern-catalog-sidebar--dark .catalog-footer-stats {
      border-top-color: rgba(148, 163, 184, 0.16);
    }

    .stat-pill {
      background: #f8fafc;
      padding: 0.75rem;
      border-radius: 10px;
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 0.25rem;
    }

    .modern-catalog-sidebar--dark .stat-pill {
      background: rgba(148, 163, 184, 0.08);
      border: 1px solid rgba(148, 163, 184, 0.14);
    }

    .stat-pill span {
      font-size: 0.75rem;
      color: #64748b;
      text-transform: uppercase;
    }

    .modern-catalog-sidebar--dark .stat-pill span {
      color: rgba(226, 232, 240, 0.72);
    }

    .stat-pill strong {
      font-size: 1.25rem;
      color: #0f172a;
    }

    .modern-catalog-sidebar--dark .stat-pill strong {
      color: #ffffff;
    }

    .stat-pill.success strong {
      color: #10b981;
    }
  </style>

  <div class="product-manager">
    <aside class="product-sidebar modern-catalog-sidebar modern-catalog-sidebar--dark">
      <div class="catalog-header-actions">
        <div class="catalog-stats">
          <p>Inventario activo</p>
          <strong id="product-count-label">{{ menu.categories|length }} categor√≠as</strong>
        </div>

        {% if has_permission(Permission.MENU_CREATE) %}
        <div class="catalog-main-actions">
          <button type="button" class="btn-modern-primary" id="new-product-btn">
            <span class="icon">+</span> Nuevo Producto
          </button>
        </div>

        <div class="catalog-quick-actions">
          <button type="button" class="btn-icon-action" title="Modificar" id="edit-product-btn" disabled>
            ‚úèÔ∏è
          </button>
          <button type="button" class="btn-icon-action" title="Marcar Disponible" id="mark-available-btn" disabled>
            ‚úÖ
          </button>
          <button type="button" class="btn-icon-action danger" title="Eliminar" id="delete-product-btn" disabled>
            üóëÔ∏è
          </button>
        </div>
        {% endif %}
      </div>

      <div class="modern-search-container">
        <div class="search-input-wrapper">
          <svg class="search-icon" viewBox="0 0 24 24" fill="none" aria-hidden="true">
            <circle cx="11" cy="11" r="8" stroke="currentColor" stroke-width="2"></circle>
            <path d="m21 21-4.3-4.3" stroke="currentColor" stroke-width="2"></path>
          </svg>
          <input type="search" id="product-search" placeholder="Buscar productos..." class="modern-search-input" />
        </div>
        <div id="product-search-suggestions" class="product-search-suggestions" aria-live="polite"></div>
      </div>

      <div class="catalog-quick-filters" aria-label="Filtros r√°pidos">
        <h4 class="filter-title">Filtros R√°pidos</h4>
        <div class="quick-filter-buttons">
          <button type="button" class="quick-filter-btn" data-quick-period="breakfast">
            <svg viewBox="0 0 24 24" fill="none" aria-hidden="true">
              <path d="M12 3v2" stroke="currentColor" stroke-width="2" stroke-linecap="round" />
              <path d="M4.2 8.2 5.6 9.6" stroke="currentColor" stroke-width="2" stroke-linecap="round" />
              <path d="M19.8 8.2 18.4 9.6" stroke="currentColor" stroke-width="2" stroke-linecap="round" />
              <path d="M4 13h16" stroke="currentColor" stroke-width="2" stroke-linecap="round" />
              <path d="M6 17h12" stroke="currentColor" stroke-width="2" stroke-linecap="round" />
            </svg>
            <span>Ma√±ana</span>
          </button>
          <button type="button" class="quick-filter-btn" data-quick-period="afternoon">
            <svg viewBox="0 0 24 24" fill="none" aria-hidden="true">
              <path d="M12 4a6 6 0 1 0 0 12 6 6 0 0 0 0-12Z" stroke="currentColor" stroke-width="2"
                stroke-linecap="round" stroke-linejoin="round" />
              <path d="M12 1v2" stroke="currentColor" stroke-width="2" stroke-linecap="round" />
              <path d="M12 21v2" stroke="currentColor" stroke-width="2" stroke-linecap="round" />
              <path d="M4.22 4.22 5.64 5.64" stroke="currentColor" stroke-width="2" stroke-linecap="round" />
              <path d="M18.36 18.36 19.78 19.78" stroke="currentColor" stroke-width="2" stroke-linecap="round" />
            </svg>
            <span>Tarde</span>
          </button>
          <button type="button" class="quick-filter-btn" data-quick-period="night">
            <svg viewBox="0 0 24 24" fill="none" aria-hidden="true">
              <path d="M21 15.5A8.5 8.5 0 0 1 9.5 3a7 7 0 1 0 11.5 12.5Z" stroke="currentColor" stroke-width="2"
                stroke-linecap="round" stroke-linejoin="round" />
            </svg>
            <span>Noche</span>
          </button>
        </div>
      </div>

      <div class="modern-filters-container">
        <!-- Availability Filter -->
        <div class="filter-section">
          <h4 class="filter-title">Estado</h4>
          <div class="segmented-control-modern" id="availability-filter">
            <button type="button" class="segment-btn active" data-availability="all">Todos</button>
            <button type="button" class="segment-btn" data-availability="available">Activos</button>
            <button type="button" class="segment-btn" data-availability="unavailable">
              Agotados
            </button>
          </div>
        </div>

        <!-- Period Filters -->
        <div class="filter-section">
          <h4 class="filter-title">Horarios</h4>
          <div class="checkbox-group-modern" id="product-period-filters">
            {% for period in day_periods %}
            <label class="checkbox-card">
              <input type="checkbox" class="period-filter-checkbox" data-period-key="{{ period.key }}" />
              <span class="checkbox-content">
                <span class="period-icon">{{ period.icon or 'üïí' }}</span>
                <span class="period-name">{{ period.name }}</span>
              </span>
            </label>
            {% endfor %}
          </div>
        </div>

        <!-- Promo Filters -->
        <div class="filter-section">
          <h4 class="filter-title">Promociones</h4>
          <div class="checkbox-group-modern">
            <label class="checkbox-card">
              <input type="checkbox" id="filter-promotion" data-filter-type="promotion" />
              <span class="checkbox-content">üéâ Con promoci√≥n</span>
            </label>
            <label class="checkbox-card">
              <input type="checkbox" id="filter-coupon" data-filter-type="coupon" />
              <span class="checkbox-content">üé´ Con cup√≥n</span>
            </label>
          </div>
        </div>

        <!-- Categories -->
        <div class="filter-section">
          <h4 class="filter-title">Categor√≠as</h4>
          <div id="product-filter-list" class="product-filter-list"></div>
        </div>
      </div>

      <!-- Stats Footer -->
      <div class="catalog-footer-stats">
        <div class="stat-pill">
          <span>Total</span>
          <strong id="product-total-count">--</strong>
        </div>
        <div class="stat-pill success">
          <span>Activos</span>
          <strong id="product-available-count">--</strong>
        </div>
      </div>
    </aside>

    <div class="product-content">
      <div class="product-toolbar">
        <button type="button" class="catalog-toolbar-btn" id="toggle-product-sidebar" title="Filtros"
          aria-label="Filtros">
          <svg viewBox="0 0 24 24" fill="none" aria-hidden="true">
            <path d="M3 4h18" stroke="currentColor" stroke-width="2" stroke-linecap="round"></path>
            <path d="M6 12h12" stroke="currentColor" stroke-width="2" stroke-linecap="round"></path>
            <path d="M10 20h4" stroke="currentColor" stroke-width="2" stroke-linecap="round"></path>
          </svg>
          <span>Filtros</span>
        </button>
        <div class="product-view-toggle">
          <button type="button" class="view-toggle-btn" data-product-view-mode="grid" title="Vista tarjetas"
            aria-label="Vista tarjetas">
            <svg viewBox="0 0 24 24" fill="none" aria-hidden="true">
              <rect x="3" y="3" width="7" height="7" rx="2" stroke="currentColor" stroke-width="2"></rect>
              <rect x="14" y="3" width="7" height="7" rx="2" stroke="currentColor" stroke-width="2"></rect>
              <rect x="3" y="14" width="7" height="7" rx="2" stroke="currentColor" stroke-width="2"></rect>
              <rect x="14" y="14" width="7" height="7" rx="2" stroke="currentColor" stroke-width="2"></rect>
            </svg>
            <span>Tarjetas</span>
          </button>
          <button type="button" class="view-toggle-btn" data-product-view-mode="compact" title="Vista compacta"
            aria-label="Vista compacta">
            <svg viewBox="0 0 24 24" fill="none" aria-hidden="true">
              <path d="M4 6h16" stroke="currentColor" stroke-width="2" stroke-linecap="round"></path>
              <path d="M4 12h16" stroke="currentColor" stroke-width="2" stroke-linecap="round"></path>
              <path d="M4 18h16" stroke="currentColor" stroke-width="2" stroke-linecap="round"></path>
            </svg>
            <span>Compacta</span>
          </button>
        </div>
      </div>
      <div class="product-grid" id="product-grid"></div>
      <div id="product-pagination"></div>
      <div class="product-empty" id="product-empty-state" style="display: none">
        <h4>Sin coincidencias</h4>
        <p>Prueba con otra b√∫squeda o cambia los filtros.</p>
      </div>
    </div>
  </div>

  {% if employee_role in ['super_admin', 'admin_roles', 'content_manager'] %}
  <div class="product-drawer" id="product-drawer">
    <div class="product-drawer__content">
      <div class="product-drawer__header">
        <h3 id="product-drawer-title">Nuevo producto</h3>
        <button class="product-drawer__close" type="button" id="close-product-drawer">√ó</button>
      </div>

      <!-- Product Form Tabs -->
      <div class="product-form-tabs">
        <button type="button" class="product-tab active" data-tab="info">üìù Informaci√≥n</button>
        <button type="button" class="product-tab" data-tab="image">üñºÔ∏è Imagen</button>
        <button type="button" class="product-tab" data-tab="availability">‚è∞ Disponibilidad</button>
        <button type="button" class="product-tab" data-tab="tags">üè∑Ô∏è Tags</button>
      </div>

      <form id="product-form">
        <input type="hidden" id="product-id" />
        <input type="hidden" id="product-image" />

        <!-- Tab 1: Informaci√≥n B√°sica -->
        <div class="product-tab-content active" data-tab-content="info">
          <div class="product-form__grid">
            <label>Nombre del producto *
              <input type="text" id="product-name" required placeholder="Ej: Hamburguesa Cl√°sica" />
            </label>
            <label>Precio *
              <input type="number" id="product-price" min="0" step="0.01" required placeholder="0.00" />
            </label>
            <label>Categor√≠a *
              <input type="text" id="product-category" list="category-options" required
                placeholder="Ej: Hamburguesas" />
            </label>
            <label id="prep-time-field">Tiempo de preparaci√≥n (min)
              <input type="number" id="product-prep-time" min="1" max="180" placeholder="15" />
              <small style="color: #94a3b8; font-size: 0.75rem; margin-top: 0.25rem">‚è±Ô∏è Tiempo estimado de
                cocina</small>
            </label>
          </div>

          <label class="product-field" style="margin-top: 1rem">Descripci√≥n
            <textarea id="product-description" rows="4"
              placeholder="Describe los ingredientes, preparaci√≥n o caracter√≠sticas especiales..."></textarea>
            <small style="color: #94a3b8; margin-top: 0.25rem">Esta descripci√≥n se mostrar√° a los clientes en el
              men√∫</small>
          </label>
        </div>

        <!-- Tab 2: Imagen -->
        <div class="product-tab-content" data-tab-content="image">
          <div class="image-manager">
            <div class="image-manager__header">
              <div>
                <p>Imagen del producto</p>
                <small>Genera con IA, sube una foto o copia una URL. Todo se guarda en el contenedor
                  est√°tico.</small>
              </div>
              <button type="button" class="btn btn--outline btn--small" id="clear-product-image">
                Quitar
              </button>
            </div>
            <div class="image-manager__preview">
              <img id="product-image-preview"
                src="{{ restaurant_assets | replace('http://', 'https://') }}/icons/placeholder.png" alt="Vista previa"
                data-state="empty" />
            </div>
            <div class="image-mode-tabs">
              <button type="button" class="image-mode-btn active" data-mode="ai-free">
                IA gratis
              </button>
              <button type="button" class="image-mode-btn" data-mode="ai-openai">OpenAI</button>
              <button type="button" class="image-mode-btn" data-mode="upload">Subir archivo</button>
              <button type="button" class="image-mode-btn" data-mode="url">URL externa</button>
            </div>
            <div class="image-mode-panel active" data-mode="ai-free">
              <label for="ai-free-prompt">Describe la imagen que quieres generar</label>
              <textarea id="ai-free-prompt" rows="3"
                placeholder="Ejemplo: Hamburguesa artesanal con queso derretido, tomate fresco y lechuga, foto profesional de restaurante, fondo blanco limpio"></textarea>
              <button type="button" class="btn btn--secondary" id="generate-free-image">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
                  style="margin-right: 0.5rem">
                  <rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect>
                  <circle cx="8.5" cy="8.5" r="1.5"></circle>
                  <polyline points="21 15 16 10 5 21"></polyline>
                </svg>
                Generar Imagen con IA
              </button>
              <small class="image-note" style="color: #64748b; display: block; margin-top: 0.5rem">
                ‚ú® Generaci√≥n gratuita usando modelos de c√≥digo abierto
              </small>
            </div>
            <div class="image-mode-panel" data-mode="ai-openai">
              <label for="ai-openai-prompt">Describe la imagen para DALL¬∑E</label>
              <textarea id="ai-openai-prompt" rows="3"
                placeholder="Descripci√≥n detallada para generar con OpenAI DALL¬∑E"></textarea>
              <button type="button" class="btn btn--secondary" id="generate-openai-image">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
                  style="margin-right: 0.5rem">
                  <circle cx="12" cy="12" r="10"></circle>
                  <path d="M12 6v6l4 2"></path>
                </svg>
                Generar con OpenAI
              </button>
              <small class="image-note" style="color: #94a3b8; display: block; margin-top: 0.5rem">
                ‚ö†Ô∏è Requiere configurar <code>OPENAI_API_KEY</code> en variables de entorno
              </small>
            </div>
            <div class="image-mode-panel" data-mode="upload">
              <label for="product-image-upload">Sube una imagen desde tu computadora</label>
              <input type="file" id="product-image-upload" accept=".png,.jpg,.jpeg,.webp,.gif"
                style="margin: 0.75rem 0" />
              <small class="image-note" style="color: #64748b; display: block">
                üìÅ Formatos permitidos: PNG, JPG, WEBP, GIF
              </small>
            </div>
            <div class="image-mode-panel" data-mode="url">
              <label for="product-image-url">URL de imagen externa</label>
              <input type="url" id="product-image-url" placeholder="https://ejemplo.com/imagen-producto.jpg"
                style="margin: 0.75rem 0" />
              <div class="image-url-actions" style="display: flex; gap: 0.75rem; margin-top: 1rem">
                <button type="button" class="btn btn--secondary" id="apply-external-url" style="flex: 1">
                  üîó Usar URL directamente
                </button>
                <button type="button" class="btn btn--primary" id="import-image-url" style="flex: 1">
                  üíæ Copiar al servidor
                </button>
              </div>
              <small class="image-note" style="color: #64748b; display: block; margin-top: 0.75rem">
                üí° Recomendamos copiar al servidor para mayor confiabilidad
              </small>
            </div>
            <p class="image-helper-feedback" id="image-helper-feedback">
              A√∫n no has seleccionado imagen.
            </p>
          </div>
        </div>

        <!-- Tab 3: Disponibilidad -->
        <div class="product-tab-content" data-tab-content="availability">
          <div class="availability-section">
            <h4 style="font-size: 1rem; font-weight: 600; color: #1e293b; margin-bottom: 1rem">
              Estado del Producto
            </h4>

            <label class="product-field product-checkbox">
              <input type="checkbox" id="product-availability" checked />
              <div>
                <span style="font-weight: 500; color: #1e293b">‚úÖ Disponible en el men√∫</span>
                <small style="display: block; color: #64748b; margin-top: 0.25rem">Los clientes podr√°n ver y ordenar
                  este producto</small>
              </div>
            </label>

            <label class="product-field product-checkbox">
              <input type="checkbox" id="product-quick-serve" />
              <div>
                <span style="font-weight: 500; color: #1e293b">‚ö° Entrega inmediata</span>
                <small style="display: block; color: #64748b; margin-top: 0.25rem">El mesero lo entrega directamente sin
                  pasar por cocina (ideal para bebidas,
                  postres empacados, etc.)</small>
              </div>
            </label>
          </div>

          <div class="product-availability-periods" style="margin-top: 2rem">
            <div class="periods-card">
              <div class="periods-card__header">
                <div>
                  <h4>üïê Horarios de Disponibilidad</h4>
                  <p>Activa los horarios en los que el producto estar√° disponible.</p>
                </div>
                <div class="periods-card__actions">
                  <button type="button" class="btn btn--outline btn--small" id="manage-day-periods-btn">
                    ‚öôÔ∏è Configurar periodos
                  </button>
                  <button type="button" class="btn btn--primary btn--small" id="add-day-period-btn">
                    ‚ûï Nuevo horario personalizado
                  </button>
                </div>
              </div>
              <div class="periods-grid" id="product-periods-grid">
                {% for period in day_periods %} {% set input_id = 'product-period-' ~ period.key %}
                <label class="period-card" data-period-key="{{ period.key }}">
                  <input type="checkbox" class="product-period-toggle" id="{{ input_id }}"
                    data-period-key="{{ period.key }}" {% if period.is_default %}checked{% endif %} />
                  <div class="period-card__content">
                    <span class="period-card__icon">{{ period.icon or 'üïí' }}</span>
                    <div class="period-card__text">
                      <span class="period-card__title">{{ period.name }}</span>
                      <span class="period-card__time">{{ period.start_time }} - {{ period.end_time }}</span>
                    </div>
                    <span class="period-card__check">‚úì</span>
                  </div>
                </label>
                {% endfor %}
              </div>
            </div>
          </div>
        </div>

        <!-- Tab 4: Tags -->
        <div class="product-tab-content" data-tab-content="tags">
          <div class="product-tags-section">
            <h4 style="font-size: 1rem; font-weight: 600; color: #1e293b; margin-bottom: 0.5rem">
              üè∑Ô∏è Etiquetas del Producto
            </h4>
            <small style="color: #64748b; margin-bottom: 1rem; display: block">
              Las etiquetas ayudan a categorizar y filtrar productos. Separa con comas.
            </small>
            <label class="product-field">
              <span style="font-weight: 500">Etiquetas</span>
              <input type="text" id="product-tags"
                placeholder="Ejemplos: bebida, caliente, premium, vegano, sin gluten, picante" />
            </label>
            <div class="product-tags-display" id="product-tags-display" style="margin-top: 1rem"></div>

            <div style="margin-top: 1.5rem; padding: 1rem; background: #f1f5f9; border-radius: 8px">
              <p style="font-size: 0.875rem; color: #475569; font-weight: 500; margin-bottom: 0.5rem">
                üí° Sugerencias de tags populares:
              </p>
              <div style="display: flex; flex-wrap: wrap; gap: 0.5rem; margin-top: 0.5rem">
                <button type="button" class="tag-suggestion" data-tag="vegano">üå± Vegano</button>
                <button type="button" class="tag-suggestion" data-tag="vegetariano">
                  ü•ó Vegetariano
                </button>
                <button type="button" class="tag-suggestion" data-tag="sin gluten">
                  üåæ Sin Gluten
                </button>
                <button type="button" class="tag-suggestion" data-tag="picante">üå∂Ô∏è Picante</button>
                <button type="button" class="tag-suggestion" data-tag="premium">‚≠ê Premium</button>
                <button type="button" class="tag-suggestion" data-tag="bajo en calor√≠as">
                  üèÉ Bajo en Calor√≠as
                </button>
              </div>
            </div>
          </div>
        </div>

        <div class="product-form__actions">
          <button type="button" class="btn btn--outline" id="cancel-product-btn">Cancelar</button>
          <button type="button" class="btn btn--danger" id="delete-product-drawer-btn" style="display: none">
            Eliminar
          </button>
          <button type="submit" class="btn btn--primary">Guardar</button>
        </div>
      </form>
      <datalist id="category-options">
        {% for category in menu.categories %}
        <option value="{{ category.name }}">{% endfor %}</option>
      </datalist>
    </div>
  </div>
  {% endif %}
</section>
{% endif %} {% if has_permission(Permission.MENU_EDIT) %}
<section class="section" id="recomendaciones" data-menu-title="Recomendaciones" data-menu-group="ESPECIALES"
  data-icon="star" data-recommendations-root>
  <header class="section__header">
    <h2>‚≠ê Gesti√≥n de Recomendaciones</h2>
    <p>
      Selecciona hasta 3 productos destacados por horario. Los clientes los ver√°n primero en el
      men√∫.
    </p>
  </header>

  <div class="recommendations-manager-new" id="recommendations-periods">
    {% for period in day_periods %}
    <div class="recommendation-period-card" data-period-key="{{ period.key }}">
      <div class="recommendation-period-card__header">
        <div>
          <h3>{{ period.icon or 'üïí' }} {{ period.name }}</h3>
          <p>{{ period.start_time }} - {{ period.end_time }}</p>
        </div>
        <span class="recommendation-count" id="{{ period.key }}-count">0/3</span>
      </div>
      <div class="recommendation-items" id="{{ period.key }}-recommendations">
        <p class="empty-recommendations">
          No hay productos recomendados para {{ period.name|lower }}
        </p>
      </div>
      <button type="button" class="btn btn--secondary btn--small add-recommendation-btn" data-period="{{ period.key }}">
        ‚ûï Agregar producto
      </button>
    </div>
    {% endfor %}
  </div>
  <button type="button" class="btn btn--outline btn--small" id="manage-day-periods-secondary" style="margin-top: 1rem">
    ‚öôÔ∏è Configurar horarios personalizados
  </button>

  <!-- Modal para seleccionar producto -->
  <div class="modal" id="select-recommendation-modal">
    <div class="modal-content" style="max-width: 700px">
      <div class="modal-header" style="
          background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
          color: white;
          padding: 1.5rem;
        ">
        <h3 id="select-recommendation-title" style="margin: 0; color: white">
          Seleccionar Producto
        </h3>
        <button class="modal-close" onclick="closeSelectRecommendationModal()" style="color: white; font-size: 1.5rem">
          √ó
        </button>
      </div>
      <div class="modal-body" style="padding: 1.5rem">
        <p class="modal-hint">Por favor busca y selecciona el producto que deseas recomendar:</p>
        <div class="form-field" style="position: relative; margin-bottom: 1rem">
          <label for="recommendation-search"
            style="display: block; margin-bottom: 0.5rem; font-weight: 600; color: #334155">üîç Buscar producto:</label>
          <input type="text" id="recommendation-search" placeholder="Escribe nombre o categor√≠a..." style="
              width: 100%;
              padding: 0.75rem 1rem;
              border: 2px solid #e2e8f0;
              border-radius: 8px;
              font-size: 1rem;
              transition: all 0.2s;
            " autocomplete="off" />
          <div id="recommendation-search-suggestions" class="search-suggestions" style="display: none"></div>
        </div>

        <div class="recommendation-filters" style="display: flex; gap: 0.5rem; flex-wrap: wrap; margin-bottom: 1rem">
          <button type="button" class="filter-chip active" data-category="all"
            onclick="filterRecommendationsByCategory('all')">
            Todos
          </button>
        </div>

        <div class="recommendation-products-list" id="recommendation-products-list"
          style="max-height: 400px; overflow-y: auto">
          <p style="text-align: center; padding: 2rem; color: #94a3b8">Cargando productos...</p>
        </div>
      </div>
    </div>
  </div>

  <p id="recommendations-feedback" class="feedback"></p>

  <div class="modal" id="day-periods-modal">
    <div class="modal-content" style="max-width: 720px">
      <div class="modal-header">
        <h3>Configurar horarios del d√≠a</h3>
        <button class="modal-close" id="close-day-periods-modal" type="button">√ó</button>
      </div>
      <div class="modal-body">
        <p class="modal-hint">
          Por favor actualiza los rangos de ma√±ana, tarde o crea nuevos periodos como brunch o happy
          hour.
        </p>
        <div class="day-periods-table" id="day-periods-table"></div>
        <form id="day-period-form" class="day-period-form">
          <input type="hidden" id="day-period-id" />
          <div class="form-row">
            <label class="form-group">
              <span>Nombre *</span>
              <input type="text" id="day-period-name" class="filter-input" required />
            </label>
            <label class="form-group">
              <span>Clave *</span>
              <input type="text" id="day-period-key" class="filter-input" placeholder="ej. breakfast" required />
            </label>
            <label class="form-group">
              <span>Icono</span>
              <input type="text" id="day-period-icon" class="filter-input" placeholder="‚òï" />
            </label>
          </div>
          <div class="form-row">
            <label class="form-group">
              <span>Inicio *</span>
              <input type="time" id="day-period-start" class="filter-input" required />
            </label>
            <label class="form-group">
              <span>Fin *</span>
              <input type="time" id="day-period-end" class="filter-input" required />
            </label>
            <label class="form-group">
              <span>Color</span>
              <input type="color" id="day-period-color" class="filter-input" value="#0ea5e9" />
            </label>
          </div>
          <div class="form-actions">
            <button type="button" class="btn btn--outline btn--small" id="reset-day-period-form">
              Cancelar
            </button>
            <button type="submit" class="btn btn--primary btn--small" id="save-day-period-btn">
              Guardar periodo
            </button>
          </div>
        </form>
        <p id="day-periods-feedback" class="feedback" style="margin-top: 1rem"></p>
      </div>
    </div>
  </div>
</section>
{% endif %} {% if has_permission(Permission.MENU_EDIT_PRICE) %}
<section class="section" id="promociones" data-menu-title="Promociones" data-menu-group="ESPECIALES" data-icon="percent"
  data-promotions-root>
  <header class="section__header">
    <h2>üéÅ Gesti√≥n de promociones</h2>
    <p>
      Crea y administra promociones autom√°ticas con filtros inteligentes y asignaci√≥n de productos.
    </p>
  </header>

  <div class="promotion-manager">
    <aside class="promotion-sidebar">
      <div class="promotion-sidebar__header">
        <div>
          <p>Promociones activas</p>
          <strong id="promotion-count-label">0 promociones</strong>
        </div>
        {% if employee_role in ['super_admin', 'admin_roles'] %}
        <button class="btn btn--primary btn--small" id="new-promotion-btn">
          + Nueva promoci√≥n
        </button>
        {% endif %}
      </div>

      <label class="promotion-field">
        <span>Buscar</span>
        <div class="promotion-search-wrapper">
          <input type="search" id="promotion-search" placeholder="Happy Hour, Navidad, etc." />
          <div id="promotion-search-suggestions" class="promotion-search-suggestions" aria-live="polite"></div>
        </div>
      </label>

      <div class="promotion-filter-group">
        <span>Estado</span>
        <div class="segmented-control" id="promotion-status-filter">
          <button class="segmented-control__btn active" data-status="all">Todas</button>
          <button class="segmented-control__btn" data-status="active">Activas</button>
          <button class="segmented-control__btn" data-status="inactive">Inactivas</button>
        </div>
      </div>

      <div class="promotion-filter-group">
        <span>Tipo de descuento</span>
        <div id="promotion-type-filter" class="promotion-filter-list"></div>
      </div>

      <div class="promotion-stats">
        <div>
          <p>Total</p>
          <strong id="promotion-total-count">--</strong>
        </div>
        <div>
          <p>Activas</p>
          <strong id="promotion-active-count">--</strong>
        </div>
      </div>
    </aside>

    <div class="promotion-content">
      <div class="promotion-grid" id="promotion-grid"></div>
      <div id="promotion-pagination" class="pagination-wrapper"></div>
      <div class="promotion-empty" id="promotion-empty-state" style="display: none">
        <h4>Sin coincidencias</h4>
        <p>Prueba con otra b√∫squeda o cambia los filtros.</p>
      </div>
    </div>
  </div>

  {% if employee_role in ['super_admin', 'admin_roles'] %}
  <div class="promotion-drawer" id="promotion-drawer">
    <div class="promotion-drawer__content">
      <div class="promotion-drawer__header">
        <h3 id="promotion-drawer-title">Nueva promoci√≥n</h3>
        <button class="promotion-drawer__close" type="button" id="close-promotion-drawer">√ó</button>
      </div>
      <form id="promotion-form">
        <input type="hidden" id="promotion-id" />

        <div class="promotion-form__grid">
          <label>Nombre *
            <input type="text" id="promotion-name" required placeholder="Ej. Happy Hour" />
          </label>
          <label>Tipo de Descuento *
            <select id="promotion-type" required>
              <option value="percentage">Porcentaje (%)</option>
              <option value="fixed">Monto Fijo</option>
            </select>
          </label>
        </div>

        <div class="promotion-form__grid">
          <label id="promotion-percentage-label">Porcentaje de Descuento *
            <input type="number" id="promotion-percentage" min="0" max="100" step="0.01" placeholder="10" />
          </label>
          <label id="promotion-amount-label" style="display: none">Monto de Descuento *
            <input type="number" id="promotion-amount" min="0" step="0.01" placeholder="5.00" />
          </label>
          <label>Compra M√≠nima
            <input type="number" id="promotion-min-purchase" min="0" step="0.01" placeholder="0.00" />
          </label>
        </div>

        <div class="promotion-form__grid">
          <label>Aplica a
            <select id="promotion-applies-to">
              <option value="all">Todos los clientes</option>
              <option value="registered">Solo registrados</option>
              <option value="anonymous">Solo an√≥nimos</option>
            </select>
          </label>
          <label>V√°lido Desde
            <input type="datetime-local" id="promotion-valid-from" />
          </label>
          <label>V√°lido Hasta
            <input type="datetime-local" id="promotion-valid-until" />
          </label>
        </div>

        <label>Descripci√≥n
          <textarea id="promotion-description" rows="2" placeholder="Descripci√≥n interna de la promoci√≥n"></textarea>
        </label>

        <label>Mensaje de Banner
          <input type="text" id="promotion-banner" placeholder="Ej. ¬°20% de descuento en todos los pedidos!" />
        </label>

        <div class="promotion-products-section">
          <div class="promotion-products-header">
            <h4>Aplicaci√≥n de la promoci√≥n</h4>
            <div class="promotion-apply-tabs">
              <button type="button" class="promotion-apply-tab active" data-tab="products"
                onclick="switchPromotionApplyTab('products')">
                Productos
              </button>
              <button type="button" class="promotion-apply-tab" data-tab="tags"
                onclick="switchPromotionApplyTab('tags')">
                Por Tags
              </button>
              <button type="button" class="promotion-apply-tab" data-tab="package"
                onclick="switchPromotionApplyTab('package')">
                Paquete
              </button>
            </div>
          </div>

          <div class="promotion-apply-content active" id="promotion-apply-products">
            <button type="button" class="btn btn--secondary btn--small" id="add-promotion-products"
              style="margin-bottom: 1rem">
              ‚ûï Agregar productos
            </button>
            <div class="promotion-products-list" id="promotion-products-list">
              <p class="empty-promotion-products">
                No hay productos seleccionados. Agrega productos espec√≠ficos para esta promoci√≥n.
              </p>
            </div>
          </div>

          <div class="promotion-apply-content" id="promotion-apply-tags">
            <div style="margin-bottom: 1rem">
              <label class="product-field">
                <span style="font-weight: 600; color: #1e293b; font-size: 0.875rem">Tags aplicables</span>
                <small style="color: #64748b; margin-bottom: 0.5rem">Ingresa tags separados por comas. La promoci√≥n
                  aplicar√° a productos con
                  cualquiera de estos tags.</small>
                <input type="text" id="promotion-tags-input" placeholder="bebida, caliente, premium" />
              </label>
            </div>
            <div class="promotion-tags-display" id="promotion-tags-display"></div>
          </div>

          <div class="promotion-apply-content" id="promotion-apply-package">
            <div style="margin-bottom: 1rem">
              <label class="product-field">
                <span style="font-weight: 600; color: #1e293b; font-size: 0.875rem">Nombre del Paquete</span>
                <small style="color: #64748b; margin-bottom: 0.5rem">Configura un paquete de productos con descuento
                  especial.</small>
                <input type="text" id="promotion-package-name" placeholder="Combo Familiar, Pack Desayuno, etc." />
              </label>
            </div>
            <button type="button" class="btn btn--secondary btn--small" id="add-package-products"
              style="margin-bottom: 1rem">
              ‚ûï Agregar productos al paquete
            </button>
            <div class="promotion-products-list" id="promotion-package-products-list">
              <p class="empty-promotion-products">
                No hay productos en el paquete. Agrega productos para crear el paquete.
              </p>
            </div>
          </div>
        </div>

        <label class="checkbox-label">
          <input type="checkbox" id="promotion-active" checked />
          Promoci√≥n activa
        </label>

        <div class="promotion-form__actions">
          <button type="button" class="btn btn--outline" id="cancel-promotion-btn">Cancelar</button>
          <button type="submit" class="btn btn--primary">Guardar Promoci√≥n</button>
        </div>
        <p id="promotion-form-feedback" class="feedback"></p>
      </form>
    </div>
  </div>

  <!-- Modal para seleccionar productos -->
  <div class="modal" id="select-promotion-products-modal">
    <div class="modal-content" style="max-width: 700px">
      <div class="modal-header">
        <h3>Seleccionar productos para la promoci√≥n</h3>
        <button class="modal-close" onclick="closeSelectPromotionProductsModal()">√ó</button>
      </div>
      <div class="modal-body">
        <p class="modal-hint">
          Por favor busca y selecciona los productos que deseas incluir en la promoci√≥n:
        </p>
        <div class="form-field">
          <label for="promotion-product-search">Buscar producto:</label>
          <input type="text" id="promotion-product-search" placeholder="Escribe para buscar..." />
        </div>
        <div class="promotion-product-selection-list" id="promotion-product-selection-list">
          <p>Cargando productos...</p>
        </div>
        <div style="margin-top: 1.5rem; display: flex; gap: 1rem; justify-content: flex-end">
          <button type="button" class="btn btn--outline" onclick="closeSelectPromotionProductsModal()">
            Cancelar
          </button>
          <button type="button" class="btn btn--primary" onclick="confirmPromotionProducts()">
            Confirmar selecci√≥n
          </button>
        </div>
      </div>
    </div>
  </div>
  {% endif %}
</section>
{% endif %} {% if has_permission(Permission.CONFIG_EDIT) %}
<section class="section" id="codigos-descuento" data-menu-title="C√≥digos de Descuento" data-menu-group="ESPECIALES"
  data-icon="tag" data-coupons-root>
  <header class="section__header">
    <h2>üè∑Ô∏è Gesti√≥n de c√≥digos de descuento</h2>
    <p>Genera y administra c√≥digos promocionales que los clientes pueden aplicar en su pedido.</p>
  </header>

  <div class="coupon-manager">
    <aside class="coupon-sidebar">
      <div class="coupon-sidebar__header">
        <div>
          <p>Cupones activos</p>
          <strong id="coupon-count-label">0 cupones</strong>
        </div>
        <button class="btn btn--primary btn--small" id="new-coupon-btn">+ Nuevo cup√≥n</button>
      </div>

      <label class="coupon-field">
        <span>Buscar</span>
        <div class="coupon-search-wrapper">
          <input type="search" id="coupon-search" placeholder="VERANO2024, PROMO10, etc." />
          <div id="coupon-search-suggestions" class="coupon-search-suggestions" aria-live="polite"></div>
        </div>
      </label>

      <div class="coupon-filter-group">
        <span>Estado</span>
        <div class="segmented-control" id="coupon-status-filter">
          <button class="segmented-control__btn active" data-status="all">Todos</button>
          <button class="segmented-control__btn" data-status="active">Activos</button>
          <button class="segmented-control__btn" data-status="inactive">Inactivos</button>
        </div>
      </div>

      <div class="coupon-filter-group">
        <span>Tipo de descuento</span>
        <div id="coupon-type-filter" class="coupon-filter-list"></div>
      </div>

      <div class="coupon-stats">
        <div>
          <p>Total</p>
          <strong id="coupon-total-count">--</strong>
        </div>
        <div>
          <p>Activos</p>
          <strong id="coupon-active-count">--</strong>
        </div>
      </div>
    </aside>

    <div class="coupon-content">
      <div class="coupon-grid" id="coupon-grid"></div>
      <div id="coupon-pagination" class="pagination-wrapper"></div>
      <div class="coupon-empty" id="coupon-empty-state" style="display: none">
        <h4>Sin coincidencias</h4>
        <p>Prueba con otra b√∫squeda o cambia los filtros.</p>
      </div>
    </div>
  </div>

  <div class="coupon-drawer" id="coupon-drawer">
    <div class="coupon-drawer__content">
      <div class="coupon-drawer__header">
        <h3 id="coupon-drawer-title">Nuevo cup√≥n</h3>
        <button class="coupon-drawer__close" type="button" id="close-coupon-drawer">√ó</button>
      </div>
      <form id="coupon-form">
        <input type="hidden" id="coupon-id" />

        <div class="coupon-form__grid">
          <label>C√≥digo *
            <input type="text" id="coupon-code" required placeholder="VERANO2024" style="text-transform: uppercase" />
          </label>
          <label>Tipo de Descuento *
            <select id="coupon-type" required>
              <option value="percentage">Porcentaje (%)</option>
              <option value="fixed">Monto Fijo</option>
            </select>
          </label>
        </div>

        <div class="coupon-form__grid">
          <label id="coupon-percentage-label">Porcentaje de Descuento *
            <input type="number" id="coupon-percentage" min="0" max="100" step="0.01" placeholder="15" />
          </label>
          <label id="coupon-amount-label" style="display: none">Monto de Descuento *
            <input type="number" id="coupon-amount" min="0" step="0.01" placeholder="10.00" />
          </label>
          <label>Compra M√≠nima
            <input type="number" id="coupon-min-purchase" min="0" step="0.01" placeholder="0.00" />
          </label>
        </div>

        <div class="coupon-form__grid">
          <label>L√≠mite de Usos
            <input type="number" id="coupon-usage-limit" min="0" placeholder="Dejar vac√≠o para ilimitado" />
          </label>
          <label>Aplica a
            <select id="coupon-applies-to">
              <option value="all">Todos los clientes</option>
              <option value="registered">Solo registrados</option>
              <option value="anonymous">Solo an√≥nimos</option>
            </select>
          </label>
        </div>

        <div class="coupon-form__grid">
          <label>V√°lido Desde
            <input type="datetime-local" id="coupon-valid-from" />
          </label>
          <label>V√°lido Hasta
            <input type="datetime-local" id="coupon-valid-until" />
          </label>
        </div>

        <label>Descripci√≥n
          <textarea id="coupon-description" rows="2" placeholder="Descripci√≥n del c√≥digo de descuento"></textarea>
        </label>

        <div class="coupon-products-section">
          <div class="coupon-products-header">
            <h4>Aplicaci√≥n del cup√≥n</h4>
            <div class="coupon-apply-tabs">
              <button type="button" class="coupon-apply-tab active" data-tab="all"
                onclick="switchCouponApplyTab('all')">
                Todos
              </button>
              <button type="button" class="coupon-apply-tab" data-tab="tags" onclick="switchCouponApplyTab('tags')">
                Por Tags
              </button>
              <button type="button" class="coupon-apply-tab" data-tab="products"
                onclick="switchCouponApplyTab('products')">
                Productos
              </button>
            </div>
          </div>

          <div class="coupon-apply-content active" id="coupon-apply-all">
            <p class="empty-coupon-products">Este cup√≥n aplica a todos los productos del men√∫</p>
          </div>

          <div class="coupon-apply-content" id="coupon-apply-tags">
            <div style="margin-bottom: 1rem">
              <label class="product-field">
                <span style="font-weight: 600; color: #1e293b; font-size: 0.875rem">Tags aplicables</span>
                <small style="color: #64748b; margin-bottom: 0.5rem">Ingresa tags separados por comas. El cup√≥n aplicar√°
                  a productos con cualquiera de
                  estos tags.</small>
                <input type="text" id="coupon-tags-input" placeholder="bebida, caliente, premium" />
              </label>
            </div>
            <div class="coupon-tags-display" id="coupon-tags-display"></div>
          </div>

          <div class="coupon-apply-content" id="coupon-apply-products">
            <button type="button" class="btn btn--secondary btn--small" id="add-coupon-products"
              style="margin-bottom: 1rem">
              ‚ûï Agregar productos
            </button>
            <div class="coupon-products-list" id="coupon-products-list"></div>
          </div>
        </div>

        <label class="checkbox-label">
          <input type="checkbox" id="coupon-active" checked />
          Cup√≥n activo
        </label>

        <div class="coupon-form__actions">
          <button type="button" class="btn btn--outline" id="cancel-coupon-btn">Cancelar</button>
          <button type="submit" class="btn btn--primary">Guardar Cup√≥n</button>
        </div>
        <p id="coupon-form-feedback" class="feedback"></p>
      </form>
    </div>
  </div>

  <!-- Modal para seleccionar productos -->
  <div class="modal" id="select-coupon-products-modal">
    <div class="modal-content" style="max-width: 700px">
      <div class="modal-header">
        <h3>Seleccionar productos para el cup√≥n</h3>
        <button class="modal-close" onclick="closeSelectCouponProductsModal()">√ó</button>
      </div>
      <div class="modal-body">
        <p class="modal-hint">
          Por favor busca y selecciona los productos que deseas incluir en el cup√≥n:
        </p>
        <div class="form-field">
          <label for="coupon-product-search">Buscar producto:</label>
          <input type="text" id="coupon-product-search" placeholder="Escribe para buscar..." />
        </div>
        <div class="coupon-product-selection-list" id="coupon-product-selection-list">
          <p>Cargando productos...</p>
        </div>
        <div style="margin-top: 1.5rem; display: flex; gap: 1rem; justify-content: flex-end">
          <button type="button" class="btn btn--outline" onclick="closeSelectCouponProductsModal()">
            Cancelar
          </button>
          <button type="button" class="btn btn--primary" onclick="confirmCouponProducts()">
            Confirmar selecci√≥n
          </button>
        </div>
      </div>
    </div>
  </div>
</section>
<section class="section" id="clientes" data-menu-title="Clientes" data-menu-group="ADMINISTRACI√ìN" data-icon="users"
  data-customers-root>
  <header class="section__header">
    <h2>üë• Gesti√≥n de clientes</h2>
    <p>Busca clientes por email, ID de usuario o nombre para ver su informaci√≥n completa.</p>
  </header>

  <div class="customer-search-container">
    <div class="customer-search-box">
      <div class="customer-search-header">
        <h3>üîç Buscar cliente</h3>
        <p>Ingresa el email, ID de usuario o nombre del cliente</p>
      </div>

      <div class="customer-search-input-group">
        <input type="search" id="customer-search-main" class="customer-search-input-large"
          placeholder="Buscar por email, user ID o nombre..." autocomplete="off" />
        <button type="button" class="btn btn--primary customer-search-btn" id="customer-search-btn">
          üîç Buscar
        </button>
      </div>

      <div id="customer-search-results" class="customer-search-results" style="display: none">
        <!-- Search results will appear here -->
      </div>
      <div id="customer-search-pagination"></div>

      <div class="customer-search-stats">
        <div class="stat-item">
          <span class="stat-label">Total de clientes</span>
          <span class="stat-value" id="customer-total-count">--</span>
        </div>
        <div class="stat-item">
          <span class="stat-label">Clientes activos</span>
          <span class="stat-value" id="customer-active-count">--</span>
        </div>
      </div>
    </div>

    <!-- Customer detail panel (shows when a customer is selected) -->
    <div class="customer-detail-panel" id="customer-detail-panel" style="display: none">
      <div class="customer-detail-header">
        <div>
          <h3 id="customer-detail-name">Cliente</h3>
          <p id="customer-detail-email" style="color: #64748b; margin-top: 0.25rem"></p>
        </div>
        <button class="btn btn--secondary btn--small" type="button" id="close-customer-detail">
          ‚úï Cerrar
        </button>
      </div>

      <div class="customer-detail-content">
        <!-- Customer info -->
        <div class="customer-detail__section">
          <h4>üìã Informaci√≥n del cliente</h4>
          <div class="customer-info-grid" id="customer-info-grid">
            <p>Cargando...</p>
          </div>
        </div>

        <!-- Statistics -->
        <div class="customer-detail__section">
          <h4>üìä Estad√≠sticas</h4>
          <div class="customer-stats-cards" id="customer-stats-cards">
            <p>Cargando...</p>
          </div>
        </div>

        <!-- Order history -->
        <div class="customer-detail__section">
          <h4>üõí Historial de √≥rdenes</h4>
          <div class="customer-orders-list" id="customer-orders-list">
            <p>Cargando...</p>
          </div>
          <div id="customer-orders-pagination"></div>
        </div>

        <!-- Coupons used -->
        <div class="customer-detail__section">
          <h4>üéüÔ∏è Cupones utilizados</h4>
          <div class="customer-coupons-list" id="customer-coupons-list">
            <p>Cargando...</p>
          </div>
        </div>
      </div>
    </div>
  </div>
</section>
{% endif %} {% if has_permission(Permission.REPORTS_VIEW) and app_context|lower != 'cashier' %}
<section class="section" id="horarios" data-menu-title="Horarios de Productos" data-menu-group="MEN√ö" data-icon="clock"
  data-schedules-root>
  <header class="section__header">
    <h2>üïí Horarios personalizados del men√∫</h2>
    <p>Define en qu√© d√≠as y horarios est√° disponible cada producto para el p√∫blico.</p>
  </header>

  <div class="schedule-manager">
    <div class="schedule-controls">
      <label class="product-field">
        <span>Selecciona un producto</span>
        <select id="schedule-product-select" class="filter-input">
          <option value="">-- Selecciona un producto --</option>
        </select>
      </label>
      <p style="color: #64748b; font-size: 0.875rem; margin-top: 0.5rem">
        Puedes crear horarios espec√≠ficos por d√≠a o dejarlos en blanco para habilitar la
        disponibilidad todo el d√≠a.
      </p>
    </div>

    <div class="schedule-content">
      <div class="schedule-list" id="schedules-list">
        <p style="text-align: center; color: #94a3b8">
          Selecciona un producto para ver sus horarios.
        </p>
      </div>

      <div class="schedule-form-card" id="schedule-form-container" style="display: none">
        <h3 style="margin-top: 0">Agregar horario</h3>
        <form id="schedule-form">
          <div class="form-row">
            <label>
              <span>D√≠a de la semana</span>
              <select id="schedule-day" class="filter-input">
                <option value="">Todos los d√≠as</option>
                <option value="1">Lunes</option>
                <option value="2">Martes</option>
                <option value="3">Mi√©rcoles</option>
                <option value="4">Jueves</option>
                <option value="5">Viernes</option>
                <option value="6">S√°bado</option>
                <option value="7">Domingo</option>
              </select>
            </label>
            <label>
              <span>Hora de inicio</span>
              <input type="time" id="schedule-start-time" class="filter-input" />
            </label>
            <label>
              <span>Hora de fin</span>
              <input type="time" id="schedule-end-time" class="filter-input" />
            </label>
          </div>
          <p style="color: #94a3b8; font-size: 0.85rem; margin-top: 0.5rem">
            Deja inicio y fin vac√≠os para permitir disponibilidad todo el d√≠a.
          </p>
          <div class="form-actions" style="margin-top: 1rem">
            <button type="submit" class="btn btn--primary btn--small">Agregar horario</button>
          </div>
        </form>
      </div>

      <p id="schedules-feedback" class="feedback"></p>
    </div>
  </div>
</section>
{% endif %} {% if employee_role in ['super_admin', 'admin_roles', 'chef'] %}
<section class="section" id="aditamentos" data-menu-title="Aditamentos" data-menu-group="MEN√ö" data-icon="plus-circle">
  <header class="section__header">
    <h2>üßÄ Cat√°logo inteligente de aditamentos</h2>
    <p>
      Gestiona grupos de modificadores y aditamentos del men√∫ con un panel visual pensado para
      operaciones.
    </p>
  </header>

  <div class="modifiers-manager" data-modifiers-root>
    <aside class="modifiers-sidebar">
      <div class="modifiers-sidebar__header">
        <div>
          <h3>Filtros</h3>
          <small>Organiza tu cat√°logo</small>
        </div>
        <button type="button" class="btn btn--primary" id="create-modifier-group-btn">
          <span>+</span> Nuevo Grupo
        </button>
      </div>

      <div class="modifiers-search">
        <input type="search" id="modifiers-search" placeholder="Buscar por nombre..." />
      </div>

      <div class="modifiers-filter-section">
        <h4>Por disponibilidad</h4>
        <label class="filter-option">
          <input type="radio" name="modifier-availability" value="all" checked />
          <span>Todos</span>
        </label>
        <label class="filter-option">
          <input type="radio" name="modifier-availability" value="available" />
          <span>Disponibles</span>
        </label>
        <label class="filter-option">
          <input type="radio" name="modifier-availability" value="unavailable" />
          <span>No disponibles</span>
        </label>
      </div>
    </aside>

    <div class="modifiers-content">
      <div class="modifiers-content__header">
        <div>
          <h3>Grupos de Modificadores</h3>
          <p id="modifiers-count">0 grupos encontrados</p>
        </div>
        {% if employee_role in ['super_admin', 'admin_roles', 'chef'] %}
        <div class="modifiers-content__actions">
          <button type="button" class="btn btn--outline" id="create-modifier-btn">
            <span>‚ûï</span> Nuevo Aditamento
          </button>
        </div>
        {% endif %}
      </div>

      <div id="modifiers-groups-list" class="modifiers-groups-grid">
        <p class="loading">Cargando grupos de aditamentos...</p>
      </div>
      <div id="modifiers-pagination"></div>
    </div>
  </div>
</section>

<!-- Drawer para Crear/Editar Grupo de Modificadores -->
<div class="modifier-group-drawer" id="modifier-group-drawer">
  <div class="modifier-group-drawer__content">
    <div class="modifier-group-drawer__header">
      <h3 id="modifier-group-drawer-title">Nuevo Grupo</h3>
      <button class="modifier-group-drawer__close" type="button" id="close-modifier-group-drawer">
        √ó
      </button>
    </div>

    <form id="modifier-group-form">
      <input type="hidden" id="modifier-group-id" name="id" />

      <div class="form-section">
        <h4>Informaci√≥n B√°sica</h4>
        <div class="product-form__grid">
          <label>Nombre del grupo *
            <input type="text" id="modifier-group-name" name="name" required
              placeholder="Ej: Salsas, Tama√±os, Extras" />
          </label>
          <label>Orden de visualizaci√≥n
            <input type="number" id="modifier-group-order" name="order" value="0" min="0" placeholder="0" />
          </label>
        </div>

        <label style="display: flex; flex-direction: column; gap: 0.5rem; margin-top: 1rem">
          Descripci√≥n
          <textarea id="modifier-group-description" name="description" rows="3"
            placeholder="Ej: Elige tus salsas favoritas"></textarea>
        </label>
      </div>

      <div class="form-section" style="margin-top: 1.5rem">
        <h4>Configuraci√≥n de Selecci√≥n</h4>
        <div class="product-form__grid">
          <label>M√≠nimo a seleccionar
            <input type="number" id="modifier-group-min" name="min_selection" value="0" min="0" placeholder="0" />
          </label>
          <label>M√°ximo a seleccionar
            <input type="number" id="modifier-group-max" name="max_selection" value="4" min="1" placeholder="4" />
          </label>
        </div>

        <label class="product-checkbox" style="margin-top: 1rem">
          <input type="checkbox" id="modifier-group-required" name="is_required" />
          <div>
            <strong>¬øEs requerido?</strong>
            <small>El cliente debe seleccionar al menos una opci√≥n de este grupo</small>
          </div>
        </label>
      </div>

      <div class="product-form__actions" style="margin-top: 2rem">
        <button type="button" class="btn btn--outline" id="cancel-modifier-group-btn">
          Cancelar
        </button>
        <button type="submit" class="btn btn--primary">Guardar Grupo</button>
      </div>
    </form>
  </div>
</div>

<!-- Drawer para Crear/Editar Modificador Individual -->
<div class="modifier-drawer" id="modifier-drawer">
  <div class="modifier-drawer__content">
    <div class="modifier-drawer__header">
      <h3 id="modifier-drawer-title">Nuevo Modificador</h3>
      <button class="modifier-drawer__close" type="button" id="close-modifier-drawer">√ó</button>
    </div>

    <form id="modifier-form">
      <input type="hidden" id="modifier-id" />
      <input type="hidden" id="modifier-group-id-input" />

      <div class="form-section">
        <h4>Informaci√≥n del Modificador</h4>
        <div class="product-form__grid">
          <label>Nombre *
            <input type="text" id="modifier-name" required placeholder="Ej: Salsa picante" />
          </label>
          <label>Precio adicional
            <input type="number" id="modifier-price" value="0" min="0" step="0.01" placeholder="0.00" />
          </label>
        </div>

        <div class="product-form__grid" style="margin-top: 1rem">
          <label>Orden de visualizaci√≥n
            <input type="number" id="modifier-order" value="0" min="0" placeholder="0" />
          </label>
          <label class="product-checkbox">
            <input type="checkbox" id="modifier-available" checked />
            <div>
              <strong>Disponible</strong>
              <small>Visible para los clientes</small>
            </div>
          </label>
        </div>
      </div>

      <div class="form-section" id="modifier-group-selector-section" style="display: none">
        <h4>Asignar a grupos</h4>
        <p style="color: #64748b; font-size: 0.85rem; margin-top: -0.25rem">
          Selecciona uno o varios grupos donde se mostrar√° este aditamento.
        </p>
        <div class="modifier-group-selector" id="modifier-group-selector">
          <p style="color: #94a3b8">Cargando grupos...</p>
        </div>
      </div>

      <div class="product-form__actions" style="margin-top: 2rem">
        <button type="button" class="btn btn--outline" id="cancel-modifier-btn">Cancelar</button>
        <button type="submit" class="btn btn--primary">Guardar Modificador</button>
      </div>
    </form>
  </div>
</div>


{% if employee_role in ['super_admin'] %}
<section class="section" id="branding-section" data-menu-title="Gesti√≥n de Marca" data-menu-group="BRANDING"
  data-icon="palette">
  <div class="branding-header">
    <h2>Gesti√≥n de Marca</h2>
    <p>Administra logos, iconos y recursos visuales del restaurante</p>
  </div>

  <div id="branding-manager">
    <div class="loading-placeholder" style="text-align: center; padding: 3rem; color: #64748b;">
      <div class="spinner"
        style="margin: 0 auto 1rem; width: 40px; height: 40px; border: 3px solid #e5e7eb; border-top-color: #ff6b35; border-radius: 50%; animation: spin 0.8s linear infinite;">
      </div>
      <p>Cargando configuraci√≥n de branding...</p>
    </div>
  </div>
</section>
{% endif %}
{% if employee_role in ['super_admin', 'admin_roles', 'manager'] %}
<section class="section" id="areas-salones" data-menu-title="Salones" data-menu-group="ADMINISTRACI√ìN" data-icon="map">
  <header class="section__header">
    <h2>üèõÔ∏è √Åreas o salones</h2>
    <p>Gestiona las √°reas o salones disponibles para las mesas del restaurante</p>
  </header>

  <div class="areas-manager" data-areas-root>
    <div class="areas-manager__header">
      <div class="areas-stats">
        <div class="stat-item">
          <span class="stat-label">Total de √°reas</span>
          <span class="stat-value" id="areas-total-count">0</span>
        </div>
      </div>
      <button type="button" class="btn btn--primary" id="open-area-modal">
        <span>‚ûï</span> Crear √°rea
      </button>
    </div>

    <div class="areas-grid" id="areas-grid">
      <div style="text-align: center; color: #64748b; padding: 2rem; display: grid; gap: 0.75rem">
        <p style="margin: 0">Cargando √°reas...</p>
        <button type="button" class="btn btn--primary btn--small"
          onclick="document.getElementById('open-area-modal')?.click()">
          ‚ûï Crear √°rea/Sal√≥n
        </button>
      </div>
    </div>
  </div>
</section>
{% endif %} {% if employee_role in ['super_admin', 'admin_roles'] %}
<section class="section" id="anonymous-sessions" data-menu-title="Sesiones An√≥nimas" data-menu-group="ADMINISTRACI√ìN"
  data-icon="user-minus">
  <header class="section__header">
    <div style="flex: 1">
      <h2>üë§ Gesti√≥n de Sesiones An√≥nimas</h2>
      <p>Administra las sesiones an√≥nimas activas asignadas a mesas</p>
    </div>
    <button type="button" class="btn btn--secondary" id="refresh-anonymous-sessions" title="Actualizar">
      üîÑ Actualizar
    </button>
  </header>

  <div class="anonymous-sessions-manager">
    <div class="table-wrapper">
      <table class="orders-table">
        <thead>
          <tr>
            <th>Mesa</th>
            <th>Cliente An√≥nimo ID</th>
            <th>Estado</th>
            <th>√ìrdenes</th>
            <th>Creada</th>
            <th>Acciones</th>
          </tr>
        </thead>
        <tbody id="anonymous-sessions-table">
          <tr>
            <td colspan="6" style="text-align: center; padding: 2rem; color: #64748b">
              Cargando sesiones an√≥nimas...
            </td>
          </tr>
        </tbody>
      </table>
    </div>
    <p id="anonymous-sessions-feedback" class="feedback"></p>
  </div>
</section>
{% endif %} {% if employee_role in ['super_admin', 'admin_roles', 'manager', 'waiter'] %}
<section class="section" id="tables" data-menu-title="Mesas" data-menu-group="ADMINISTRACI√ìN" data-icon="layout-grid"
  data-tables-root>
  <header class="section__header">
    <h2>ü™ë Mesas</h2>
    <p>Administra las mesas del restaurante con vista gr√°fica interactiva</p>
  </header>

  <!-- Message if no areas configured -->
  <div class="alert alert--warning" id="no-areas-alert" style="display: none">
    <div style="display: flex; align-items: center; gap: 1rem">
      <span style="font-size: 2rem">‚ö†Ô∏è</span>
      <div style="flex: 1">
        <h4 style="margin: 0 0 0.5rem 0; color: #1e293b">No hay √°reas o salones configurados</h4>
        <p style="margin: 0; color: #64748b; font-size: 0.875rem">
          Antes de crear mesas, debes configurar al menos un √°rea o sal√≥n.
        </p>
      </div>
      <a href="javascript:void(0)" class="btn btn--primary" onclick="
          const el = document.getElementById('areas-salones');
          if (el) el.scrollIntoView({ behavior: 'smooth' });
        ">
        Ir a √Åreas y Salones
      </a>
    </div>
  </div>

  <!-- Vista gr√°fica de mesas -->
  <div class="tables-visual-manager">
    <div class="tables-visual-sidebar">
      <!-- Header con t√≠tulo -->
      <div class="tables-sidebar-header">
        <div class="tables-sidebar-icon">üè†</div>
        <div class="tables-sidebar-title">
          <h3>√Åreas del Local</h3>
          <p>Selecciona un √°rea para gestionar</p>
        </div>
      </div>

      <!-- Selector de √°reas -->
      <div class="tables-area-selector" id="tables-area-selector">
        <button type="button" class="area-selector-btn active" data-area="all">
          <span class="area-color" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%)"></span>
          <span class="area-name">Todas las √°reas</span>
        </button>
      </div>

      <!-- Bot√≥n crear mesa - MEJORADO -->
      <button type="button" class="btn-create-table" id="add-table-btn">
        <span class="btn-create-table__icon">
          <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"
            stroke-linecap="round">
            <line x1="12" y1="5" x2="12" y2="19"></line>
            <line x1="5" y1="12" x2="19" y2="12"></line>
          </svg>
        </span>
        <span class="btn-create-table__text">
          <strong>Nueva Mesa</strong>
          <small>Agregar al √°rea seleccionada</small>
        </span>
      </button>

      <!-- Estad√≠sticas -->
      <div class="tables-visual-stats">
        <h4>üìä Resumen de Mesas</h4>
        <div class="stats-grid">
          <div class="stat-card stat-card--total">
            <span class="stat-value" id="tables-total-count">0</span>
            <span class="stat-label">Total</span>
          </div>
          <div class="stat-card stat-card--available">
            <span class="stat-value" id="tables-available-count">0</span>
            <span class="stat-label">Libres</span>
          </div>
          <div class="stat-card stat-card--occupied">
            <span class="stat-value" id="tables-occupied-count">0</span>
            <span class="stat-label">Ocupadas</span>
          </div>
          <div class="stat-card stat-card--reserved">
            <span class="stat-value" id="tables-reserved-count">0</span>
            <span class="stat-label">Reservadas</span>
          </div>
          <div class="stat-card stat-card--indisposed">
            <span class="stat-value" id="tables-indisposed-count">0</span>
            <span class="stat-label">No disponibles</span>
          </div>
        </div>
      </div>

      <!-- Leyenda -->
      <div class="tables-visual-legend">
        <h4>üé® Estados de Mesa</h4>
        <div class="legend-grid">
          <div class="legend-item">
            <span class="legend-dot legend-dot--available"></span>
            <span>Disponible</span>
          </div>
          <div class="legend-item">
            <span class="legend-dot legend-dot--occupied"></span>
            <span>Ocupada</span>
          </div>
          <div class="legend-item">
            <span class="legend-dot legend-dot--reserved"></span>
            <span>Reservada</span>
          </div>
          <div class="legend-item">
            <span class="legend-dot legend-dot--inactive"></span>
            <span>No disponible</span>
          </div>
        </div>
      </div>
    </div>

    <div class="tables-visual-canvas" id="tables-visual-canvas">
      <div class="tables-canvas-controls">
        <button type="button" class="canvas-control-btn" id="canvas-zoom-out" title="Alejar">
          <span>‚àí</span>
        </button>
        <button type="button" class="canvas-control-btn" id="canvas-reset" title="Reset vista">
          <span>‚ü≤</span>
        </button>
        <button type="button" class="canvas-control-btn" id="canvas-zoom-in" title="Acercar">
          <span>+</span>
        </button>
      </div>

      <div class="tables-canvas-wrapper" id="tables-canvas-wrapper">
        <div class="tables-canvas-content" id="tables-canvas-content">
          <div class="canvas-empty-state" id="canvas-empty-state">
            <span style="font-size: 3rem; opacity: 0.5">ü™ë</span>
            <p style="font-size: 1.125rem; color: #64748b; margin-top: 1rem">
              No hay mesas creadas
            </p>
            <p style="font-size: 0.875rem; color: #94a3b8">
              Haz clic en "‚ûï Mesa" para agregar tu primera mesa
            </p>
          </div>
        </div>
      </div>

      <div class="canvas-area-label" id="canvas-area-label">Todas las √°reas</div>
    </div>
  </div>

  <!-- Lista de mesas (modo alternativo) -->
  <div style="margin-top: 2rem">
    <details class="section__collapsible">
      <summary style="
          font-weight: 600;
          color: #1e293b;
          cursor: pointer;
          padding: 1rem;
          background: #f8fafc;
          border-radius: 8px;
        ">
        üìã Ver lista de mesas
      </summary>
      <div style="margin-top: 1rem">
        <div id="tables-list-grid" class="tables-list-grid">
          <p style="text-align: center; color: #64748b; padding: 2rem">Cargando mesas...</p>
        </div>
      </div>
    </details>
  </div>
</section>
{% endif %}

<div class="modal" id="employee-payment-modal">
  <div class="modal-content payment-modal-content">
    <div class="payment-modal-header">
      <h3>
        üí∞ Cobrar cuenta
        <span id="employee-payment-session-label"
          title="Cuenta (ID de sesi√≥n): Una sesi√≥n puede contener m√∫ltiples √≥rdenes"></span>
      </h3>
      <button type="button" class="payment-modal-close" id="close-employee-payment">√ó</button>
    </div>

    <!-- Step 1: Payment Method Selection -->
    <div id="payment-method-selection" class="payment-step">
      <p class="payment-step-title modal-hint">Por favor selecciona el m√©todo de pago:</p>

      <div class="payment-methods-grid">
        <button type="button" class="payment-method-btn" data-method="cash">
          <span class="payment-method-icon">üíµ</span>
          <span class="payment-method-label">Efectivo</span>
        </button>
        <button type="button" class="payment-method-btn" data-method="terminal">
          <span class="payment-method-icon">üí≥</span>
          <span class="payment-method-label">Terminal f√≠sico</span>
        </button>
        <button type="button" class="payment-method-btn" data-method="clip">
          <span class="payment-method-icon">üì±</span>
          <span class="payment-method-label">Clip API (prueba)</span>
        </button>
      </div>

      <div class="payment-modal-footer">
        <button type="button" class="btn btn--outline" id="cancel-employee-payment">
          Cancelar
        </button>
      </div>
    </div>

    <!-- Step 2: Cash Confirmation -->
    <div id="payment-cash-confirmation" class="payment-step" style="display: none">
      <div class="payment-step-icon">üíµ</div>
      <p class="payment-step-heading">¬øConfirmar el cobro en efectivo?</p>
      <p class="payment-step-description">
        Despu√©s del cobro podr√°s registrar la propina y entregar el ticket.
      </p>

      <div class="payment-modal-footer">
        <button type="button" class="btn btn--outline" id="back-from-cash">Atr√°s</button>
        <button type="button" class="btn btn--success" id="confirm-cash-payment">
          ‚úì Confirmar cobro
        </button>
      </div>
    </div>

    <!-- Step 3: Terminal/Clip Options -->
    <div id="payment-terminal-options" class="payment-step" style="display: none">
      <div class="payment-step-icon">üí≥</div>
      <p class="payment-step-heading">Pago con terminal</p>
      <p class="payment-step-description">Completa los detalles opcionales del pago</p>

      <form id="terminal-payment-form" class="payment-form">
        <div class="payment-form-group">
          <label for="terminal-reference">Referencia de pago (opcional)</label>
          <input type="text" id="terminal-reference" placeholder="Ej. √öltimos 4 d√≠gitos" />
        </div>

        <div class="payment-form-group">
          <label for="terminal-card-type">Tipo de tarjeta (opcional)</label>
          <select id="terminal-card-type">
            <option value="">No especificado</option>
            <option value="credit">Cr√©dito</option>
            <option value="debit">D√©bito</option>
          </select>
        </div>

        <div class="payment-form-group">
          <label for="terminal-receipt-photo">Foto del ticket del terminal</label>
          <input type="file" id="terminal-receipt-photo" accept="image/*" capture="environment" style="display: none" />
          <div style="display: flex; gap: 0.5rem; flex-direction: column">
            <button type="button" class="btn btn--outline" id="terminal-photo-btn" style="
                width: 100%;
                display: flex;
                align-items: center;
                justify-content: center;
                gap: 0.5rem;
              ">
              üì∑ Tomar foto del ticket
            </button>
            <div id="terminal-photo-preview" style="display: none; text-align: center; margin-top: 0.5rem">
              <img id="terminal-photo-preview-img" src="" alt="Preview" style="
                  max-width: 100%;
                  max-height: 200px;
                  border-radius: 8px;
                  border: 2px solid #e2e8f0;
                " />
              <p style="font-size: 0.875rem; color: #64748b; margin-top: 0.5rem">
                ‚úì Foto capturada
              </p>
            </div>
          </div>
        </div>

        <div class="payment-modal-footer">
          <button type="button" class="btn btn--outline" id="back-from-terminal">Atr√°s</button>
          <button type="submit" class="btn btn--success">‚úì Confirmar cobro</button>
        </div>
      </form>
    </div>

    <!-- Step 4: Stripe Confirmation -->
    <div id="payment-stripe-confirmation" class="payment-step" style="display: none">
      <div class="payment-step-icon">üåê</div>
      <p class="payment-step-heading">¬øProcesar pago con Stripe?</p>
      <p class="payment-step-description">
        El pago se procesar√° autom√°ticamente a trav√©s de Stripe.
      </p>

      <div class="payment-modal-footer">
        <button type="button" class="btn btn--outline" id="back-from-stripe">Atr√°s</button>
        <button type="button" class="btn btn--success" id="confirm-stripe-payment">
          ‚úì Procesar pago
        </button>
      </div>
    </div>

    <!-- Step 5: Clip API Confirmation -->
    <div id="payment-clip-confirmation" class="payment-step" style="display: none">
      <div class="payment-step-icon">üì±</div>
      <p class="payment-step-heading">¬øProcesar pago con Clip API?</p>
      <p class="payment-step-description">
        Modo de prueba (sandbox). El pago se procesar√° a trav√©s del API de Clip.
      </p>
      <div class="payment-form-group" style="background: #fef3c7; padding: 1rem; border-radius: 8px; margin: 1rem 0">
        <p style="margin: 0; font-size: 0.875rem; color: #92400e">
          <strong>‚ö†Ô∏è Modo de prueba</strong><br />
          Este es el modo sandbox de Clip para probar el flujo antes de comprar el aparato f√≠sico.
        </p>
      </div>

      <div class="payment-modal-footer">
        <button type="button" class="btn btn--outline" id="back-from-clip">Atr√°s</button>
        <button type="button" class="btn btn--success" id="confirm-clip-payment">
          ‚úì Procesar pago (sandbox)
        </button>
      </div>
    </div>
  </div>
</div>

<!-- Modal de propina (aparece despu√©s del cobro) -->
<div class="modal" id="employee-tip-modal">
  <div class="modal-content" style="max-width: 480px">
    <div class="modal-header" style="justify-content: space-between">
      <h3>
        Registrar propina
        <span id="employee-tip-session-label"
          title="Cuenta (ID de sesi√≥n): Una sesi√≥n puede contener m√∫ltiples √≥rdenes"></span>
      </h3>
      <button type="button" class="modal-close" id="close-employee-tip">√ó</button>
    </div>
    <form id="employee-tip-form">
      <p class="modal-hint">Por favor selecciona el porcentaje de propina que dej√≥ el cliente:</p>
      <div class="tip-chip-grid" id="employee-tip-options-modal">
        <button type="button" class="tip-chip" data-tip="0">Sin propina</button>
        <button type="button" class="tip-chip" data-tip="5">5%</button>
        <button type="button" class="tip-chip" data-tip="10">10%</button>
        <button type="button" class="tip-chip" data-tip="15">15%</button>
        <button type="button" class="tip-chip" data-tip="20">20%</button>
      </div>

      <div class="modal-footer" style="margin-top: 1.5rem; display: flex; justify-content: flex-end; gap: 0.75rem">
        <button type="button" class="btn btn--outline" id="cancel-employee-tip">Omitir</button>
        <button type="submit" class="btn btn--primary">Continuar</button>
      </div>
    </form>
  </div>
</div>

<!-- Modal de entrega de ticket (aparece despu√©s de propina) -->
<div class="modal" id="employee-ticket-modal">
  <div class="modal-content" style="max-width: 480px">
    <div class="modal-header" style="justify-content: space-between">
      <h3>
        Entrega del ticket
        <span id="employee-ticket-session-label"
          title="Cuenta (ID de sesi√≥n): Una sesi√≥n puede contener m√∫ltiples √≥rdenes"></span>
      </h3>
      <button type="button" class="modal-close" id="close-employee-ticket">√ó</button>
    </div>
    <form id="employee-ticket-form">
      <p style="color: #475569; font-weight: 600">Vista previa del ticket</p>
      <div id="ticket-preview-container" class="ticket-preview" style="
          margin: 1rem 0;
          padding: 1rem;
          background: #f8fafc;
          border: 1px solid #e2e8f0;
          border-radius: 8px;
          max-height: 300px;
          overflow-y: auto;
          font-family: monospace;
          font-size: 0.9rem;
        ">
        <!-- Ticket content will be injected here -->
        <div style="text-align: center; color: #94a3b8">Cargando vista previa...</div>
      </div>

      <p style="color: #475569; font-weight: 600; margin-top: 1.5rem">
        ¬øC√≥mo deseas entregar el ticket?
      </p>
      <div class="ticket-options" style="margin-top: 1rem">
        <label><input type="radio" name="ticket-delivery" value="physical" checked /> Entregar
          impreso</label>
        <label><input type="radio" name="ticket-delivery" value="digital" /> Enviar por email</label>
      </div>
      <input type="email" id="ticket-email-input" placeholder="cliente@ejemplo.com"
        style="display: none; margin-top: 0.5rem" />

      <div class="modal-footer" style="margin-top: 1.5rem; display: flex; justify-content: flex-end; gap: 0.75rem">
        <button type="button" class="btn btn--outline" id="cancel-employee-ticket">Omitir</button>
        <button type="submit" class="btn btn--primary">Finalizar</button>
      </div>
    </form>
  </div>
</div>

<!-- Modal para reenviar ticket por email -->
<div class="modal" id="resend-ticket-modal">
  <div class="modal-content" style="max-width: 480px">
    <div class="modal-header" style="justify-content: space-between">
      <h3>Reenviar ticket <span id="resend-ticket-session-label"></span></h3>
      <button type="button" class="modal-close" id="close-resend-ticket">√ó</button>
    </div>
    <form id="resend-ticket-form">
      <p class="modal-hint">
        Por favor ingresa el correo electr√≥nico del cliente para reenviar el ticket:
      </p>
      <input type="email" id="resend-ticket-email" placeholder="cliente@ejemplo.com" required style="
          width: 100%;
          padding: 0.75rem;
          margin-top: 1rem;
          border: 1px solid #cbd5e1;
          border-radius: 0.5rem;
          font-size: 1rem;
        " />

      <div class="modal-footer" style="margin-top: 1.5rem; display: flex; justify-content: flex-end; gap: 0.75rem">
        <button type="button" class="btn btn--outline" id="cancel-resend-ticket">Cancelar</button>
        <button type="submit" class="btn btn--primary">Enviar</button>
      </div>
    </form>
  </div>
</div>

<!-- Modal para crear/editar mesa -->
<div class="modal" id="table-modal">
  <div class="modal-content" style="max-width: 600px">
    <div class="modal-header" style="justify-content: space-between">
      <h3 id="table-modal-title">Crear Mesa</h3>
      <button type="button" class="modal-close" id="close-table-modal">√ó</button>
    </div>
    <form id="table-form">
      <input type="hidden" id="table-id" />
      <p class="modal-hint">Por favor completa la informaci√≥n de la mesa:</p>
      <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1.25rem; margin-top: 1rem">
        <label style="display: flex; flex-direction: column; gap: 0.5rem">
          <span style="font-weight: 600; color: #1e293b">N√∫mero/Nombre *</span>
          <input type="text" id="table-number" required placeholder="Ej. 1, 12 (se formatea a M01, M12)"
            style="padding: 0.75rem; border: 2px solid #e2e8f0; border-radius: 8px; font-size: 1rem" />
        </label>

        <label style="display: flex; flex-direction: column; gap: 0.5rem">
          <span style="font-weight: 600; color: #1e293b">√Årea/Sal√≥n *</span>
          <select id="table-area" required style="
              padding: 0.75rem;
              border: 2px solid #e2e8f0;
              border-radius: 8px;
              font-size: 1rem;
              cursor: pointer;
            ">
            <option value="">Seleccionar √°rea</option>
          </select>
        </label>

        <label style="display: flex; flex-direction: column; gap: 0.5rem">
          <span style="font-weight: 600; color: #1e293b">Capacidad *</span>
          <input type="number" id="table-capacity" required min="1" value="4"
            style="padding: 0.75rem; border: 2px solid #e2e8f0; border-radius: 8px; font-size: 1rem" />
        </label>

        <label style="display: flex; flex-direction: column; gap: 0.5rem">
          <span style="font-weight: 600; color: #1e293b">Forma</span>
          <select id="table-shape" style="
              padding: 0.75rem;
              border: 2px solid #e2e8f0;
              border-radius: 8px;
              font-size: 1rem;
              cursor: pointer;
            ">
            <option value="round">Redonda</option>
            <option value="square">Cuadrada</option>
            <option value="rectangular">Rectangular</option>
          </select>
        </label>
      </div>

      <div style="margin-top: 1.25rem">
        <label style="display: flex; flex-direction: column; gap: 0.5rem">
          <span style="font-weight: 600; color: #1e293b">Notas</span>
          <textarea id="table-notes" rows="3" placeholder="Notas adicionales sobre esta mesa" style="
              padding: 0.75rem;
              border: 2px solid #e2e8f0;
              border-radius: 8px;
              font-size: 1rem;
              resize: vertical;
            "></textarea>
        </label>
      </div>

      <div class="modal-footer" style="margin-top: 2rem; display: flex; justify-content: flex-end; gap: 0.75rem">
        <button type="button" class="btn btn--outline" id="cancel-table">Cancelar</button>
        <button type="submit" class="btn btn--primary">Guardar</button>
      </div>
    </form>
  </div>
</div>

<!-- Modal para crear/editar √°rea -->
<div class="modal" id="area-modal">
  <div class="modal-content" style="max-width: 600px">
    <div class="modal-header" style="justify-content: space-between">
      <h3 id="area-modal-title">Crear √Årea/Sal√≥n</h3>
      <button type="button" class="modal-close" id="close-area-modal">√ó</button>
    </div>
    <form id="area-form">
      <input type="hidden" id="area-id" />
      <p class="modal-hint">Por favor completa la informaci√≥n del √°rea/sal√≥n:</p>
      <div style="display: flex; flex-direction: column; gap: 1.25rem; margin-top: 1rem">
        <label style="display: flex; flex-direction: column; gap: 0.5rem">
          <span style="font-weight: 600; color: #1e293b">Nombre del √°rea *</span>
          <input type="text" id="area-name" required placeholder="Ej. Interior, Terraza, VIP, Bar"
            style="padding: 0.75rem; border: 2px solid #e2e8f0; border-radius: 8px; font-size: 1rem" />
        </label>

        <label style="display: flex; flex-direction: column; gap: 0.5rem">
          <span style="font-weight: 600; color: #1e293b">Prefijo</span>
          <input type="text" id="area-prefix" maxlength="3" placeholder="Ej. V para VIP, R para Roof"
            style="padding: 0.75rem; border: 2px solid #e2e8f0; border-radius: 8px; font-size: 1rem" />
          <small style="color: #64748b">Se usa para nombrar mesas como V-M01, R-M02, etc.</small>
        </label>

        <label style="display: flex; flex-direction: column; gap: 0.5rem">
          <span style="font-weight: 600; color: #1e293b">Descripci√≥n</span>
          <textarea id="area-description" rows="3" placeholder="Descripci√≥n opcional del √°rea" style="
              padding: 0.75rem;
              border: 2px solid #e2e8f0;
              border-radius: 8px;
              font-size: 1rem;
              resize: vertical;
            "></textarea>
        </label>

        <label style="display: flex; flex-direction: column; gap: 0.5rem">
          <span style="font-weight: 600; color: #1e293b">Color de identificaci√≥n</span>
          <div style="display: flex; gap: 0.75rem; align-items: center">
            <input type="color" id="area-color" value="#ff6b35" style="
                width: 60px;
                height: 40px;
                border: 2px solid #e2e8f0;
                border-radius: 8px;
                cursor: pointer;
              " />
            <span style="color: #64748b; font-size: 0.875rem">Elige un color para identificar visualmente este √°rea en
              el mapa de mesas</span>
          </div>
        </label>

        <div>
          <div style="display: flex; flex-wrap: wrap; gap: 0.75rem; align-items: center">
            <span style="font-weight: 600; color: #1e293b">Boceto del √°rea</span>
            <div style="display: inline-flex; gap: 0.5rem; align-items: center">
              <button type="button" class="btn btn--small btn--secondary draw-mode-btn active" data-draw-mode="pen">
                ‚úèÔ∏è
              </button>
              <button type="button" class="btn btn--small btn--secondary draw-mode-btn" data-draw-mode="line">
                üìè
              </button>
              <button type="button" class="btn btn--small btn--secondary draw-mode-btn" data-draw-mode="rect">
                ‚ñ≠
              </button>
              <button type="button" class="btn btn--small btn--secondary draw-mode-btn" data-draw-mode="circle">
                ‚óØ
              </button>
            </div>
            <label style="
                display: inline-flex;
                align-items: center;
                gap: 0.5rem;
                font-size: 0.85rem;
                color: #475569;
              ">
              Color
              <input type="color" id="area-draw-color" value="#475569" style="
                  width: 40px;
                  height: 32px;
                  border: 2px solid #e2e8f0;
                  border-radius: 8px;
                  cursor: pointer;
                " />
            </label>
            <button type="button" class="btn btn--small btn--outline" id="clear-canvas-btn">
              Limpiar
            </button>
          </div>
          <canvas id="area-background-canvas" width="520" height="260" style="
              width: 100%;
              margin-top: 0.75rem;
              border: 2px dashed #e2e8f0;
              border-radius: 12px;
              background: #f8fafc;
            "></canvas>
          <small style="color: #64748b; display: block; margin-top: 0.5rem">
            Este boceto se usa como fondo en la vista de mesas para diagramar el espacio.
          </small>
        </div>
      </div>

      <div class="modal-footer" style="margin-top: 2rem; display: flex; justify-content: flex-end; gap: 0.75rem">
        <button type="button" class="btn btn--outline" id="cancel-area">Cancelar</button>
        <button type="submit" class="btn btn--primary">Guardar</button>
      </div>
    </form>
  </div>
</div>


<!-- Table Assignment Modal - Modern POS Design -->
<div id="table-assignment-modal" class="modal">
  <div class="table-assignment-modal__overlay">
    <div class="table-assignment-modal__panel">
      <div class="table-assignment-modal__header">
        <div>
          <h2 class="table-assignment-modal__title">Gestionar Mesas</h2>
          <p class="table-assignment-modal__subtitle">Asigna o libera mesas desde un solo lugar</p>
        </div>
        <div class="table-assignment-modal__header-actions">
          <button type="button" id="close-table-assignment" class="btn btn--secondary">‚úï</button>
        </div>
      </div>

      <div class="table-assignment-modal__body">
        <div>
          <h3 class="text-sm font-semibold text-gray-700 uppercase tracking-wide mb-3">
            Mesas Asignadas
          </h3>
          <div id="my-tables-container" class="assigned-tables-list">
            <div class="border-2 border-dashed border-gray-200 rounded-xl px-4 py-6 text-center">
              <p class="text-sm text-gray-500" style="margin: 0">No hay mesas asignadas a√∫n</p>
            </div>
          </div>
        </div>

        <div>
          <div class="flex items-center justify-between mb-3">
            <h3 class="text-sm font-semibold text-gray-700 uppercase tracking-wide">
              Mesas Disponibles
            </h3>
            <select id="zone-filter"
              class="rounded-full border border-gray-200 px-4 py-2 text-sm font-medium text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-orange-500 focus:border-transparent transition-all cursor-pointer">
              <option value="all">Todas las zonas</option>
            </select>
          </div>

          <div id="available-tables-container" class="available-tables-grid">
            <div class="col-span-full text-center py-8 text-gray-400">
              <p class="text-sm" style="margin: 0">Cargando mesas...</p>
            </div>
          </div>
        </div>

        <!-- Auto-assign preference -->
        <div style="margin-top: 1.5rem; padding-top: 1.5rem; border-top: 1px solid #e5e7eb">
          <div class="flex items-center gap-3">
            <label class="flex items-center gap-2 cursor-pointer">
              <input type="checkbox" id="auto-assign-table-on-order-accept" checked
                style="width: 18px; height: 18px; cursor: pointer; accent-color: #ea580c" />
              <span class="text-sm font-medium text-gray-700">Auto-asignar mesa al aceptar orden</span>
            </label>
            <span class="text-xs text-gray-500"
              title="Cuando aceptas una orden de una mesa, autom√°ticamente se te asignar√° esa mesa y todas sus √≥rdenes pendientes">
              ‚ÑπÔ∏è
            </span>
          </div>
          <p class="text-xs text-gray-500 mt-1 ml-6" style="margin-bottom: 0">
            Al aceptar una orden, se te asignar√° autom√°ticamente toda la mesa y sus √≥rdenes
            pendientes
          </p>
        </div>
      </div>

      <div class="table-assignment-modal__footer">
        <button type="button" id="assign-selected-tables" disabled class="btn btn--secondary">
          Asignar mesa
        </button>
        <button type="button" id="cancel-table-assignment" class="btn btn--secondary">
          Cancelar
        </button>
        <button type="button" id="accept-table-assignment-footer" class="btn btn--primary">
          ‚úì Aceptar
        </button>
      </div>
    </div>
  </div>
</div>

<!-- Transfer Request Modal -->
<div id="transfer-request-modal" class="modal">
  <div class="modal-content modal-content--medium">
    <div class="modal-header">
      <h5 class="modal-title">Solicitud de Transferencia</h5>
      <button type="button" class="btn-close" id="close-transfer-modal"></button>
    </div>
    <div class="modal-body">
      <p id="transfer-request-message" class="mb-3"></p>
      <p id="transfer-request-note" class="text-muted mb-3" style="display: none"></p>
      <div class="form-check">
        <input class="form-check-input" type="checkbox" id="transfer-orders-checkbox" />
        <label class="form-check-label" for="transfer-orders-checkbox">
          ¬øTransferir √≥rdenes existentes?
        </label>
      </div>
    </div>
    <div class="modal-footer">
      <button type="button" class="btn btn-danger" id="reject-transfer-btn">Rechazar</button>
      <button type="button" class="btn btn-success" id="accept-transfer-btn">Aceptar</button>
    </div>
  </div>
</div>

<!-- Footer for waiter panel -->
<footer class="waiter-panel-footer" style="
    background: white;
    border-top: 1px solid #e5e7eb;
    padding: 1rem 2rem;
    text-align: center;
    color: #64748b;
    font-size: 0.875rem;
    margin-top: auto;
    flex-shrink: 0;
  ">
  <div class="footer-links"
    style="display: flex; justify-content: center; gap: 2rem; align-items: center; flex-wrap: wrap">
    <span style="color: #94a3b8">¬© 2025 Cafeter√≠a-Test</span>
    <a href="javascript:void(0)" class="footer-homepage-link" style="
        display: inline-flex;
        align-items: center;
        gap: 0.5rem;
        color: #64748b;
        text-decoration: none;
        transition: color 0.2s;
        padding: 0.5rem 1rem;
        border-radius: 6px;
        border: 1px solid #e5e7eb;
      ">
      <svg class="footer-homepage-icon" width="16" height="16" fill="none" viewBox="0 0 24 24" stroke="currentColor">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
          d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6" />
      </svg>
      <span>Establecer como inicio</span>
    </a>
  </div>
</footer>

{% endif %}

<!-- SECCI√ìN BRANDING (NUEVA) -->

<!-- SECCIONES ADMINISTRACI√ìN ADICIONALES -->
{% if has_permission(Permission.CONFIG_EDIT) %}




{% endif %} {% if has_permission(Permission.EMPLOYEES_VIEW) %}


<section class="section" id="empleados-section" data-menu-title="Empleados" data-menu-group="ADMINISTRACI√ìN"
  data-icon="users-round">
  <header class="section__header" style="display: flex; justify-content: space-between; align-items: center;">
    <div>
      <h2>üë• Gesti√≥n de Empleados</h2>
      <p>Administra los usuarios y roles del sistema.</p>
    </div>
    <button id="btn-add-employee" class="btn btn--white" style="color: #333; font-weight: 600;">
      <span style="margin-right:0.5rem">‚ûï</span> Nuevo Empleado
    </button>
  </header>

  <div class="table-wrapper">
    <table class="table" id="employees-table">
      <thead>
        <tr>
          <th>Nombre</th>
          <th>Email</th>
          <th>Rol</th>
          <th>Estado</th>
          <th>Acciones</th>
        </tr>
      </thead>
      <tbody>
        <!-- JS inyectar√° filas aqu√≠ -->
        <tr>
          <td colspan="5" style="text-align:center; padding: 3rem; color: #64748b;">
            Cargando empleados...
          </td>
        </tr>
      </tbody>
    </table>
  </div>
</section>

<!-- Modal CRUD Empleado -->
<div class="modal" id="employee-modal"
  style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); z-index:1000; align-items:center; justify-content:center;">
  <div class="modal-content"
    style="background:white; padding:2rem; border-radius:16px; width:100%; max-width:500px; box-shadow:0 10px 25px rgba(0,0,0,0.2);">
    <div class="modal-header"
      style="display:flex; justify-content:space-between; align-items:center; margin-bottom:1.5rem;">
      <h3 class="modal-title" style="margin:0; font-size:1.5rem; font-weight:700;">Nuevo Empleado</h3>
      <button class="close-modal-btn"
        style="background:none; border:none; font-size:1.5rem; cursor:pointer;">&times;</button>
    </div>
    <form id="employee-form">
      <div style="margin-bottom:1rem;">
        <label style="display:block; font-weight:600; margin-bottom:0.5rem;">Nombre</label>
        <input type="text" id="emp-name" class="input"
          style="width:100%; padding:0.75rem; border:1px solid #e2e8f0; border-radius:8px;" required>
      </div>
      <div style="margin-bottom:1rem;">
        <label style="display:block; font-weight:600; margin-bottom:0.5rem;">Email</label>
        <input type="email" id="emp-email" class="input"
          style="width:100%; padding:0.75rem; border:1px solid #e2e8f0; border-radius:8px;" required>
      </div>
      <div style="margin-bottom:1rem;">
        <label style="display:block; font-weight:600; margin-bottom:0.5rem;">Rol</label>
        <select id="emp-role" class="select"
          style="width:100%; padding:0.75rem; border:1px solid #e2e8f0; border-radius:8px;" required>
          <option value="waiter">Mesero</option>
          <option value="chef">Cocinero</option>
          <option value="cashier">Cajero</option>
          <option value="supervisor">Supervisor</option>
          <option value="admin_roles">Administrador</option>
        </select>
      </div>
      <div style="margin-bottom:1.5rem;">
        <label style="display:block; font-weight:600; margin-bottom:0.5rem;">Contrase√±a</label>
        <input type="password" id="emp-password" class="input"
          style="width:100%; padding:0.75rem; border:1px solid #e2e8f0; border-radius:8px;" placeholder="Contrase√±a">
        <small style="color:#64748b; font-size:0.85rem;">Dejar vac√≠o si no se desea cambiar (al editar)</small>
      </div>
      <div class="form-actions" style="display:flex; gap:1rem; justify-content:flex-end;">
        <button type="button" class="btn btn--secondary close-modal-btn"
          style="background:#f1f5f9; padding:0.75rem 1.5rem; border-radius:8px; border:none; cursor:pointer;">Cancelar</button>
        <button type="submit" class="btn btn--primary"
          style="background:#0f172a; color:white; padding:0.75rem 1.5rem; border-radius:8px; border:none; cursor:pointer;">Guardar</button>
      </div>
    </form>
  </div>
</div>



<style>
  /* Global Override to fix "shrinked" config forms */
  .section,
  .section>div,
  .config-container,
  form {
    max-width: 100% !important;
  }

  .input,
  .select,
  textarea {
    max-width: 100% !important;
  }

  #business-info {
    max-width: 100% !important;
  }
</style>
{% endif %}

<!-- SECCI√ìN ROLES Y PERMISOS UNIFICADA -->
{% if has_permission(Permission.EMPLOYEES_MANAGE_PERMISSIONS) %}
<section class="section" id="role-permissions" data-menu-title="Roles y Permisos" data-menu-group="SEGURIDAD"
  data-icon="shield-check">
  <header class="section__header">
    <div class="header-content">
      <h2>üîë Gesti√≥n de Roles</h2>
      <p>Define los roles del sistema y sus permisos.</p>
    </div>
    <button class="btn btn--primary" id="btn-create-role">
      <span class="btn__icon">‚ûï</span> Nuevo Rol
    </button>
  </header>

  <div class="table-container card">
    <table class="table">
      <thead>
        <tr>
          <th>Rol</th>
          <th>Tipo</th>
          <th>Descripci√≥n</th>
          <th>Permisos</th>
          <th>Acciones</th>
        </tr>
      </thead>
      <tbody id="roles-table-body">
        <tr>
          <td colspan="5" class="text-center p-4">Cargando roles...</td>
        </tr>
      </tbody>
    </table>
  </div>
</section>

<!-- Modal Gesti√≥n de Roles -->
<dialog id="roles-modal" class="modal">
  <div class="modal__content modal__content--large">
    <header class="modal__header">
      <h3 id="roles-modal-title">Gesti√≥n de Rol</h3>
      <button type="button" class="btn-icon close-roles-modal">‚úï</button>
    </header>
    <form id="roles-form">
      <div class="modal__body">
        <div class="form-grid">
          <div class="form-group">
            <label for="role_name" class="form-label">Nombre T√©cnico (ID)</label>
            <input type="text" name="name" id="role_name" class="form-input" required pattern="[a-zA-Z0-9_]+"
              placeholder="ej: gerente_turno">
            <p class="form-hint">Usado internamente. Solo letras, n√∫meros y guiones bajos.</p>
          </div>
          <div class="form-group">
            <label for="role_display_name" class="form-label">Nombre Visible</label>
            <input type="text" name="display_name" id="role_display_name" class="form-input" required
              placeholder="ej: Gerente de Turno">
          </div>
          <div class="form-group full-width">
            <label for="role_description" class="form-label">Descripci√≥n</label>
            <textarea name="description" id="role_description" class="form-input" rows="2"></textarea>
          </div>
        </div>

        <div class="permissions-section mt-6">
          <h4 class="text-lg font-semibold mb-3 border-b pb-2">Permisos Asignados</h4>
          <div id="roles-permissions-container" class="permissions-grid bg-gray-50 dark:bg-gray-800 p-4 rounded-lg"
            style="max-height: 400px; overflow-y: auto;">
            <div class="text-center text-gray-500">Cargando cat√°logo de permisos...</div>
          </div>
        </div>
      </div>

      <footer class="modal__footer">
        <button type="button" class="btn btn--secondary close-roles-modal">Cancelar</button>
        <button type="submit" class="btn btn--primary" id="roles-save-btn">Guardar Rol</button>
      </footer>
    </form>
  </div>
</dialog>
{% endif %}


<!-- SECCI√ìN FEEDBACK -->
{% if app_context|lower != 'cashier' %}
<section class="section" id="feedback-section" data-menu-title="Feedback" data-menu-group="FEEDBACK"
  data-icon="message-square">
  <header class="section__header">
    <h2>‚≠ê Feedback de Clientes</h2>
    <p>Revisa calificaciones y comentarios.</p>
  </header>
  <div class="feedback-container">
    <div class="feedback-stats-summary" style="margin-bottom: 2rem;">
      <div class="stat-card"
        style="background: white; padding: 1.5rem; border-radius: 12px; border: 1px solid #e2e8f0; display: flex; align-items: center; gap: 1rem;">
        <div class="stat-icon"
          style="background: #fef3c7; color: #d97706; width: 48px; height: 48px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 1.5rem;">
          ‚≠ê</div>
        <div>
          <h3 style="margin: 0; font-size: 1.5rem; font-weight: 700; color: #1e293b;">4.8</h3>
          <p style="margin: 0; color: #64748b; font-size: 0.875rem;">Calificaci√≥n Promedio</p>
        </div>
      </div>
    </div>

    <div class="feedback-list" id="feedback-list-container">
      <!-- Loading state -->
      <div style="text-align: center; padding: 3rem; color: #64748b;">
        Cargando comentarios...
      </div>
    </div>
  </div>
</section>
{% endif %}

<script>
  document.addEventListener('DOMContentLoaded', function () {
    // Simple fetch for feedback if endpoints exist, or mock for now as requested by user expectation
    // Since this is a view template, we'll set up the structure.
    // The actual data fetching would normally happen in dashboard.js or here.
  });
</script>

<!-- SECCIONES CONFIGURACI√ìN -->
{% if employee_role in ['super_admin'] %}
<section class="section" id="business-info" data-menu-title="Informaci√≥n del Negocio" data-menu-group="CONFIGURACI√ìN"
  data-icon="building">
  <header class="section__header">
    <h2>üè¢ Informaci√≥n del Negocio</h2>
    <p>Datos generales, direcci√≥n y contacto.</p>
  </header>
  <div class="empty-state">
    <div class="empty-state__icon">üöß</div>
    <h3>Secci√≥n en construcci√≥n</h3>
  </div>
</section>

<section class="section" id="business-hours" data-menu-title="Horarios de Atenci√≥n" data-menu-group="CONFIGURACI√ìN"
  data-icon="clock-4">
  <header class="section__header">
    <h2>üïí Horarios de Atenci√≥n</h2>
    <p>Configura los horarios de apertura y cierre.</p>
  </header>
  <div class="empty-state">
    <div class="empty-state__icon">üöß</div>
    <h3>Secci√≥n en construcci√≥n</h3>
  </div>
</section>

<section class="section" id="system-params" data-menu-title="Par√°metros del Sistema" data-menu-group="CONFIGURACI√ìN"
  data-icon="settings">
  <header class="section__header">
    <h2>‚öôÔ∏è Par√°metros del Sistema</h2>
    <p>Configuraciones t√©cnicas y preferencias globales.</p>
  </header>
  <div class="empty-state">
    <div class="empty-state__icon">üöß</div>
    <h3>Secci√≥n en construcci√≥n</h3>
  </div>
</section>

<section class="section" id="feedback-settings" data-menu-title="Feedback Settings" data-menu-group="CONFIGURACI√ìN"
  data-icon="settings-2">
  <header class="section__header">
    <h2>üí¨ Configuraci√≥n de Feedback</h2>
    <p>Personaliza las preguntas y opciones de feedback.</p>
  </header>
  <div class="empty-state">
    <div class="empty-state__icon">üöß</div>
    <h3>Secci√≥n en construcci√≥n</h3>
  </div>
</section>
{% endif %}

{% endblock %} {% block scripts %}
<!-- Socket.io for real-time notifications (Disabled: Using Redis Polling) -->
<!-- <script src="{{ url_for('static', filename='assets/lib/socket.io.min.js') }}"></script> -->

<script>
  // Configuration and data for dashboard.js
  window.APP_CONFIG = {
    assets_css_employees: "{{ assets_css_employees }}",
    assets_js_employees: "{{ assets_js_employees }}",
    restaurant_assets: "{{ restaurant_assets }}",
    items_per_page: {{ items_per_page }}
  };
  window.APP_DATA = {
    categories: {{ menu.categories | tojson }},
    orders: {{ session_orders | tojson }},
    employee_id: {{ employee_id | tojson }},
    employee_name: {{ employee_name | tojson }},
    employee_role: {{ employee_role | tojson }},
    role_capabilities: {{ role_capabilities | tojson }},
    can_process_payments: {{ 'true' if can_process_payments else 'false' }},
    day_periods: {{ day_periods | tojson }},
    paid_orders_retention_minutes: {{ paid_orders_retention_minutes }},
    payment_action_delay_seconds: {{ payment_action_delay_seconds }},
    table_base_prefix: {{ table_base_prefix | tojson }}
  };

  // Waiter panel data
  {% if has_permission(Permission.ORDERS_VIEW) %}
  window.WAITER_ORDERS_DATA = {{ waiter_orders | tojson }};
  {% endif %}

  // Cashier panel data
  {% if employee_role in ['super_admin', 'admin_roles', 'cashier'] %}
  window.CASHIER_ORDERS_DATA = {{ waiter_orders | tojson }};
  {% endif %}

  // Kitchen panel data
  {% if has_permission(Permission.KITCHEN_VIEW) %}
  window.KITCHEN_ORDERS_DATA = {{ kitchen_orders | tojson }};
  {% endif %}
</script>
<script src="{{ assets_js_employees }}/pagination.js"></script>
<script>
  window.__PRONTO_TS_ORDERS_BOARD__ = true;
  window.__PRONTO_TS_WAITER__ = true;
  window.__PRONTO_TS_KITCHEN__ = true;
  window.__PRONTO_TS_CATALOG__ = true;
  window.__PRONTO_TS_PAYMENTS__ = true;
  window.__PRONTO_TS_MODIFIERS__ = true;
  window.__PRONTO_TS_AREAS__ = true;
  window.__PRONTO_TS_TABLES__ = true;
  window.__PRONTO_TS_CONFIG__ = true;
  window.__PRONTO_TS_PROMOTIONS__ = true;
  window.__PRONTO_TS_RECOMMENDATIONS__ = true;
  window.__PRONTO_TS_REPORTS__ = true;
  window.__PRONTO_TS_CUSTOMERS__ = true;
  window.__PRONTO_TS_EMPLOYEE_EVENTS__ = true;
  window.__PRONTO_TS_ROLES__ = true;
  window.__PRONTO_TS_SESSIONS__ = true;
  window.__PRONTO_TS_PREP_TIMES__ = true;
  window.__PRONTO_TS_SCHEDULES__ = true;
</script>

<!-- Modern POS Card Renderer -->
<script>
  (function () {
    'use strict';

    // Wait for DOM and waiter board to be ready
    document.addEventListener('DOMContentLoaded', function () {
      // Sync modern tabs with legacy logic
      initializeSegmentedControl();

      // Force table view and disable card rendering hooks
      window.renderOrderCards = () => { };
      localStorage.setItem('waiter_view_mode', 'table');
      document.querySelectorAll('.orders-grid').forEach((grid) => (grid.style.display = 'none'));
      document
        .querySelectorAll('.table-wrapper')
        .forEach((table) => (table.style.display = 'block'));
    });

    function initializeSegmentedControl() {
      const modernTabs = document.querySelectorAll('.waiter-tab');
      const legacyTabs = document.querySelectorAll('.waiter-toolbar__tabs .waiter-tab');

      modernTabs.forEach((button) => {
        button.addEventListener('click', function () {
          const tab = this.dataset.tab;

          // Update modern tabs active state
          modernTabs.forEach((btn) => btn.classList.remove('active'));
          this.classList.add('active');

          // Also click the corresponding legacy tab to trigger existing logic
          const legacyTab = Array.from(legacyTabs).find((t) => t.dataset.tab === tab);
          if (legacyTab) {
            legacyTab.click();
          }
        });
      });
    }

    function initializeCardRendering() {
      console.log('[POS Cards] Initializing card rendering...');

      // Hook into the existing waiter board rendering
      const originalRenderMethod = window.renderWaiterOrders;

      if (typeof originalRenderMethod === 'function') {
        window.renderWaiterOrders = function (...args) {
          // Call original method
          originalRenderMethod.apply(this, args);

          // Then render cards
          renderOrderCards();
        };
      }

      // Initial render
      renderOrderCards();

      // Re-render on data updates
      setInterval(renderOrderCards, 5000);
    }

    function renderOrderCards() {
      // Get active tab
      const activeTab =
        document.querySelector('.waiter-tabs-container .waiter-tab.active')?.dataset.tab ||
        'active';

      // Get grid container
      const gridId = `orders-grid-${activeTab}`;
      const gridContainer = document.getElementById(gridId);

      if (!gridContainer) return;

      // Get table rows from legacy table
      const tableBody =
        activeTab === 'active'
          ? document.getElementById('waiter-orders')
          : activeTab === 'tracking'
            ? document.getElementById('tracking-orders')
            : document.getElementById('paid-orders');

      if (!tableBody) return;

      const rows = Array.from(tableBody.querySelectorAll('tr')).filter((row) => {
        return row.dataset.orderId && row.style.display !== 'none';
      });

      if (rows.length === 0) {
        gridContainer.innerHTML = `
                <div class="orders-empty">
                    <div class="orders-empty__icon">üìã</div>
                    <div class="orders-empty__title">No hay √≥rdenes</div>
                    <div class="orders-empty__text">Las √≥rdenes aparecer√°n aqu√≠ cuando los clientes realicen pedidos</div>
                </div>
            `;
        return;
      }

      // Render cards
      gridContainer.innerHTML = rows.map((row) => createOrderCard(row, activeTab)).join('');

      // Load items for large mode cards
      loadItemsForLargeCards();
    }

    // Load order items for cards in large mode
    async function loadItemsForLargeCards() {
      const grid = document.querySelector('.orders-grid.size-large');
      if (!grid) return; // Only load if in large mode

      const previewContainers = document.querySelectorAll('.order-card__items-preview');

      for (const container of previewContainers) {
        const orderId = container.dataset.orderId;
        if (!orderId) continue;

        try {
          const detail = await getOrderDetails(parseInt(orderId));
          const items = Array.isArray(detail?.items) ? detail.items : [];

          if (items.length === 0) {
            container.innerHTML = `
                        <div class="order-card__items-preview-title">Productos</div>
                        <div class="order-card__items-loading">Sin items</div>
                    `;
            continue;
          }

          // Show first 4 items
          const displayItems = items.slice(0, 4);
          const remainingCount = items.length - 4;

          const itemsHtml = displayItems
            .map((item) => {
              const qty = item.quantity || 1;
              const name = escapeAttr(item.name || 'Producto');
              return `
                        <div class="order-card__item-row">
                            <div class="order-card__item-name">
                                <span class="order-card__item-quantity">${qty}x</span> ${name}
                            </div>
                        </div>
                    `;
            })
            .join('');

          const moreHtml =
            remainingCount > 0
              ? `
                    <div class="order-card__items-more">+ ${remainingCount} producto${remainingCount !== 1 ? 's' : ''} m√°s...</div>
                `
              : '';

          container.innerHTML = `
                    <div class="order-card__items-preview-title">Productos</div>
                    <div class="order-card__items-list">
                        ${itemsHtml}
                    </div>
                    ${moreHtml}
                `;
        } catch (error) {
          console.error(`Error loading items for order ${orderId}:`, error);
          container.innerHTML = `
                    <div class="order-card__items-preview-title">Productos</div>
                    <div class="order-card__items-loading">Error al cargar</div>
                `;
        }
      }
    }

    function escapeAttr(value) {
      return String(value !== null && value !== undefined ? value : '')
        .replace(/&/g, '&amp;')
        .replace(/"/g, '&quot;')
        .replace(/</g, '&lt;')
        .replace(/>/g, '&gt;')
        .replace(/'/g, '&#39;');
    }

    function sanitizeBasePrefix(value) {
      const cleaned = (value || 'M').replace(/[^A-Za-z0-9]/g, '').toUpperCase();
      return cleaned.slice(0, 3) || 'M';
    }

    const TABLE_BASE_PREFIX = sanitizeBasePrefix(window.APP_DATA?.table_base_prefix || 'M');

    function normalizePrefix(prefix = '') {
      const clean = prefix
        .replace(/[^a-zA-Z]/g, '')
        .trim()
        .toUpperCase();
      return clean ? clean.charAt(0) : '';
    }

    function inferZonePrefix(label = '') {
      const normalized = (label || '').toLowerCase();
      if (!normalized) return '';
      if (normalized.includes('vip')) return 'V';
      if (normalized.includes('roof')) return 'R';
      if (normalized.includes('terraza') || normalized.includes('terrace')) return 'T';
      if (normalized.includes('bar') || normalized.includes('barra')) return 'B';
      if (
        normalized.includes('interior') ||
        normalized.includes('salon') ||
        normalized.includes('comedor')
      )
        return 'I';
      if (normalized.startsWith('mesa') || normalized.startsWith('table')) return '';
      if (/^m[\s-]?\d/.test(normalized)) return '';
      return label.trim().charAt(0).toUpperCase() || '';
    }

    function formatTableCode(rawNumber = '', zonePrefix = '') {
      const digitsMatch = (rawNumber || '').match(/(\d+)/);
      const numericPart = (digitsMatch ? digitsMatch[1] : '01').padStart(2, '0');
      const baseCode = `${TABLE_BASE_PREFIX}${numericPart}`;
      const prefix = normalizePrefix(zonePrefix) || inferZonePrefix(rawNumber);
      return prefix ? `${prefix}-${baseCode}` : baseCode;
    }

    function normalizeTableForCompare(value) {
      return formatTableCode(value).replace(/[^A-Z0-9]/g, '');
    }

    function getTablePrefixFromCache(tableNumber) {
      if (tablesCache === null && !tablesPromise) {
        // Trigger async load so next renders can use prefixes from cat√°logo de mesas
        void loadTablesCatalog().then((tables) => {
          tablesCache = tables;
          renderOrderCards();
          return tables;
        });
      }
      if (Array.isArray(tablesCache)) {
        const normalizedTarget = normalizeTableForCompare(tableNumber);
        const match = tablesCache.find(
          (table) => normalizeTableForCompare(table.table_number) === normalizedTarget
        );
        if (match) {
          return normalizePrefix(
            match.prefix || match.zone_prefix || inferZonePrefix(match.zone || '')
          );
        }
      }
      return '';
    }

    function createOrderCard(row, tab) {
      const orderId = row.dataset.orderId;
      const status = row.dataset.status;
      const tableCellValue = row.querySelector('td:nth-child(3)')?.textContent?.trim() || '';
      const rawTableNumber = row.dataset.tableNumber || tableCellValue || 'N/A';
      if (!row.dataset.tableNumber && rawTableNumber) {
        row.dataset.tableNumber = rawTableNumber;
      }
      const tablePrefix = getTablePrefixFromCache(rawTableNumber);
      const tableNumber = formatTableCode(rawTableNumber, tablePrefix);
      row.dataset.tableNumberRaw = rawTableNumber;
      const customerName = row.dataset.customerName || 'Cliente';
      const customerId = row.dataset.customerId || '';
      const customerEmail = row.dataset.customerEmail || '';
      const customerPhone = row.dataset.customerPhone || '';
      const customerDescription = row.dataset.customerDescription || '';
      const customerAvatar = row.dataset.customerAvatar || '';
      const waiterName = row.dataset.waiterName || 'Sin asignar';
      const notes = row.dataset.notes || '';
      const waiterNotes = row.dataset.waiterNotes || '';
      const sessionId = row.dataset.sessionId || '';
      const safeNotes = escapeAttr(notes);
      const safeWaiterNotes = escapeAttr(waiterNotes);

      // Get total from table cell (used for detail popover)
      const totalCell = row.querySelector('td:nth-child(6)');
      const totalText = totalCell ? totalCell.textContent.trim() : '$0.00';

      // Determine card urgency class
      let urgencyClass = '';
      const createdTime = row.dataset.createdAt;
      if (createdTime) {
        const elapsed = Date.now() - new Date(createdTime).getTime();
        if (elapsed > 30 * 60 * 1000) urgencyClass = 'urgent';
        else if (elapsed > 15 * 60 * 1000) urgencyClass = 'warning';
      }

      const isNewOrder = createdTime
        ? Date.now() - new Date(createdTime).getTime() < 3 * 60 * 1000
        : true;

      // Determine timer status
      let timerClass = 'normal';
      let timerText = '';
      if (createdTime) {
        const elapsed = Math.max(
          0,
          Math.floor((Date.now() - new Date(createdTime).getTime()) / 60000)
        );
        timerText = elapsed < 1 ? '0 min' : `${elapsed} min`;
        if (elapsed > 30) timerClass = 'urgent';
        else if (elapsed > 15) timerClass = 'warning';
      }
      const timerDisplay = timerText || '0 min';
      const timerClassName =
        timerClass !== 'normal' ? `order-card__waiter-time--${timerClass}` : '';

      // Get action buttons
      const actionsCell = row.querySelector('.actions');
      let actionButton = '';
      let actionTooltip = '';

      if (actionsCell) {
        const buttons = actionsCell.querySelectorAll('button');
        if (buttons.length > 0) {
          const firstButton = buttons[0];
          const buttonText = firstButton.textContent.trim();
          const buttonClass = firstButton.className.includes('success')
            ? 'primary'
            : firstButton.className.includes('warning')
              ? 'warning'
              : firstButton.className.includes('danger')
                ? 'danger'
                : 'secondary';
          const endpoint = firstButton.getAttribute('data-endpoint') || '';

          // Create tooltip based on button type
          if (buttonText.includes('Aceptar')) actionTooltip = 'Aceptar orden del cliente';
          else if (buttonText.includes('En cocina')) actionTooltip = 'Enviar orden a cocina';
          else if (buttonText.includes('Lista')) actionTooltip = 'Marcar como lista para servir';
          else if (buttonText.includes('Entregar')) actionTooltip = 'Marcar orden como entregada';
          else actionTooltip = buttonText;

          actionButton = `
                    <button class="order-card__action waiter-action ${buttonClass}" data-endpoint="${endpoint}" title="${actionTooltip}">
                        ${buttonText}
                    </button>
                `;
        }
      }

      // Is starred?
      const starBtn = row.querySelector('.star-btn');
      const isStarred = starBtn && starBtn.classList.contains('active');
      const statusLabel = row.dataset.statusDisplay || translateStatus(status);
      const safeCustomerName = escapeAttr(customerName);
      const orderCardClasses = [
        'order-card',
        urgencyClass,
        isStarred ? 'starred' : '',
        isNewOrder ? 'order-card--fresh' : '',
      ]
        .filter(Boolean)
        .join(' ');

      return `
            <div class="${orderCardClasses}" data-order-id="${orderId}"
                data-table-number="${escapeAttr(tableNumber)}"
                data-customer-name="${safeCustomerName}"
                data-customer-email="${escapeAttr(customerEmail)}"
                data-customer-phone="${escapeAttr(customerPhone)}"
                data-customer-description="${escapeAttr(customerDescription)}"
                data-customer-id="${escapeAttr(customerId)}"
                data-customer-avatar="${escapeAttr(customerAvatar)}"
                data-created-at="${escapeAttr(createdTime || '')}"
                data-total="${escapeAttr(totalText)}"
                data-notes="${safeNotes}"
                data-waiter-notes="${safeWaiterNotes}"
                data-session-id="${escapeAttr(sessionId)}"
                data-table-number-raw="${escapeAttr(rawTableNumber)}"
                data-status="${escapeAttr(status)}">
                <div class="order-card__header">
                    <div class="order-card__header-left">
                        <button class="order-card__table" type="button" data-table-info="${escapeAttr(tableNumber)}">
                            <span class="order-card__table-full">Mesa ${tableNumber}</span>
                            <span class="order-card__table-compact">${tableNumber}</span>
                        </button>
                    </div>
                    <div class="order-card__header-right">
                        <div class="order-card__header-timer ${timerClassName.replace('order-card__waiter-time--', 'order-card__header-timer--')}">
                            <svg class="timer-icon-compact" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <circle cx="12" cy="12" r="10"></circle>
                                <polyline points="12 6 12 12 16 14"></polyline>
                            </svg>
                            ${timerDisplay}
                        </div>
                    </div>
                    <button class="order-card__star ${isStarred ? 'active' : ''}" onclick="toggleTracking(${orderId}, this)" title="${isStarred ? 'Quitar de seguimiento' : 'Agregar a seguimiento'}">
                        ${isStarred ? '‚òÖ' : '‚òÜ'}
                    </button>
                </div>
                <div class="order-card__meta">
                    ${customerName !== 'Cliente' && customerId
          ? `
                    <button type="button" class="order-card__customer"
                        data-customer-profile="${escapeAttr(customerId)}"
                        data-customer-name="${safeCustomerName}"
                        data-customer-email="${escapeAttr(customerEmail)}"
                        data-customer-phone="${escapeAttr(customerPhone)}"
                        data-customer-description="${escapeAttr(customerDescription)}"
                        data-customer-avatar="${escapeAttr(customerAvatar)}">
                        <svg class="customer-icon" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path>
                            <circle cx="12" cy="7" r="4"></circle>
                        </svg>
                        ${customerName}
                    </button>
                    `
          : ''
        }
                </div>
                <div class="order-card__meta-row">
                    <span class="order-card__status-badge ${status}">${statusLabel}</span>
                    <span class="order-card__order-number"> ‚Ä¢ #${orderId}</span>
                    <div class="order-card__star-label ${isStarred ? 'active' : ''}">
                        ${isStarred ? '‚òÖ' : '‚òÜ'}
                    </div>
                </div>
                <div class="order-card__items-preview" data-order-id="${orderId}">
                    <div class="order-card__items-preview-title">Productos</div>
                    <div class="order-card__items-loading">Cargando items...</div>
                </div>
                <div class="order-card__body">
                    ${notes
          ? `
                        <div class="order-card__notes order-card__notes--customer">
                            <div class="order-card__notes-header">
                                <svg class="notes-icon" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"></path>
                                </svg>
                                <span class="order-card__notes-label">Cliente</span>
                            </div>
                            <p class="order-card__notes-text">${safeNotes}</p>
                        </div>
                    `
          : ''
        }
                    <div class="order-card__notes order-card__notes--waiter">
                        <div class="order-card__notes-header">
                            <svg class="notes-icon" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M12 20h9"></path>
                                <path d="M16.5 3.5a2.121 2.121 0 0 1 3 3L7 19l-4 1 1-4L16.5 3.5z"></path>
                            </svg>
                            <span class="order-card__notes-label">Notas del mesero</span>
                        </div>
                        <textarea
                            class="order-card__notes-input"
                            id="waiter-note-card-${orderId}"
                            data-order-note="${orderId}"
                            placeholder="Ej. Cliente con sombrero, mesa cerca ventana..."
                            title="Escribe notas sobre el cliente o pedido"
                        >${safeWaiterNotes}</textarea>
                    </div>
                </div>
                <div class="order-card__footer">
                    <div class="order-card__quick-actions">
                        <button type="button" class="order-card__icon-btn" data-order-detail="${orderId}" title="Ver detalle de la orden">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M4 19h16"></path>
                                <path d="M4 5h16"></path>
                                <rect x="4" y="9" width="16" height="6" rx="2"></rect>
                            </svg>
                        </button>
                        <button type="button" class="order-card__icon-btn" data-table-info="${escapeAttr(tableNumber)}" title="Ver datos de la mesa">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <rect x="3" y="4" width="18" height="5" rx="1"></rect>
                                <path d="M7 9v11"></path>
                                <path d="M17 9v11"></path>
                                <path d="M3 14h18"></path>
                            </svg>
                        </button>
                        <button type="button" class="order-card__icon-btn"
                            data-customer-profile="${escapeAttr(customerId)}"
                            data-customer-name="${safeCustomerName}"
                            data-customer-email="${escapeAttr(customerEmail)}"
                            data-customer-phone="${escapeAttr(customerPhone)}"
                            data-customer-description="${escapeAttr(customerDescription)}"
                            data-customer-avatar="${escapeAttr(customerAvatar)}"
                            title="${customerId ? 'Ver perfil del cliente' : 'Cliente sin identificar'}">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path>
                                <circle cx="12" cy="7" r="4"></circle>
                            </svg>
                        </button>
                    </div>
                    ${actionButton}
                </div>
                <div class="order-card__waiter">
                    <div class="order-card__waiter-info">
                        <svg class="waiter-icon" width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path>
                            <circle cx="12" cy="7" r="4"></circle>
                        </svg>
                        <span class="waiter-name">${waiterName}</span>
                    </div>
                    <span class="order-card__waiter-separator" aria-hidden="true"></span>
                    <span class="order-card__waiter-time ${timerClassName}">${timerDisplay}</span>
                </div>
            </div>
        `;
    }

    function translateStatus(status) {
      const translations = {
        requested: 'Esperando mesero',
        waiter_accepted: 'Enviando a cocina',
        kitchen_in_progress: 'En cocina',
        ready_for_delivery: 'Listo entrega',
        delivered: 'Entregado',
        cancelled: 'Cancelada',
        new: 'Esperando mesero',
        queued: 'Enviando a cocina',
        preparing: 'En cocina',
        ready: 'Listo entrega',
        awaiting_payment: 'Esperando pago',
        paid: 'Pagada',
      };
      return translations[status] || status;
    }

    const orderDetailsCache = new Map();
    let tablesCache = null;
    let tablesPromise = null;

    const floatingPanelEl = document.getElementById('order-floating-panel');
    const floatingPanelTitleEl = document.getElementById('floating-panel-title');
    const floatingPanelSubtitleEl = document.getElementById('floating-panel-subtitle');
    const floatingPanelBodyEl = document.getElementById('floating-panel-body');

    function openFloatingPanel({ title, subtitle = '', body = '' }) {
      if (!floatingPanelEl || !floatingPanelBodyEl || !floatingPanelTitleEl) return;
      floatingPanelTitleEl.textContent = title || '';
      if (floatingPanelSubtitleEl) {
        floatingPanelSubtitleEl.textContent = subtitle || '';
        floatingPanelSubtitleEl.style.display = subtitle ? '' : 'none';
      }
      floatingPanelBodyEl.innerHTML = body || '';
      floatingPanelEl.style.display = 'flex';
      requestAnimationFrame(() => floatingPanelEl.classList.add('is-visible'));
    }

    function closeFloatingPanel() {
      if (!floatingPanelEl || !floatingPanelBodyEl || !floatingPanelTitleEl) return;
      floatingPanelEl.classList.remove('is-visible');
      setTimeout(() => {
        floatingPanelEl.style.display = 'none';
        floatingPanelBodyEl.innerHTML = '';
        floatingPanelTitleEl.textContent = '';
        if (floatingPanelSubtitleEl) {
          floatingPanelSubtitleEl.textContent = '';
        }
      }, 180);
    }

    function formatMoneyFromAny(value, fallback = '') {
      if (value === null || typeof value === 'undefined') return fallback;
      const numeric =
        typeof value === 'string' ? Number(value.replace(/[^0-9.-]+/g, '')) : Number(value);
      if (!Number.isFinite(numeric)) return fallback || '';
      try {
        return new Intl.NumberFormat('es-MX', { style: 'currency', currency: 'MXN' }).format(
          numeric
        );
      } catch (err) {
        return `$${numeric.toFixed(2)}`;
      }
    }

    function formatHourMinute(value) {
      if (!value) return '';
      const date = new Date(value);
      if (Number.isNaN(date.getTime())) return '';
      return date.toLocaleTimeString('es-MX', { hour: '2-digit', minute: '2-digit' });
    }

    function getZoneColor(zone = '') {
      const normalized = zone.toLowerCase();
      if (['terraza', 'terrace', 'exterior'].includes(normalized)) return '#10b981';
      if (['bar', 'barra'].includes(normalized)) return '#3b82f6';
      if (['interior', 'salon', 'comedor'].includes(normalized)) return '#8b5cf6';
      if (normalized === 'vip') return '#f59e0b';
      return '#6b7280';
    }

    function getDatasetFromTrigger(target) {
      const card = target.closest('.order-card');
      const row = target.closest('tr[data-order-id]');
      const rowData = row ? row.dataset : {};
      return {
        orderId: target.dataset.orderDetail || card?.dataset.orderId || rowData.orderId || '',
        tableNumber:
          target.dataset.tableInfo || card?.dataset.tableNumber || rowData.tableNumber || '',
        customerId:
          target.dataset.customerProfile || card?.dataset.customerId || rowData.customerId || '',
        customerName:
          target.dataset.customerName ||
          card?.dataset.customerName ||
          rowData.customerName ||
          'Cliente',
        customerEmail:
          target.dataset.customerEmail ||
          card?.dataset.customerEmail ||
          rowData.customerEmail ||
          '',
        customerPhone:
          target.dataset.customerPhone ||
          card?.dataset.customerPhone ||
          rowData.customerPhone ||
          '',
        customerDescription:
          target.dataset.customerDescription ||
          card?.dataset.customerDescription ||
          rowData.customerDescription ||
          '',
        customerAvatar:
          target.dataset.customerAvatar ||
          card?.dataset.customerAvatar ||
          rowData.customerAvatar ||
          '',
        createdAt: card?.dataset.createdAt || rowData.createdAt || '',
        total: target.dataset.total || card?.dataset.total || rowData.total || '',
        status: target.dataset.status || card?.dataset.status || rowData.status || '',
        statusDisplay:
          target.dataset.statusDisplay || card?.dataset.statusDisplay || rowData.statusDisplay || '',
        notes: target.dataset.notes || card?.dataset.notes || rowData.notes || '',
        waiterNotes:
          target.dataset.waiterNotes || card?.dataset.waiterNotes || rowData.waiterNotes || '',
      };
    }

    async function loadTablesCatalog() {
      if (tablesCache !== null) return tablesCache;
      if (!tablesPromise) {
        tablesPromise = fetch('/api/tables', { credentials: 'include' })
          .then((resp) =>
            resp.ok ? resp.json() : Promise.reject(new Error('No se pudieron cargar las mesas'))
          )
          .then((data) =>
            (data.tables || []).map((table) => {
              const zonePrefix = normalizePrefix(
                table.prefix || table.zone_prefix || inferZonePrefix(table.zone || '')
              );
              return {
                ...table,
                prefix: zonePrefix,
                zone_prefix: zonePrefix,
                formatted_number: formatTableCode(table.table_number, zonePrefix),
              };
            })
          )
          .catch((err) => {
            console.warn('No se pudo cargar cat√°logo de mesas', err);
            return [];
          });
      }
      tablesCache = await tablesPromise;
      return tablesCache;
    }

    async function getTableInfo(tableNumber) {
      const tables = await loadTablesCatalog();
      const targetVariants = new Set([
        String(tableNumber),
        formatTableCode(tableNumber),
        normalizeTableForCompare(tableNumber),
      ]);
      return tables.find((table) => {
        const formatted =
          table.formatted_number || formatTableCode(table.table_number, table.zone_prefix);
        const normalized = normalizeTableForCompare(table.table_number);
        return (
          targetVariants.has(String(table.table_number)) ||
          targetVariants.has(formatted) ||
          targetVariants.has(normalized) ||
          targetVariants.has(normalizeTableForCompare(formatted))
        );
      });
    }

    async function getOrderDetails(orderId) {
      const cached = orderDetailsCache.get(orderId);
      if (cached) return cached;

      const localOrder = (window.WAITER_ORDERS_DATA || []).find(
        (o) => Number(o.id) === Number(orderId)
      );
      if (localOrder) {
        orderDetailsCache.set(orderId, localOrder);
        return localOrder;
      }

      try {
        const response = await fetch('/api/orders?include_closed=true&include_delivered=true', {
          credentials: 'include',
        });
        if (!response.ok) throw new Error('No se pudieron obtener las √≥rdenes');
        const data = await response.json();
        const match = (data.orders || []).find((o) => Number(o.id) === Number(orderId));
        if (match) {
          orderDetailsCache.set(orderId, match);
          return match;
        }
      } catch (error) {
        console.warn('No se pudieron obtener detalles de la orden', error);
      }
      return null;
    }

    function showCustomerProfile(target) {
      const data = getDatasetFromTrigger(target);
      const subtitle = data.customerId ? 'Cliente identificado' : 'Cliente sin identificar';
      const rows = [];

      if (data.customerEmail) {
        rows.push(`
                <div class="floating-panel__field">
                    <span class="floating-panel__label">Correo</span>
                    <span class="floating-panel__value">${escapeAttr(data.customerEmail)}</span>
                </div>
            `);
      }

      if (data.customerPhone) {
        rows.push(`
                <div class="floating-panel__field">
                    <span class="floating-panel__label">Tel√©fono</span>
                    <span class="floating-panel__value">${escapeAttr(data.customerPhone)}</span>
                </div>
            `);
      }

      const descriptionBlock = data.customerDescription
        ? `
            <div class="floating-panel__note">
                <p class="floating-panel__label">Descripci√≥n</p>
                <p class="floating-panel__text">${escapeAttr(data.customerDescription)}</p>
            </div>
        `
        : '';

      const hasData = rows.length > 0 || descriptionBlock;
      const body = hasData
        ? `<div class="floating-panel__grid">${rows.join('')}</div>${descriptionBlock}`
        : '<p class="floating-panel__empty">Sin datos adicionales del cliente.</p>';

      openFloatingPanel({
        title: data.customerName || 'Cliente',
        subtitle,
        body,
      });
    }

    async function showTableInfo(target) {
      const data = getDatasetFromTrigger(target);
      if (!data.tableNumber) {
        openFloatingPanel({
          title: 'Mesa',
          subtitle: 'Informaci√≥n no disponible',
          body: '<p class="floating-panel__empty">Esta orden no tiene una mesa asignada.</p>',
        });
        return;
      }

      let tableInfo = null;
      try {
        tableInfo = await getTableInfo(data.tableNumber);
      } catch (error) {
        console.warn('No se pudo cargar la mesa', error);
      }

      if (!tableInfo) {
        openFloatingPanel({
          title: `Mesa ${escapeAttr(data.tableNumber)}`,
          subtitle: 'Sin registro',
          body: '<p class="floating-panel__empty">No encontramos informaci√≥n de esta mesa.</p>',
        });
        return;
      }

      const zoneColor = getZoneColor(tableInfo.zone || '');
      const body = `
            <div class="floating-panel__grid">
                <div class="floating-panel__field">
                    <span class="floating-panel__label">Zona</span>
                    <span class="floating-panel__value">
                        <span class="zone-dot" style="background:${zoneColor};"></span>
                        ${escapeAttr(tableInfo.zone || 'Sin zona')}
                    </span>
                </div>
                <div class="floating-panel__field">
                    <span class="floating-panel__label">Estado</span>
                    <span class="floating-panel__value">${escapeAttr(tableInfo.status || 'Disponible')}</span>
                </div>
                <div class="floating-panel__field">
                    <span class="floating-panel__label">Capacidad</span>
                    <span class="floating-panel__value">${escapeAttr(tableInfo.capacity || 0)} personas</span>
                </div>
                <div class="floating-panel__field">
                    <span class="floating-panel__label">C√≥digo QR</span>
                    <span class="floating-panel__value">${escapeAttr(tableInfo.qr_code || '')}</span>
                </div>
            </div>
            ${tableInfo.id ? `<a class="floating-panel__link" href="/api/tables/${tableInfo.id}/qr" target="_blank" rel="noopener">Descargar QR</a>` : ''}
        `;

      openFloatingPanel({
        title: `Mesa ${escapeAttr(data.tableNumber)}`,
        subtitle: 'Detalles de la mesa',
        body,
      });
    }

    async function showOrderDetail(target) {
      const data = getDatasetFromTrigger(target);
      const orderId = data.orderId;
      if (!orderId) return;

      const detail = await getOrderDetails(orderId);
      const workflowStatus =
        detail?.workflow_status_legacy || detail?.workflow_status || data.status || 'requested';
      const statusLabel = detail?.status_display || data.statusDisplay || translateStatus(workflowStatus);
      const tableLabel = detail?.session?.table_number || data.tableNumber || 'N/A';
      const totalDisplay = detail
        ? formatMoneyFromAny(detail.total_amount, data.total)
        : data.total || '';
      const safeTotal = escapeAttr(totalDisplay);
      const createdAt = detail?.created_at || data.createdAt;

      const items = Array.isArray(detail?.items) ? detail.items : [];
      const itemsHtml = items.length
        ? items
          .map((item) => {
            const price = item.unit_price ?? item.price ?? 0;
            const qty = item.quantity || 1;
            const subtotal = Number(price) * Number(qty);
            return `
                <div class="floating-panel__item">
                    <div>
                        <p class="floating-panel__item-title">${escapeAttr(item.name || 'Producto')}</p>
                        <p class="floating-panel__item-meta">x${qty}</p>
                    </div>
                    <span class="floating-panel__item-price">${formatMoneyFromAny(subtotal || price, '')}</span>
                </div>
            `;
          })
          .join('')
        : '<p class="floating-panel__empty">Sin items disponibles para esta orden.</p>';

      const customerNote = (detail && detail.customer_notes) || data.notes;
      const waiterNote = (detail && detail.waiter_notes) || data.waiterNotes;
      const notesHtml = `
            ${customerNote
          ? `
                <div class="floating-panel__note">
                    <p class="floating-panel__label">Nota del cliente</p>
                    <p class="floating-panel__text">${escapeAttr(customerNote)}</p>
                </div>`
          : ''
        }
            ${waiterNote
          ? `
                <div class="floating-panel__note">
                    <p class="floating-panel__label">Nota del mesero</p>
                    <p class="floating-panel__text">${escapeAttr(waiterNote)}</p>
                </div>`
          : ''
        }
        `;

      const body = `
            <div class="receipt-header">
                <div class="receipt-header__info">
                    <span class="receipt-header__label">Orden</span>
                    <span class="receipt-header__value">#${orderId}</span>
                </div>
                <div class="receipt-header__info">
                    <span class="receipt-header__label">Cuenta</span>
                    <span class="receipt-header__value">${detail?.session?.id || 'N/A'}</span>
                </div>
                <div class="receipt-header__info">
                    <span class="receipt-header__label">Mesa</span>
                    <span class="receipt-header__value">${escapeAttr(tableLabel)}</span>
                </div>
                <div class="receipt-header__status">
                    <span class="receipt-status-badge receipt-status-badge--${workflowStatus}">${statusLabel}</span>
                </div>
            </div>
            <div class="receipt-items">
                ${items.length
          ? items
            .map((item, idx) => {
              const price = item.unit_price ?? item.price ?? 0;
              const qty = item.quantity || 1;
              const subtotal = Number(price) * Number(qty);
              return `
                        <div class="receipt-item ${idx < items.length - 1 ? 'receipt-item--bordered' : ''}">
                            <div class="receipt-item__info">
                                <span class="receipt-item__name">${escapeAttr(item.name || 'Producto')}</span>
                                <span class="receipt-item__qty">√ó ${qty}</span>
                            </div>
                            <span class="receipt-item__price">${formatMoneyFromAny(subtotal || price, '')}</span>
                        </div>
                    `;
            })
            .join('')
          : '<p class="receipt-empty">Sin items disponibles para esta orden.</p>'
        }
            </div>
            ${waiterNote
          ? `
                <div class="receipt-notes">
                    <svg class="receipt-notes__icon" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M12 20h9"></path>
                        <path d="M16.5 3.5a2.121 2.121 0 0 1 3 3L7 19l-4 1 1-4L16.5 3.5z"></path>
                    </svg>
                    <span class="receipt-notes__text">${escapeAttr(waiterNote)}</span>
                </div>
            `
          : ''
        }
            <div class="receipt-footer">
                <div class="receipt-footer__total">
                    <span class="receipt-footer__total-label">Total</span>
                    <span class="receipt-footer__total-amount">${safeTotal}</span>
                </div>
                ${createdAt ? `<div class="receipt-footer__timestamp">Creada ${formatHourMinute(createdAt)}</div>` : ''}
            </div>
            ${['cancelled', 'delivered', 'paid', 'closed', 'billed'].includes(workflowStatus)
          ? ''
          : `
            <div style="margin-top: 1rem; padding-top: 1rem; border-top: 1px solid #e5e7eb; text-align: center;">
                <button type="button" class="btn btn--small btn--danger"
                    onclick="confirmCancelOrder(${orderId})">
                    ‚ùå Cancelar Orden
                </button>
            </div>
            `
        }
        `;

      openFloatingPanel({
        title: `Orden #${orderId}`,
        subtitle: detail?.session?.id ? `Cuenta ${detail.session.id}` : 'Detalle de la orden',
        body,
      });
    }

    // Function to open cancel order modal (called from order detail panel)
    function confirmCancelOrder(orderId) {
      // Close the order detail panel first
      closeFloatingPanel();

      // Open the cancel order modal using the waiter board's modal
      if (window.openCancelOrderModal) {
        window.openCancelOrderModal(orderId);
      } else {
        // Fallback if waiter board is not loaded
        const reason = window.prompt('Motivo de cancelaci√≥n (obligatorio)')?.trim();
        if (!reason) {
          alert('Debes indicar un motivo para cancelar.');
          return;
        }
        // Call the cancel API directly
        fetch(`/api/orders/${orderId}/cancel`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          credentials: 'include',
          body: JSON.stringify({ cancellation_reason: reason }),
        })
          .then((response) => {
            if (response.ok) {
              if (window.refreshWaiterOrders) {
                window.refreshWaiterOrders();
              } else {
                location.reload();
              }
            } else {
              alert('Error al cancelar la orden');
            }
          })
          .catch((error) => {
            alert('Error al cancelar la orden: ' + error.message);
          });
      }
    }

    // Expose cancel action for inline buttons rendered en el panel flotante
    window.confirmCancelOrder = confirmCancelOrder;

    document.addEventListener('click', (event) => {
      const target = event.target;
      if (!(target instanceof HTMLElement)) return;

      if (target.closest('[data-close-floating]')) {
        event.preventDefault();
        closeFloatingPanel();
        return;
      }

      const tableBtn = target.closest('[data-table-info]');
      if (tableBtn) {
        event.preventDefault();
        void showTableInfo(tableBtn);
        return;
      }

      // Handle table number link clicks to show table info
      const tableNumberLink = target.closest('.table-number-link');
      if (tableNumberLink) {
        event.preventDefault();
        void showTableInfo(tableNumberLink);
        return;
      }

      // Handle order ID link clicks to show order details
      const orderIdLink = target.closest('.order-id-link');
      if (orderIdLink) {
        event.preventDefault();
        void showOrderDetail(orderIdLink);
        return;
      }

      const customerBtn = target.closest('[data-customer-profile]');
      if (customerBtn) {
        event.preventDefault();
        showCustomerProfile(customerBtn);
        return;
      }

      const detailBtn = target.closest('[data-order-detail]');
      if (detailBtn) {
        event.preventDefault();
        void showOrderDetail(detailBtn);
      }
    });

    document.addEventListener('keyup', (event) => {
      if (event.key === 'Escape') {
        closeFloatingPanel();
      }
    });

    // Card Size Control with API persistence
    let currentCardSize = 'normal';
    let preferencesLoaded = false;

    async function initCardSizeControl() {
      // Card view disabled: hide controls if they exist
      const cardSizeControls = document.querySelector('.card-size-control');
      if (cardSizeControls) {
        cardSizeControls.style.display = 'none';
      }
    }

    // View Mode Toggle (Cards vs Table)
    function initViewModeToggle() {
      const grids = document.querySelectorAll('.orders-grid');
      const tables = document.querySelectorAll('.table-wrapper');
      grids.forEach((grid) => (grid.style.display = 'none'));
      tables.forEach((table) => (table.style.display = 'block'));
      localStorage.setItem('waiter_view_mode', 'table');
      document.getElementById('view-mode-cards')?.remove();
      const cardSizeControls = document.querySelector('.card-size-control');
      if (cardSizeControls) cardSizeControls.style.display = 'none';
    }

    // Initialize view mode toggle
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', initViewModeToggle);
    } else {
      initViewModeToggle();
    }

    // Initialize on load
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', initCardSizeControl);
    } else {
      initCardSizeControl();
    }

    // Handle waiter notes auto-save
    let notesSaveTimeout = null;

    document.addEventListener('input', (e) => {
      if (e.target.matches('[data-order-note]')) {
        const orderId = e.target.dataset.orderNote;
        const noteText = e.target.value;

        // Clear existing timeout
        if (notesSaveTimeout) clearTimeout(notesSaveTimeout);

        // Set new timeout to save after 1 second of no typing
        notesSaveTimeout = setTimeout(() => {
          saveWaiterNote(orderId, noteText);
        }, 1000);
      }
    });

    async function saveWaiterNote(orderId, noteText) {
      try {
        const response = await fetch(`/api/orders/${orderId}/notes`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          credentials: 'include',
          body: JSON.stringify({ notes: noteText }),
        });

        if (response.ok) {
          const data = await response.json();
          // Update the hidden table row as well
          const tableRow = document.querySelector(`tr[data-order-id="${orderId}"]`);
          if (tableRow) {
            tableRow.dataset.waiterNotes = data.waiter_notes || '';
            const tableTextarea = tableRow.querySelector(`#waiter-note-${orderId}`);
            if (tableTextarea) {
              tableTextarea.value = data.waiter_notes || '';
            }
          }
          // Update card textarea if it differs (server normalization)
          const cardTextarea = document.querySelector(`#waiter-note-card-${orderId}`);
          if (cardTextarea && cardTextarea.value !== data.waiter_notes) {
            cardTextarea.value = data.waiter_notes || '';
          }
        }
      } catch (error) {
        console.error('Error saving waiter note:', error);
      }
    }

    // Toggle Tracking (Star) Function
    window.toggleTracking = async function (orderId, buttonElement) {
      const isCurrentlyStarred = buttonElement.classList.contains('active');
      const newStarredState = !isCurrentlyStarred;

      try {
        // Update localStorage
        let trackedOrders = JSON.parse(localStorage.getItem('trackedOrders') || '[]');
        if (newStarredState) {
          if (!trackedOrders.includes(orderId)) {
            trackedOrders.push(orderId);
          }
        } else {
          trackedOrders = trackedOrders.filter((id) => id !== orderId);
        }
        localStorage.setItem('trackedOrders', JSON.stringify(trackedOrders));

        // Update button UI
        buttonElement.classList.toggle('active', newStarredState);
        buttonElement.textContent = newStarredState ? '‚òÖ' : '‚òÜ';
        buttonElement.title = newStarredState ? 'Quitar de seguimiento' : 'Agregar a seguimiento';

        // Update label in meta-row
        const card = buttonElement.closest('.order-card');
        if (card) {
          const label = card.querySelector('.order-card__star-label');
          if (label) {
            label.classList.toggle('active', newStarredState);
            label.textContent = newStarredState ? '‚òÖ' : '‚òÜ';
          }
        }

        // Optional: Save to server
        try {
          await fetch(`/api/orders/${orderId}/track`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            credentials: 'include',
            body: JSON.stringify({ tracked: newStarredState }),
          });
        } catch (err) {
          console.warn('Could not save tracking state to server:', err);
        }
      } catch (error) {
        console.error('Error toggling tracking:', error);
      }
    };
  })();
</script>

<script type="module" src="{{ assets_js_employees }}/dashboard.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>

<!-- Employee Preferences Feature (saved to database) -->
<script>
  (function () {
    // Cache for preferences
    let employeePreferences = {};
    let preferencesLoaded = false;

    // API functions
    async function loadPreferences() {
      try {
        const response = await fetch('/api/employees/me/preferences');
        const result = await response.json();
        if (result.status === 'success') {
          employeePreferences = result.data.preferences || {};
          preferencesLoaded = true;
        }
      } catch (e) {
        console.warn('[Preferences] Could not load from server, using localStorage fallback');
        // Fallback to localStorage
        try {
          const local = localStorage.getItem('pronto_employee_preferences');
          if (local) employeePreferences = JSON.parse(local);
        } catch (err) {
          /* ignore */
        }
        preferencesLoaded = true;
      }
      return employeePreferences;
    }

    async function savePreference(key, value) {
      employeePreferences[key] = value;
      // Save to localStorage as backup
      try {
        localStorage.setItem('pronto_employee_preferences', JSON.stringify(employeePreferences));
      } catch (e) {
        /* ignore */
      }

      // Save to server
      try {
        const response = await fetch('/api/employees/me/preferences', {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ [key]: value }),
        });
        return response.ok;
      } catch (e) {
        console.warn('[Preferences] Could not save to server');
        return false;
      }
    }

    function getPreference(key, defaultValue = null) {
      return employeePreferences[key] ?? defaultValue;
    }

    // Expose to window for other modules
    window.EmployeePreferences = {
      load: loadPreferences,
      save: savePreference,
      get: getPreference,
      getAll: () => employeePreferences,
    };

    // Determine default home section based on employee role
    function getDefaultHomeSection() {
      const role = window.APP_DATA?.employee_role;
      const roleSectionMap = {
        waiter: 'panel-meseros',
        chef: 'panel-cocina',
        cashier: 'caja',
        admin_roles: 'resumen',
        super_admin: 'resumen',
      };
      return roleSectionMap[role] || 'resumen';
    }

    // Add "Set as homepage" link to footer (single global link)
    function addHomepageLinks() {
      let currentHome = getPreference('home_section');

      // If no home section is set, use default based on role
      if (!currentHome) {
        currentHome = getDefaultHomeSection();
        // Save the default preference (don't await, let it happen in background)
        savePreference('home_section', currentHome).catch(() => { });
      }

      // Get current visible section
      const getCurrentSection = () => {
        const sections = document.querySelectorAll('section.section[id][data-menu-title]');
        for (const section of sections) {
          const rect = section.getBoundingClientRect();
          if (rect.top >= 0 && rect.top < window.innerHeight / 2) {
            return {
              id: section.id,
              title: section.dataset.menuTitle,
            };
          }
        }
        return { id: currentHome, title: '' };
      };

      // Update footer link based on current section
      const updateFooterLink = () => {
        const current = getCurrentSection();
        const footer = document.querySelector('footer');
        if (!footer) return;

        let linkElement = footer.querySelector('.footer-homepage-link');

        if (!linkElement) {
          // Create link for the first time
          const small = footer.querySelector('small');
          if (!small) return;

          linkElement = document.createElement('button');
          linkElement.type = 'button';
          linkElement.className = 'footer-homepage-link';

          // Insert after copyright
          small.insertAdjacentElement('afterend', linkElement);
        }

        const isCurrentHome = currentHome === current.id;
        const isDefaultHome = current.id === getDefaultHomeSection();

        if (isCurrentHome) {
          linkElement.className = 'footer-homepage-link footer-homepage-link--active';
          linkElement.innerHTML = `
                    <svg class="footer-homepage-icon" viewBox="0 0 20 20" fill="currentColor">
                        <path d="M10.707 2.293a1 1 0 00-1.414 0l-7 7a1 1 0 001.414 1.414L4 10.414V17a1 1 0 001 1h2a1 1 0 001-1v-2a1 1 0 011-1h2a1 1 0 011 1v2a1 1 0 001 1h2a1 1 0 001-1v-6.586l.293.293a1 1 0 001.414-1.414l-7-7z"/>
                    </svg>
                    Inicio predeterminado ${isDefaultHome ? '' : '‚úì'}
                `;
          linkElement.style.cursor = 'default';
          linkElement.onclick = null;
        } else {
          linkElement.className = 'footer-homepage-link';
          linkElement.innerHTML = `
                    <svg class="footer-homepage-icon" viewBox="0 0 20 20" fill="currentColor">
                        <path d="M10.707 2.293a1 1 0 00-1.414 0l-7 7a1 1 0 001.414 1.414L4 10.414V17a1 1 0 001 1h2a1 1 0 001-1v-2a1 1 0 011-1h2a1 1 0 011 1v2a1 1 0 001 1h2a1 1 0 001-1v-6.586l.293.293a1 1 0 001.414-1.414l-7-7z"/>
                    </svg>
                    Establecer como inicio
                `;
          linkElement.style.cursor = 'pointer';
          linkElement.onclick = async () => {
            // Save preference
            await savePreference('home_section', current.id);
            currentHome = current.id;

            // Update link
            updateFooterLink();

            // Show confirmation
            showToast(`"${current.title}" es ahora tu p√°gina de inicio`);
          };
        }
      };

      // Initial update
      updateFooterLink();

      // Update on scroll
      let scrollTimeout;
      window.addEventListener(
        'scroll',
        () => {
          if (scrollTimeout) clearTimeout(scrollTimeout);
          scrollTimeout = setTimeout(updateFooterLink, 100);
        },
        { passive: true }
      );
    }

    // Scroll to saved section on load
    function scrollToSavedSection() {
      const hashId = (location.hash || '').replace('#', '').trim();
      const hashTarget = hashId ? document.getElementById(hashId) : null;

      let lastSection = null;
      try {
        lastSection = sessionStorage.getItem('pronto_last_section');
      } catch (e) {
        /* ignore */
      }

      let savedSection =
        (hashTarget && hashTarget.classList.contains('section') ? hashId : null) ||
        lastSection ||
        getPreference('home_section') ||
        getDefaultHomeSection();

      if (!savedSection) return;
      const section = document.getElementById(savedSection);
      if (!section) return;

      setTimeout(() => {
        section.scrollIntoView({ behavior: 'auto', block: 'start' });
      }, 50);
    }

    function saveLastSectionForRefresh() {
      try {
        const sections = document.querySelectorAll('section.section[id][data-menu-title]');
        for (const section of sections) {
          const rect = section.getBoundingClientRect();
          if (rect.top >= 0 && rect.top < window.innerHeight / 2) {
            sessionStorage.setItem('pronto_last_section', section.id);
            break;
          }
        }
      } catch (e) {
        /* ignore */
      }
    }

    // Toast notification
    function showToast(message) {
      const existing = document.querySelector('.homepage-toast');
      if (existing) existing.remove();

      const toast = document.createElement('div');
      toast.className = 'homepage-toast';
      toast.innerHTML = `<span>‚úÖ</span> ${message}`;
      document.body.appendChild(toast);

      setTimeout(() => toast.classList.add('show'), 10);
      setTimeout(() => {
        toast.classList.remove('show');
        setTimeout(() => toast.remove(), 300);
      }, 3000);
    }

    // Initialize
    document.addEventListener('DOMContentLoaded', async () => {
      await loadPreferences();
      addHomepageLinks();
      scrollToSavedSection();

      // Persist where the user is "standing" so refresh keeps the same module
      window.addEventListener('beforeunload', saveLastSectionForRefresh);
      document.addEventListener('visibilitychange', () => {
        if (document.visibilityState === 'hidden') {
          saveLastSectionForRefresh();
        }
      });
    });
  })();
</script>

<style>
  .section-homepage-footer {
    margin-top: 2rem;
    padding-top: 1.5rem;
    border-top: 1px dashed #e2e8f0;
    text-align: center;
  }

  .set-homepage-link {
    display: inline-flex;
    align-items: center;
    gap: 0.5rem;
    padding: 0.6rem 1.25rem;
    background: #f8fafc;
    border: 2px solid #e2e8f0;
    border-radius: 8px;
    font-size: 0.875rem;
    font-weight: 500;
    color: #64748b;
    cursor: pointer;
    transition: all 0.2s ease;
  }

  .set-homepage-link:hover {
    background: #fff7ed;
    border-color: #ff6b35;
    color: #ff6b35;
  }

  .set-homepage-link--active {
    background: linear-gradient(135deg, #ecfdf5 0%, #d1fae5 100%);
    border-color: #10b981;
    color: #059669;
  }

  .set-homepage-link--active:hover {
    background: linear-gradient(135deg, #ecfdf5 0%, #d1fae5 100%);
    border-color: #10b981;
    color: #059669;
  }

  .homepage-icon {
    font-size: 1rem;
  }

  .homepage-toast {
    position: fixed;
    bottom: 2rem;
    left: 50%;
    transform: translateX(-50%) translateY(20px);
    background: linear-gradient(135deg, #1e293b 0%, #334155 100%);
    color: white;
    padding: 0.85rem 1.5rem;
    border-radius: 10px;
    font-size: 0.9rem;
    font-weight: 500;
    box-shadow: 0 10px 40px rgba(0, 0, 0, 0.25);
    opacity: 0;
    transition: all 0.3s ease;
    z-index: 9999;
    display: flex;
    align-items: center;
    gap: 0.5rem;
  }

  .homepage-toast.show {
    opacity: 1;
    transform: translateX(-50%) translateY(0);
  }

  /* Table Assignment Styles */
  .modal {
    background-color: rgba(0, 0, 0, 0.5);
  }

  .modal.show {
    display: block !important;
  }

  .table-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
    gap: 1rem;
    margin-top: 1rem;
  }

  .table-card {
    border: 2px solid #e2e8f0;
    border-radius: 8px;
    padding: 1rem;
    cursor: pointer;
    transition: all 0.2s ease;
    background: white;
  }

  .table-card:hover {
    border-color: #3b82f6;
    box-shadow: 0 4px 12px rgba(59, 130, 246, 0.15);
    transform: translateY(-2px);
  }

  .table-card.selected {
    border-color: #10b981;
    background: #f0fdf4;
  }

  .table-card.my-table {
    border-color: #8b5cf6;
    background: linear-gradient(135deg, #faf5ff 0%, #f3e8ff 100%);
  }

  .table-card-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 0.75rem;
  }

  .table-number {
    font-weight: 600;
    font-size: 1.1rem;
    color: #1e293b;
  }

  .table-card-body {
    margin-top: 0.5rem;
  }

  .table-info {
    display: flex;
    justify-content: space-between;
    align-items: center;
    gap: 0.5rem;
  }

  .capacity {
    font-size: 0.875rem;
    color: #64748b;
    display: flex;
    align-items: center;
    gap: 0.25rem;
  }

  .unassign-btn {
    padding: 0.25rem 0.5rem;
    font-size: 0.875rem;
  }

  /* Button Link Style */
  .btn-link {
    background: none;
    border: none;
    cursor: pointer;
    padding: 0;
    font: inherit;
    transition: color var(--transition-fast);
  }

  .btn-link:hover {
    text-decoration: underline;
  }

  .order-id-link {
    color: #3b82f6;
    font-weight: 600;
  }

  .order-id-link:hover {
    color: #2563eb;
  }

  .table-number-link {
    color: #ea580c;
    font-weight: 600;
    display: inline-flex;
    align-items: center;
    gap: 0.25rem;
  }

  .table-number-link:hover {
    color: #c2410c;
  }

  .star-btn {
    background: none;
    border: none;
    cursor: pointer;
    padding: 0.25rem;
    font-size: 1.25rem;
    color: #94a3b8;
    transition: color var(--transition-fast), transform var(--transition-fast);
  }

  .star-btn:hover {
    color: #fbbf24;
    transform: scale(1.1);
  }

  .star-btn.starred {
    color: #fbbf24;
  }
</style>

<!-- Toast Notification Container -->
<div id="toast-container" class="toast-container" aria-live="polite" aria-atomic="true"></div>

<!-- Empty State Template (hidden by default) -->
<div id="empty-state-template" class="empty-state empty-state--table" style="display: none;">
  <div class="empty-state__icon">
    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
      <path stroke-linecap="round" stroke-linejoin="round"
        d="M12 9v3.75m9-.75a9 9 0 11-18 0 9 9 0 0118 0zm-9 3.75h.008v.008H12v-.008z" />
    </svg>
  </div>
  <h3 class="empty-state__title">Sin datos</h3>
  <p class="empty-state__description">No hay elementos para mostrar en este momento.</p>
</div>

<!-- Empty State for No Orders -->
<div id="empty-orders-template" class="empty-state empty-state--table" style="display: none;">
  <div class="empty-state__icon">
    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
      <path stroke-linecap="round" stroke-linejoin="round"
        d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2" />
    </svg>
  </div>
  <h3 class="empty-state__title">Sin √≥rdenes</h3>
  <p class="empty-state__description">No hay √≥rdenes activas en este momento.</p>
</div>

<!-- ToastManager is now defined in base.html - no duplicate needed here -->

<!-- Chart.js for reports visualization -->
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"
  integrity="sha384-e6nUZLBkQ86NJ6TVVKAeSaK8jWa3NhkYWZFomE39AvDbQWeie9PlQqM3pmYW5d1g" crossorigin="anonymous"></script>


<script>
  // Branding Manager Logic
  document.addEventListener('DOMContentLoaded', () => {
    // Only init if branding section exists
    if (document.getElementById('branding-manager-container') || document.getElementById('branding-manager')) {
      class BrandingManager {
        constructor() {
          this.container = document.getElementById('branding-manager') || document.getElementById('branding-manager-container');
          if (!this.container) return;

          this.config = null;
          this.selectedApi = 'pollinations';
          this.selectedStyle = 'modern';
          this.init();
        }

        async init() {
          await this.loadConfig();
          this.render();
          this.bindEvents();
        }

        async loadConfig() {
          // Mock config for now if endpoint fails or returns 404
          this.config = {
            branding_url: '/static/assets/branding',
            static_url: '/static',
            restaurant_slug: 'pronto',
            product_images_count: 0,
            files: { logo: false, icon: false, banner: false, placeholder: false }
          };

          try {
            const response = await fetch('/api/branding/config');
            if (response.ok) {
              const data = await response.json();
              if (data.status === 'success' || data.success) {
                this.config = data.data;
              }
            }
          } catch (error) {
            console.warn('Error cargando configuraci√≥n real, usando mock:', error);
          }
        }

        render() {
          if (!this.config) return;

          const t = Date.now();
          this.container.innerHTML = `
                <div class="branding-manager">
                    <div class="branding-grid" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 1.5rem; margin-bottom: 2rem;">
                        ${this.renderAssetCard('logo', 'Logo Principal', '512x512px', this.config.branding_url, this.config.files.logo)}
                        ${this.renderAssetCard('icon', 'Icono / Favicon', '128x128px', this.config.branding_url, this.config.files.icon, 'small')}
                        ${this.renderAssetCard('banner', 'Banner', '1200x400px', this.config.branding_url, this.config.files.banner, 'banner wide')}
                    </div>
                </div>
            `;
        }

        renderAssetCard(type, title, size, baseUrl, exists, extraClass = '') {
          const t = Date.now();
          return `
                <div class="branding-card card" style="padding: 1.5rem; border: 1px solid #e5e8ec; border-radius: 12px; background: white;">
                    <div class="branding-info">
                        <h4 style="margin:0 0 0.5rem 0; font-size: 1.1rem;">${title}</h4>
                        <p style="color:#64748b; font-size:0.9rem;">${size}</p>
                    </div>
                </div>
            `;
        }

        bindEvents() { }
      }
      new BrandingManager();
    }
  });
</script>

<!-- Reports manager -->
<script src="{{ assets_js_employees }}/reports.js"></script>

<script>
  window.currentUser = {
    id: {{ employee_id | tojson }},
    name: {{ employee_name | tojson }},
    role: {{ employee_role | tojson }},
    permissions: {{ role_capabilities | tojson }}
  };
</script>

<!-- Managers Scripts -->
<script src="{{ assets_js_employees }}/employees_manager_vanilla.js"></script>
<script src="{{ assets_js_employees }}/roles_manager_vanilla.js"></script>

<!-- Notifications SSE Stream -->
<script>
  (function () {
    if (!window.NotificationManager) {
      console.warn('[NOTIFICATIONS] NotificationManager not available');
      return;
    }

    const role = window.APP_DATA?.employee_role || window.currentUser?.role;
    if (!role) {
      console.warn('[NOTIFICATIONS] No role found, skipping notifications');
      return;
    }

    const notificationsUrl = '/api/notifications/stream';
    console.log('[NOTIFICATIONS] Connecting to SSE:', notificationsUrl, 'for role:', role);

    const notificationManager = new window.NotificationManager(notificationsUrl);
    notificationManager.connect();

    window.addEventListener('beforeunload', () => {
      notificationManager.disconnect();
    });

    console.log('[NOTIFICATIONS] Notification system initialized');
  })();
</script>

{% endblock %}
