{% extends "base.html" %}
{% block title %}Branding - {{ restaurant_name }}{% endblock %} {% block
content %}
<div class="page-header">
  <div class="page-header-content">
    <h1>Gesti√≥n de Marca</h1>
    <p class="page-subtitle">Administra logos, iconos y recursos visuales del restaurante</p>
  </div>
</div>

<div id="branding-manager">
  <!-- El contenido se carga din√°micamente por branding-manager.ts -->
  <div class="loading-placeholder">
    <div class="spinner"></div>
    <p>Cargando configuraci√≥n de branding...</p>
  </div>
</div>

<style>
  .loading-placeholder {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    padding: 4rem;
    color: #6b7280;
  }

  .loading-placeholder .spinner {
    width: 40px;
    height: 40px;
    border: 3px solid #e5e7eb;
    border-top-color: var(--primary-orange, #ff6b35);
    border-radius: 50%;
    animation: spin 0.8s linear infinite;
    margin-bottom: 1rem;
  }

  @keyframes spin {
    to {
      transform: rotate(360deg);
    }
  }
</style>
{% endblock %} {% block scripts %}
<script type="module">
  // Branding Manager inline (para evitar problemas de bundling)
  class BrandingManager {
    constructor() {
      this.container = document.getElementById('branding-manager');
      this.config = null;
      this.selectedApi = 'pollinations';
      this.selectedStyle = 'modern';
      this.init();
    }

    async init() {
      await this.loadConfig();
      this.render();
      this.bindEvents();
    }

    async loadConfig() {
      try {
        const response = await fetch('/api/branding/config');
        const data = await response.json();
        if (data.success) {
          this.config = data.data;
        }
      } catch (error) {
        console.error('Error cargando configuraci√≥n:', error);
        this.container.innerHTML = '<div class="error-message">Error cargando configuraci√≥n</div>';
      }
    }

    render() {
      if (!this.config) return;

      const t = Date.now();
      this.container.innerHTML = `
            <div class="branding-manager">
                <div class="branding-grid">
                    ${this.renderAssetCard('logo', 'Logo Principal', '512x512px', this.config.branding_url, this.config.files.logo)}
                    ${this.renderAssetCard('icon', 'Icono / Favicon', '128x128px', this.config.branding_url, this.config.files.icon, 'small')}
                    ${this.renderAssetCard('banner', 'Banner', '1200x400px', this.config.branding_url, this.config.files.banner, 'banner wide')}
                    ${this.renderAssetCard(
                      'placeholder',
                      'Placeholder Productos',
                      '256x256px',
                      this.config.static_url + '/assets/' + this.config.restaurant_slug + '/icons',
                      this.config.files.placeholder
                    )}
                </div>

                <div class="branding-section">
                    <h3>Generaci√≥n con IA</h3>
                    <div class="generation-options">
                        <div class="option-group">
                            <label>API de Generaci√≥n</label>
                            <select id="api-select" class="form-select">
                                <option value="pollinations" selected>Pollinations (Gratis, sin API key)</option>
                                <option value="stability">Stability AI (Requiere API Key)</option>
                                <option value="replicate">Replicate (Requiere API Key)</option>
                            </select>
                        </div>
                        <div class="option-group">
                            <label>Estilo Visual</label>
                            <select id="style-select" class="form-select">
                                <option value="modern" selected>Moderno</option>
                                <option value="classic">Cl√°sico / Elegante</option>
                                <option value="minimal">Minimalista</option>
                                <option value="playful">Divertido / Colorido</option>
                            </select>
                        </div>
                        <button class="btn btn-lg btn-primary" id="generate-all">
                            Generar Todo el Branding
                        </button>
                    </div>
                </div>

                <div class="branding-section">
                    <h3>Im√°genes de Productos</h3>
                    <p class="text-muted">Genera autom√°ticamente im√°genes para los productos del men√∫ usando IA.</p>
                    <p>Im√°genes generadas: <strong>${this.config.product_images_count}</strong></p>

                    <div class="product-generation">
                        <div class="option-group">
                            <label>Categor√≠a (dejar vac√≠o para todas)</label>
                            <input type="text" id="product-category" class="form-input" placeholder="Ej: Entradas">
                        </div>
                        <div class="option-group">
                            <label>Cantidad m√°xima</label>
                            <input type="number" id="product-limit" class="form-input" value="10" min="1" max="100">
                        </div>
                        <button class="btn btn-lg btn-secondary" id="generate-products">
                            Generar Im√°genes de Productos
                        </button>
                    </div>
                </div>

                <div id="branding-status" class="branding-status hidden"></div>
            </div>
        `;
    }

    renderAssetCard(type, title, size, baseUrl, exists, extraClass = '') {
      const t = Date.now();
      return `
            <div class="branding-card ${extraClass.includes('wide') ? 'wide' : ''}">
                <div class="branding-preview ${extraClass.replace('wide', '')} ${exists ? 'has-image' : ''}">
                    ${
                      exists
                        ? `<img src="${baseUrl}/${type}.png?t=${t}" alt="${title}">`
                        : '<div class="placeholder-icon">üñº</div>'
                    }
                </div>
                <div class="branding-info">
                    <h4>${title}</h4>
                    <p>${size} recomendado</p>
                    <div class="branding-actions">
                        <input type="file" id="upload-${type}" accept="image/*" hidden>
                        <button class="btn btn-sm btn-outline" data-upload="${type}">
                            ‚Üë Subir
                        </button>
                        <button class="btn btn-sm btn-primary" data-generate="${type}">
                            ‚ú® Generar IA
                        </button>
                    </div>
                </div>
            </div>
        `;
    }

    bindEvents() {
      // Selects
      document.getElementById('api-select')?.addEventListener('change', (e) => {
        this.selectedApi = e.target.value;
      });

      document.getElementById('style-select')?.addEventListener('change', (e) => {
        this.selectedStyle = e.target.value;
      });

      // Upload buttons
      document.querySelectorAll('[data-upload]').forEach((btn) => {
        btn.addEventListener('click', (e) => {
          const type = e.currentTarget.dataset.upload;
          document.getElementById(`upload-${type}`)?.click();
        });
      });

      // File inputs
      ['logo', 'icon', 'banner', 'placeholder'].forEach((type) => {
        document.getElementById(`upload-${type}`)?.addEventListener('change', (e) => {
          this.handleUpload(type, e.target);
        });
      });

      // Generate buttons
      document.querySelectorAll('[data-generate]').forEach((btn) => {
        btn.addEventListener('click', (e) => {
          this.generateAsset(e.currentTarget.dataset.generate);
        });
      });

      // Generate all
      document.getElementById('generate-all')?.addEventListener('click', () => {
        this.generateAsset('all');
      });

      // Generate products
      document.getElementById('generate-products')?.addEventListener('click', () => {
        this.validateAndGenerateProducts();
      });

      // Validate product limit on change/blur
      const limitInput = document.getElementById('product-limit');
      limitInput?.addEventListener('change', () => this.validateLimit());
      limitInput?.addEventListener('blur', () => this.validateLimit());
    }

    validateLimit() {
      const limitInput = document.getElementById('product-limit');
      if (!limitInput) return;

      let value = parseInt(limitInput.value);
      const min = 1;
      const max = 100;

      if (isNaN(value) || value < min) {
        value = min;
      } else if (value > max) {
        value = max;
      }

      limitInput.value = value.toString();
    }

    validateAndGenerateProducts() {
      this.validateLimit();
      this.generateProductImages();
    }

    async handleUpload(type, input) {
      const file = input.files?.[0];
      if (!file) return;

      this.showStatus('loading', `Subiendo ${type}...`);

      const formData = new FormData();
      formData.append('file', file);

      try {
        const response = await fetch(`/api/branding/upload/${type}`, {
          method: 'POST',
          body: formData,
        });
        const data = await response.json();

        if (data.success) {
          this.showStatus('success', `${type} actualizado correctamente`);
          await this.loadConfig();
          this.render();
          this.bindEvents();
        } else {
          this.showStatus('error', data.error || 'Error al subir');
        }
      } catch (error) {
        this.showStatus('error', 'Error de conexi√≥n');
      }
    }

    async generateAsset(type) {
      this.showStatus('loading', `Generando ${type} con IA... (puede tardar 10-30 segundos)`);

      try {
        const response = await fetch(`/api/branding/generate/${type}`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            api: this.selectedApi,
            style: this.selectedStyle,
          }),
        });
        const data = await response.json();

        if (data.success) {
          this.showStatus('success', 'Generaci√≥n completada');
          await this.loadConfig();
          this.render();
          this.bindEvents();
        } else {
          this.showStatus('error', 'Error en la generaci√≥n');
        }
      } catch (error) {
        this.showStatus('error', 'Error de conexi√≥n');
      }
    }

    async generateProductImages() {
      const category = document.getElementById('product-category')?.value || '';
      const limit = parseInt(document.getElementById('product-limit')?.value || '10');

      this.showStatus('loading', 'Iniciando generaci√≥n de im√°genes...');

      try {
        const response = await fetch('/api/branding/generate-products', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ category, limit, api: this.selectedApi }),
        });
        const data = await response.json();

        if (data.success) {
          this.showStatus(
            'success',
            `Generaci√≥n iniciada en background. Procesando hasta ${limit} productos.`
          );
        } else {
          this.showStatus('error', data.error);
        }
      } catch (error) {
        this.showStatus('error', 'Error de conexi√≥n');
      }
    }

    showStatus(type, message) {
      const status = document.getElementById('branding-status');
      if (!status) return;

      const icons = { loading: '‚è≥', success: '‚úÖ', error: '‚ùå' };
      status.className = `branding-status ${type}`;
      status.innerHTML = `<span>${icons[type]}</span> <span>${message}</span>`;
      status.classList.remove('hidden');

      if (type !== 'loading') {
        setTimeout(() => status.classList.add('hidden'), 5000);
      }
    }
  }

  new BrandingManager();
</script>
{% endblock %}
