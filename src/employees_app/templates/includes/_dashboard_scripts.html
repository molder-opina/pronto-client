<!-- <script src="{{ url_for('static', filename='assets/lib/socket.io.min.js') }}"></script> -->

<script>
  // Configuration and data for dashboard.js
  window.APP_CONFIG = {
    assets_css_employees: "{{ assets_css_employees }}",
    assets_js_employees: "{{ assets_js_employees }}",
    restaurant_assets: "{{ restaurant_assets }}",
    items_per_page: {{ items_per_page }}
  };
  window.APP_DATA = {
    categories: {{ menu.categories | tojson }},
  orders: {{ session_orders | tojson }},
  employee_id: {{ employee_id | tojson }},
  employee_name: {{ employee_name | tojson }},
  employee_role: {{ employee_role | tojson }},
  role_capabilities: {{ role_capabilities | tojson }},
  can_process_payments: {{ 'true' if can_process_payments else 'false' }},
  day_periods: {{ day_periods | tojson }},
  paid_orders_retention_minutes: {{ paid_orders_retention_minutes }},
  payment_action_delay_seconds: {{ payment_action_delay_seconds }},
  table_base_prefix: {{ table_base_prefix | tojson }}
  };

  // Waiter panel data
  {% if has_permission(Permission.ORDERS_VIEW) %}
  window.WAITER_ORDERS_DATA = {{ waiter_orders | tojson }};
  {% endif %}

  // Cashier panel data
  {% if employee_role in ['system', 'admin', 'cashier'] %}
  window.CASHIER_ORDERS_DATA = {{ waiter_orders | tojson }};
  {% endif %}

  // Kitchen panel data
  {% if has_permission(Permission.KITCHEN_VIEW) %}
  window.KITCHEN_ORDERS_DATA = {{ kitchen_orders | tojson }};
  {% endif %}
</script>
<script src="{{ assets_js_employees }}/pagination.js"></script>
<script>
  window.__PRONTO_TS_ORDERS_BOARD__ = true;
  window.__PRONTO_TS_WAITER__ = true;
  window.__PRONTO_TS_KITCHEN__ = true;
  window.__PRONTO_TS_CATALOG__ = true;
  window.__PRONTO_TS_PAYMENTS__ = true;
  window.__PRONTO_TS_MODIFIERS__ = true;
  window.__PRONTO_TS_AREAS__ = true;
  window.__PRONTO_TS_TABLES__ = true;
  window.__PRONTO_TS_CONFIG__ = true;
  window.__PRONTO_TS_PROMOTIONS__ = true;
  window.__PRONTO_TS_RECOMMENDATIONS__ = true;
  window.__PRONTO_TS_REPORTS__ = true;
  window.__PRONTO_TS_CUSTOMERS__ = true;
  window.__PRONTO_TS_EMPLOYEE_EVENTS__ = true;
  window.__PRONTO_TS_ROLES__ = true;
  window.__PRONTO_TS_SESSIONS__ = true;
  window.__PRONTO_TS_PREP_TIMES__ = true;
  window.__PRONTO_TS_SCHEDULES__ = true;
</script>

<!-- Modern POS Card Renderer -->
<script>
  (function () {
    'use strict';

    // Wait for DOM and waiter board to be ready
    document.addEventListener('DOMContentLoaded', function () {
      // Sync modern tabs with legacy logic
      initializeSegmentedControl();

      // Force table view and disable card rendering hooks
      window.renderOrderCards = () => { };
      localStorage.setItem('waiter_view_mode', 'table');
      document.querySelectorAll('.orders-grid').forEach((grid) => (grid.style.display = 'none'));
      document
        .querySelectorAll('.table-wrapper')
        .forEach((table) => (table.style.display = 'block'));
    });

    function initializeSegmentedControl() {
      const modernTabs = document.querySelectorAll('.waiter-tab');
      const legacyTabs = document.querySelectorAll('.waiter-toolbar__tabs .waiter-tab');

      modernTabs.forEach((button) => {
        button.addEventListener('click', function () {
          const tab = this.dataset.tab;

          // Update modern tabs active state
          modernTabs.forEach((btn) => btn.classList.remove('active'));
          this.classList.add('active');

          // Also click the corresponding legacy tab to trigger existing logic
          const legacyTab = Array.from(legacyTabs).find((t) => t.dataset.tab === tab);
          if (legacyTab) {
            legacyTab.click();
          }
        });
      });
    }

    function initializeCardRendering() {
      console.log('[POS Cards] Initializing card rendering...');

      // Hook into the existing waiter board rendering
      const originalRenderMethod = window.renderWaiterOrders;

      if (typeof originalRenderMethod === 'function') {
        window.renderWaiterOrders = function (...args) {
          // Call original method
          originalRenderMethod.apply(this, args);

          // Then render cards
          renderOrderCards();
        };
      }

      // Initial render
      renderOrderCards();

      // Re-render on data updates
      setInterval(renderOrderCards, 5000);
    }

    function renderOrderCards() {
      // Get active tab
      const activeTab =
        document.querySelector('.waiter-tabs-container .waiter-tab.active')?.dataset.tab ||
        'active';

      // Get grid container
      const gridId = `orders-grid-${activeTab}`;
      const gridContainer = document.getElementById(gridId);

      if (!gridContainer) return;

      // Get table rows from legacy table
      const tableBody =
        activeTab === 'active'
          ? document.getElementById('waiter-orders')
          : activeTab === 'tracking'
            ? document.getElementById('tracking-orders')
            : document.getElementById('paid-orders');

      if (!tableBody) return;

      const rows = Array.from(tableBody.querySelectorAll('tr')).filter((row) => {
        return row.dataset.orderId && row.style.display !== 'none';
      });

      if (rows.length === 0) {
        gridContainer.innerHTML = `
                <div class="orders-empty">
                    <div class="orders-empty__icon">üìã</div>
                    <div class="orders-empty__title">No hay √≥rdenes</div>
                    <div class="orders-empty__text">Las √≥rdenes aparecer√°n aqu√≠ cuando los clientes realicen pedidos</div>
                </div>
            `;
        return;
      }

      // Render cards
      gridContainer.innerHTML = rows.map((row) => createOrderCard(row, activeTab)).join('');

      // Load items for large mode cards
      loadItemsForLargeCards();
    }

    // Load order items for cards in large mode
    async function loadItemsForLargeCards() {
      const grid = document.querySelector('.orders-grid.size-large');
      if (!grid) return; // Only load if in large mode

      const previewContainers = document.querySelectorAll('.order-card__items-preview');

      for (const container of previewContainers) {
        const orderId = container.dataset.orderId;
        if (!orderId) continue;

        try {
          const detail = await getOrderDetails(parseInt(orderId));
          const items = Array.isArray(detail?.items) ? detail.items : [];

          if (items.length === 0) {
            container.innerHTML = `
                        <div class="order-card__items-preview-title">Productos</div>
                        <div class="order-card__items-loading">Sin items</div>
                    `;
            continue;
          }

          // Show first 4 items
          const displayItems = items.slice(0, 4);
          const remainingCount = items.length - 4;

          const itemsHtml = displayItems
            .map((item) => {
              const qty = item.quantity || 1;
              const name = escapeAttr(item.name || 'Producto');
              return `
                        <div class="order-card__item-row">
                            <div class="order-card__item-name">
                                <span class="order-card__item-quantity">${qty}x</span> ${name}
                            </div>
                        </div>
                    `;
            })
            .join('');

          const moreHtml =
            remainingCount > 0
              ? `
                    <div class="order-card__items-more">+ ${remainingCount} producto${remainingCount !== 1 ? 's' : ''} m√°s...</div>
                `
              : '';

          container.innerHTML = `
                    <div class="order-card__items-preview-title">Productos</div>
                    <div class="order-card__items-list">
                        ${itemsHtml}
                    </div>
                    ${moreHtml}
                `;
        } catch (error) {
          console.error(`Error loading items for order ${orderId}:`, error);
          container.innerHTML = `
                    <div class="order-card__items-preview-title">Productos</div>
                    <div class="order-card__items-loading">Error al cargar</div>
                `;
        }
      }
    }

    function escapeAttr(value) {
      return String(value !== null && value !== undefined ? value : '')
        .replace(/&/g, '&amp;')
        .replace(/"/g, '&quot;')
        .replace(/</g, '&lt;')
        .replace(/>/g, '&gt;')
        .replace(/'/g, '&#39;');
    }

    function sanitizeBasePrefix(value) {
      const cleaned = (value || 'M').replace(/[^A-Za-z0-9]/g, '').toUpperCase();
      return cleaned.slice(0, 3) || 'M';
    }

    const TABLE_BASE_PREFIX = sanitizeBasePrefix(window.APP_DATA?.table_base_prefix || 'M');

    function normalizePrefix(prefix = '') {
      const clean = prefix
        .replace(/[^a-zA-Z]/g, '')
        .trim()
        .toUpperCase();
      return clean ? clean.charAt(0) : '';
    }

    function inferZonePrefix(label = '') {
      const normalized = (label || '').toLowerCase();
      if (!normalized) return '';
      if (normalized.includes('vip')) return 'V';
      if (normalized.includes('roof')) return 'R';
      if (normalized.includes('terraza') || normalized.includes('terrace')) return 'T';
      if (normalized.includes('bar') || normalized.includes('barra')) return 'B';
      if (
        normalized.includes('interior') ||
        normalized.includes('salon') ||
        normalized.includes('comedor')
      )
        return 'I';
      if (normalized.startsWith('mesa') || normalized.startsWith('table')) return '';
      if (/^m[\s-]?\d/.test(normalized)) return '';
      return label.trim().charAt(0).toUpperCase() || '';
    }

    function formatTableCode(rawNumber = '', zonePrefix = '') {
      const digitsMatch = (rawNumber || '').match(/(\d+)/);
      const numericPart = (digitsMatch ? digitsMatch[1] : '01').padStart(2, '0');
      const baseCode = `${TABLE_BASE_PREFIX}${numericPart}`;
      const prefix = normalizePrefix(zonePrefix) || inferZonePrefix(rawNumber);
      return prefix ? `${prefix}-${baseCode}` : baseCode;
    }

    function normalizeTableForCompare(value) {
      return formatTableCode(value).replace(/[^A-Z0-9]/g, '');
    }

    function getTablePrefixFromCache(tableNumber) {
      if (tablesCache === null && !tablesPromise) {
        // Trigger async load so next renders can use prefixes from cat√°logo de mesas
        void loadTablesCatalog().then((tables) => {
          tablesCache = tables;
          renderOrderCards();
          return tables;
        });
      }
      if (Array.isArray(tablesCache)) {
        const normalizedTarget = normalizeTableForCompare(tableNumber);
        const match = tablesCache.find(
          (table) => normalizeTableForCompare(table.table_number) === normalizedTarget
        );
        if (match) {
          return normalizePrefix(
            match.prefix || match.zone_prefix || inferZonePrefix(match.zone || '')
          );
        }
      }
      return '';
    }

    function createOrderCard(row, tab) {
      const orderId = row.dataset.orderId;
      const status = row.dataset.status;
      const tableCellValue = row.querySelector('td:nth-child(3)')?.textContent?.trim() || '';
      const rawTableNumber = row.dataset.tableNumber || tableCellValue || 'N/A';
      if (!row.dataset.tableNumber && rawTableNumber) {
        row.dataset.tableNumber = rawTableNumber;
      }
      const tablePrefix = getTablePrefixFromCache(rawTableNumber);
      const tableNumber = formatTableCode(rawTableNumber, tablePrefix);
      row.dataset.tableNumberRaw = rawTableNumber;
      const customerName = row.dataset.customerName || 'Cliente';
      const customerId = row.dataset.customerId || '';
      const customerEmail = row.dataset.customerEmail || '';
      const customerPhone = row.dataset.customerPhone || '';
      const customerDescription = row.dataset.customerDescription || '';
      const customerAvatar = row.dataset.customerAvatar || '';
      const waiterName = row.dataset.waiterName || 'Sin asignar';
      const notes = row.dataset.notes || '';
      const waiterNotes = row.dataset.waiterNotes || '';
      const sessionId = row.dataset.sessionId || '';
      const safeNotes = escapeAttr(notes);
      const safeWaiterNotes = escapeAttr(waiterNotes);

      // Get total from table cell (used for detail popover)
      const totalCell = row.querySelector('td:nth-child(6)');
      const totalText = totalCell ? totalCell.textContent.trim() : '$0.00';

      // Determine card urgency class
      let urgencyClass = '';
      const createdTime = row.dataset.createdAt;
      if (createdTime) {
        const elapsed = Date.now() - new Date(createdTime).getTime();
        if (elapsed > 30 * 60 * 1000) urgencyClass = 'urgent';
        else if (elapsed > 15 * 60 * 1000) urgencyClass = 'warning';
      }

      const isNewOrder = createdTime
        ? Date.now() - new Date(createdTime).getTime() < 3 * 60 * 1000
        : true;

      // Determine timer status
      let timerClass = 'normal';
      let timerText = '';
      if (createdTime) {
        const elapsed = Math.max(
          0,
          Math.floor((Date.now() - new Date(createdTime).getTime()) / 60000)
        );
        timerText = elapsed < 1 ? '0 min' : `${elapsed} min`;
        if (elapsed > 30) timerClass = 'urgent';
        else if (elapsed > 15) timerClass = 'warning';
      }
      const timerDisplay = timerText || '0 min';
      const timerClassName =
        timerClass !== 'normal' ? `order-card__waiter-time--${timerClass}` : '';

      // Get action buttons
      const actionsCell = row.querySelector('.actions');
      let actionButton = '';
      let actionTooltip = '';

      if (actionsCell) {
        const buttons = actionsCell.querySelectorAll('button');
        if (buttons.length > 0) {
          const firstButton = buttons[0];
          const buttonText = firstButton.textContent.trim();
          const buttonClass = firstButton.className.includes('success')
            ? 'primary'
            : firstButton.className.includes('warning')
              ? 'warning'
              : firstButton.className.includes('danger')
                ? 'danger'
                : 'secondary';
          const endpoint = firstButton.getAttribute('data-endpoint') || '';

          // Create tooltip based on button type
          if (buttonText.includes('Aceptar')) actionTooltip = 'Aceptar orden del cliente';
          else if (buttonText.includes('En cocina')) actionTooltip = 'Enviar orden a cocina';
          else if (buttonText.includes('Lista')) actionTooltip = 'Marcar como lista para servir';
          else if (buttonText.includes('Entregar')) actionTooltip = 'Marcar orden como entregada';
          else actionTooltip = buttonText;

          actionButton = `
                    <button class="order-card__action waiter-action ${buttonClass}" data-endpoint="${endpoint}" title="${actionTooltip}">
                        ${buttonText}
                    </button>
                `;
        }
      }

      // Is starred?
      const starBtn = row.querySelector('.star-btn');
      const isStarred = starBtn && starBtn.classList.contains('active');
      const statusLabel = row.dataset.statusDisplay || translateStatus(status);
      const safeCustomerName = escapeAttr(customerName);
      const orderCardClasses = [
        'order-card',
        urgencyClass,
        isStarred ? 'starred' : '',
        isNewOrder ? 'order-card--fresh' : '',
      ]
        .filter(Boolean)
        .join(' ');

      return `
            <div class="${orderCardClasses}" data-order-id="${orderId}"
                data-table-number="${escapeAttr(tableNumber)}"
                data-customer-name="${safeCustomerName}"
                data-customer-email="${escapeAttr(customerEmail)}"
                data-customer-phone="${escapeAttr(customerPhone)}"
                data-customer-description="${escapeAttr(customerDescription)}"
                data-customer-id="${escapeAttr(customerId)}"
                data-customer-avatar="${escapeAttr(customerAvatar)}"
                data-created-at="${escapeAttr(createdTime || '')}"
                data-total="${escapeAttr(totalText)}"
                data-notes="${safeNotes}"
                data-waiter-notes="${safeWaiterNotes}"
                data-session-id="${escapeAttr(sessionId)}"
                data-table-number-raw="${escapeAttr(rawTableNumber)}"
                data-status="${escapeAttr(status)}">
                <div class="order-card__header">
                    <div class="order-card__header-left">
                        <button class="order-card__table" type="button" data-table-info="${escapeAttr(tableNumber)}">
                            <span class="order-card__table-full">Mesa ${tableNumber}</span>
                            <span class="order-card__table-compact">${tableNumber}</span>
                        </button>
                    </div>
                    <div class="order-card__header-right">
                        <div class="order-card__header-timer ${timerClassName.replace('order-card__waiter-time--', 'order-card__header-timer--')}">
                            <svg class="timer-icon-compact" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <circle cx="12" cy="12" r="10"></circle>
                                <polyline points="12 6 12 12 16 14"></polyline>
                            </svg>
                            ${timerDisplay}
                        </div>
                    </div>
                    <button class="order-card__star ${isStarred ? 'active' : ''}" onclick="toggleTracking(${orderId}, this)" title="${isStarred ? 'Quitar de seguimiento' : 'Agregar a seguimiento'}">
                        ${isStarred ? '‚òÖ' : '‚òÜ'}
                    </button>
                </div>
                <div class="order-card__meta">
                    ${customerName !== 'Cliente' && customerId
          ? `
                    <button type="button" class="order-card__customer"
                        data-customer-profile="${escapeAttr(customerId)}"
                        data-customer-name="${safeCustomerName}"
                        data-customer-email="${escapeAttr(customerEmail)}"
                        data-customer-phone="${escapeAttr(customerPhone)}"
                        data-customer-description="${escapeAttr(customerDescription)}"
                        data-customer-avatar="${escapeAttr(customerAvatar)}">
                        <svg class="customer-icon" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path>
                            <circle cx="12" cy="7" r="4"></circle>
                        </svg>
                        ${customerName}
                    </button>
                    `
          : ''
        }
                </div>
                <div class="order-card__meta-row">
                    <span class="order-card__status-badge ${status}">${statusLabel}</span>
                    <span class="order-card__order-number"> ‚Ä¢ #${orderId}</span>
                    <div class="order-card__star-label ${isStarred ? 'active' : ''}">
                        ${isStarred ? '‚òÖ' : '‚òÜ'}
                    </div>
                </div>
                <div class="order-card__items-preview" data-order-id="${orderId}">
                    <div class="order-card__items-preview-title">Productos</div>
                    <div class="order-card__items-loading">Cargando items...</div>
                </div>
                <div class="order-card__body">
                    ${notes
          ? `
                        <div class="order-card__notes order-card__notes--customer">
                            <div class="order-card__notes-header">
                                <svg class="notes-icon" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"></path>
                                </svg>
                                <span class="order-card__notes-label">Cliente</span>
                            </div>
                            <p class="order-card__notes-text">${safeNotes}</p>
                        </div>
                    `
          : ''
        }
                    <div class="order-card__notes order-card__notes--waiter">
                        <div class="order-card__notes-header">
                            <svg class="notes-icon" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M12 20h9"></path>
                                <path d="M16.5 3.5a2.121 2.121 0 0 1 3 3L7 19l-4 1 1-4L16.5 3.5z"></path>
                            </svg>
                            <span class="order-card__notes-label">Notas del mesero</span>
                        </div>
                        <textarea
                            class="order-card__notes-input"
                            id="waiter-note-card-${orderId}"
                            data-order-note="${orderId}"
                            placeholder="Ej. Cliente con sombrero, mesa cerca ventana..."
                            title="Escribe notas sobre el cliente o pedido"
                        >${safeWaiterNotes}</textarea>
                    </div>
                </div>
                <div class="order-card__footer">
                    <div class="order-card__quick-actions">
                        <button type="button" class="order-card__icon-btn" data-order-detail="${orderId}" title="Ver detalle de la orden">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M4 19h16"></path>
                                <path d="M4 5h16"></path>
                                <rect x="4" y="9" width="16" height="6" rx="2"></rect>
                            </svg>
                        </button>
                        <button type="button" class="order-card__icon-btn" data-table-info="${escapeAttr(tableNumber)}" title="Ver datos de la mesa">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <rect x="3" y="4" width="18" height="5" rx="1"></rect>
                                <path d="M7 9v11"></path>
                                <path d="M17 9v11"></path>
                                <path d="M3 14h18"></path>
                            </svg>
                        </button>
                        <button type="button" class="order-card__icon-btn"
                            data-customer-profile="${escapeAttr(customerId)}"
                            data-customer-name="${safeCustomerName}"
                            data-customer-email="${escapeAttr(customerEmail)}"
                            data-customer-phone="${escapeAttr(customerPhone)}"
                            data-customer-description="${escapeAttr(customerDescription)}"
                            data-customer-avatar="${escapeAttr(customerAvatar)}"
                            title="${customerId ? 'Ver perfil del cliente' : 'Cliente sin identificar'}">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path>
                                <circle cx="12" cy="7" r="4"></circle>
                            </svg>
                        </button>
                    </div>
                    ${actionButton}
                </div>
                <div class="order-card__waiter">
                    <div class="order-card__waiter-info">
                        <svg class="waiter-icon" width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path>
                            <circle cx="12" cy="7" r="4"></circle>
                        </svg>
                        <span class="waiter-name">${waiterName}</span>
                    </div>
                    <span class="order-card__waiter-separator" aria-hidden="true"></span>
                    <span class="order-card__waiter-time ${timerClassName}">${timerDisplay}</span>
                </div>
            </div>
        `;
    }

    function translateStatus(status) {
      const translations = {
        requested: 'Esperando mesero',
        waiter_accepted: 'Enviando a cocina',
        kitchen_in_progress: 'En cocina',
        ready_for_delivery: 'Listo entrega',
        delivered: 'Entregado',
        cancelled: 'Cancelada',
        new: 'Esperando mesero',
        queued: 'Enviando a cocina',
        preparing: 'En cocina',
        ready: 'Listo entrega',
        awaiting_payment: 'Esperando pago',
        paid: 'Pagada',
      };
      return translations[status] || status;
    }

    const orderDetailsCache = new Map();
    let tablesCache = null;
    let tablesPromise = null;

    const floatingPanelEl = document.getElementById('order-floating-panel');
    const floatingPanelTitleEl = document.getElementById('floating-panel-title');
    const floatingPanelSubtitleEl = document.getElementById('floating-panel-subtitle');
    const floatingPanelBodyEl = document.getElementById('floating-panel-body');

    function openFloatingPanel({ title, subtitle = '', body = '' }) {
      if (!floatingPanelEl || !floatingPanelBodyEl || !floatingPanelTitleEl) return;
      floatingPanelTitleEl.textContent = title || '';
      if (floatingPanelSubtitleEl) {
        floatingPanelSubtitleEl.textContent = subtitle || '';
        floatingPanelSubtitleEl.style.display = subtitle ? '' : 'none';
      }
      floatingPanelBodyEl.innerHTML = body || '';
      floatingPanelEl.style.display = 'flex';
      requestAnimationFrame(() => floatingPanelEl.classList.add('is-visible'));
    }

    function closeFloatingPanel() {
      if (!floatingPanelEl || !floatingPanelBodyEl || !floatingPanelTitleEl) return;
      floatingPanelEl.classList.remove('is-visible');
      setTimeout(() => {
        floatingPanelEl.style.display = 'none';
        floatingPanelBodyEl.innerHTML = '';
        floatingPanelTitleEl.textContent = '';
        if (floatingPanelSubtitleEl) {
          floatingPanelSubtitleEl.textContent = '';
        }
      }, 180);
    }

    function formatMoneyFromAny(value, fallback = '') {
      if (value === null || typeof value === 'undefined') return fallback;
      const numeric =
        typeof value === 'string' ? Number(value.replace(/[^0-9.-]+/g, '')) : Number(value);
      if (!Number.isFinite(numeric)) return fallback || '';
      try {
        return new Intl.NumberFormat('es-MX', { style: 'currency', currency: 'MXN' }).format(
          numeric
        );
      } catch (err) {
        return `$${numeric.toFixed(2)}`;
      }
    }

    function formatHourMinute(value) {
      if (!value) return '';
      const date = new Date(value);
      if (Number.isNaN(date.getTime())) return '';
      return date.toLocaleTimeString('es-MX', { hour: '2-digit', minute: '2-digit' });
    }

    function getZoneColor(zone = '') {
      const normalized = zone.toLowerCase();
      if (['terraza', 'terrace', 'exterior'].includes(normalized)) return '#10b981';
      if (['bar', 'barra'].includes(normalized)) return '#3b82f6';
      if (['interior', 'salon', 'comedor'].includes(normalized)) return '#8b5cf6';
      if (normalized === 'vip') return '#f59e0b';
      return '#6b7280';
    }

    function getDatasetFromTrigger(target) {
      const card = target.closest('.order-card');
      const row = target.closest('tr[data-order-id]');
      const rowData = row ? row.dataset : {};
      return {
        orderId: target.dataset.orderDetail || card?.dataset.orderId || rowData.orderId || '',
        tableNumber:
          target.dataset.tableInfo || card?.dataset.tableNumber || rowData.tableNumber || '',
        customerId:
          target.dataset.customerProfile || card?.dataset.customerId || rowData.customerId || '',
        customerName:
          target.dataset.customerName ||
          card?.dataset.customerName ||
          rowData.customerName ||
          'Cliente',
        customerEmail:
          target.dataset.customerEmail ||
          card?.dataset.customerEmail ||
          rowData.customerEmail ||
          '',
        customerPhone:
          target.dataset.customerPhone ||
          card?.dataset.customerPhone ||
          rowData.customerPhone ||
          '',
        customerDescription:
          target.dataset.customerDescription ||
          card?.dataset.customerDescription ||
          rowData.customerDescription ||
          '',
        customerAvatar:
          target.dataset.customerAvatar ||
          card?.dataset.customerAvatar ||
          rowData.customerAvatar ||
          '',
        createdAt: card?.dataset.createdAt || rowData.createdAt || '',
        total: target.dataset.total || card?.dataset.total || rowData.total || '',
        status: target.dataset.status || card?.dataset.status || rowData.status || '',
        statusDisplay:
          target.dataset.statusDisplay ||
          card?.dataset.statusDisplay ||
          rowData.statusDisplay ||
          '',
        notes: target.dataset.notes || card?.dataset.notes || rowData.notes || '',
        waiterNotes:
          target.dataset.waiterNotes || card?.dataset.waiterNotes || rowData.waiterNotes || '',
      };
    }

    async function loadTablesCatalog() {
      if (tablesCache !== null) return tablesCache;
      if (!tablesPromise) {
        tablesPromise = fetch('/api/tables', { credentials: 'include' })
          .then((resp) =>
            resp.ok ? resp.json() : Promise.reject(new Error('No se pudieron cargar las mesas'))
          )
          .then((data) =>
            (data.tables || []).map((table) => {
              const zonePrefix = normalizePrefix(
                table.prefix || table.zone_prefix || inferZonePrefix(table.zone || '')
              );
              return {
                ...table,
                prefix: zonePrefix,
                zone_prefix: zonePrefix,
                formatted_number: formatTableCode(table.table_number, zonePrefix),
              };
            })
          )
          .catch((err) => {
            console.warn('No se pudo cargar cat√°logo de mesas', err);
            return [];
          });
      }
      tablesCache = await tablesPromise;
      return tablesCache;
    }

    async function getTableInfo(tableNumber) {
      const tables = await loadTablesCatalog();
      const targetVariants = new Set([
        String(tableNumber),
        formatTableCode(tableNumber),
        normalizeTableForCompare(tableNumber),
      ]);
      return tables.find((table) => {
        const formatted =
          table.formatted_number || formatTableCode(table.table_number, table.zone_prefix);
        const normalized = normalizeTableForCompare(table.table_number);
        return (
          targetVariants.has(String(table.table_number)) ||
          targetVariants.has(formatted) ||
          targetVariants.has(normalized) ||
          targetVariants.has(normalizeTableForCompare(formatted))
        );
      });
    }

    async function getOrderDetails(orderId) {
      const cached = orderDetailsCache.get(orderId);
      if (cached) return cached;

      const localOrder = (window.WAITER_ORDERS_DATA || []).find(
        (o) => Number(o.id) === Number(orderId)
      );
      if (localOrder) {
        orderDetailsCache.set(orderId, localOrder);
        return localOrder;
      }

      try {
        const response = await fetch('/api/orders?include_closed=true&include_delivered=true', {
          credentials: 'include',
        });
        if (!response.ok) throw new Error('No se pudieron obtener las √≥rdenes');
        const data = await response.json();
        const match = (data.orders || []).find((o) => Number(o.id) === Number(orderId));
        if (match) {
          orderDetailsCache.set(orderId, match);
          return match;
        }
      } catch (error) {
        console.warn('No se pudieron obtener detalles de la orden', error);
      }
      return null;
    }

    function showCustomerProfile(target) {
      const data = getDatasetFromTrigger(target);
      const subtitle = data.customerId ? 'Cliente identificado' : 'Cliente sin identificar';
      const rows = [];

      if (data.customerEmail) {
        rows.push(`
                <div class="floating-panel__field">
                    <span class="floating-panel__label">Correo</span>
                    <span class="floating-panel__value">${escapeAttr(data.customerEmail)}</span>
                </div>
            `);
      }

      if (data.customerPhone) {
        rows.push(`
                <div class="floating-panel__field">
                    <span class="floating-panel__label">Tel√©fono</span>
                    <span class="floating-panel__value">${escapeAttr(data.customerPhone)}</span>
                </div>
            `);
      }

      const descriptionBlock = data.customerDescription
        ? `
            <div class="floating-panel__note">
                <p class="floating-panel__label">Descripci√≥n</p>
                <p class="floating-panel__text">${escapeAttr(data.customerDescription)}</p>
            </div>
        `
        : '';

      const hasData = rows.length > 0 || descriptionBlock;
      const body = hasData
        ? `<div class="floating-panel__grid">${rows.join('')}</div>${descriptionBlock}`
        : '<p class="floating-panel__empty">Sin datos adicionales del cliente.</p>';

      openFloatingPanel({
        title: data.customerName || 'Cliente',
        subtitle,
        body,
      });
    }

    async function showTableInfo(target) {
      const data = getDatasetFromTrigger(target);
      if (!data.tableNumber) {
        openFloatingPanel({
          title: 'Mesa',
          subtitle: 'Informaci√≥n no disponible',
          body: '<p class="floating-panel__empty">Esta orden no tiene una mesa asignada.</p>',
        });
        return;
      }

      let tableInfo = null;
      try {
        tableInfo = await getTableInfo(data.tableNumber);
      } catch (error) {
        console.warn('No se pudo cargar la mesa', error);
      }

      if (!tableInfo) {
        openFloatingPanel({
          title: `Mesa ${escapeAttr(data.tableNumber)}`,
          subtitle: 'Sin registro',
          body: '<p class="floating-panel__empty">No encontramos informaci√≥n de esta mesa.</p>',
        });
        return;
      }

      const zoneColor = getZoneColor(tableInfo.zone || '');
      const body = `
            <div class="floating-panel__grid">
                <div class="floating-panel__field">
                    <span class="floating-panel__label">Zona</span>
                    <span class="floating-panel__value">
                        <span class="zone-dot" style="background:${zoneColor};"></span>
                        ${escapeAttr(tableInfo.zone || 'Sin zona')}
                    </span>
                </div>
                <div class="floating-panel__field">
                    <span class="floating-panel__label">Estado</span>
                    <span class="floating-panel__value">${escapeAttr(tableInfo.status || 'Disponible')}</span>
                </div>
                <div class="floating-panel__field">
                    <span class="floating-panel__label">Capacidad</span>
                    <span class="floating-panel__value">${escapeAttr(tableInfo.capacity || 0)} personas</span>
                </div>
                <div class="floating-panel__field">
                    <span class="floating-panel__label">C√≥digo QR</span>
                    <span class="floating-panel__value">${escapeAttr(tableInfo.qr_code || '')}</span>
                </div>
            </div>
            ${tableInfo.id ? `<a class="floating-panel__link" href="/api/tables/${tableInfo.id}/qr" target="_blank" rel="noopener">Descargar QR</a>` : ''}
        `;

      openFloatingPanel({
        title: `Mesa ${escapeAttr(data.tableNumber)}`,
        subtitle: 'Detalles de la mesa',
        body,
      });
    }

    async function showOrderDetail(target) {
      const data = getDatasetFromTrigger(target);
      const orderId = data.orderId;
      if (!orderId) return;

      const detail = await getOrderDetails(orderId);
      const workflowStatus =
        detail?.workflow_status_legacy || detail?.workflow_status || data.status || 'requested';
      const statusLabel =
        detail?.status_display || data.statusDisplay || translateStatus(workflowStatus);
      const tableLabel = detail?.session?.table_number || data.tableNumber || 'N/A';
      const totalDisplay = detail
        ? formatMoneyFromAny(detail.total_amount, data.total)
        : data.total || '';
      const safeTotal = escapeAttr(totalDisplay);
      const createdAt = detail?.created_at || data.createdAt;

      const items = Array.isArray(detail?.items) ? detail.items : [];
      const itemsHtml = items.length
        ? items
          .map((item) => {
            const price = item.unit_price ?? item.price ?? 0;
            const qty = item.quantity || 1;
            const subtotal = Number(price) * Number(qty);
            return `
                <div class="floating-panel__item">
                    <div>
                        <p class="floating-panel__item-title">${escapeAttr(item.name || 'Producto')}</p>
                        <p class="floating-panel__item-meta">x${qty}</p>
                    </div>
                    <span class="floating-panel__item-price">${formatMoneyFromAny(subtotal || price, '')}</span>
                </div>
            `;
          })
          .join('')
        : '<p class="floating-panel__empty">Sin items disponibles para esta orden.</p>';

      const customerNote = (detail && detail.customer_notes) || data.notes;
      const waiterNote = (detail && detail.waiter_notes) || data.waiterNotes;
      const notesHtml = `
            ${customerNote
          ? `
                <div class="floating-panel__note">
                    <p class="floating-panel__label">Nota del cliente</p>
                    <p class="floating-panel__text">${escapeAttr(customerNote)}</p>
                </div>`
          : ''
        }
            ${waiterNote
          ? `
                <div class="floating-panel__note">
                    <p class="floating-panel__label">Nota del mesero</p>
                    <p class="floating-panel__text">${escapeAttr(waiterNote)}</p>
                </div>`
          : ''
        }
        `;

      const body = `
            <div class="receipt-header">
                <div class="receipt-header__info">
                    <span class="receipt-header__label">Orden</span>
                    <span class="receipt-header__value">#${orderId}</span>
                </div>
                <div class="receipt-header__info">
                    <span class="receipt-header__label">Cuenta</span>
                    <span class="receipt-header__value">${detail?.session?.id || 'N/A'}</span>
                </div>
                <div class="receipt-header__info">
                    <span class="receipt-header__label">Mesa</span>
                    <span class="receipt-header__value">${escapeAttr(tableLabel)}</span>
                </div>
                <div class="receipt-header__status">
                    <span class="receipt-status-badge receipt-status-badge--${workflowStatus}">${statusLabel}</span>
                </div>
            </div>
            <div class="receipt-items">
                ${items.length
          ? items
            .map((item, idx) => {
              const price = item.unit_price ?? item.price ?? 0;
              const qty = item.quantity || 1;
              const subtotal = Number(price) * Number(qty);
              return `
                        <div class="receipt-item ${idx < items.length - 1 ? 'receipt-item--bordered' : ''}">
                            <div class="receipt-item__info">
                                <span class="receipt-item__name">${escapeAttr(item.name || 'Producto')}</span>
                                <span class="receipt-item__qty">√ó ${qty}</span>
                            </div>
                            <span class="receipt-item__price">${formatMoneyFromAny(subtotal || price, '')}</span>
                        </div>
                    `;
            })
            .join('')
          : '<p class="receipt-empty">Sin items disponibles para esta orden.</p>'
        }
            </div>
            ${waiterNote
          ? `
                <div class="receipt-notes">
                    <svg class="receipt-notes__icon" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M12 20h9"></path>
                        <path d="M16.5 3.5a2.121 2.121 0 0 1 3 3L7 19l-4 1 1-4L16.5 3.5z"></path>
                    </svg>
                    <span class="receipt-notes__text">${escapeAttr(waiterNote)}</span>
                </div>
            `
          : ''
        }
            <div class="receipt-footer">
                <div class="receipt-footer__total">
                    <span class="receipt-footer__total-label">Total</span>
                    <span class="receipt-footer__total-amount">${safeTotal}</span>
                </div>
                ${createdAt ? `<div class="receipt-footer__timestamp">Creada ${formatHourMinute(createdAt)}</div>` : ''}
            </div>
            ${['cancelled', 'delivered', 'paid', 'closed', 'billed'].includes(workflowStatus)
          ? ''
          : `
            <div style="margin-top: 1rem; padding-top: 1rem; border-top: 1px solid #e5e7eb; text-align: center;">
                <button type="button" class="btn btn--small btn--danger"
                    onclick="confirmCancelOrder(${orderId})">
                    ‚ùå Cancelar Orden
                </button>
            </div>
            `
        }
        `;

      openFloatingPanel({
        title: `Orden #${orderId}`,
        subtitle: detail?.session?.id ? `Cuenta ${detail.session.id}` : 'Detalle de la orden',
        body,
      });
    }

    // Function to open cancel order modal (called from order detail panel)
    function confirmCancelOrder(orderId) {
      // Close the order detail panel first
      closeFloatingPanel();

      // Open the cancel order modal using the waiter board's modal
      if (window.openCancelOrderModal) {
        window.openCancelOrderModal(orderId);
      } else {
        // Fallback if waiter board is not loaded
        const reason = window.prompt('Motivo de cancelaci√≥n (obligatorio)')?.trim();
        if (!reason) {
          alert('Debes indicar un motivo para cancelar.');
          return;
        }
        // Call the cancel API directly
        fetch(`/api/orders/${orderId}/cancel`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          credentials: 'include',
          body: JSON.stringify({ cancellation_reason: reason }),
        })
          .then((response) => {
            if (response.ok) {
              if (window.refreshWaiterOrders) {
                window.refreshWaiterOrders();
              } else {
                location.reload();
              }
            } else {
              alert('Error al cancelar la orden');
            }
          })
          .catch((error) => {
            alert('Error al cancelar la orden: ' + error.message);
          });
      }
    }

    // Expose cancel action for inline buttons rendered en el panel flotante
    window.confirmCancelOrder = confirmCancelOrder;

    document.addEventListener('click', (event) => {
      const target = event.target;
      if (!(target instanceof HTMLElement)) return;

      if (target.closest('[data-close-floating]')) {
        event.preventDefault();
        closeFloatingPanel();
        return;
      }

      const tableBtn = target.closest('[data-table-info]');
      if (tableBtn) {
        event.preventDefault();
        void showTableInfo(tableBtn);
        return;
      }

      // Handle table number link clicks to show table info
      const tableNumberLink = target.closest('.table-number-link');
      if (tableNumberLink) {
        event.preventDefault();
        void showTableInfo(tableNumberLink);
        return;
      }

      // Handle order ID link clicks to show order details
      const orderIdLink = target.closest('.order-id-link');
      if (orderIdLink) {
        event.preventDefault();
        void showOrderDetail(orderIdLink);
        return;
      }

      const customerBtn = target.closest('[data-customer-profile]');
      if (customerBtn) {
        event.preventDefault();
        showCustomerProfile(customerBtn);
        return;
      }

      const detailBtn = target.closest('[data-order-detail]');
      if (detailBtn) {
        event.preventDefault();
        void showOrderDetail(detailBtn);
      }
    });

    document.addEventListener('keyup', (event) => {
      if (event.key === 'Escape') {
        closeFloatingPanel();
      }
    });

    // Card Size Control with API persistence
    let currentCardSize = 'normal';
    let preferencesLoaded = false;

    async function initCardSizeControl() {
      // Card view disabled: hide controls if they exist
      const cardSizeControls = document.querySelector('.card-size-control');
      if (cardSizeControls) {
        cardSizeControls.style.display = 'none';
      }
    }

    // View Mode Toggle (Cards vs Table)
    function initViewModeToggle() {
      const grids = document.querySelectorAll('.orders-grid');
      const tables = document.querySelectorAll('.table-wrapper');
      grids.forEach((grid) => (grid.style.display = 'none'));
      tables.forEach((table) => (table.style.display = 'block'));
      localStorage.setItem('waiter_view_mode', 'table');
      document.getElementById('view-mode-cards')?.remove();
      const cardSizeControls = document.querySelector('.card-size-control');
      if (cardSizeControls) cardSizeControls.style.display = 'none';
    }

    // Initialize view mode toggle
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', initViewModeToggle);
    } else {
      initViewModeToggle();
    }

    // Initialize on load
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', initCardSizeControl);
    } else {
      initCardSizeControl();
    }

    // Handle waiter notes auto-save
    let notesSaveTimeout = null;

    document.addEventListener('input', (e) => {
      if (e.target.matches('[data-order-note]')) {
        const orderId = e.target.dataset.orderNote;
        const noteText = e.target.value;

        // Clear existing timeout
        if (notesSaveTimeout) clearTimeout(notesSaveTimeout);

        // Set new timeout to save after 1 second of no typing
        notesSaveTimeout = setTimeout(() => {
          saveWaiterNote(orderId, noteText);
        }, 1000);
      }
    });

    async function saveWaiterNote(orderId, noteText) {
      try {
        const response = await fetch(`/api/orders/${orderId}/notes`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          credentials: 'include',
          body: JSON.stringify({ notes: noteText }),
        });

        if (response.ok) {
          const data = await response.json();
          // Update the hidden table row as well
          const tableRow = document.querySelector(`tr[data-order-id="${orderId}"]`);
          if (tableRow) {
            tableRow.dataset.waiterNotes = data.waiter_notes || '';
            const tableTextarea = tableRow.querySelector(`#waiter-note-${orderId}`);
            if (tableTextarea) {
              tableTextarea.value = data.waiter_notes || '';
            }
          }
          // Update card textarea if it differs (server normalization)
          const cardTextarea = document.querySelector(`#waiter-note-card-${orderId}`);
          if (cardTextarea && cardTextarea.value !== data.waiter_notes) {
            cardTextarea.value = data.waiter_notes || '';
          }
        }
      } catch (error) {
        console.error('Error saving waiter note:', error);
      }
    }

    // Toggle Tracking (Star) Function
    window.toggleTracking = async function (orderId, buttonElement) {
      const isCurrentlyStarred = buttonElement.classList.contains('active');
      const newStarredState = !isCurrentlyStarred;

      try {
        // Update localStorage
        let trackedOrders = JSON.parse(localStorage.getItem('trackedOrders') || '[]');
        if (newStarredState) {
          if (!trackedOrders.includes(orderId)) {
            trackedOrders.push(orderId);
          }
        } else {
          trackedOrders = trackedOrders.filter((id) => id !== orderId);
        }
        localStorage.setItem('trackedOrders', JSON.stringify(trackedOrders));

        // Update button UI
        buttonElement.classList.toggle('active', newStarredState);
        buttonElement.textContent = newStarredState ? '‚òÖ' : '‚òÜ';
        buttonElement.title = newStarredState ? 'Quitar de seguimiento' : 'Agregar a seguimiento';

        // Update label in meta-row
        const card = buttonElement.closest('.order-card');
        if (card) {
          const label = card.querySelector('.order-card__star-label');
          if (label) {
            label.classList.toggle('active', newStarredState);
            label.textContent = newStarredState ? '‚òÖ' : '‚òÜ';
          }
        }

        // Optional: Save to server
        try {
          await fetch(`/api/orders/${orderId}/track`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            credentials: 'include',
            body: JSON.stringify({ tracked: newStarredState }),
          });
        } catch (err) {
          console.warn('Could not save tracking state to server:', err);
        }
      } catch (error) {
        console.error('Error toggling tracking:', error);
      }
    };
  })();
</script>

<script type="module" src="{{ assets_js_employees }}/dashboard.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>

<!-- Employee Preferences Feature (saved to database) -->
<script>
  (function () {
    // Cache for preferences
    let employeePreferences = {};
    let preferencesLoaded = false;

    // API functions
    async function loadPreferences() {
      try {
        const response = await fetch('/api/employees/me/preferences');
        const result = await response.json();
        if (result.status === 'success') {
          employeePreferences = result.data.preferences || {};
          preferencesLoaded = true;
        }
      } catch (e) {
        console.warn('[Preferences] Could not load from server, using localStorage fallback');
        // Fallback to localStorage
        try {
          const local = localStorage.getItem('pronto_employee_preferences');
          if (local) employeePreferences = JSON.parse(local);
        } catch (err) {
          /* ignore */
        }
        preferencesLoaded = true;
      }
      return employeePreferences;
    }

    async function savePreference(key, value) {
      employeePreferences[key] = value;
      // Save to localStorage as backup
      try {
        localStorage.setItem('pronto_employee_preferences', JSON.stringify(employeePreferences));
      } catch (e) {
        /* ignore */
      }

      // Save to server
      try {
        const response = await fetch('/api/employees/me/preferences', {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ [key]: value }),
        });
        return response.ok;
      } catch (e) {
        console.warn('[Preferences] Could not save to server');
        return false;
      }
    }

    function getPreference(key, defaultValue = null) {
      return employeePreferences[key] ?? defaultValue;
    }

    // Expose to window for other modules
    window.EmployeePreferences = {
      load: loadPreferences,
      save: savePreference,
      get: getPreference,
      getAll: () => employeePreferences,
    };

    // Determine default home section based on employee role
    function getDefaultHomeSection() {
      const role = window.APP_DATA?.employee_role;
      const roleSectionMap = {
        waiter: 'panel-meseros',
        chef: 'panel-cocina',
        cashier: 'caja',
        admin_roles: 'resumen',
        super_admin: 'resumen',
      };
      return roleSectionMap[role] || 'resumen';
    }

    // Add "Set as homepage" link to footer (single global link)
    function addHomepageLinks() {
      let currentHome = getPreference('home_section');

      // If no home section is set, use default based on role
      if (!currentHome) {
        currentHome = getDefaultHomeSection();
        // Save the default preference (don't await, let it happen in background)
        savePreference('home_section', currentHome).catch(() => { });
      }

      // Get current visible section
      const getCurrentSection = () => {
        const sections = document.querySelectorAll('section.section[id][data-menu-title]');
        for (const section of sections) {
          const rect = section.getBoundingClientRect();
          if (rect.top >= 0 && rect.top < window.innerHeight / 2) {
            return {
              id: section.id,
              title: section.dataset.menuTitle,
            };
          }
        }
        return { id: currentHome, title: '' };
      };

      // Update footer link based on current section
      const updateFooterLink = () => {
        const current = getCurrentSection();
        const footer = document.querySelector('footer');
        if (!footer) return;

        let linkElement = footer.querySelector('.footer-homepage-link');

        if (!linkElement) {
          // Create link for the first time
          const small = footer.querySelector('small');
          if (!small) return;

          linkElement = document.createElement('button');
          linkElement.type = 'button';
          linkElement.className = 'footer-homepage-link';

          // Insert after copyright
          small.insertAdjacentElement('afterend', linkElement);
        }

        const isCurrentHome = currentHome === current.id;
        const isDefaultHome = current.id === getDefaultHomeSection();

        if (isCurrentHome) {
          linkElement.className = 'footer-homepage-link footer-homepage-link--active';
          linkElement.innerHTML = `
                    <svg class="footer-homepage-icon" viewBox="0 0 20 20" fill="currentColor">
                        <path d="M10.707 2.293a1 1 0 00-1.414 0l-7 7a1 1 0 001.414 1.414L4 10.414V17a1 1 0 001 1h2a1 1 0 001-1v-2a1 1 0 011-1h2a1 1 0 011 1v2a1 1 0 001 1h2a1 1 0 001-1v-6.586l.293.293a1 1 0 001.414-1.414l-7-7z"/>
                    </svg>
                    Inicio predeterminado ${isDefaultHome ? '' : '‚úì'}
                `;
          linkElement.style.cursor = 'default';
          linkElement.onclick = null;
        } else {
          linkElement.className = 'footer-homepage-link';
          linkElement.innerHTML = `
                    <svg class="footer-homepage-icon" viewBox="0 0 20 20" fill="currentColor">
                        <path d="M10.707 2.293a1 1 0 00-1.414 0l-7 7a1 1 0 001.414 1.414L4 10.414V17a1 1 0 001 1h2a1 1 0 001-1v-2a1 1 0 011-1h2a1 1 0 011 1v2a1 1 0 001 1h2a1 1 0 001-1v-6.586l.293.293a1 1 0 001.414-1.414l-7-7z"/>
                    </svg>
                    Establecer como inicio
                `;
          linkElement.style.cursor = 'pointer';
          linkElement.onclick = async () => {
            // Save preference
            await savePreference('home_section', current.id);
            currentHome = current.id;

            // Update link
            updateFooterLink();

            // Show confirmation
            showToast(`"${current.title}" es ahora tu p√°gina de inicio`);
          };
        }
      };

      // Initial update
      updateFooterLink();

      // Update on scroll
      let scrollTimeout;
      window.addEventListener(
        'scroll',
        () => {
          if (scrollTimeout) clearTimeout(scrollTimeout);
          scrollTimeout = setTimeout(updateFooterLink, 100);
        },
        { passive: true }
      );
    }

    // Scroll to saved section on load
    function scrollToSavedSection() {
      const hashId = (location.hash || '').replace('#', '').trim();
      const hashTarget = hashId ? document.getElementById(hashId) : null;

      let lastSection = null;
      try {
        lastSection = sessionStorage.getItem('pronto_last_section');
      } catch (e) {
        /* ignore */
      }

      let savedSection =
        (hashTarget && hashTarget.classList.contains('section') ? hashId : null) ||
        lastSection ||
        getPreference('home_section') ||
        getDefaultHomeSection();

      if (!savedSection) return;
      const section = document.getElementById(savedSection);
      if (!section) return;

      setTimeout(() => {
        section.scrollIntoView({ behavior: 'auto', block: 'start' });
      }, 50);
    }

    function saveLastSectionForRefresh() {
      try {
        const sections = document.querySelectorAll('section.section[id][data-menu-title]');
        for (const section of sections) {
          const rect = section.getBoundingClientRect();
          if (rect.top >= 0 && rect.top < window.innerHeight / 2) {
            sessionStorage.setItem('pronto_last_section', section.id);
            break;
          }
        }
      } catch (e) {
        /* ignore */
      }
    }

    // Toast notification
    function showToast(message) {
      const existing = document.querySelector('.homepage-toast');
      if (existing) existing.remove();

      const toast = document.createElement('div');
      toast.className = 'homepage-toast';
      toast.innerHTML = `<span>‚úÖ</span> ${message}`;
      document.body.appendChild(toast);

      setTimeout(() => toast.classList.add('show'), 10);
      setTimeout(() => {
        toast.classList.remove('show');
        setTimeout(() => toast.remove(), 300);
      }, 3000);
    }

    // Initialize
    document.addEventListener('DOMContentLoaded', async () => {
      await loadPreferences();
      addHomepageLinks();
      scrollToSavedSection();

      // Persist where the user is "standing" so refresh keeps the same module
      window.addEventListener('beforeunload', saveLastSectionForRefresh);
      document.addEventListener('visibilitychange', () => {
        if (document.visibilityState === 'hidden') {
          saveLastSectionForRefresh();
        }
      });
    });
  })();
</script>

<style>
  .section-homepage-footer {
    margin-top: 2rem;
    padding-top: 1.5rem;
    border-top: 1px dashed #e2e8f0;
    text-align: center;
  }

  .set-homepage-link {
    display: inline-flex;
    align-items: center;
    gap: 0.5rem;
    padding: 0.6rem 1.25rem;
    background: #f8fafc;
    border: 2px solid #e2e8f0;
    border-radius: 8px;
    font-size: 0.875rem;
    font-weight: 500;
    color: #64748b;
    cursor: pointer;
    transition: all 0.2s ease;
  }

  .set-homepage-link:hover {
    background: #fff7ed;
    border-color: #ff6b35;
    color: #ff6b35;
  }

  .set-homepage-link--active {
    background: linear-gradient(135deg, #ecfdf5 0%, #d1fae5 100%);
    border-color: #10b981;
    color: #059669;
  }

  .set-homepage-link--active:hover {
    background: linear-gradient(135deg, #ecfdf5 0%, #d1fae5 100%);
    border-color: #10b981;
    color: #059669;
  }

  .homepage-icon {
    font-size: 1rem;
  }

  .homepage-toast {
    position: fixed;
    bottom: 2rem;
    left: 50%;
    transform: translateX(-50%) translateY(20px);
    background: linear-gradient(135deg, #1e293b 0%, #334155 100%);
    color: white;
    padding: 0.85rem 1.5rem;
    border-radius: 10px;
    font-size: 0.9rem;
    font-weight: 500;
    box-shadow: 0 10px 40px rgba(0, 0, 0, 0.25);
    opacity: 0;
    transition: all 0.3s ease;
    z-index: 9999;
    display: flex;
    align-items: center;
    gap: 0.5rem;
  }

  .homepage-toast.show {
    opacity: 1;
    transform: translateX(-50%) translateY(0);
  }

  /* Table Assignment Styles */
  .modal {
    background-color: rgba(0, 0, 0, 0.5);
  }

  .modal.show {
    display: block !important;
  }

  .table-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
    gap: 1rem;
    margin-top: 1rem;
  }

  .table-card {
    border: 2px solid #e2e8f0;
    border-radius: 8px;
    padding: 1rem;
    cursor: pointer;
    transition: all 0.2s ease;
    background: white;
  }

  .table-card:hover {
    border-color: #3b82f6;
    box-shadow: 0 4px 12px rgba(59, 130, 246, 0.15);
    transform: translateY(-2px);
  }

  .table-card.selected {
    border-color: #10b981;
    background: #f0fdf4;
  }

  .table-card.my-table {
    border-color: #8b5cf6;
    background: linear-gradient(135deg, #faf5ff 0%, #f3e8ff 100%);
  }

  .table-card-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 0.75rem;
  }

  .table-number {
    font-weight: 600;
    font-size: 1.1rem;
    color: #1e293b;
  }

  .table-card-body {
    margin-top: 0.5rem;
  }

  .table-info {
    display: flex;
    justify-content: space-between;
    align-items: center;
    gap: 0.5rem;
  }

  .capacity {
    font-size: 0.875rem;
    color: #64748b;
    display: flex;
    align-items: center;
    gap: 0.25rem;
  }

  .unassign-btn {
    padding: 0.25rem 0.5rem;
    font-size: 0.875rem;
  }

  /* Button Link Style */
  .btn-link {
    background: none;
    border: none;
    cursor: pointer;
    padding: 0;
    font: inherit;
    transition: color var(--transition-fast);
  }

  .btn-link:hover {
    text-decoration: underline;
  }

  .order-id-link {
    color: #3b82f6;
    font-weight: 600;
  }

  .order-id-link:hover {
    color: #2563eb;
  }

  .table-number-link {
    color: #ea580c;
    font-weight: 600;
    display: inline-flex;
    align-items: center;
    gap: 0.25rem;
  }

  .table-number-link:hover {
    color: #c2410c;
  }

  .star-btn {
    background: none;
    border: none;
    cursor: pointer;
    padding: 0.25rem;
    font-size: 1.25rem;
    color: #94a3b8;
    transition:
      color var(--transition-fast),
      transform var(--transition-fast);
  }

  .star-btn:hover {
    color: #fbbf24;
    transform: scale(1.1);
  }

  .star-btn.starred {
    color: #fbbf24;
  }
</style>

<!-- Toast Notification Container -->
<div id="toast-container" class="toast-container" aria-live="polite" aria-atomic="true"></div>

<!-- Empty State Template (hidden by default) -->
<div id="empty-state-template" class="empty-state empty-state--table" style="display: none">
  <div class="empty-state__icon">
    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
      <path stroke-linecap="round" stroke-linejoin="round"
        d="M12 9v3.75m9-.75a9 9 0 11-18 0 9 9 0 0118 0zm-9 3.75h.008v.008H12v-.008z" />
    </svg>
  </div>
  <h3 class="empty-state__title">Sin datos</h3>
  <p class="empty-state__description">No hay elementos para mostrar en este momento.</p>
</div>

<!-- Empty State for No Orders -->
<div id="empty-orders-template" class="empty-state empty-state--table" style="display: none">
  <div class="empty-state__icon">
    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
      <path stroke-linecap="round" stroke-linejoin="round"
        d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2" />
    </svg>
  </div>
  <h3 class="empty-state__title">Sin √≥rdenes</h3>
  <p class="empty-state__description">No hay √≥rdenes activas en este momento.</p>
</div>

<!-- ToastManager is now defined in base.html - no duplicate needed here -->

<!-- Chart.js for reports visualization -->
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"
  integrity="sha384-e6nUZLBkQ86NJ6TVVKAeSaK8jWa3NhkYWZFomE39AvDbQWeie9PlQqM3pmYW5d1g" crossorigin="anonymous"></script>

<script>
  // Branding Manager Logic
  document.addEventListener('DOMContentLoaded', () => {
    // Only init if branding section exists
    if (
      document.getElementById('branding-manager-container') ||
      document.getElementById('branding-manager')
    ) {
      class BrandingManager {
        constructor() {
          this.container =
            document.getElementById('branding-manager') ||
            document.getElementById('branding-manager-container');
          if (!this.container) return;

          this.config = null;
          this.selectedApi = 'pollinations';
          this.selectedStyle = 'modern';
          this.init();
        }

        async init() {
          await this.loadConfig();
          this.render();
          this.bindEvents();
        }

        async loadConfig() {
          // Mock config for now if endpoint fails or returns 404
          this.config = {
            branding_url: '/static/assets/branding',
            static_url: '/static',
            restaurant_slug: 'pronto',
            product_images_count: 0,
            files: { logo: false, icon: false, banner: false, placeholder: false },
          };

          try {
            const response = await fetch('/api/branding/config');
            if (response.ok) {
              const data = await response.json();
              if (data.status === 'success' || data.success) {
                this.config = data.data;
              }
            }
          } catch (error) {
            console.warn('Error cargando configuraci√≥n real, usando mock:', error);
          }
        }

        render() {
          if (!this.config) return;

          const t = Date.now();
          this.container.innerHTML = `
                <div class="branding-manager">
                    <div class="branding-grid" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 1.5rem; margin-bottom: 2rem;">
                        ${this.renderAssetCard('logo', 'Logo Principal', '512x512px', this.config.branding_url, this.config.files.logo)}
                        ${this.renderAssetCard('icon', 'Icono / Favicon', '128x128px', this.config.branding_url, this.config.files.icon, 'small')}
                        ${this.renderAssetCard('banner', 'Banner', '1200x400px', this.config.branding_url, this.config.files.banner, 'banner wide')}
                    </div>
                </div>
            `;
        }

        renderAssetCard(type, title, size, baseUrl, exists, extraClass = '') {
          const t = Date.now();
          return `
                <div class="branding-card card" style="padding: 1.5rem; border: 1px solid #e5e8ec; border-radius: 12px; background: white;">
                    <div class="branding-info">
                        <h4 style="margin:0 0 0.5rem 0; font-size: 1.1rem;">${title}</h4>
                        <p style="color:#64748b; font-size:0.9rem;">${size}</p>
                    </div>
                </div>
            `;
        }

        bindEvents() { }
      }
      new BrandingManager();
    }
  });
</script>

<!-- Reports manager -->
<script src="{{ assets_js_employees }}/reports.js"></script>

window.currentUser = {
id: {{ employee_id | tojson }},
name: {{ employee_name | tojson }},
role: {{ employee_role | tojson }},
permissions: {{ role_capabilities | tojson }}
};

// Initialize Employee Events
if (typeof initEmployeeEvents === 'function') {
initEmployeeEvents();
} else if (window.EmployeeEvents && typeof window.EmployeeEvents.init === 'function') {
window.EmployeeEvents.init();
}
</script>

<!-- Managers Scripts -->
<script src="{{ assets_js_employees }}/employees_manager_vanilla.js"></script>
<script src="{{ assets_js_employees }}/roles_manager_vanilla.js"></script>
