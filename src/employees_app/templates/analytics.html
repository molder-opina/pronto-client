{% extends "base.html" %} {% block content %}
<div class="analytics-container">
  <div class="analytics-header">
    <div>
      <h1>Analytics</h1>
      <p class="subtitle">Business intelligence and KPIs</p>
    </div>
    <div class="period-selector">
      <label for="period">Period:</label>
      <select id="period" onchange="changePeriod(this.value)">
        <option value="7">Last 7 days</option>
        <option value="14">Last 14 days</option>
        <option value="30" selected>Last 30 days</option>
        <option value="90">Last 90 days</option>
      </select>
      <label for="comparison" style="margin-left: 1rem">Compare to:</label>
      <select id="comparison" onchange="changeComparison(this.value)">
        <option value="previous_period" selected>Previous period</option>
        <option value="same_period_last_year">Same period last year</option>
      </select>
    </div>
  </div>

  <!-- KPIs Section -->
  <div class="kpi-grid" id="kpi-grid">
    <!-- Loading state -->
    <div class="loading-state">Loading KPIs...</div>
  </div>

  <!-- Charts Row -->
  <div class="charts-row">
    <!-- Revenue Trend Chart -->
    <div class="chart-card full-width">
      <div class="chart-header">
        <h3>Revenue Trend</h3>
        <div class="chart-controls">
          <select id="revenue-granularity" onchange="updateRevenueChart()">
            <option value="day">Daily</option>
            <option value="week">Weekly</option>
            <option value="month">Monthly</option>
          </select>
        </div>
      </div>
      <div class="chart-container" id="revenue-chart">
        <canvas id="revenueCanvas"></canvas>
      </div>
    </div>
  </div>

  <!-- Metrics Row -->
  <div class="metrics-row">
    <!-- Waiter Performance -->
    <div class="metrics-card">
      <div class="metrics-header">
        <h3>Waiter Performance</h3>
        <button class="btn-secondary" onclick="exportWaiterPerformance()">Export</button>
      </div>
      <div class="metrics-content" id="waiter-performance">
        <div class="loading-state">Loading waiter performance...</div>
      </div>
    </div>

    <!-- Category Performance -->
    <div class="metrics-card">
      <div class="metrics-header">
        <h3>Category Performance</h3>
        <button class="btn-secondary" onclick="exportCategoryPerformance()">Export</button>
      </div>
      <div class="metrics-content" id="category-performance">
        <div class="loading-state">Loading category performance...</div>
      </div>
    </div>
  </div>

  <!-- Operational Metrics -->
  <div class="operational-metrics" id="operational-metrics">
    <div class="loading-state">Loading operational metrics...</div>
  </div>

  <!-- Customer Segments -->
  <div class="customer-segments" id="customer-segments">
    <div class="segments-header">
      <h3>Customer Segments</h3>
      <div class="segment-filters">
        <button class="btn-filter active" onclick="filterSegments('all')">All</button>
        <button class="btn-filter" onclick="filterSegments('high_value')">High Value</button>
        <button class="btn-filter" onclick="filterSegments('medium_value')">Medium Value</button>
        <button class="btn-filter" onclick="filterSegments('low_value')">Low Value</button>
      </div>
    </div>
    <div class="segments-content" id="segments-content">
      <div class="loading-state">Loading customer segments...</div>
    </div>
  </div>

  <!-- Comparison View -->
  <div class="comparison-view" id="comparison-view">
    <div class="comparison-header">
      <h3>Period Comparison</h3>
      <div class="comparison-dates" id="comparison-dates">
        <!-- Will be populated by JS -->
      </div>
    </div>
    <div class="comparison-content" id="comparison-content">
      <div class="loading-state">Loading comparison data...</div>
    </div>
  </div>
</div>

<!-- Custom Styles -->
<style>
  .analytics-container {
    padding: 2rem;
    max-width: 1400px;
    margin: 0 auto;
  }

  .analytics-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 2rem;
  }

  .analytics-header h1 {
    margin: 0;
    font-size: 2rem;
    color: #1e293b;
  }

  .subtitle {
    margin: 0.5rem 0 0 0;
    color: #64748b;
    font-size: 0.875rem;
  }

  .period-selector {
    display: flex;
    align-items: center;
    gap: 0.5rem;
  }

  .period-selector label {
    color: #64748b;
    font-size: 0.875rem;
    font-weight: 500;
  }

  .period-selector select {
    padding: 0.5rem 1rem;
    border: 1px solid #e2e8f0;
    border-radius: 0.5rem;
    background: white;
    color: #1e293b;
    font-size: 0.875rem;
    cursor: pointer;
  }

  .kpi-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
    gap: 1rem;
    margin-bottom: 2rem;
  }

  .kpi-card {
    background: white;
    border-radius: 0.75rem;
    padding: 1.5rem;
    box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
    border: 1px solid #e2e8f0;
  }

  .kpi-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 1rem;
  }

  .kpi-icon {
    width: 48px;
    height: 48px;
    border-radius: 0.5rem;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 1.5rem;
  }

  .kpi-label {
    font-size: 0.875rem;
    color: #64748b;
    font-weight: 500;
    margin-bottom: 0.5rem;
  }

  .kpi-value {
    font-size: 2rem;
    font-weight: 700;
    color: #1e293b;
    margin-bottom: 0.5rem;
  }

  .kpi-change {
    font-size: 0.875rem;
    font-weight: 500;
    display: flex;
    align-items: center;
    gap: 0.25rem;
  }

  .kpi-change.positive {
    color: #16a34a;
  }

  .kpi-change.negative {
    color: #dc2626;
  }

  .kpi-change.neutral {
    color: #64748b;
  }

  .charts-row {
    display: grid;
    grid-template-columns: 1fr;
    gap: 1rem;
    margin-bottom: 2rem;
  }

  .chart-card {
    background: white;
    border-radius: 0.75rem;
    padding: 1.5rem;
    box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
    border: 1px solid #e2e8f0;
  }

  .chart-card.full-width {
    grid-column: 1 / -1;
  }

  .chart-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 1rem;
  }

  .chart-header h3 {
    margin: 0;
    font-size: 1.125rem;
    color: #1e293b;
  }

  .chart-controls select {
    padding: 0.25rem 0.5rem;
    border: 1px solid #e2e8f0;
    border-radius: 0.375rem;
    background: white;
    color: #1e293b;
    font-size: 0.875rem;
    cursor: pointer;
  }

  .chart-container {
    height: 400px;
    position: relative;
  }

  .metrics-row {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
    gap: 1rem;
    margin-bottom: 2rem;
  }

  .metrics-card {
    background: white;
    border-radius: 0.75rem;
    padding: 1.5rem;
    box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
    border: 1px solid #e2e8f0;
  }

  .metrics-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 1rem;
  }

  .metrics-header h3 {
    margin: 0;
    font-size: 1.125rem;
    color: #1e293b;
  }

  .btn-secondary {
    padding: 0.5rem 1rem;
    background: #f1f5f9;
    border: none;
    border-radius: 0.375rem;
    color: #475569;
    font-size: 0.875rem;
    font-weight: 500;
    cursor: pointer;
    transition: all 0.2s;
  }

  .btn-secondary:hover {
    background: #e2e8f0;
  }

  .metrics-content {
    max-height: 400px;
    overflow-y: auto;
  }

  .performance-item {
    display: grid;
    grid-template-columns: 2fr 1fr 1fr 1fr 1fr;
    gap: 0.75rem;
    padding: 0.75rem;
    border-bottom: 1px solid #e2e8f0;
    align-items: center;
  }

  .performance-item:last-child {
    border-bottom: none;
  }

  .performance-item.header {
    font-weight: 600;
    color: #64748b;
    font-size: 0.75rem;
    text-transform: uppercase;
    letter-spacing: 0.05em;
  }

  .performance-name {
    font-weight: 500;
    color: #1e293b;
  }

  .performance-value {
    font-size: 0.875rem;
    color: #475569;
  }

  .operational-metrics {
    background: white;
    border-radius: 0.75rem;
    padding: 1.5rem;
    box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
    border: 1px solid #e2e8f0;
    margin-bottom: 2rem;
  }

  .operational-metrics h3 {
    margin: 0 0 1.5rem 0;
    font-size: 1.125rem;
    color: #1e293b;
  }

  .operational-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
    gap: 1.5rem;
  }

  .operational-item {
    background: #f8fafc;
    border-radius: 0.5rem;
    padding: 1.25rem;
  }

  .operational-label {
    font-size: 0.75rem;
    font-weight: 600;
    color: #64748b;
    text-transform: uppercase;
    letter-spacing: 0.05em;
    margin-bottom: 0.75rem;
  }

  .operational-value {
    font-size: 1.5rem;
    font-weight: 700;
    color: #1e293b;
    margin-bottom: 0.5rem;
  }

  .operational-sub {
    font-size: 0.75rem;
    color: #64748b;
  }

  .customer-segments {
    background: white;
    border-radius: 0.75rem;
    padding: 1.5rem;
    box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
    border: 1px solid #e2e8f0;
    margin-bottom: 2rem;
  }

  .segments-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 1.5rem;
  }

  .segments-header h3 {
    margin: 0;
    font-size: 1.125rem;
    color: #1e293b;
  }

  .segment-filters {
    display: flex;
    gap: 0.5rem;
  }

  .btn-filter {
    padding: 0.5rem 1rem;
    background: #f1f5f9;
    border: 1px solid #e2e8f0;
    border-radius: 0.375rem;
    color: #475569;
    font-size: 0.875rem;
    font-weight: 500;
    cursor: pointer;
    transition: all 0.2s;
  }

  .btn-filter:hover {
    background: #e2e8f0;
  }

  .btn-filter.active {
    background: #ff6b35;
    border-color: #ff6b35;
    color: white;
  }

  .segments-content {
    max-height: 400px;
    overflow-y: auto;
  }

  .segment-item {
    display: grid;
    grid-template-columns: 2fr 1fr 1fr 1fr 1fr;
    gap: 0.75rem;
    padding: 0.75rem;
    border-bottom: 1px solid #e2e8f0;
    align-items: center;
  }

  .segment-item:last-child {
    border-bottom: none;
  }

  .segment-badge {
    display: inline-block;
    padding: 0.25rem 0.5rem;
    border-radius: 0.25rem;
    font-size: 0.75rem;
    font-weight: 600;
    text-transform: uppercase;
  }

  .segment-badge.high_value {
    background: #dcfce7;
    color: #166534;
  }

  .segment-badge.medium_value {
    background: #fef9c3;
    color: #854d0e;
  }

  .segment-badge.low_value {
    background: #fee2e2;
    color: #991b1b;
  }

  .comparison-view {
    background: white;
    border-radius: 0.75rem;
    padding: 1.5rem;
    box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
    border: 1px solid #e2e8f0;
  }

  .comparison-header {
    margin-bottom: 1.5rem;
  }

  .comparison-header h3 {
    margin: 0 0 1rem 0;
    font-size: 1.125rem;
    color: #1e293b;
  }

  .comparison-dates {
    display: flex;
    gap: 2rem;
    font-size: 0.875rem;
    color: #64748b;
  }

  .comparison-date-item {
    display: flex;
    align-items: center;
    gap: 0.5rem;
  }

  .comparison-date-label {
    font-weight: 500;
  }

  .comparison-content {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
    gap: 1.5rem;
  }

  .comparison-item {
    background: #f8fafc;
    border-radius: 0.5rem;
    padding: 1.25rem;
  }

  .comparison-label {
    font-size: 0.875rem;
    color: #64748b;
    margin-bottom: 0.5rem;
  }

  .comparison-values {
    display: flex;
    justify-content: space-between;
    align-items: center;
  }

  .comparison-current {
    font-size: 1.25rem;
    font-weight: 700;
    color: #1e293b;
  }

  .comparison-change {
    display: flex;
    align-items: center;
    gap: 0.25rem;
    font-size: 0.875rem;
    font-weight: 500;
  }

  .comparison-change.positive {
    color: #16a34a;
  }

  .comparison-change.negative {
    color: #dc2626;
  }

  .loading-state {
    display: flex;
    align-items: center;
    justify-content: center;
    padding: 3rem;
    color: #64748b;
    font-size: 0.875rem;
  }

  @media (max-width: 768px) {
    .analytics-header {
      flex-direction: column;
      align-items: flex-start;
      gap: 1rem;
    }

    .period-selector {
      flex-wrap: wrap;
    }

    .metrics-row {
      grid-template-columns: 1fr;
    }

    .operational-grid {
      grid-template-columns: 1fr;
    }

    .segment-filters {
      flex-wrap: wrap;
    }
  }
</style>

<!-- Chart.js Library -->
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>

<!-- Custom JavaScript -->
<script>
  let revenueChart = null;
  let currentPeriod = 30;
  let currentComparison = 'previous_period';

  // Initialize on page load
  document.addEventListener('DOMContentLoaded', function () {
    loadKPIs();
    loadRevenueTrend();
    loadWaiterPerformance();
    loadCategoryPerformance();
    loadOperationalMetrics();
    loadCustomerSegments();
    loadComparison();
  });

  function changePeriod(days) {
    currentPeriod = parseInt(days);
    loadKPIs();
    loadRevenueTrend();
    loadWaiterPerformance();
    loadCategoryPerformance();
    loadOperationalMetrics();
    loadCustomerSegments();
    loadComparison();
  }

  function changeComparison(comparison) {
    currentComparison = comparison;
    loadKPIs();
    loadComparison();
  }

  async function loadKPIs() {
    const container = document.getElementById('kpi-grid');
    container.innerHTML = '<div class="loading-state">Loading KPIs...</div>';

    try {
      const endDate = new Date().toISOString().split('T')[0];
      const startDate = new Date(Date.now() - currentPeriod * 24 * 60 * 60 * 1000)
        .toISOString()
        .split('T')[0];

      const response = await fetch(
        `/api/analytics/kpis?start_date=${startDate}&end_date=${endDate}&comparison_period=${currentComparison}`
      );
      const data = await response.json();

      if (data.success) {
        renderKPIs(data.data.kpis);
      } else {
        container.innerHTML = '<div class="loading-state">Error loading KPIs</div>';
      }
    } catch (error) {
      console.error('Error loading KPIs:', error);
      container.innerHTML = '<div class="loading-state">Error loading KPIs</div>';
    }
  }

  function renderKPIs(kpis) {
    const container = document.getElementById('kpi-grid');

    const kpiConfigs = [
      {
        key: 'total_orders',
        label: 'Total Orders',
        icon: 'ðŸ“¦',
        format: (v) => v.toLocaleString(),
      },
      {
        key: 'total_revenue',
        label: 'Total Revenue',
        icon: 'ðŸ’°',
        format: (v) =>
          `$${v.toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 })}`,
      },
      {
        key: 'avg_order_value',
        label: 'Avg Order Value',
        icon: 'ðŸ“Š',
        format: (v) =>
          `$${v.toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 })}`,
      },
      {
        key: 'total_customers',
        label: 'Total Customers',
        icon: 'ðŸ‘¥',
        format: (v) => v.toLocaleString(),
      },
      {
        key: 'repeat_customer_rate',
        label: 'Repeat Customer Rate',
        icon: 'ðŸ”„',
        format: (v) => `${v.toFixed(1)}%`,
      },
      {
        key: 'total_tips',
        label: 'Total Tips',
        icon: 'ðŸ’µ',
        format: (v) =>
          `$${v.toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 })}`,
      },
    ];

    container.innerHTML = kpiConfigs
      .map((config) => {
        const kpi = kpis[config.key];
        const change = kpi.change;
        const changeClass =
          change && change.value > 0
            ? 'positive'
            : change && change.value < 0
              ? 'negative'
              : 'neutral';
        const changeIcon =
          change && change.value > 0 ? 'â†‘' : change && change.value < 0 ? 'â†“' : 'â€”';

        return `
                <div class="kpi-card">
                    <div class="kpi-header">
                        <div class="kpi-icon" style="background: #FFF5F2; color: var(--primary-orange);">
                            ${config.icon}
                        </div>
                    </div>
                    <div class="kpi-label">${config.label}</div>
                    <div class="kpi-value">${config.format(kpi.value)}</div>
                    <div class="kpi-change ${changeClass}">
                        ${
                          change
                            ? `
                            ${changeIcon} ${Math.abs(change.percentage).toFixed(1)}%
                            <span style="color: #64748b; margin-left: 0.5rem;">vs previous</span>
                        `
                            : 'No change data'
                        }
                    </div>
                </div>
            `;
      })
      .join('');
  }

  async function loadRevenueTrend() {
    const granularity = document.getElementById('revenue-granularity').value;

    try {
      const endDate = new Date().toISOString().split('T')[0];
      const startDate = new Date(Date.now() - currentPeriod * 24 * 60 * 60 * 1000)
        .toISOString()
        .split('T')[0];

      const response = await fetch(
        `/api/analytics/revenue-trends?start_date=${startDate}&end_date=${endDate}&granularity=${granularity}`
      );
      const data = await response.json();

      if (data.success) {
        renderRevenueChart(data.data.data, granularity);
      }
    } catch (error) {
      console.error('Error loading revenue trend:', error);
    }
  }

  function updateRevenueChart() {
    loadRevenueTrend();
  }

  function renderRevenueChart(data, granularity) {
    const ctx = document.getElementById('revenueCanvas').getContext('2d');

    if (revenueChart) {
      revenueChart.destroy();
    }

    const labels = data.map((d) => d.time_period);
    const revenueData = data.map((d) => d.total_revenue);

    revenueChart = new Chart(ctx, {
      type: 'line',
      data: {
        labels: labels,
        datasets: [
          {
            label: 'Revenue',
            data: revenueData,
            borderColor: '#ff6b35',
            backgroundColor: 'rgba(255, 107, 53, 0.1)',
            fill: true,
            tension: 0.4,
          },
        ],
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
          legend: {
            display: false,
          },
        },
        scales: {
          y: {
            beginAtZero: true,
            ticks: {
              callback: function (value) {
                return '$' + value.toLocaleString();
              },
            },
          },
        },
      },
    });
  }

  async function loadWaiterPerformance() {
    const container = document.getElementById('waiter-performance');

    try {
      const endDate = new Date().toISOString().split('T')[0];
      const startDate = new Date(Date.now() - currentPeriod * 24 * 60 * 60 * 1000)
        .toISOString()
        .split('T')[0];

      const response = await fetch(
        `/api/analytics/waiter-performance?start_date=${startDate}&end_date=${endDate}`
      );
      const data = await response.json();

      if (data.success) {
        renderWaiterPerformance(data.data.data);
      } else {
        container.innerHTML = '<div class="loading-state">Error loading waiter performance</div>';
      }
    } catch (error) {
      console.error('Error loading waiter performance:', error);
      container.innerHTML = '<div class="loading-state">Error loading waiter performance</div>';
    }
  }

  function renderWaiterPerformance(data) {
    const container = document.getElementById('waiter-performance');

    container.innerHTML = `
            <div class="performance-item header">
                <div>Waiter</div>
                <div>Orders</div>
                <div>Sales</div>
                <div>Tips</div>
                <div>Tip %</div>
            </div>
            ${data
              .map(
                (item) => `
                <div class="performance-item">
                    <div class="performance-name">${item.waiter_name}</div>
                    <div class="performance-value">${item.order_count}</div>
                    <div class="performance-value">$${item.total_sales.toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 })}</div>
                    <div class="performance-value">$${item.total_tips.toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 })}</div>
                    <div class="performance-value">${item.tip_percentage.toFixed(1)}%</div>
                </div>
            `
              )
              .join('')}
        `;
  }

  async function loadCategoryPerformance() {
    const container = document.getElementById('category-performance');

    try {
      const endDate = new Date().toISOString().split('T')[0];
      const startDate = new Date(Date.now() - currentPeriod * 24 * 60 * 60 * 1000)
        .toISOString()
        .split('T')[0];

      const response = await fetch(
        `/api/analytics/category-performance?start_date=${startDate}&end_date=${endDate}`
      );
      const data = await response.json();

      if (data.success) {
        renderCategoryPerformance(data.data.data);
      } else {
        container.innerHTML = '<div class="loading-state">Error loading category performance</div>';
      }
    } catch (error) {
      console.error('Error loading category performance:', error);
      container.innerHTML = '<div class="loading-state">Error loading category performance</div>';
    }
  }

  function renderCategoryPerformance(data) {
    const container = document.getElementById('category-performance');

    container.innerHTML = `
            <div class="performance-item header">
                <div>Category</div>
                <div>Quantity</div>
                <div>Revenue</div>
                <div>Avg Price</div>
                <div>Revenue %</div>
            </div>
            ${data
              .map(
                (item) => `
                <div class="performance-item">
                    <div class="performance-name">${item.category_name}</div>
                    <div class="performance-value">${item.total_quantity}</div>
                    <div class="performance-value">$${item.total_revenue.toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 })}</div>
                    <div class="performance-value">$${item.avg_item_price.toFixed(2)}</div>
                    <div class="performance-value">${item.revenue_percentage.toFixed(1)}%</div>
                </div>
            `
              )
              .join('')}
        `;
  }

  async function loadOperationalMetrics() {
    const container = document.getElementById('operational-metrics');

    try {
      const endDate = new Date().toISOString().split('T')[0];
      const startDate = new Date(Date.now() - currentPeriod * 24 * 60 * 60 * 1000)
        .toISOString()
        .split('T')[0];

      const response = await fetch(
        `/api/analytics/operational-metrics?start_date=${startDate}&end_date=${endDate}`
      );
      const data = await response.json();

      if (data.success) {
        renderOperationalMetrics(data.data.data);
      } else {
        container.innerHTML = '<div class="loading-state">Error loading operational metrics</div>';
      }
    } catch (error) {
      console.error('Error loading operational metrics:', error);
      container.innerHTML = '<div class="loading-state">Error loading operational metrics</div>';
    }
  }

  function renderOperationalMetrics(data) {
    const container = document.getElementById('operational-metrics');

    const formatSeconds = (seconds) => {
      if (!seconds) return 'N/A';
      const mins = Math.floor(seconds / 60);
      const secs = Math.floor(seconds % 60);
      return `${mins}m ${secs}s`;
    };

    container.innerHTML = `
            <h3>Operational Metrics</h3>
            <div class="operational-grid">
                <div class="operational-item">
                    <div class="operational-label">Preparation Time</div>
                    <div class="operational-value">${formatSeconds(data.preparation_time.avg_seconds)}</div>
                    <div class="operational-sub">
                        Avg: ${formatSeconds(data.preparation_time.avg_seconds)} |
                        Min: ${formatSeconds(data.preparation_time.min_seconds)} |
                        Max: ${formatSeconds(data.preparation_time.max_seconds)}
                    </div>
                </div>
                <div class="operational-item">
                    <div class="operational-label">Delivery Time</div>
                    <div class="operational-value">${formatSeconds(data.delivery_time.avg_seconds)}</div>
                    <div class="operational-sub">
                        Avg: ${formatSeconds(data.delivery_time.avg_seconds)} |
                        Min: ${formatSeconds(data.delivery_time.min_seconds)} |
                        Max: ${formatSeconds(data.delivery_time.max_seconds)}
                    </div>
                </div>
                <div class="operational-item">
                    <div class="operational-label">Waiter Acceptance Time</div>
                    <div class="operational-value">${formatSeconds(data.waiter_acceptance_time.avg_seconds)}</div>
                    <div class="operational-sub">
                        Avg: ${formatSeconds(data.waiter_acceptance_time.avg_seconds)} |
                        Min: ${formatSeconds(data.waiter_acceptance_time.min_seconds)} |
                        Max: ${formatSeconds(data.waiter_acceptance_time.max_seconds)}
                    </div>
                </div>
                <div class="operational-item">
                    <div class="operational-label">Chef Acceptance Time</div>
                    <div class="operational-value">${formatSeconds(data.chef_acceptance_time.avg_seconds)}</div>
                    <div class="operational-sub">
                        Avg: ${formatSeconds(data.chef_acceptance_time.avg_seconds)} |
                        Min: ${formatSeconds(data.chef_acceptance_time.min_seconds)} |
                        Max: ${formatSeconds(data.chef_acceptance_time.max_seconds)}
                    </div>
                </div>
                <div class="operational-item">
                    <div class="operational-label">Delivery Rate</div>
                    <div class="operational-value">${data.delivery_rate.percentage.toFixed(1)}%</div>
                    <div class="operational-sub">
                        ${data.delivery_rate.delivered_orders} of ${data.delivery_rate.total_orders} orders delivered
                    </div>
                </div>
            </div>
        `;
  }

  async function loadCustomerSegments(filter = 'all') {
    const container = document.getElementById('segments-content');

    try {
      const endDate = new Date().toISOString().split('T')[0];
      const startDate = new Date(Date.now() - currentPeriod * 24 * 60 * 60 * 1000)
        .toISOString()
        .split('T')[0];

      const response = await fetch(
        `/api/analytics/customer-segments?start_date=${startDate}&end_date=${endDate}`
      );
      const data = await response.json();

      if (data.success) {
        renderCustomerSegments(data.data.data, filter);
      } else {
        container.innerHTML = '<div class="loading-state">Error loading customer segments</div>';
      }
    } catch (error) {
      console.error('Error loading customer segments:', error);
      container.innerHTML = '<div class="loading-state">Error loading customer segments</div>';
    }
  }

  function filterSegments(filter) {
    document.querySelectorAll('.btn-filter').forEach((btn) => btn.classList.remove('active'));
    event.target.classList.add('active');
    loadCustomerSegments(filter);
  }

  function renderCustomerSegments(data, filter) {
    const container = document.getElementById('segments-content');

    const filteredData = filter === 'all' ? data : data.filter((item) => item.segment === filter);

    container.innerHTML = `
            <div class="segment-item header">
                <div>Customer</div>
                <div>Orders</div>
                <div>Total Spent</div>
                <div>Avg Order</div>
                <div>Segment</div>
            </div>
            ${filteredData
              .map(
                (item) => `
                <div class="segment-item">
                    <div>
                        <div class="performance-name">${item.customer_name}</div>
                        <div style="font-size: 0.75rem; color: #64748b;">${item.customer_email}</div>
                    </div>
                    <div class="performance-value">${item.order_count}</div>
                    <div class="performance-value">$${item.total_spent.toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 })}</div>
                    <div class="performance-value">$${item.avg_order_value.toFixed(2)}</div>
                    <div>
                        <span class="segment-badge ${item.segment}">${item.segment.replace('_', ' ')}</span>
                    </div>
                </div>
            `
              )
              .join('')}
        `;
  }

  async function loadComparison() {
    const container = document.getElementById('comparison-content');

    try {
      const endDate = new Date().toISOString().split('T')[0];
      const startDate = new Date(Date.now() - currentPeriod * 24 * 60 * 60 * 1000)
        .toISOString()
        .split('T')[0];

      const response = await fetch(
        `/api/analytics/comparison?current_start_date=${startDate}&current_end_date=${endDate}&comparison_period=${currentComparison}`
      );
      const data = await response.json();

      if (data.success) {
        renderComparison(data.data);
      } else {
        container.innerHTML = '<div class="loading-state">Error loading comparison</div>';
      }
    } catch (error) {
      console.error('Error loading comparison:', error);
      container.innerHTML = '<div class="loading-state">Error loading comparison</div>';
    }
  }

  function renderComparison(data) {
    const container = document.getElementById('comparison-content');
    const datesContainer = document.getElementById('comparison-dates');

    datesContainer.innerHTML = `
            <div class="comparison-date-item">
                <span class="comparison-date-label">Current:</span>
                <span>${data.current_period.start_date} - ${data.current_period.end_date}</span>
            </div>
            <div class="comparison-date-item">
                <span class="comparison-date-label">Previous:</span>
                <span>${data.previous_period.start_date} - ${data.previous_period.end_date}</span>
            </div>
        `;

    const changeItems = [
      { key: 'total_orders', label: 'Total Orders', format: (v) => v.toLocaleString() },
      {
        key: 'total_revenue',
        label: 'Total Revenue',
        format: (v) =>
          `$${v.toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 })}`,
      },
      { key: 'avg_order_value', label: 'Avg Order Value', format: (v) => `$${v.toFixed(2)}` },
      { key: 'total_customers', label: 'Total Customers', format: (v) => v.toLocaleString() },
      {
        key: 'total_tips',
        label: 'Total Tips',
        format: (v) =>
          `$${v.toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 })}`,
      },
    ];

    container.innerHTML = changeItems
      .map((item) => {
        const current = data.current_period.metrics[item.key];
        const change = data.changes[item.key];
        const changeClass = change > 0 ? 'positive' : change < 0 ? 'negative' : 'neutral';
        const changeIcon = change > 0 ? 'â†‘' : change < 0 ? 'â†“' : 'â€”';

        return `
                <div class="comparison-item">
                    <div class="comparison-label">${item.label}</div>
                    <div class="comparison-values">
                        <div class="comparison-current">${item.format(current)}</div>
                        <div class="comparison-change ${changeClass}">
                            ${changeIcon} ${Math.abs(change).toFixed(1)}%
                        </div>
                    </div>
                </div>
            `;
      })
      .join('');
  }

  function exportWaiterPerformance() {
    window.print();
  }

  function exportCategoryPerformance() {
    window.print();
  }
</script>
{% endblock %}
